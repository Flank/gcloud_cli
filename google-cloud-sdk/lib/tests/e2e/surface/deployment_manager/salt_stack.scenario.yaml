title: IntegrationTest
summary:
# This summary is generated automatically on update and should not be edited.
- execute:
  - command: |
      deployment-manager deployments create $$dm1$$ --config salt_cluster.yaml
      --format "text(resources[0].name,resources[1].name)"
  - stderr: |
      The fingerprint of the deployment is adJvfg-TqZmD1oLviWV33g==
  - progress_tracker:
    - message: Waiting for create [$$operation$$]
    - status: SUCCESS
  - stderr: .*Create operation $$operation$$.*$
  - stdout: |
      resources[0].name: $$dm1$$-minions-0
      resources[1].name: $$dm1$$-minions-1
- execute:
  - command: |
      deployment-manager deployments describe $$dm1$$
      --format "text(resources[0].name,resources[1].name)"
  - stdout: |
      resources[0].name: $$dm1$$-minions-0
      resources[1].name: $$dm1$$-minions-1
- execute:
  - command: deployment-manager deployments delete -q --async $$dm1$$ --format "text(kind)"
  - stdout: |
      ---
      kind: deploymentmanager#operation
actions:
- generate_resource_id:
    reference: dm1
    prefix: dm
- define_reference:
    reference: zone
    value: us-central1-f
- load_resource:
    path: tests/lib/surface/deployment_manager/test_data/saltstack/salt_cluster.jinja
- load_resource:
    path: tests/lib/surface/deployment_manager/test_data/saltstack/minion.jinja
- load_resource:
    path: tests/e2e/surface/deployment_manager/test_data/salt_cluster.yaml
- load_resource:
    path: tests/lib/surface/deployment_manager/test_data/saltstack/master.py
- execute_command:
    # testSaltstack
    command: |
      deployment-manager deployments create $$dm1$$ --config salt_cluster.yaml
      --format "text(resources[0].name,resources[1].name)"
    events:
    - api_call:
        expect_request:
          uri: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/deployments?alt=json&createPolicy=CREATE_OR_ACQUIRE&preview=False
          method: POST
          headers: {}
          body:
            json:
              name: $$dm1$$
              target:
                config:
                  content: |+
                    # Copyright 2015 Google LLC. All rights reserved.
                    #
                    # Licensed under the Apache License, Version 2.0 (the "License");
                    # you may not use this file except in compliance with the License.
                    # You may obtain a copy of the License at
                    #
                    #     http://www.apache.org/licenses/LICENSE-2.0
                    #
                    # Unless required by applicable law or agreed to in writing, software
                    # distributed under the License is distributed on an "AS IS" BASIS,
                    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                    # See the License for the specific language governing permissions and
                    # limitations under the License.

                    # Note that we - redundantly - provide the imports of salt_cluster.jinja.
                    # Once Expander supports Type Descriptors, it will be able to compute the
                    # transitive closure of dependencies itself.
                    imports:
                    - path: salt_cluster.jinja
                    - path: minion.jinja
                    - path: master.py

                    resources:
                    - name: salt-cluster
                      type: salt_cluster.jinja
                      properties:
                        minionCount: 4
                        zone: $$zone$$

                imports:
                - content: |
                    # Copyright 2015 Google LLC. All Rights Reserved.
                    #
                    # Licensed under the Apache License, Version 2.0 (the "License");
                    # you may not use this file except in compliance with the License.
                    # You may obtain a copy of the License at
                    #
                    #    http://www.apache.org/licenses/LICENSE-2.0
                    #
                    # Unless required by applicable law or agreed to in writing, software
                    # distributed under the License is distributed on an "AS IS" BASIS,
                    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                    # See the License for the specific language governing permissions and
                    # limitations under the License.

                    #% description: Creates a VM running a Salt master daemon in a Docker container.
                    #% parameters:
                    #% - name: zone
                    #%   type: string
                    #%   description: Zone to create the resources in.
                    #%   required: true
                    """Generates config for a VM running a SaltStack master.

                    Just for fun this template is in Python, while the others in this
                    directory are in Jinja2.
                    """

                    from __future__ import unicode_literals


                    def GenerateConfig(evaluation_context):
                      return """
                    resources:
                    - type: compute.v1.firewall
                      name: %(master)s-firewall
                      properties:
                        network: https://www.googleapis.com/compute/v1/projects/%(project)s/global/networks/default
                        sourceRanges: [ "0.0.0.0/0" ]
                        allowed:
                        - IPProtocol: tcp
                          ports: [ "4505", "4506" ]
                    - type: compute.v1.instance
                      name: %(master)s
                      properties:
                        zone: %(zone)s
                        machineType: https://www.googleapis.com/compute/v1/projects/%(project)s/zones/%(zone)s/machineTypes/f1-micro
                        disks:
                        - deviceName: boot
                          type: PERSISTENT
                          boot: true
                          autoDelete: true
                          initializeParams:
                            sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                        networkInterfaces:
                        - network: https://www.googleapis.com/compute/v1/projects/%(project)s/global/networks/default
                          accessConfigs:
                          - name: External NAT
                            type: ONE_TO_ONE_NAT
                        metadata:
                          items:
                          - key: startup-script
                            value: |
                              #! /bin/bash
                              sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                              sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                              sudo apt-get update
                              sudo apt-get -y install salt-master
                              sudo salt-master -l debug
                    """ % {"master": evaluation_context.env["name"],
                           "project": evaluation_context.env["project"],
                           "zone": evaluation_context.properties["zone"]}
                  name: master.py
                - content: |+
                    # Copyright 2015 Google LLC. All Rights Reserved.
                    {#
                    Copyright 2015 Google LLC. All rights reserved.
                    Licensed under the Apache License, Version 2.0 (the "License");
                    you may not use this file except in compliance with the License.
                    You may obtain a copy of the License at

                        http://www.apache.org/licenses/LICENSE-2.0

                    Unless required by applicable law or agreed to in writing, software
                    distributed under the License is distributed on an "AS IS" BASIS,
                    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                    See the License for the specific language governing permissions and
                    limitations under the License.
                    #}

                    #% description: Creates a set of VMs each running a Salt minion daemon in a Docker container.
                    #% parameters:
                    #% - name: minionCount
                    #%   type: int
                    #%   description: How many minion VMs to set up.
                    #%   default: 1
                    #% - name: master
                    #%   type: string
                    #%   description: Name of the master.
                    #%   required: true
                    #% - name: zone
                    #%   type: string
                    #%   description: Zone to create the resources in.
                    #%   required: true

                    resources:
                    {% for replica in range(0, properties["minionCount"]) %}
                    - type: compute.v1.instance
                      name: {{ env["deployment"] + "-" + env["name"] + "-" + replica|string }}
                      properties:
                        zone: {{ properties["zone"] }}
                        machineType: https://www.googleapis.com/compute/v1/projects/{{ env["project"] }}/zones/{{ properties["zone"] }}/machineTypes/f1-micro
                        disks:
                        - deviceName: boot
                          type: PERSISTENT
                          boot: true
                          autoDelete: true
                          initializeParams:
                            sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                        networkInterfaces:
                        - network: https://www.googleapis.com/compute/v1/projects/{{ env["project"] }}/global/networks/default
                          accessConfigs:
                          - name: External NAT
                            type: ONE_TO_ONE_NAT
                        metadata:
                          items:
                          - key: startup-script
                            value: |
                              #! /bin/bash
                              sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                              sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                              sudo apt-get update
                              sudo apt-get -y install salt-minion
                              sudo sed -i 's/#master: salt/master: {{ properties["master"] }}/' /etc/salt/minion
                              sudo salt-minion -l debug
                    {% endfor %}

                  name: minion.jinja
                - content: |
                    # Copyright 2015 Google LLC. All Rights Reserved.
                    {#
                    Copyright 2015 Google LLC. All rights reserved.
                    Licensed under the Apache License, Version 2.0 (the "License");
                    you may not use this file except in compliance with the License.
                    You may obtain a copy of the License at

                        http://www.apache.org/licenses/LICENSE-2.0

                    Unless required by applicable law or agreed to in writing, software
                    distributed under the License is distributed on an "AS IS" BASIS,
                    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                    See the License for the specific language governing permissions and
                    limitations under the License.
                    #}

                    #% description: Creates a set of VMs each running either a Salt master or minion daemon in a Docker container.
                    #% imports: ["minion.jinja", "master.py"]
                    #% parameters:
                    #% - name: minionCount
                    #%   type: int
                    #%   description: How many minion VMs to set up.
                    #%   default: 1
                    #% - name: zone
                    #%   type: string
                    #%   description: Zone to create the resources in.
                    #%   required: true

                    {% set MASTER_NAME = env["deployment"] + "-" + env["name"] + "-master" %}

                    resources:
                    - name: minions
                      type: minion.jinja
                      properties:
                        master: {{ MASTER_NAME }}
                        minionCount: {{ properties["minionCount"] }}
                        zone: {{ properties["zone"] }}
                    - name: {{ MASTER_NAME }}
                      type: master.py
                      properties:
                        zone: {{ properties["zone"] }}
                  name: salt_cluster.jinja
        return_response:
          headers:
            cache-control: no-cache, no-store, max-age=0, must-revalidate
            content-length: '704'
            content-type: application/json; charset=UTF-8
            etag: '"MBVBbqFwoL314QGz63rX-F3C9f8/vf8nCOJCjx-2JdYvlmsSgtlXrFw"'
            pragma: no-cache
            status: '200'
          body:
            kind: deploymentmanager#operation
            id: '4714814572014325554'
            name: operation-1544712669607-57ce871f3b459-acf36c9e-c03ec89b
            operationType: insert
            targetLink: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/deployments/$$dm1$$
            targetId: '5764659262403890994'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2018-12-13T06:51:09.766-08:00'
            selfLink: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/operations/operation-1544712669607-57ce871f3b459-acf36c9e-c03ec89b
        poll_operation: true
    - api_call:
        expect_request:
          uri: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/deployments/$$dm1$$?alt=json
          method: GET
          headers: {}
          body: null
        expect_response:
          extract_references:
          - reference: manifest1
            field: update.manifest
          body:
            json: {}
        return_response:
          headers:
            cache-control: private, max-age=0, must-revalidate, no-transform
            content-length: '1282'
            content-type: application/json; charset=UTF-8
            etag: '"MBVBbqFwoL314QGz63rX-F3C9f8/IIAWKi1c7fgrGa5GnFKJuh3atOA"'
            status: '200'
          body:
            id: '5764659262403890994'
            name: $$dm1$$
            operation:
              kind: deploymentmanager#operation
              id: '4714814572014325554'
              name: operation-1544712669607-57ce871f3b459-acf36c9e-c03ec89b
              operationType: insert
              targetLink: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/deployments/$$dm1$$
              targetId: '5764659262403890994'
              status: PENDING
              user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              progress: 0
              insertTime: '2018-12-13T06:51:09.766-08:00'
              selfLink: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/operations/operation-1544712669607-57ce871f3b459-acf36c9e-c03ec89b
            fingerprint: adJvfg-TqZmD1oLviWV33g==
            update:
              manifest: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/deployments/$$dm1$$/manifests/manifest-1544712669720
            insertTime: '2018-12-13T06:51:09.707-08:00'
            updateTime: '1969-12-31T16:00:00.000-08:00'
            selfLink: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/deployments/$$dm1$$
    - expect_stderr:
        matches: The fingerprint of the deployment is.*
    - expect_progress_tracker:
        message: Waiting for create [$$operation$$]
        status: SUCCESS
    - expect_stderr:
        matches: .*Create operation $$operation$$.*
    - api_call:
        expect_request:
          uri: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/deployments/$$dm1$$/resources?alt=json&maxResults=500
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private, max-age=0, must-revalidate, no-transform
            content-length: '17716'
            content-type: application/json; charset=UTF-8
            etag: '"MBVBbqFwoL314QGz63rX-F3C9f8/ErhAkbcPlecx44gzJfPSZDO5ZpQ"'
            status: '200'
          body:
            resources:
            - id: '8738649821092499213'
              name: $$dm1$$-minions-0
              type: compute.v1.instance
              manifest: $$manifest1$$
              url: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/instances/$$dm1$$-minions-0
              properties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-minion
                      sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                      sudo salt-minion -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              finalProperties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-minion
                      sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                      sudo salt-minion -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              insertTime: '2018-12-13T06:51:14.143-08:00'
              updateTime: '2018-12-13T06:52:08.749-08:00'
              warnings:
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
            - id: '2315212714491760397'
              name: $$dm1$$-minions-1
              type: compute.v1.instance
              manifest: $$manifest1$$
              url: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/instances/$$dm1$$-minions-1
              properties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-minion
                      sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                      sudo salt-minion -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              finalProperties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-minion
                      sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                      sudo salt-minion -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              insertTime: '2018-12-13T06:51:14.166-08:00'
              updateTime: '2018-12-13T06:53:25.812-08:00'
              warnings:
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
            - id: '6485179600136556301'
              name: $$dm1$$-minions-2
              type: compute.v1.instance
              manifest: $$manifest1$$
              url: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/instances/$$dm1$$-minions-2
              properties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-minion
                      sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                      sudo salt-minion -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              finalProperties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-minion
                      sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                      sudo salt-minion -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              insertTime: '2018-12-13T06:51:14.190-08:00'
              updateTime: '2018-12-13T06:53:14.724-08:00'
              warnings:
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
            - id: '4586400568896900877'
              name: $$dm1$$-minions-3
              type: compute.v1.instance
              manifest: $$manifest1$$
              url: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/instances/$$dm1$$-minions-3
              properties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-minion
                      sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                      sudo salt-minion -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              finalProperties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-minion
                      sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                      sudo salt-minion -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              insertTime: '2018-12-13T06:51:14.213-08:00'
              updateTime: '2018-12-13T06:51:59.611-08:00'
              warnings:
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
            - id: '3749219655160418061'
              name: $$dm1$$-salt-cluster-master
              type: compute.v1.instance
              manifest: $$manifest1$$
              url: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/instances/$$dm1$$-salt-cluster-master
              properties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-master
                      sudo salt-master -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              finalProperties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-master
                      sudo salt-master -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              insertTime: '2018-12-13T06:51:14.262-08:00'
              updateTime: '2018-12-13T06:51:56.077-08:00'
              warnings:
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
            - id: '6544687368455048973'
              name: $$dm1$$-salt-cluster-master-firewall
              type: compute.v1.firewall
              manifest: $$manifest1$$
              url: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/firewalls/$$dm1$$-salt-cluster-master-firewall
              properties: |
                allowed:
                - IPProtocol: tcp
                  ports:
                  - '4505'
                  - '4506'
                network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                sourceRanges:
                - 0.0.0.0/0
              finalProperties: |
                allowed:
                - IPProtocol: tcp
                  ports:
                  - '4505'
                  - '4506'
                network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                sourceRanges:
                - 0.0.0.0/0
              insertTime: '2018-12-13T06:51:14.237-08:00'
              updateTime: '2018-12-13T06:53:02.026-08:00'
    - api_call:
        expect_request:
          uri: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/deployments/$$dm1$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private, max-age=0, must-revalidate, no-transform
            content-length: '4153'
            content-type: application/json; charset=UTF-8
            etag: '"MBVBbqFwoL314QGz63rX-F3C9f8/Ot5-kHkqawQEhxCFRWLYRlz973k"'
            status: '200'
          body:
            id: '5764659262403890994'
            name: $$dm1$$
            operation:
              kind: deploymentmanager#operation
              id: '4714814572014325554'
              name: operation-1544712669607-57ce871f3b459-acf36c9e-c03ec89b
              operationType: insert
              targetLink: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/deployments/$$dm1$$
              targetId: '5764659262403890994'
              status: DONE
              user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              progress: 100
              insertTime: '2018-12-13T06:51:09.766-08:00'
              startTime: '2018-12-13T06:51:10.065-08:00'
              endTime: '2018-12-13T06:53:32.063-08:00'
              warnings:
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
              selfLink: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/operations/operation-1544712669607-57ce871f3b459-acf36c9e-c03ec89b
            fingerprint: adJvfg-TqZmD1oLviWV33g==
            manifest: $$manifest1$$
            insertTime: '2018-12-13T06:51:09.707-08:00'
            updateTime: '2018-12-13T06:53:32.030-08:00'
            selfLink: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/deployments/$$dm1$$
    - api_call:
        expect_request:
          uri: $$manifest1$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private, max-age=0, must-revalidate, no-transform
            content-length: '15694'
            content-type: application/json; charset=UTF-8
            etag: '"MBVBbqFwoL314QGz63rX-F3C9f8/RkPtiblLcKip5h3O7wo217KQ1sY"'
            status: '200'
          body:
            selfLink: $$manifest1$$
            id: '9161836625259384626'
            name: manifest-1544712669720
            config:
              content: |+
                # Copyright 2015 Google LLC. All rights reserved.
                #
                # Licensed under the Apache License, Version 2.0 (the "License");
                # you may not use this file except in compliance with the License.
                # You may obtain a copy of the License at
                #
                #     http://www.apache.org/licenses/LICENSE-2.0
                #
                # Unless required by applicable law or agreed to in writing, software
                # distributed under the License is distributed on an "AS IS" BASIS,
                # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                # See the License for the specific language governing permissions and
                # limitations under the License.

                # Note that we - redundantly - provide the imports of salt_cluster.jinja.
                # Once Expander supports Type Descriptors, it will be able to compute the
                # transitive closure of dependencies itself.
                imports:
                - path: salt_cluster.jinja
                - path: minion.jinja
                - path: master.py

                resources:
                - name: salt-cluster
                  type: salt_cluster.jinja
                  properties:
                    minionCount: 4
                    zone: $$zone$$

            imports:
            - name: minion.jinja
              content: |+
                # Copyright 2015 Google LLC. All Rights Reserved.
                {#
                Copyright 2015 Google LLC. All rights reserved.
                Licensed under the Apache License, Version 2.0 (the "License");
                you may not use this file except in compliance with the License.
                You may obtain a copy of the License at

                    http://www.apache.org/licenses/LICENSE-2.0

                Unless required by applicable law or agreed to in writing, software
                distributed under the License is distributed on an "AS IS" BASIS,
                WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                See the License for the specific language governing permissions and
                limitations under the License.
                #}

                #% description: Creates a set of VMs each running a Salt minion daemon in a Docker container.
                #% parameters:
                #% - name: minionCount
                #%   type: int
                #%   description: How many minion VMs to set up.
                #%   default: 1
                #% - name: master
                #%   type: string
                #%   description: Name of the master.
                #%   required: true
                #% - name: zone
                #%   type: string
                #%   description: Zone to create the resources in.
                #%   required: true

                resources:
                {% for replica in range(0, properties["minionCount"]) %}
                - type: compute.v1.instance
                  name: {{ env["deployment"] + "-" + env["name"] + "-" + replica|string }}
                  properties:
                    zone: {{ properties["zone"] }}
                    machineType: https://www.googleapis.com/compute/v1/projects/{{ env["project"] }}/zones/{{ properties["zone"] }}/machineTypes/f1-micro
                    disks:
                    - deviceName: boot
                      type: PERSISTENT
                      boot: true
                      autoDelete: true
                      initializeParams:
                        sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                    networkInterfaces:
                    - network: https://www.googleapis.com/compute/v1/projects/{{ env["project"] }}/global/networks/default
                      accessConfigs:
                      - name: External NAT
                        type: ONE_TO_ONE_NAT
                    metadata:
                      items:
                      - key: startup-script
                        value: |
                          #! /bin/bash
                          sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                          sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                          sudo apt-get update
                          sudo apt-get -y install salt-minion
                          sudo sed -i 's/#master: salt/master: {{ properties["master"] }}/' /etc/salt/minion
                          sudo salt-minion -l debug
                {% endfor %}

            - name: master.py
              content: |
                # Copyright 2015 Google LLC. All Rights Reserved.
                #
                # Licensed under the Apache License, Version 2.0 (the "License");
                # you may not use this file except in compliance with the License.
                # You may obtain a copy of the License at
                #
                #    http://www.apache.org/licenses/LICENSE-2.0
                #
                # Unless required by applicable law or agreed to in writing, software
                # distributed under the License is distributed on an "AS IS" BASIS,
                # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                # See the License for the specific language governing permissions and
                # limitations under the License.

                #% description: Creates a VM running a Salt master daemon in a Docker container.
                #% parameters:
                #% - name: zone
                #%   type: string
                #%   description: Zone to create the resources in.
                #%   required: true
                """Generates config for a VM running a SaltStack master.

                Just for fun this template is in Python, while the others in this
                directory are in Jinja2.
                """

                from __future__ import unicode_literals


                def GenerateConfig(evaluation_context):
                  return """
                resources:
                - type: compute.v1.firewall
                  name: %(master)s-firewall
                  properties:
                    network: https://www.googleapis.com/compute/v1/projects/%(project)s/global/networks/default
                    sourceRanges: [ "0.0.0.0/0" ]
                    allowed:
                    - IPProtocol: tcp
                      ports: [ "4505", "4506" ]
                - type: compute.v1.instance
                  name: %(master)s
                  properties:
                    zone: %(zone)s
                    machineType: https://www.googleapis.com/compute/v1/projects/%(project)s/zones/%(zone)s/machineTypes/f1-micro
                    disks:
                    - deviceName: boot
                      type: PERSISTENT
                      boot: true
                      autoDelete: true
                      initializeParams:
                        sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                    networkInterfaces:
                    - network: https://www.googleapis.com/compute/v1/projects/%(project)s/global/networks/default
                      accessConfigs:
                      - name: External NAT
                        type: ONE_TO_ONE_NAT
                    metadata:
                      items:
                      - key: startup-script
                        value: |
                          #! /bin/bash
                          sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                          sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                          sudo apt-get update
                          sudo apt-get -y install salt-master
                          sudo salt-master -l debug
                """ % {"master": evaluation_context.env["name"],
                       "project": evaluation_context.env["project"],
                       "zone": evaluation_context.properties["zone"]}
            - name: salt_cluster.jinja
              content: |
                # Copyright 2015 Google LLC. All Rights Reserved.
                {#
                Copyright 2015 Google LLC. All rights reserved.
                Licensed under the Apache License, Version 2.0 (the "License");
                you may not use this file except in compliance with the License.
                You may obtain a copy of the License at

                    http://www.apache.org/licenses/LICENSE-2.0

                Unless required by applicable law or agreed to in writing, software
                distributed under the License is distributed on an "AS IS" BASIS,
                WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                See the License for the specific language governing permissions and
                limitations under the License.
                #}

                #% description: Creates a set of VMs each running either a Salt master or minion daemon in a Docker container.
                #% imports: ["minion.jinja", "master.py"]
                #% parameters:
                #% - name: minionCount
                #%   type: int
                #%   description: How many minion VMs to set up.
                #%   default: 1
                #% - name: zone
                #%   type: string
                #%   description: Zone to create the resources in.
                #%   required: true

                {% set MASTER_NAME = env["deployment"] + "-" + env["name"] + "-master" %}

                resources:
                - name: minions
                  type: minion.jinja
                  properties:
                    master: {{ MASTER_NAME }}
                    minionCount: {{ properties["minionCount"] }}
                    zone: {{ properties["zone"] }}
                - name: {{ MASTER_NAME }}
                  type: master.py
                  properties:
                    zone: {{ properties["zone"] }}
            expandedConfig: |
              resources:
              - name: $$dm1$$-minions-0
                properties:
                  disks:
                  - autoDelete: true
                    boot: true
                    deviceName: boot
                    initializeParams:
                      sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                    type: PERSISTENT
                  machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                  metadata:
                    items:
                    - key: startup-script
                      value: |
                        #! /bin/bash
                        sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                        sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                        sudo apt-get update
                        sudo apt-get -y install salt-minion
                        sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                        sudo salt-minion -l debug
                  networkInterfaces:
                  - accessConfigs:
                    - name: External NAT
                      type: ONE_TO_ONE_NAT
                    network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                  zone: $$zone$$
                type: compute.v1.instance
              - name: $$dm1$$-minions-1
                properties:
                  disks:
                  - autoDelete: true
                    boot: true
                    deviceName: boot
                    initializeParams:
                      sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                    type: PERSISTENT
                  machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                  metadata:
                    items:
                    - key: startup-script
                      value: |
                        #! /bin/bash
                        sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                        sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                        sudo apt-get update
                        sudo apt-get -y install salt-minion
                        sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                        sudo salt-minion -l debug
                  networkInterfaces:
                  - accessConfigs:
                    - name: External NAT
                      type: ONE_TO_ONE_NAT
                    network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                  zone: $$zone$$
                type: compute.v1.instance
              - name: $$dm1$$-minions-2
                properties:
                  disks:
                  - autoDelete: true
                    boot: true
                    deviceName: boot
                    initializeParams:
                      sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                    type: PERSISTENT
                  machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                  metadata:
                    items:
                    - key: startup-script
                      value: |
                        #! /bin/bash
                        sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                        sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                        sudo apt-get update
                        sudo apt-get -y install salt-minion
                        sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                        sudo salt-minion -l debug
                  networkInterfaces:
                  - accessConfigs:
                    - name: External NAT
                      type: ONE_TO_ONE_NAT
                    network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                  zone: $$zone$$
                type: compute.v1.instance
              - name: $$dm1$$-minions-3
                properties:
                  disks:
                  - autoDelete: true
                    boot: true
                    deviceName: boot
                    initializeParams:
                      sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                    type: PERSISTENT
                  machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                  metadata:
                    items:
                    - key: startup-script
                      value: |
                        #! /bin/bash
                        sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                        sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                        sudo apt-get update
                        sudo apt-get -y install salt-minion
                        sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                        sudo salt-minion -l debug
                  networkInterfaces:
                  - accessConfigs:
                    - name: External NAT
                      type: ONE_TO_ONE_NAT
                    network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                  zone: $$zone$$
                type: compute.v1.instance
              - name: $$dm1$$-salt-cluster-master-firewall
                properties:
                  allowed:
                  - IPProtocol: tcp
                    ports:
                    - '4505'
                    - '4506'
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                  sourceRanges:
                  - 0.0.0.0/0
                type: compute.v1.firewall
              - name: $$dm1$$-salt-cluster-master
                properties:
                  disks:
                  - autoDelete: true
                    boot: true
                    deviceName: boot
                    initializeParams:
                      sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                    type: PERSISTENT
                  machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                  metadata:
                    items:
                    - key: startup-script
                      value: |
                        #! /bin/bash
                        sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                        sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                        sudo apt-get update
                        sudo apt-get -y install salt-master
                        sudo salt-master -l debug
                  networkInterfaces:
                  - accessConfigs:
                    - name: External NAT
                      type: ONE_TO_ONE_NAT
                    network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                  zone: $$zone$$
                type: compute.v1.instance
            insertTime: '2018-12-13T06:51:09.731-08:00'
            layout: |
              resources:
              - name: salt-cluster
                properties:
                  minionCount: 4
                  zone: $$zone$$
                resources:
                - name: minions
                  properties:
                    master: $$dm1$$-salt-cluster-master
                    minionCount: 4
                    zone: $$zone$$
                  resources:
                  - name: $$dm1$$-minions-0
                    type: compute.v1.instance
                  - name: $$dm1$$-minions-1
                    type: compute.v1.instance
                  - name: $$dm1$$-minions-2
                    type: compute.v1.instance
                  - name: $$dm1$$-minions-3
                    type: compute.v1.instance
                  type: minion.jinja
                - name: $$dm1$$-salt-cluster-master
                  properties:
                    zone: $$zone$$
                  resources:
                  - name: $$dm1$$-salt-cluster-master-firewall
                    type: compute.v1.firewall
                  - name: $$dm1$$-salt-cluster-master
                    type: compute.v1.instance
                  type: master.py
                type: salt_cluster.jinja
    - expect_stdout: |
        resources[0].name: $$dm1$$-minions-0
        resources[1].name: $$dm1$$-minions-1
    - expect_exit:
        code: 0
- execute_command:
    # testSaltstack
    command: |
      deployment-manager deployments describe $$dm1$$
      --format "text(resources[0].name,resources[1].name)"
    events:
    - api_call:
        expect_request:
          uri: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/deployments/$$dm1$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private, max-age=0, must-revalidate, no-transform
            content-length: '4153'
            content-type: application/json; charset=UTF-8
            etag: '"MBVBbqFwoL314QGz63rX-F3C9f8/Ot5-kHkqawQEhxCFRWLYRlz973k"'
            status: '200'
          body:
            id: '5764659262403890994'
            name: $$dm1$$
            operation:
              kind: deploymentmanager#operation
              id: '4714814572014325554'
              name: operation-1544712669607-57ce871f3b459-acf36c9e-c03ec89b
              operationType: insert
              targetLink: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/deployments/$$dm1$$
              targetId: '5764659262403890994'
              status: DONE
              user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              progress: 100
              insertTime: '2018-12-13T06:51:09.766-08:00'
              startTime: '2018-12-13T06:51:10.065-08:00'
              endTime: '2018-12-13T06:53:32.063-08:00'
              warnings:
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
              selfLink: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/operations/operation-1544712669607-57ce871f3b459-acf36c9e-c03ec89b
            fingerprint: adJvfg-TqZmD1oLviWV33g==
            manifest: $$manifest1$$
            insertTime: '2018-12-13T06:51:09.707-08:00'
            updateTime: '2018-12-13T06:53:32.030-08:00'
            selfLink: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/deployments/$$dm1$$
    - api_call:
        expect_request:
          uri: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/deployments/$$dm1$$/resources?alt=json&maxResults=500
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private, max-age=0, must-revalidate, no-transform
            content-length: '17716'
            content-type: application/json; charset=UTF-8
            etag: '"MBVBbqFwoL314QGz63rX-F3C9f8/ErhAkbcPlecx44gzJfPSZDO5ZpQ"'
            status: '200'
          body:
            resources:
            - id: '8738649821092499213'
              name: $$dm1$$-minions-0
              type: compute.v1.instance
              manifest: $$manifest1$$
              url: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/instances/$$dm1$$-minions-0
              properties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-minion
                      sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                      sudo salt-minion -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              finalProperties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-minion
                      sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                      sudo salt-minion -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              insertTime: '2018-12-13T06:51:14.143-08:00'
              updateTime: '2018-12-13T06:52:08.749-08:00'
              warnings:
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
            - id: '2315212714491760397'
              name: $$dm1$$-minions-1
              type: compute.v1.instance
              manifest: $$manifest1$$
              url: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/instances/$$dm1$$-minions-1
              properties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-minion
                      sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                      sudo salt-minion -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              finalProperties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-minion
                      sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                      sudo salt-minion -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              insertTime: '2018-12-13T06:51:14.166-08:00'
              updateTime: '2018-12-13T06:53:25.812-08:00'
              warnings:
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
            - id: '6485179600136556301'
              name: $$dm1$$-minions-2
              type: compute.v1.instance
              manifest: $$manifest1$$
              url: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/instances/$$dm1$$-minions-2
              properties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-minion
                      sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                      sudo salt-minion -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              finalProperties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-minion
                      sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                      sudo salt-minion -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              insertTime: '2018-12-13T06:51:14.190-08:00'
              updateTime: '2018-12-13T06:53:14.724-08:00'
              warnings:
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
            - id: '4586400568896900877'
              name: $$dm1$$-minions-3
              type: compute.v1.instance
              manifest: $$manifest1$$
              url: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/instances/$$dm1$$-minions-3
              properties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-minion
                      sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                      sudo salt-minion -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              finalProperties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-minion
                      sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                      sudo salt-minion -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              insertTime: '2018-12-13T06:51:14.213-08:00'
              updateTime: '2018-12-13T06:51:59.611-08:00'
              warnings:
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
            - id: '3749219655160418061'
              name: $$dm1$$-salt-cluster-master
              type: compute.v1.instance
              manifest: $$manifest1$$
              url: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/instances/$$dm1$$-salt-cluster-master
              properties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-master
                      sudo salt-master -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              finalProperties: |
                disks:
                - autoDelete: true
                  boot: true
                  deviceName: boot
                  initializeParams:
                    sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                  type: PERSISTENT
                machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                metadata:
                  items:
                  - key: startup-script
                    value: |
                      #! /bin/bash
                      sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                      sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                      sudo apt-get update
                      sudo apt-get -y install salt-master
                      sudo salt-master -l debug
                networkInterfaces:
                - accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                zone: $$zone$$
              insertTime: '2018-12-13T06:51:14.262-08:00'
              updateTime: '2018-12-13T06:51:56.077-08:00'
              warnings:
              - code: EXTERNAL_API_WARNING
                message: The resource 'projects/debian-cloud/global/images/debian-7-wheezy-v20140619'
                  is deprecated. A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
                data:
                - key: resource_name
                  value: projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                - key: replacement_suggestion
                  value: A suggested replacement is 'projects/debian-cloud/global/images/debian-7-wheezy-v20140718'.
            - id: '6544687368455048973'
              name: $$dm1$$-salt-cluster-master-firewall
              type: compute.v1.firewall
              manifest: $$manifest1$$
              url: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/firewalls/$$dm1$$-salt-cluster-master-firewall
              properties: |
                allowed:
                - IPProtocol: tcp
                  ports:
                  - '4505'
                  - '4506'
                network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                sourceRanges:
                - 0.0.0.0/0
              finalProperties: |
                allowed:
                - IPProtocol: tcp
                  ports:
                  - '4505'
                  - '4506'
                network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                sourceRanges:
                - 0.0.0.0/0
              insertTime: '2018-12-13T06:51:14.237-08:00'
              updateTime: '2018-12-13T06:53:02.026-08:00'
    - api_call:
        expect_request:
          uri: $$manifest1$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private, max-age=0, must-revalidate, no-transform
            content-length: '15694'
            content-type: application/json; charset=UTF-8
            etag: '"MBVBbqFwoL314QGz63rX-F3C9f8/RkPtiblLcKip5h3O7wo217KQ1sY"'
            status: '200'
          body:
            selfLink: $$manifest1$$
            id: '9161836625259384626'
            name: manifest-1544712669720
            config:
              content: |+
                # Copyright 2015 Google LLC. All rights reserved.
                #
                # Licensed under the Apache License, Version 2.0 (the "License");
                # you may not use this file except in compliance with the License.
                # You may obtain a copy of the License at
                #
                #     http://www.apache.org/licenses/LICENSE-2.0
                #
                # Unless required by applicable law or agreed to in writing, software
                # distributed under the License is distributed on an "AS IS" BASIS,
                # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                # See the License for the specific language governing permissions and
                # limitations under the License.

                # Note that we - redundantly - provide the imports of salt_cluster.jinja.
                # Once Expander supports Type Descriptors, it will be able to compute the
                # transitive closure of dependencies itself.
                imports:
                - path: salt_cluster.jinja
                - path: minion.jinja
                - path: master.py

                resources:
                - name: salt-cluster
                  type: salt_cluster.jinja
                  properties:
                    minionCount: 4
                    zone: $$zone$$

            imports:
            - name: minion.jinja
              content: |+
                # Copyright 2015 Google LLC. All Rights Reserved.
                {#
                Copyright 2015 Google LLC. All rights reserved.
                Licensed under the Apache License, Version 2.0 (the "License");
                you may not use this file except in compliance with the License.
                You may obtain a copy of the License at

                    http://www.apache.org/licenses/LICENSE-2.0

                Unless required by applicable law or agreed to in writing, software
                distributed under the License is distributed on an "AS IS" BASIS,
                WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                See the License for the specific language governing permissions and
                limitations under the License.
                #}

                #% description: Creates a set of VMs each running a Salt minion daemon in a Docker container.
                #% parameters:
                #% - name: minionCount
                #%   type: int
                #%   description: How many minion VMs to set up.
                #%   default: 1
                #% - name: master
                #%   type: string
                #%   description: Name of the master.
                #%   required: true
                #% - name: zone
                #%   type: string
                #%   description: Zone to create the resources in.
                #%   required: true

                resources:
                {% for replica in range(0, properties["minionCount"]) %}
                - type: compute.v1.instance
                  name: {{ env["deployment"] + "-" + env["name"] + "-" + replica|string }}
                  properties:
                    zone: {{ properties["zone"] }}
                    machineType: https://www.googleapis.com/compute/v1/projects/{{ env["project"] }}/zones/{{ properties["zone"] }}/machineTypes/f1-micro
                    disks:
                    - deviceName: boot
                      type: PERSISTENT
                      boot: true
                      autoDelete: true
                      initializeParams:
                        sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                    networkInterfaces:
                    - network: https://www.googleapis.com/compute/v1/projects/{{ env["project"] }}/global/networks/default
                      accessConfigs:
                      - name: External NAT
                        type: ONE_TO_ONE_NAT
                    metadata:
                      items:
                      - key: startup-script
                        value: |
                          #! /bin/bash
                          sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                          sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                          sudo apt-get update
                          sudo apt-get -y install salt-minion
                          sudo sed -i 's/#master: salt/master: {{ properties["master"] }}/' /etc/salt/minion
                          sudo salt-minion -l debug
                {% endfor %}

            - name: master.py
              content: |
                # Copyright 2015 Google LLC. All Rights Reserved.
                #
                # Licensed under the Apache License, Version 2.0 (the "License");
                # you may not use this file except in compliance with the License.
                # You may obtain a copy of the License at
                #
                #    http://www.apache.org/licenses/LICENSE-2.0
                #
                # Unless required by applicable law or agreed to in writing, software
                # distributed under the License is distributed on an "AS IS" BASIS,
                # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                # See the License for the specific language governing permissions and
                # limitations under the License.

                #% description: Creates a VM running a Salt master daemon in a Docker container.
                #% parameters:
                #% - name: zone
                #%   type: string
                #%   description: Zone to create the resources in.
                #%   required: true
                """Generates config for a VM running a SaltStack master.

                Just for fun this template is in Python, while the others in this
                directory are in Jinja2.
                """

                from __future__ import unicode_literals


                def GenerateConfig(evaluation_context):
                  return """
                resources:
                - type: compute.v1.firewall
                  name: %(master)s-firewall
                  properties:
                    network: https://www.googleapis.com/compute/v1/projects/%(project)s/global/networks/default
                    sourceRanges: [ "0.0.0.0/0" ]
                    allowed:
                    - IPProtocol: tcp
                      ports: [ "4505", "4506" ]
                - type: compute.v1.instance
                  name: %(master)s
                  properties:
                    zone: %(zone)s
                    machineType: https://www.googleapis.com/compute/v1/projects/%(project)s/zones/%(zone)s/machineTypes/f1-micro
                    disks:
                    - deviceName: boot
                      type: PERSISTENT
                      boot: true
                      autoDelete: true
                      initializeParams:
                        sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                    networkInterfaces:
                    - network: https://www.googleapis.com/compute/v1/projects/%(project)s/global/networks/default
                      accessConfigs:
                      - name: External NAT
                        type: ONE_TO_ONE_NAT
                    metadata:
                      items:
                      - key: startup-script
                        value: |
                          #! /bin/bash
                          sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                          sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                          sudo apt-get update
                          sudo apt-get -y install salt-master
                          sudo salt-master -l debug
                """ % {"master": evaluation_context.env["name"],
                       "project": evaluation_context.env["project"],
                       "zone": evaluation_context.properties["zone"]}
            - name: salt_cluster.jinja
              content: |
                # Copyright 2015 Google LLC. All Rights Reserved.
                {#
                Copyright 2015 Google LLC. All rights reserved.
                Licensed under the Apache License, Version 2.0 (the "License");
                you may not use this file except in compliance with the License.
                You may obtain a copy of the License at

                    http://www.apache.org/licenses/LICENSE-2.0

                Unless required by applicable law or agreed to in writing, software
                distributed under the License is distributed on an "AS IS" BASIS,
                WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                See the License for the specific language governing permissions and
                limitations under the License.
                #}

                #% description: Creates a set of VMs each running either a Salt master or minion daemon in a Docker container.
                #% imports: ["minion.jinja", "master.py"]
                #% parameters:
                #% - name: minionCount
                #%   type: int
                #%   description: How many minion VMs to set up.
                #%   default: 1
                #% - name: zone
                #%   type: string
                #%   description: Zone to create the resources in.
                #%   required: true

                {% set MASTER_NAME = env["deployment"] + "-" + env["name"] + "-master" %}

                resources:
                - name: minions
                  type: minion.jinja
                  properties:
                    master: {{ MASTER_NAME }}
                    minionCount: {{ properties["minionCount"] }}
                    zone: {{ properties["zone"] }}
                - name: {{ MASTER_NAME }}
                  type: master.py
                  properties:
                    zone: {{ properties["zone"] }}
            expandedConfig: |
              resources:
              - name: $$dm1$$-minions-0
                properties:
                  disks:
                  - autoDelete: true
                    boot: true
                    deviceName: boot
                    initializeParams:
                      sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                    type: PERSISTENT
                  machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                  metadata:
                    items:
                    - key: startup-script
                      value: |
                        #! /bin/bash
                        sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                        sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                        sudo apt-get update
                        sudo apt-get -y install salt-minion
                        sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                        sudo salt-minion -l debug
                  networkInterfaces:
                  - accessConfigs:
                    - name: External NAT
                      type: ONE_TO_ONE_NAT
                    network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                  zone: $$zone$$
                type: compute.v1.instance
              - name: $$dm1$$-minions-1
                properties:
                  disks:
                  - autoDelete: true
                    boot: true
                    deviceName: boot
                    initializeParams:
                      sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                    type: PERSISTENT
                  machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                  metadata:
                    items:
                    - key: startup-script
                      value: |
                        #! /bin/bash
                        sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                        sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                        sudo apt-get update
                        sudo apt-get -y install salt-minion
                        sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                        sudo salt-minion -l debug
                  networkInterfaces:
                  - accessConfigs:
                    - name: External NAT
                      type: ONE_TO_ONE_NAT
                    network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                  zone: $$zone$$
                type: compute.v1.instance
              - name: $$dm1$$-minions-2
                properties:
                  disks:
                  - autoDelete: true
                    boot: true
                    deviceName: boot
                    initializeParams:
                      sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                    type: PERSISTENT
                  machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                  metadata:
                    items:
                    - key: startup-script
                      value: |
                        #! /bin/bash
                        sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                        sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                        sudo apt-get update
                        sudo apt-get -y install salt-minion
                        sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                        sudo salt-minion -l debug
                  networkInterfaces:
                  - accessConfigs:
                    - name: External NAT
                      type: ONE_TO_ONE_NAT
                    network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                  zone: $$zone$$
                type: compute.v1.instance
              - name: $$dm1$$-minions-3
                properties:
                  disks:
                  - autoDelete: true
                    boot: true
                    deviceName: boot
                    initializeParams:
                      sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                    type: PERSISTENT
                  machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                  metadata:
                    items:
                    - key: startup-script
                      value: |
                        #! /bin/bash
                        sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                        sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                        sudo apt-get update
                        sudo apt-get -y install salt-minion
                        sudo sed -i 's/#master: salt/master: $$dm1$$-salt-cluster-master/' /etc/salt/minion
                        sudo salt-minion -l debug
                  networkInterfaces:
                  - accessConfigs:
                    - name: External NAT
                      type: ONE_TO_ONE_NAT
                    network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                  zone: $$zone$$
                type: compute.v1.instance
              - name: $$dm1$$-salt-cluster-master-firewall
                properties:
                  allowed:
                  - IPProtocol: tcp
                    ports:
                    - '4505'
                    - '4506'
                  network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                  sourceRanges:
                  - 0.0.0.0/0
                type: compute.v1.firewall
              - name: $$dm1$$-salt-cluster-master
                properties:
                  disks:
                  - autoDelete: true
                    boot: true
                    deviceName: boot
                    initializeParams:
                      sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-7-wheezy-v20140619
                    type: PERSISTENT
                  machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$zone$$/machineTypes/f1-micro
                  metadata:
                    items:
                    - key: startup-script
                      value: |
                        #! /bin/bash
                        sudo echo 'deb http://debian.saltstack.com/debian wheezy-saltstack main' >> /etc/apt/sources.list
                        sudo wget -q -O- http://debian.saltstack.com/debian-salt-team-joehealy.gpg.key | sudo apt-key add -
                        sudo apt-get update
                        sudo apt-get -y install salt-master
                        sudo salt-master -l debug
                  networkInterfaces:
                  - accessConfigs:
                    - name: External NAT
                      type: ONE_TO_ONE_NAT
                    network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
                  zone: $$zone$$
                type: compute.v1.instance
            insertTime: '2018-12-13T06:51:09.731-08:00'
            layout: |
              resources:
              - name: salt-cluster
                properties:
                  minionCount: 4
                  zone: $$zone$$
                resources:
                - name: minions
                  properties:
                    master: $$dm1$$-salt-cluster-master
                    minionCount: 4
                    zone: $$zone$$
                  resources:
                  - name: $$dm1$$-minions-0
                    type: compute.v1.instance
                  - name: $$dm1$$-minions-1
                    type: compute.v1.instance
                  - name: $$dm1$$-minions-2
                    type: compute.v1.instance
                  - name: $$dm1$$-minions-3
                    type: compute.v1.instance
                  type: minion.jinja
                - name: $$dm1$$-salt-cluster-master
                  properties:
                    zone: $$zone$$
                  resources:
                  - name: $$dm1$$-salt-cluster-master-firewall
                    type: compute.v1.firewall
                  - name: $$dm1$$-salt-cluster-master
                    type: compute.v1.instance
                  type: master.py
                type: salt_cluster.jinja
    - expect_stdout: |
        resources[0].name: $$dm1$$-minions-0
        resources[1].name: $$dm1$$-minions-1
    - expect_exit:
        code: 0
- execute_command:
    # testSaltstack
    cleanup_for: dm1
    command: deployment-manager deployments delete -q --async $$dm1$$ --format "text(kind)"
    events:
    - api_call:
        expect_request:
          uri: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/deployments/$$dm1$$?alt=json&deletePolicy=DELETE
          method: DELETE
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: no-cache, no-store, max-age=0, must-revalidate
            content-length: '704'
            content-type: application/json; charset=UTF-8
            etag: '"MBVBbqFwoL314QGz63rX-F3C9f8/VY9eiU6PYmrBt-5Q9j2sLDJdZPc"'
            pragma: no-cache
            status: '200'
          body:
            kind: deploymentmanager#operation
            id: '4322323740198161536'
            name: operation-1544712815623-57ce87aa7bb58-9339c234-26c831cf
            operationType: delete
            targetLink: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/deployments/$$dm1$$
            targetId: '5764659262403890994'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2018-12-13T06:53:35.870-08:00'
            selfLink: https://www.googleapis.com/deploymentmanager/v2/projects/cloud-sdk-integration-testing/global/operations/operation-1544712815623-57ce87aa7bb58-9339c234-26c831cf
        poll_operation: true
    - expect_stdout: |
        ---
        kind: deploymentmanager#operation
    - expect_exit:
        code: 0
