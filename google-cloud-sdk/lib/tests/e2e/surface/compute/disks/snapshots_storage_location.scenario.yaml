title: Test that a snapshot can be created with a specific storage location
release_tracks: [GA]

summary:
# This summary is generated automatically on update and should not be edited.
- execute:
  - command: compute disks create $$disk$$ --image-family=debian-9 --image-project=debian-cloud
      --zone us-central1-f --format 'yaml(name,zone,status)'
  - stderr: |
      Created [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/disks/$$disk$$].
  - stdout: |
      ---
      name: $$disk$$
      status: READY
      zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
- execute:
  - command: compute disks snapshot $$disk$$ --zone us-central1-f --snapshot-names
      $$snapshot$$ --storage-location us-west1
  - progress_tracker:
    - message: Creating snapshot(s) $$snapshot$$
    - status: SUCCESS
- execute:
  - command: compute snapshots describe $$snapshot$$ --format 'yaml(name,storageLocations,status)'
  - stdout: |
      name: $$snapshot$$
      status: READY
      storageLocations:
      - us-west1
- execute:
  - command: compute snapshots delete $$snapshot$$ -q
  - stderr: |
      Deleted [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/snapshots/$$snapshot$$].
- execute:
  - command: compute disks delete $$disk$$ --zone us-central1-f -q
  - stderr: |
      Deleted [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/disks/$$disk$$].
actions:
- define_reference:
    reference: compute-uri
    value: www.googleapis.com/compute
- generate_resource_id:
    reference: disk
    prefix: gcloud-compute-test-snapshot-labels

- execute_command:
    command: compute disks create $$disk$$ --image-family=debian-9 --image-project=debian-cloud
      --zone us-central1-f --format 'yaml(name,zone,status)'
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Content-Type: application/json; charset=UTF-8
            ETag: Iev48-qX6i6KyEdmZQez4fNzP-0=/k-VjAoQ9FBvGnV-s2HPXuBJQMEY=
            status: '200'
          body:
            id: '2004'
            creationTimestamp: '1969-12-31T16:00:00.000-08:00'
            name: us-central1-f
            description: us-central1-f
            status: UP
            region: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            availableCpuPlatforms:
            - Intel Skylake
            - Intel Broadwell
            - Intel Haswell
            - Intel Ivy Bridge
            kind: compute#zone
    - api_call:
        poll_operation: true
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/disks?alt=json&sourceImage=https%3A%2F%2Fwww.googleapis.com%2Fcompute%2Fv1%2Fprojects%2Fdebian-cloud%2Fglobal%2Fimages%2Ffamily%2Fdebian-9
          method: POST
          headers: {}
          body:
            json:
              name: $$disk$$
        return_response:
          headers:
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            id: '2606463526434417891'
            name: operation-1536102923959-57513d51efbc7-b0ad8cbf-b16f1aa7
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            operationType: insert
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/disks/$$disk$$
            targetId: '3421755727757356259'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2018-09-04T16:15:24.696-07:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/operations/operation-1536102923959-57513d51efbc7-b0ad8cbf-b16f1aa7
            kind: compute#operation
    - expect_stderr: |
        Created [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/disks/$$disk$$].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/disks/$$disk$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Content-Type: application/json; charset=UTF-8
            ETag: jG0BsfaXrjZwvuLsEgFQxEtcnm8=/YMfIUL1u8L3NiHR1ghR_oYa0fEE=
            status: '200'
          body:
            id: '3421755727757356259'
            creationTimestamp: '2018-09-04T16:15:24.660-07:00'
            name: $$disk$$
            sizeGb: '10'
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            status: READY
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/disks/$$disk$$
            sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-9-stretch-v20180820
            sourceImageId: '1810947815570337941'
            type: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/diskTypes/pd-standard
            licenses:
            - https://www.googleapis.com/compute/v1/projects/debian-cloud/global/licenses/debian-9-stretch
            guestOsFeatures:
            - type: VIRTIO_SCSI_MULTIQUEUE
            labelFingerprint: 42WmSpB8rSM=
            licenseCodes:
            - '1000205'
            physicalBlockSizeBytes: '4096'
            kind: compute#disk
    - expect_stdout: |
        ---
        name: $$disk$$
        status: READY
        zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
    - expect_exit:
        code: 0

- generate_resource_id:
    reference: snapshot
    prefix: gcloud-compute-test-snapshot

- execute_command:
    command: compute disks snapshot $$disk$$ --zone us-central1-f --snapshot-names
      $$snapshot$$ --storage-location us-west1
    events:
    - api_call:
        poll_operation: true
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/disks/$$disk$$/createSnapshot?alt=json&guestFlush=False
          method: POST
          headers: {}
          body:
            json:
              name: $$snapshot$$
        return_response:
          headers:
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            id: '7551077834641550590'
            name: operation-1536102928728-57513d567c206-545037fd-23ed763d
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            operationType: createSnapshot
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/disks/$$disk$$
            targetId: '3421755727757356259'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2018-09-04T16:15:29.149-07:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/operations/operation-1536102928728-57513d567c206-545037fd-23ed763d
            kind: compute#operation
    - expect_progress_tracker:
        message: Creating snapshot(s) $$snapshot$$
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/snapshots/$$snapshot$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Content-Type: application/json; charset=UTF-8
            ETag: 2xFMYJg4-CZ1-5pEXWycrNy_LYs=/YOtGpmkutY-ggEOJGn-ziY53y1M=
            status: '200'
          body:
            id: '6072941281827532031'
            creationTimestamp: '2018-09-04T16:15:29.549-07:00'
            name: $$snapshot$$
            status: READY
            sourceDisk: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/disks/$$disk$$
            sourceDiskId: '3421755727757356259'
            diskSizeGb: '10'
            storageBytes: '557533248'
            storageBytesStatus: UP_TO_DATE
            licenses:
            - https://www.googleapis.com/compute/v1/projects/debian-cloud/global/licenses/debian-9-stretch
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/snapshots/$$snapshot$$
            labelFingerprint: 42WmSpB8rSM=
            licenseCodes:
            - '1000205'
            storageLocations:
            - us-west1
            guestOsFeatures:
            - type: VIRTIO_SCSI_MULTIQUEUE
            kind: compute#snapshot
    - expect_exit:
        code: 0

- execute_command:
    command: compute snapshots describe $$snapshot$$ --format 'yaml(name,storageLocations,status)'
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/snapshots/$$snapshot$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Content-Type: application/json; charset=UTF-8
            ETag: sajG12u4OcSDHOLDF4EurMp7_-0=/2Wvp9D_LZjD-QcPG2Ff9tXp_LO8=
            status: '200'
          body:
            id: '6072941281827532031'
            creationTimestamp: '2018-09-04T16:15:29.549-07:00'
            name: $$snapshot$$
            status: READY
            sourceDisk: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/disks/$$disk$$
            sourceDiskId: '3421755727757356259'
            diskSizeGb: '10'
            storageBytes: '557533248'
            storageBytesStatus: UP_TO_DATE
            licenses:
            - https://www.googleapis.com/compute/v1/projects/debian-cloud/global/licenses/debian-9-stretch
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/snapshots/$$snapshot$$
            labelFingerprint: 42WmSpB8rSM=
            licenseCodes:
            - '1000205'
            storageLocations:
            - us-west1
            guestOsFeatures:
            - type: VIRTIO_SCSI_MULTIQUEUE
            kind: compute#snapshot
    - expect_stdout: |
        name: $$snapshot$$
        status: READY
        storageLocations:
        - us-west1
    - expect_exit:
        code: 0
- execute_command:
    command: compute snapshots delete $$snapshot$$ -q
    cleanup_for: snapshot
    events:
    - api_call:
        poll_operation: true
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/snapshots/$$snapshot$$?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          headers:
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            id: '5357327342935125187'
            name: operation-1536102956516-57513d70fc5d1-015cb966-f8afc312
            operationType: delete
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/snapshots/$$snapshot$$
            targetId: '6072941281827532031'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2018-09-04T16:15:57.081-07:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/operations/operation-1536102956516-57513d70fc5d1-015cb966-f8afc312
            kind: compute#operation
    - expect_stderr: |
        Deleted [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/snapshots/$$snapshot$$].
    - expect_exit:
        code: 0

- execute_command:
    command: compute disks delete $$disk$$ --zone us-central1-f -q
    cleanup_for: disk
    events:
    - api_call:
        poll_operation: true
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/disks/$$disk$$?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          headers:
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            id: '3786785182927989979'
            name: operation-1536102964022-57513d7824e2a-b34cf3d8-3c9ae3ea
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            operationType: delete
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/disks/$$disk$$
            targetId: '3421755727757356259'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2018-09-04T16:16:04.387-07:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/operations/operation-1536102964022-57513d7824e2a-b34cf3d8-3c9ae3ea
            kind: compute#operation
    - expect_stderr: |
        Deleted [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/disks/$$disk$$].
    - expect_exit:
        code: 0
