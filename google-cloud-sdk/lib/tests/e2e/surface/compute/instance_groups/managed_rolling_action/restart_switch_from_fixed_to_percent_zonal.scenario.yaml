title: Creates a zonal MIG and performs a rolling update
release_tracks: [BETA]
summary:
# This summary is generated automatically on update and should not be edited.
- execute:
  - command: compute instance-templates create $$template1$$ --machine-type n1-standard-1
      --format 'text(name,properties.machineType)'
  - stderr: |
      Created [https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$\].
  - stdout: |
      ---
      name:                   $$template1$$
      properties.machineType: n1-standard-1
- execute:
  - command: compute instance-groups managed create $$manager$$ --zone us-central1-f
      --base-instance-name $$manager$$ --size 10 --template $$template1$$ --format
      'text(name,region,targetSize)'
  - stderr: |
      Created [https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$\].
  - stdout: |
      ---
      name:       $$manager$$
      targetSize: 10
- execute:
  - command: compute instance-groups managed rolling-action restart $$manager$$ --max-unavailable=3
      --format=disable --zone us-central1-f
  - stderr: |
      Updated [https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$\].
- execute:
  - command: compute instance-groups managed rolling-action restart $$manager$$ --max-unavailable=25%
      --format=disable --zone us-central1-f
  - stderr: |
      Updated [https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$\].
- execute:
  - command: compute instance-groups managed rolling-action restart $$manager$$ --max-unavailable=4
      --format=disable --zone us-central1-f
  - stderr: |
      Updated [https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$\].
- execute:
  - command: compute instance-groups managed delete $$manager$$ --zone us-central1-f
  - prompt:
    - message: |
        The following instance group managers will be deleted:
         - [$$manager$$] in [us-central1-f]
    - input: y
  - stderr: |
      Deleted [https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$\].
  - progress_tracker:
    - message: Deleting Managed Instance Group
    - status: SUCCESS
- execute:
  - command: compute instance-templates delete $$template1$$
  - prompt:
    - message: |
        The following instance templates will be deleted:
         - [$$template1$$]
    - input: y
  - stderr: |
      Deleted [https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$\].
actions:
- define_reference:
    reference: compute-uri
    value: compute.googleapis.com/compute
- generate_resource_id:
    reference: template1
    prefix: mig-restart-switch-zonal
- execute_command:
    command: compute instance-templates create $$template1$$ --machine-type n1-standard-1
      --format 'text(name,properties.machineType)'
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/debian-cloud/global/images/family/debian-9?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '995'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#image
            id: '1464844176702362429'
            creationTimestamp: '2019-06-18T16:03:47.268-07:00'
            name: debian-9-stretch-v20190618
            description: Debian, Debian GNU/Linux, 9 (stretch), amd64 built on 20190618
            sourceType: RAW
            rawDisk:
              source: ''
              containerType: TAR
            status: READY
            archiveSizeBytes: '10705167360'
            diskSizeGb: '10'
            licenses:
            - https://$$compute-uri$$/beta/projects/debian-cloud/global/licenses/debian-9-stretch
            family: debian-9
            selfLink: https://$$compute-uri$$/beta/projects/debian-cloud/global/images/debian-9-stretch-v20190618
            labelFingerprint: 42WmSpB8rSM=
            guestOsFeatures:
            - type: VIRTIO_SCSI_MULTIQUEUE
            licenseCodes:
            - '1000205'
            storageLocations:
            - asia
            - asia
            - eu
            - eu
            - us
            - asia
            - us
            - us
            - eu
            - us
            - eu
            - asia
            - us
            - us
            - asia
            - asia
            - eu
            - eu
            - us
            - asia
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates?alt=json
          method: POST
          headers: {}
          body:
            json:
              name: $$template1$$
              properties:
                canIpForward: false
                disks:
                - autoDelete: true
                  boot: true
                  initializeParams:
                    sourceImage: https://$$compute-uri$$/beta/projects/debian-cloud/global/images/family/debian-9
                  mode: READ_WRITE
                  type: PERSISTENT
                machineType: n1-standard-1
                metadata: {}
                networkInterfaces:
                - accessConfigs:
                  - name: external-nat
                    type: ONE_TO_ONE_NAT
                  network: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/networks/default
                scheduling:
                  automaticRestart: true
                serviceAccounts:
                - email: default
                  scopes:
                  - https://www.googleapis.com/auth/devstorage.read_only
                  - https://www.googleapis.com/auth/logging.write
                  - https://www.googleapis.com/auth/monitoring.write
                  - https://www.googleapis.com/auth/pubsub
                  - https://www.googleapis.com/auth/service.management.readonly
                  - https://www.googleapis.com/auth/servicecontrol
                  - https://www.googleapis.com/auth/trace.append
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '779'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '2543448908705010592'
            name: operation-1561996623035-58ca0addb3ad0-4b42b150-517f3edc
            operationType: compute.instanceTemplates.insert
            targetLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
            targetId: '1025831332878980000'
            status: RUNNING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2019-07-01T08:57:03.853-07:00'
            startTime: '2019-07-01T08:57:03.866-07:00'
            selfLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/operations/operation-1561996623035-58ca0addb3ad0-4b42b150-517f3edc
        poll_operation: true
    - expect_stderr:
        matches: |
          Created \[https://.*.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$\].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1856'
            Content-Type: application/json; charset=UTF-8
            ETag: '"CJE2SHV1Rk2MqZN5pXJlWSJpPzo=/T1-pLE5A_Wgn3C2IollIBA_kDvE="'
            status: '200'
          body:
            kind: compute#instanceTemplate
            id: '1025831332878980000'
            creationTimestamp: '2019-07-01T08:57:03.788-07:00'
            name: $$template1$$
            description: ''
            properties:
              machineType: n1-standard-1
              canIpForward: false
              networkInterfaces:
              - kind: compute#networkInterface
                network: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/networks/default
                accessConfigs:
                - kind: compute#accessConfig
                  type: ONE_TO_ONE_NAT
                  name: external-nat
                  networkTier: PREMIUM
              disks:
              - kind: compute#attachedDisk
                type: PERSISTENT
                mode: READ_WRITE
                deviceName: persistent-disk-0
                index: 0
                boot: true
                initializeParams:
                  sourceImage: https://$$compute-uri$$/beta/projects/debian-cloud/global/images/family/debian-9
                autoDelete: true
              metadata:
                kind: compute#metadata
                fingerprint: 4_QxQ57NQak=
              serviceAccounts:
              - email: default
                scopes:
                - https://www.googleapis.com/auth/devstorage.read_only
                - https://www.googleapis.com/auth/logging.write
                - https://www.googleapis.com/auth/monitoring.write
                - https://www.googleapis.com/auth/pubsub
                - https://www.googleapis.com/auth/service.management.readonly
                - https://www.googleapis.com/auth/servicecontrol
                - https://www.googleapis.com/auth/trace.append
              scheduling:
                onHostMaintenance: MIGRATE
                automaticRestart: true
                preemptible: false
            selfLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
    - expect_stdout: |
        ---
        name:                   $$template1$$
        properties.machineType: n1-standard-1
    - expect_exit:
        code: 0


- generate_resource_id:
    reference: manager
    prefix: mig-restart-switch-zonal
- execute_command:
    command: compute instance-groups managed create $$manager$$ --zone us-central1-f
      --base-instance-name $$manager$$ --size 10 --template $$template1$$ --format
      'text(name,region,targetSize)'
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '538'
            Content-Type: application/json; charset=UTF-8
            ETag: '"xGu6mdOE9kpJhOvPEm2eLnf32Ms=/6moZ-VRXpTyI3H0Jp5UucTxYZw0="'
            status: '200'
          body:
            kind: compute#zone
            id: '2004'
            creationTimestamp: '1969-12-31T16:00:00.000-08:00'
            name: us-central1-f
            description: us-central1-f
            status: UP
            region: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/regions/us-central1
            selfLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
            availableCpuPlatforms:
            - Intel Cascade Lake
            - Intel Skylake
            - Intel Broadwell
            - Intel Haswell
            - Intel Ivy Bridge
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers?alt=json
          method: POST
          headers: {}
          body:
            json:
              baseInstanceName: $$manager$$
              instanceTemplate: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
              name: $$manager$$
              zone: us-central1-f
              targetSize: 10
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '923'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '8804296746960655290'
            name: operation-1561996628615-58ca0ae305f71-5b72b0e9-75d0e48e
            zone: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
            operationType: compute.instanceGroupManagers.insert
            targetLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            targetId: '844090667922068410'
            status: RUNNING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2019-07-01T08:57:09.586-07:00'
            startTime: '2019-07-01T08:57:09.595-07:00'
            selfLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/operations/operation-1561996628615-58ca0ae305f71-5b72b0e9-75d0e48e
        poll_operation: true
    - expect_stderr:
        matches: |
          Created \[https://.*.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$\].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1865'
            Content-Type: application/json; charset=UTF-8
            ETag: '"U7FoXr8IIaEPRlhv6f01T51p_5U=/H2E_Uh-9DK0flgitmKuX3JOmTQ8="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '844090667922068410'
            creationTimestamp: '2019-07-01T08:57:09.519-07:00'
            name: $$manager$$
            zone: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
            versions:
            - instanceTemplate: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
              targetSize:
                calculated: 10
            instanceGroup: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
            baseInstanceName: $$manager$$
            fingerprint: VqEeDYH2qJo=
            currentActions:
              none: 0
              creating: 10
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 0
              deleting: 0
              abandoning: 0
              restarting: 0
              refreshing: 0
            pendingActions:
              creating: 0
              deleting: 0
              recreating: 0
              restarting: 0
            status:
              isStable: false
              versionTarget:
                isReached: true
            targetSize: 10
            selfLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: OPPORTUNISTIC
              minimalAction: REPLACE
              maxSurge:
                fixed: 1
                calculated: 1
              maxUnavailable:
                fixed: 1
                calculated: 1
              minReadySec: 0
            serviceAccount: 462803083913@cloudservices.gserviceaccount.com
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups?alt=json&maxResults=500
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '6262'
            Content-Type: application/json; charset=UTF-8
            ETag: '"oqZ8IDqKW058LscJF2u_6JckZ7Y=/nJpP5JNkYXUUEERnMmcvG2yHm4U="'
            status: '200'
          body:
            kind: compute#instanceGroupList
            id: projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups
            items:
            - kind: compute#instanceGroup
              id: '5031816577615893094'
              creationTimestamp: '2019-07-01T08:53:45.231-07:00'
              name: compute-backend-ig-20190701-155342-uxhm
              description: ''
              network: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/compute-backend-ig-20190701-155342-uxhm
              size: 1
            - kind: compute#instanceGroup
              id: '82886278247846500'
              creationTimestamp: '2019-07-01T08:53:47.302-07:00'
              name: compute-backend-ig-20190701-155344-ryf3
              description: ''
              network: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/compute-backend-ig-20190701-155344-ryf3
              size: 1
            - kind: compute#instanceGroup
              id: '2529681519886701512'
              creationTimestamp: '2019-07-01T08:56:23.380-07:00'
              name: mig-instance-configs-zonal-20190701-155621-ss9n
              description: "This instance group is controlled by Instance Group Manager\
                \ 'mig-instance-configs-zonal-20190701-155621-ss9n'. To modify instances\
                \ in this group, use the Instance Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/mig-instance-configs-zonal-20190701-155621-ss9n
              size: 1
            - kind: compute#instanceGroup
              id: '675215276852614074'
              creationTimestamp: '2019-07-01T08:57:09.522-07:00'
              name: $$manager$$
              description: "This instance group is controlled by Instance Group Manager\
                \ '$$manager$$'. To modify instances in this group, use the Instance\
                \ Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
              size: 0
            - kind: compute#instanceGroup
              id: '9211885780391662501'
              creationTimestamp: '2019-07-01T08:56:58.299-07:00'
              name: mig-stateful-policy-zonal-20190701-155657-b909
              description: "This instance group is controlled by Instance Group Manager\
                \ 'mig-stateful-policy-zonal-20190701-155657-b909'. To modify instances\
                \ in this group, use the Instance Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/mig-stateful-policy-zonal-20190701-155657-b909
              size: 0
            - kind: compute#instanceGroup
              id: '1843014054251565764'
              creationTimestamp: '2019-07-01T08:52:11.612-07:00'
              name: mig-update-instances-zonal-20190701-155209-l1dc
              description: "This instance group is controlled by Instance Group Manager\
                \ 'mig-update-instances-zonal-20190701-155209-l1dc'. To modify instances\
                \ in this group, use the Instance Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/mig-update-instances-zonal-20190701-155209-l1dc
              size: 0
            - kind: compute#instanceGroup
              id: '3771817028604105638'
              creationTimestamp: '2019-07-01T08:56:57.481-07:00'
              name: mig-update-instances-zonal-20190701-155656-knmu
              description: "This instance group is controlled by Instance Group Manager\
                \ 'mig-update-instances-zonal-20190701-155656-knmu'. To modify instances\
                \ in this group, use the Instance Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/mig-update-instances-zonal-20190701-155656-knmu
              size: 0
            selfLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/autoscalers?alt=json&maxResults=500
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '246'
            Content-Type: application/json; charset=UTF-8
            ETag: '"fhXOayo8ki_d-QAPHuLLVKnMo1A=/Ec4bIXKMjvv3x8B-YR6cggM3bhk="'
            status: '200'
          body:
            kind: compute#autoscalerList
            id: projects/cloud-sdk-integration-testing/zones/us-central1-f/autoscalers
            selfLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/autoscalers
    - expect_stdout: |
        ---
        name:       $$manager$$
        targetSize: 10
    - expect_exit:
        code: 0


- execute_command:
    command: compute instance-groups managed rolling-action restart $$manager$$ --max-unavailable=3
      --format=disable --zone us-central1-f
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1865'
            Content-Type: application/json; charset=UTF-8
            ETag: '"jcBMeij6D1Y_4jZfg3lXaibdnW0=/fOsVjUo_VDApB1IAIIrT1CX4Li4="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '844090667922068410'
            creationTimestamp: '2019-07-01T08:57:09.519-07:00'
            name: $$manager$$
            zone: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
            versions:
            - instanceTemplate: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
              targetSize:
                calculated: 10
            instanceGroup: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
            baseInstanceName: $$manager$$
            fingerprint: VqEeDYH2qJo=
            currentActions:
              none: 0
              creating: 10
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 0
              deleting: 0
              abandoning: 0
              restarting: 0
              refreshing: 0
            pendingActions:
              creating: 0
              deleting: 0
              recreating: 0
              restarting: 0
            status:
              isStable: false
              versionTarget:
                isReached: true
            targetSize: 10
            selfLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: OPPORTUNISTIC
              minimalAction: REPLACE
              maxSurge:
                fixed: 1
                calculated: 1
              maxUnavailable:
                fixed: 1
                calculated: 1
              minReadySec: 0
            serviceAccount: 462803083913@cloudservices.gserviceaccount.com
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: PATCH
          headers: {}
          body:
            json:
              updatePolicy:
                type: PROACTIVE
                minimalAction: RESTART
                maxUnavailable:
                  fixed: 3
                  percent: null
              versions:
              - instanceTemplate: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
                targetSize:
                  calculated: 10
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '892'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '4867619793206219653'
            name: operation-1561996647470-58ca0af50158c-d54c15a0-42956354
            zone: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
            operationType: patch
            targetLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            targetId: '844090667922068410'
            status: RUNNING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2019-07-01T08:57:30.386-07:00'
            startTime: '2019-07-01T08:57:30.399-07:00'
            selfLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/operations/operation-1561996647470-58ca0af50158c-d54c15a0-42956354
        poll_operation: true
    - expect_stderr:
        matches: |
          Updated \[https://.*.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$\].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        expect_response:
          body:
            json:
              updatePolicy.maxUnavailable.calculated: 3
              updatePolicy.maxUnavailable.fixed: 3
              updatePolicy.minimalAction: RESTART
              updatePolicy.type: PROACTIVE
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1912'
            Content-Type: application/json; charset=UTF-8
            ETag: '"Y7aDWm8ee5VN-gplfNNtZi1RswQ=/kzTkIaXY2U2-7UW7aNvwkwaIw6c="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '844090667922068410'
            creationTimestamp: '2019-07-01T08:57:09.519-07:00'
            name: $$manager$$
            zone: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
            versions:
            - name: 0/2019-07-01 15:57:27.457267+00:00
              instanceTemplate: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
              targetSize:
                calculated: 10
            instanceGroup: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
            baseInstanceName: $$manager$$
            fingerprint: fskRpmCVxaM=
            currentActions:
              none: 0
              creating: 10
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 0
              deleting: 0
              abandoning: 0
              restarting: 0
              refreshing: 0
            pendingActions:
              creating: 0
              deleting: 0
              recreating: 0
              restarting: 10
            status:
              isStable: false
              versionTarget:
                isReached: false
            targetSize: 10
            selfLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: PROACTIVE
              minimalAction: RESTART
              maxSurge:
                fixed: 1
                calculated: 1
              maxUnavailable:
                fixed: 3
                calculated: 3
              minReadySec: 0
            serviceAccount: 462803083913@cloudservices.gserviceaccount.com
    - expect_exit:
        code: 0
- execute_command:
    command: compute instance-groups managed rolling-action restart $$manager$$ --max-unavailable=25%
      --format=disable --zone us-central1-f
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1912'
            Content-Type: application/json; charset=UTF-8
            ETag: '"jcBMeij6D1Y_4jZfg3lXaibdnW0=/uh8Yad8s4tkG_RxC9g6tc-LLHJA="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '844090667922068410'
            creationTimestamp: '2019-07-01T08:57:09.519-07:00'
            name: $$manager$$
            zone: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
            versions:
            - name: 0/2019-07-01 15:57:27.457267+00:00
              instanceTemplate: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
              targetSize:
                calculated: 10
            instanceGroup: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
            baseInstanceName: $$manager$$
            fingerprint: fskRpmCVxaM=
            currentActions:
              none: 0
              creating: 10
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 0
              deleting: 0
              abandoning: 0
              restarting: 0
              refreshing: 0
            pendingActions:
              creating: 0
              deleting: 0
              recreating: 0
              restarting: 10
            status:
              isStable: false
              versionTarget:
                isReached: false
            targetSize: 10
            selfLink: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: PROACTIVE
              minimalAction: RESTART
              maxSurge:
                fixed: 1
                calculated: 1
              maxUnavailable:
                fixed: 3
                calculated: 3
              minReadySec: 0
            serviceAccount: 462803083913@cloudservices.gserviceaccount.com
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: PATCH
          headers: {}
          body:
            json:
              versions:
              - targetSize:
                  calculated: 10
                instanceTemplate: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
              updatePolicy:
                maxUnavailable:
                  percent: 25
                  fixed: null
                minimalAction: RESTART
                type: PROACTIVE
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '892'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '2488314499425604502'
            name: operation-1561996663819-58ca0b0498e6e-9e02b177-319b17b9
            zone: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
            operationType: patch
            targetLink: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            targetId: '844090667922068410'
            status: RUNNING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2019-07-01T08:57:45.239-07:00'
            startTime: '2019-07-01T08:57:45.256-07:00'
            selfLink: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/operations/operation-1561996663819-58ca0b0498e6e-9e02b177-319b17b9
        poll_operation: true
    - expect_stderr:
        matches: |
          Updated \[https://.*.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$\].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        expect_response:
          body:
            json:
              updatePolicy.maxUnavailable.calculated: 2
              updatePolicy.maxUnavailable.percent: 25
              updatePolicy.minimalAction: RESTART
              updatePolicy.type: PROACTIVE
          extract_references:
          - field: versions[0].name
            reference: version
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1914'
            Content-Type: application/json; charset=UTF-8
            ETag: '"kYFXEaJp3sMGqlV2KJ186l1hdR0=/1eDjmk0J_094d3RTO9GfBbF9agw="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '844090667922068410'
            creationTimestamp: '2019-07-01T08:57:09.519-07:00'
            name: $$manager$$
            zone: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
            versions:
            - name: 0/2019-07-01 15:57:43.806129+00:00
              instanceTemplate: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
              targetSize:
                calculated: 10
            instanceGroup: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
            baseInstanceName: $$manager$$
            fingerprint: OumiKDQUwfQ=
            currentActions:
              none: 2
              creating: 8
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 0
              deleting: 0
              abandoning: 0
              restarting: 0
              refreshing: 0
            pendingActions:
              creating: 0
              deleting: 0
              recreating: 0
              restarting: 10
            status:
              isStable: false
              versionTarget:
                isReached: false
            targetSize: 10
            selfLink: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: PROACTIVE
              minimalAction: RESTART
              maxSurge:
                fixed: 1
                calculated: 1
              maxUnavailable:
                percent: 25
                calculated: 2
              minReadySec: 0
            serviceAccount: 462803083913@cloudservices.gserviceaccount.com
    - expect_exit:
        code: 0
- execute_command:
    command: compute instance-groups managed rolling-action restart $$manager$$ --max-unavailable=4
      --format=disable --zone us-central1-f
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1914'
            Content-Type: application/json; charset=UTF-8
            ETag: '"zuI1yRydbC6IUqtOp28LKyWQ5gs=/14987PBvWfjQxstHb8U5Bd8jTtI="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '844090667922068410'
            creationTimestamp: '2019-07-01T08:57:09.519-07:00'
            name: $$manager$$
            zone: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
            versions:
            - name: 0/2019-07-01 15:57:43.806129+00:00
              instanceTemplate: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
              targetSize:
                calculated: 10
            instanceGroup: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
            baseInstanceName: $$manager$$
            fingerprint: OumiKDQUwfQ=
            currentActions:
              none: 2
              creating: 8
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 0
              deleting: 0
              abandoning: 0
              restarting: 0
              refreshing: 0
            pendingActions:
              creating: 0
              deleting: 0
              recreating: 0
              restarting: 10
            status:
              isStable: false
              versionTarget:
                isReached: false
            targetSize: 10
            selfLink: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: PROACTIVE
              minimalAction: RESTART
              maxSurge:
                fixed: 1
                calculated: 1
              maxUnavailable:
                percent: 25
                calculated: 2
              minReadySec: 0
            serviceAccount: 462803083913@cloudservices.gserviceaccount.com
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: PATCH
          headers: {}
          body:
            json:
              versions:
              - targetSize:
                  calculated: 10
                instanceTemplate: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
              updatePolicy:
                maxUnavailable:
                  percent: null
                  fixed: 4
                minimalAction: RESTART
                type: PROACTIVE
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '891'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '732018160667431780'
            name: operation-1561996682559-58ca0b1678170-dc988218-4e86b3f2
            zone: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
            operationType: patch
            targetLink: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            targetId: '844090667922068410'
            status: RUNNING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2019-07-01T08:58:03.482-07:00'
            startTime: '2019-07-01T08:58:03.493-07:00'
            selfLink: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/operations/operation-1561996682559-58ca0b1678170-dc988218-4e86b3f2
        poll_operation: true
    - expect_stderr:
        matches: |
          Updated \[https://.*.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$\].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        expect_response:
          body:
            json:
              updatePolicy.maxUnavailable.calculated: 4
              updatePolicy.maxUnavailable.fixed: 4
              updatePolicy.minimalAction: RESTART
              updatePolicy.type: PROACTIVE
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1910'
            Content-Type: application/json; charset=UTF-8
            ETag: '"xjX_4wI_e3SoB4uvjW3hgtzCmT4=/wCuBXd2KBjSQyunUYSlnRfDUnVY="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '844090667922068410'
            creationTimestamp: '2019-07-01T08:57:09.519-07:00'
            name: $$manager$$
            zone: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
            versions:
            - name: 0/2019-07-01 15:58:02.546585+00:00
              instanceTemplate: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
              targetSize:
                calculated: 10
            instanceGroup: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
            baseInstanceName: $$manager$$
            fingerprint: EnvcNT06FfA=
            currentActions:
              none: 6
              creating: 1
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 0
              deleting: 0
              abandoning: 0
              restarting: 3
              refreshing: 0
            pendingActions:
              creating: 0
              deleting: 0
              recreating: 0
              restarting: 6
            status:
              isStable: false
              versionTarget:
                isReached: false
            targetSize: 10
            selfLink: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: PROACTIVE
              minimalAction: RESTART
              maxSurge:
                fixed: 1
                calculated: 1
              maxUnavailable:
                fixed: 4
                calculated: 4
              minReadySec: 0
            serviceAccount: 462803083913@cloudservices.gserviceaccount.com
    - expect_exit:
        code: 0
- execute_command:
    command: compute instance-groups managed delete $$manager$$ --zone us-central1-f
    cleanup_for: manager
    events:
    - expect_prompt_continue:
        message: |
          The following instance group managers will be deleted:
           - [$$manager$$] in [us-central1-f]
        user_input: y
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/autoscalers?alt=json&maxResults=500
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '246'
            Content-Type: application/json; charset=UTF-8
            ETag: '"S2SDrEHGJrWHC000ZLcZGlwSxrM=/GeqVDtj1WRRYweYSaAk2rvQHYJ0="'
            status: '200'
          body:
            kind: compute#autoscalerList
            id: projects/cloud-sdk-integration-testing/zones/us-central1-f/autoscalers
            selfLink: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/autoscalers
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '923'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '3700237730714194805'
            name: operation-1561996696964-58ca0b2434d9c-7d4f54b9-d98b20a0
            zone: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f
            operationType: compute.instanceGroupManagers.delete
            targetLink: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            targetId: '844090667922068410'
            status: RUNNING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2019-07-01T08:58:18.642-07:00'
            startTime: '2019-07-01T08:58:18.656-07:00'
            selfLink: https://www.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/operations/operation-1561996696964-58ca0b2434d9c-7d4f54b9-d98b20a0
        poll_operation: true
    - expect_stderr:
        matches: |
          Deleted \[https://.*.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$\].
    - expect_progress_tracker:
        message: Deleting Managed Instance Group
        status: SUCCESS
    - expect_exit:
        code: 0


- execute_command:
    command: compute instance-templates delete $$template1$$
    cleanup_for: template1
    events:
    - expect_prompt_continue:
        message: |
          The following instance templates will be deleted:
           - [$$template1$$]
        user_input: y
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '753'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '7889766006253916260'
            name: operation-1561996938439-58ca0c0a7ea29-9583ef4a-cd275559
            operationType: delete
            targetLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
            targetId: '1025831332878980000'
            status: RUNNING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2019-07-01T09:02:19.047-07:00'
            startTime: '2019-07-01T09:02:19.059-07:00'
            selfLink: https://$$compute-uri$$/beta/projects/cloud-sdk-integration-testing/global/operations/operation-1561996938439-58ca0c0a7ea29-9583ef4a-cd275559
        poll_operation: true
    - expect_stderr:
        matches: |
          Deleted \[https://.*.googleapis.com/compute/beta/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$\].
    - expect_exit:
        code: 0
