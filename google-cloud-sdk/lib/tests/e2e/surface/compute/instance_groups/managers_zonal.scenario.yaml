title: Basic tests of a zonal managed instance group.
release_tracks: [GA]
summary:
# This summary is generated automatically on update and should not be edited.
- execute:
  - command: compute instance-templates create $$template1$$ --machine-type n1-standard-1
      --format 'text(name,properties.machineType)'
  - stderr: |
      Created [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$].
  - stdout: |
      ---
      name:                   $$template1$$
      properties.machineType: n1-standard-1
- execute:
  - command: compute instance-templates create $$template2$$ --machine-type f1-micro
      --format 'text(name,properties.machineType)'
  - stderr: |
      Created [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$].
  - stdout: |
      ---
      name:                   $$template2$$
      properties.machineType: f1-micro
- execute:
  - command: compute instance-groups managed create $$manager$$ --zone us-central1-f
      --base-instance-name $$manager$$ --size 0 --template $$template1$$ --format
      'text(name,zone,targetSize)'
  - stderr: |
      Created [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$].
  - stdout: |
      ---
      name:       $$manager$$
      targetSize: 0
      zone:       https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
- execute:
  - command: compute instance-groups managed resize $$manager$$ --zone us-central1-f
      --size 3 --format 'text(name,zone,targetSize)'
  - stderr: |
      Updated [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$].
  - stdout: |
      ---
      name:       $$manager$$
      targetSize: 3
      zone:       https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
- execute:
  - command: compute instance-groups managed wait-until-stable $$manager$$ --timeout
      600 --zone us-central1-f --no-user-output-enabled
- execute:
  - command: compute instance-groups managed list-instances $$manager$$ --zone us-central1-f
      --format 'text(instanceStatus,version.name)'
  - stdout: |
      ---
      instanceStatus: RUNNING
      ---
      instanceStatus: RUNNING
      ---
      instanceStatus: RUNNING
- execute:
  - command: compute instances describe $$instance1$$ --format 'text(machineType)'
  - stdout: |
      machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/machineTypes/n1-standard-1
- execute:
  - command: compute instance-groups managed set-instance-template $$manager$$ --zone
      us-central1-f --template $$template2$$ --format none
  - stderr: |
      Updated [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$].
- execute:
  - command: compute instance-groups managed recreate-instances $$manager$$ --zone
      us-central1-f --instances $$instance1$$ --format text
  - stderr: |
      Updated [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$].
  - stdout: |
      ---
      selfLink: $$instance1$$
      status:   SUCCESS
- execute:
  - command: compute instance-groups managed wait-until-stable $$manager$$ --timeout
      600 --zone us-central1-f --no-user-output-enabled
- execute:
  - command: compute instances describe $$instance1$$ --format 'text(machineType)'
  - stdout: |
      machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/machineTypes/f1-micro
- execute:
  - command: compute instance-groups managed delete-instances $$manager$$ --zone us-central1-f
      --instances $$instance1$$ --format none
  - stderr: |
      Updated [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$].
- execute:
  - command: compute instance-groups managed wait-until-stable $$manager$$ --timeout
      600 --zone us-central1-f --no-user-output-enabled
- execute:
  - command: compute instance-groups managed list-instances $$manager$$ --zone us-central1-f
      --format 'text(instanceStatus,version.name)'
  - stdout: |
      ---
      instanceStatus: RUNNING
      ---
      instanceStatus: RUNNING
- execute:
  - command: compute instance-groups managed abandon-instances $$manager$$ --zone
      us-central1-f --instances $$instance2$$ --format none
  - stderr: |
      Updated [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$].
- execute:
  - command: compute instance-groups managed wait-until-stable $$manager$$ --timeout
      600 --zone us-central1-f --no-user-output-enabled
- execute:
  - command: compute instance-groups managed list-instances $$manager$$ --zone us-central1-f
      --format 'text(instanceStatus,version.name)'
  - stdout: |
      ---
      instanceStatus: RUNNING
- execute:
  - command: compute instance-groups managed set-named-ports $$manager$$ --zone us-central1-f
      --named-ports my-service:1234
  - stderr: |
      Updated [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$].
- execute:
  - command: compute instance-groups managed get-named-ports $$manager$$ --zone us-central1-f
      --format text
  - stdout: |
      ---
      name: my-service
      port: 1234
- execute:
  - command: compute target-pools create $$targetpool$$ --region us-central1 --format
      none
  - stderr: |
      Created [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1/targetPools/$$targetpool$$].
- execute:
  - command: compute instance-groups managed set-target-pools $$manager$$ --zone us-central1-f
      --target-pools $$targetpool$$ --format 'text(targetPools)'
  - stderr: |
      Updated [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$].
  - stdout: |
      ---
      targetPools[0]: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1/targetPools/$$targetpool$$
- execute:
  - command: compute target-pools delete $$targetpool$$ --region us-central1 --format
      none
  - prompt:
    - message: |
        The following target pools will be deleted:
         - [$$targetpool$$] in [us-central1]
    - input: y
  - stderr: |
      Deleted [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1/targetPools/$$targetpool$$].
- execute:
  - command: compute instance-groups managed delete $$manager$$ --zone us-central1-f
  - prompt:
    - message: |
        The following instance group managers will be deleted:
         - [$$manager$$] in [us-central1-f]
    - input: y
  - stderr: |
      Deleted [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$].
  - progress_tracker:
    - message: Deleting Managed Instance Group
    - status: SUCCESS
- execute:
  - command: compute instance-templates delete $$template2$$
  - prompt:
    - message: |
        The following instance templates will be deleted:
         - [$$template2$$]
    - input: y
  - stderr: |
      Deleted [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$].
- execute:
  - command: compute instance-templates delete $$template1$$
  - prompt:
    - message: |
        The following instance templates will be deleted:
         - [$$template1$$]
    - input: y
  - stderr: |
      Deleted [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$].
actions:
- define_reference:
    reference: compute-uri
    value: www.googleapis.com/compute
- generate_resource_id:
    reference: template1
    prefix: mig-zonal
- execute_command:
    command: compute instance-templates create $$template1$$ --machine-type n1-standard-1
      --format 'text(name,properties.machineType)'
    validation_only: true
    events:
    - expect_stderr: |
        Created [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$].
    - expect_stdout: |
        ---
        name:                   $$template1$$
        properties.machineType: n1-standard-1
    - expect_exit:
        code: 0

- generate_resource_id:
    reference: template2
    prefix: mig-zonal
- execute_command:
    command: compute instance-templates create $$template2$$ --machine-type f1-micro
      --format 'text(name,properties.machineType)'
    validation_only: true
    events:
    - expect_stderr: |
        Created [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$].
    - expect_stdout: |
        ---
        name:                   $$template2$$
        properties.machineType: f1-micro
    - expect_exit:
        code: 0


- generate_resource_id:
    reference: manager
    prefix: mig-zonal
- execute_command:
    # Create an empty MIG from template 1.
    command: compute instance-groups managed create $$manager$$ --zone us-central1-f
      --base-instance-name $$manager$$ --size 0 --template $$template1$$ --format
      'text(name,zone,targetSize)'
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '510'
            Content-Type: application/json; charset=UTF-8
            ETag: '"bQ6ag43DN57cDSuePuswFNRkD2g=/NMJP7XSgJseGb2eFGVZZvRzvXtE="'
            status: '200'
          body:
            kind: compute#zone
            id: '2004'
            creationTimestamp: '1969-12-31T16:00:00.000-08:00'
            name: us-central1-f
            description: us-central1-f
            status: UP
            region: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            availableCpuPlatforms:
            - Intel Skylake
            - Intel Broadwell
            - Intel Haswell
            - Intel Ivy Bridge
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers?alt=json
          method: POST
          headers: {}
          body:
            json:
              baseInstanceName: $$manager$$
              instanceTemplate: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
              name: $$manager$$
              targetSize: 0
              zone: us-central1-f
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '856'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '4927479053045849212'
            name: operation-1549034130320-580d69d152b01-89ad394e-2932653d
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            operationType: compute.instanceGroupManagers.insert
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            targetId: '5537668278014041212'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2019-02-01T07:15:31.293-08:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/operations/operation-1549034130320-580d69d152b01-89ad394e-2932653d
        poll_operation: true
    - expect_stderr: |
        Created [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1530'
            Content-Type: application/json; charset=UTF-8
            ETag: '"SJ5xjluhtKFBCHdtGKi5dxpuEyM=/NNVdtTYXtcEiBXG-2Sib8_zE28Q="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '5537668278014041212'
            creationTimestamp: '2019-02-01T07:15:31.257-08:00'
            name: $$manager$$
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
            versions:
            - instanceTemplate: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
              targetSize:
                calculated: 0
            instanceGroup: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
            baseInstanceName: $$manager$$
            fingerprint: _N9LOQhjCM0=
            currentActions:
              none: 0
              creating: 0
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 0
              deleting: 0
              abandoning: 0
              restarting: 0
              refreshing: 0
            status:
              isStable: true
            targetSize: 0
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: OPPORTUNISTIC
              minimalAction: REPLACE
              maxSurge:
                fixed: 1
                calculated: 1
              maxUnavailable:
                fixed: 1
                calculated: 1
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups?alt=json&maxResults=500
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '13309'
            Content-Type: application/json; charset=UTF-8
            ETag: '"sKvIo7jLtBh5XVvK4pW-ZTojh-0=/mQ79l5lC96ZWPfcDw2x-7c2tn2Y="'
            status: '200'
          body:
            kind: compute#instanceGroupList
            id: projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups
            items:
            - kind: compute#instanceGroup
              id: '4048505092452244705'
              creationTimestamp: '2019-02-01T07:13:18.345-08:00'
              name: compute-backend-ig-20190201-151316-oqi2
              description: ''
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/compute-backend-ig-20190201-151316-oqi2
              size: 1
            - kind: compute#instanceGroup
              id: '4346200150595198123'
              creationTimestamp: '2019-02-01T07:14:12.708-08:00'
              name: compute-backend-ig-20190201-151409-bxpo
              description: ''
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/compute-backend-ig-20190201-151409-bxpo
              size: 1
            - kind: compute#instanceGroup
              id: '5568124290541935763'
              creationTimestamp: '2019-02-01T07:15:08.571-08:00'
              name: gcloud-compute-ig-20190201-151506-zpdg
              description: ''
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/gcloud-compute-ig-20190201-151506-zpdg
              size: 1
            - kind: compute#instanceGroup
              id: '6424322859903606690'
              creationTimestamp: '2019-02-01T07:10:05.199-08:00'
              name: gke-test-pool-20190201-1-default-pool-1b17ea33-grp
              description: "This instance group is controlled by Instance Group Manager\
                \ 'gke-test-pool-20190201-1-default-pool-1b17ea33-grp'. To modify\
                \ instances in this group, use the Instance Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/gke-test-pool-20190201-1-default-pool-1b17ea33-grp
              size: 0
            - kind: compute#instanceGroup
              id: '1331762458951023328'
              creationTimestamp: '2019-02-01T05:05:19.649-08:00'
              name: gke-test-pool-20190201-1-default-pool-f1d1a24f-grp
              description: "This instance group is controlled by Instance Group Manager\
                \ 'gke-test-pool-20190201-1-default-pool-f1d1a24f-grp'. To modify\
                \ instances in this group, use the Instance Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/gke-test-pool-20190201-1-default-pool-f1d1a24f-grp
              size: 1
            - kind: compute#instanceGroup
              id: '4552263120860084776'
              creationTimestamp: '2019-02-01T05:08:23.646-08:00'
              name: gke-test-pool-region-201-default-pool-5a6429e8-grp
              description: "This instance group is controlled by Instance Group Manager\
                \ 'gke-test-pool-region-201-default-pool-5a6429e8-grp'. To modify\
                \ instances in this group, use the Instance Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/gke-test-pool-region-201-default-pool-5a6429e8-grp
              size: 1
            - kind: compute#instanceGroup
              id: '5526937916405308635'
              creationTimestamp: '2019-02-01T07:13:56.643-08:00'
              name: managed-instance-group-auto-healing-20190201-151355-tt27
              description: "This instance group is controlled by Instance Group Manager\
                \ 'managed-instance-group-auto-healing-20190201-151355-tt27'. To modify\
                \ instances in this group, use the Instance Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/managed-instance-group-auto-healing-20190201-151355-tt27
              size: 0
            - kind: compute#instanceGroup
              id: '2681726510363696321'
              creationTimestamp: '2019-02-01T07:13:50.742-08:00'
              name: mig-instance-configs-zonal-20190201-151347-vp6d
              description: "This instance group is controlled by Instance Group Manager\
                \ 'mig-instance-configs-zonal-20190201-151347-vp6d'. To modify instances\
                \ in this group, use the Instance Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/mig-instance-configs-zonal-20190201-151347-vp6d
              size: 0
            - kind: compute#instanceGroup
              id: '662468496805453016'
              creationTimestamp: '2019-02-01T07:13:59.539-08:00'
              name: mig-instance-configs-zonal-20190201-151357-xg1p
              description: "This instance group is controlled by Instance Group Manager\
                \ 'mig-instance-configs-zonal-20190201-151357-xg1p'. To modify instances\
                \ in this group, use the Instance Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/mig-instance-configs-zonal-20190201-151357-xg1p
              size: 0
            - kind: compute#instanceGroup
              id: '4718596496880688314'
              creationTimestamp: '2019-02-01T07:14:30.028-08:00'
              name: mig-instance-configs-zonal-20190201-151426-y3z1
              description: "This instance group is controlled by Instance Group Manager\
                \ 'mig-instance-configs-zonal-20190201-151426-y3z1'. To modify instances\
                \ in this group, use the Instance Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/mig-instance-configs-zonal-20190201-151426-y3z1
              size: 1
            - kind: compute#instanceGroup
              id: '3277284482561465490'
              creationTimestamp: '2019-02-01T07:15:09.463-08:00'
              name: mig-instance-configs-zonal-20190201-151508-5iow
              description: "This instance group is controlled by Instance Group Manager\
                \ 'mig-instance-configs-zonal-20190201-151508-5iow'. To modify instances\
                \ in this group, use the Instance Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/mig-instance-configs-zonal-20190201-151508-5iow
              size: 1
            - kind: compute#instanceGroup
              id: '5448852696544697594'
              creationTimestamp: '2019-02-01T07:13:25.466-08:00'
              name: mig-replacer-zonal-20190201-151324-kj5q
              description: "This instance group is controlled by Instance Group Manager\
                \ 'mig-replacer-zonal-20190201-151324-kj5q'. To modify instances in\
                \ this group, use the Instance Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/mig-replacer-zonal-20190201-151324-kj5q
              size: 3
            - kind: compute#instanceGroup
              id: '2670050018999262366'
              creationTimestamp: '2019-02-01T07:14:57.063-08:00'
              name: mig-stop-zonal-20190201-151455-johd
              description: "This instance group is controlled by Instance Group Manager\
                \ 'mig-stop-zonal-20190201-151455-johd'. To modify instances in this\
                \ group, use the Instance Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/mig-stop-zonal-20190201-151455-johd
              size: 5
            - kind: compute#instanceGroup
              id: '5088192069222653028'
              creationTimestamp: '2019-02-01T07:15:23.910-08:00'
              name: mig-updater-zonal-20190201-151521-4q3z
              description: "This instance group is controlled by Instance Group Manager\
                \ 'mig-updater-zonal-20190201-151521-4q3z'. To modify instances in\
                \ this group, use the Instance Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/mig-updater-zonal-20190201-151521-4q3z
              size: 0
            - kind: compute#instanceGroup
              id: '5537668278014041212'
              creationTimestamp: '2019-02-01T07:15:31.258-08:00'
              name: $$manager$$
              description: "This instance group is controlled by Instance Group Manager\
                \ '$$manager$$'. To modify instances in this group, use the Instance\
                \ Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
              selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
              size: 0
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/autoscalers?alt=json&maxResults=500
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '244'
            Content-Type: application/json; charset=UTF-8
            ETag: '"hBlmaX9NVKRHzuVouKpdipni42o=/9aIiB9WdKaWoPpp2eYCUvaHy_KE="'
            status: '200'
          body:
            kind: compute#autoscalerList
            id: projects/cloud-sdk-integration-testing/zones/us-central1-f/autoscalers
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/autoscalers
    - expect_stdout: |
        ---
        name:       $$manager$$
        targetSize: 0
        zone:       https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
    - expect_exit:
        code: 0


- execute_command:
    # Increase the size to 3.
    command: compute instance-groups managed resize $$manager$$ --zone us-central1-f
      --size 3 --format 'text(name,zone,targetSize)'
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$/resize?alt=json&size=3
          method: POST
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '947'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '1594716295435770993'
            name: operation-1549034140534-580d69db10658-9bada43f-da6c8734
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            operationType: compute.instanceGroupManagers.resize
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            targetId: '5537668278014041212'
            status: DONE
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 100
            insertTime: '2019-02-01T07:15:42.739-08:00'
            startTime: '2019-02-01T07:15:42.741-08:00'
            endTime: '2019-02-01T07:15:42.741-08:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/operations/operation-1549034140534-580d69db10658-9bada43f-da6c8734
        poll_operation: true
    - expect_stderr: |
        Updated [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1531'
            Content-Type: application/json; charset=UTF-8
            ETag: '"9YSQ-ymiSTunX5m2mYeh-9pvUTE=/tkAb-7fk1ffitQIgs9jUXmSYADI="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '5537668278014041212'
            creationTimestamp: '2019-02-01T07:15:31.257-08:00'
            name: $$manager$$
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
            versions:
            - instanceTemplate: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
              targetSize:
                calculated: 3
            instanceGroup: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
            baseInstanceName: $$manager$$
            fingerprint: _N9LOQhjCM0=
            currentActions:
              none: 0
              creating: 3
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 0
              deleting: 0
              abandoning: 0
              restarting: 0
              refreshing: 0
            status:
              isStable: false
            targetSize: 3
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: OPPORTUNISTIC
              minimalAction: REPLACE
              maxSurge:
                fixed: 1
                calculated: 1
              maxUnavailable:
                fixed: 1
                calculated: 1
    - expect_stdout: |
        ---
        name:       $$manager$$
        targetSize: 3
        zone:       https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
    - expect_exit:
        code: 0
- execute_command:
    command: compute instance-groups managed wait-until-stable $$manager$$ --timeout
      600 --zone us-central1-f --no-user-output-enabled
    validation_only: true
    events:
    - expect_exit:
        code: 0


- execute_command:
    # Check that there are 3 instances and extract 2 of the ids.
    command: compute instance-groups managed list-instances $$manager$$ --zone us-central1-f
      --format 'text(instanceStatus,version.name)'
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$/listManagedInstances?alt=json&maxResults=500
          method: POST
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '812'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            managedInstances:
            - instance: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instances/mig-zonal-20190201-151529-s4xm-2c9g
              id: '2216615065836706893'
              instanceStatus: RUNNING
              currentAction: NONE
            - instance: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instances/mig-zonal-20190201-151529-s4xm-hnzh
              id: '7335241623308721230'
              instanceStatus: RUNNING
              currentAction: NONE
            - instance: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instances/$$manager$$-qx94
              id: '8740507815358618701'
              instanceStatus: RUNNING
              currentAction: NONE
        expect_response:
          extract_references:
          - field: managedInstances[0].instance
            reference: instance1
          - field: managedInstances[1].instance
            reference: instance2
          body:
            json: {}
    - expect_stdout: |
        ---
        instanceStatus: RUNNING
        ---
        instanceStatus: RUNNING
        ---
        instanceStatus: RUNNING
    - expect_exit:
        code: 0


- execute_command:
    # Check that the instance is on the old machine type.
    command: compute instances describe $$instance1$$ --format 'text(machineType)'
    validation_only: true
    events:
    - expect_stdout: |
        machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/machineTypes/n1-standard-1
    - expect_exit:
        code: 0


- execute_command:
    # Change to template 2.
    command: compute instance-groups managed set-instance-template $$manager$$ --zone
      us-central1-f --template $$template2$$ --format none
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: PATCH
          headers: {}
          body:
            json:
              instanceTemplate: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
              versions:
              - instanceTemplate: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '825'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '5810642904560557102'
            name: operation-1549034176606-580d69fd7722b-2ace2b36-0dda0502
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            operationType: patch
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            targetId: '5537668278014041212'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2019-02-01T07:16:17.546-08:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/operations/operation-1549034176606-580d69fd7722b-2ace2b36-0dda0502
        poll_operation: true
    - expect_stderr: |
        Updated [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1530'
            Content-Type: application/json; charset=UTF-8
            ETag: '"_WOfALp7_0iyFB0bO-CtgMyajWU=/wlVJ22s53ufERnlE7C4QrLuhud4="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '5537668278014041212'
            creationTimestamp: '2019-02-01T07:15:31.257-08:00'
            name: $$manager$$
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
            versions:
            - instanceTemplate: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
              targetSize:
                calculated: 3
            instanceGroup: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
            baseInstanceName: $$manager$$
            fingerprint: 3yR47S12vfE=
            currentActions:
              none: 3
              creating: 0
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 0
              deleting: 0
              abandoning: 0
              restarting: 0
              refreshing: 0
            status:
              isStable: true
            targetSize: 3
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: OPPORTUNISTIC
              minimalAction: REPLACE
              maxSurge:
                fixed: 1
                calculated: 1
              maxUnavailable:
                fixed: 1
                calculated: 1
    - expect_exit:
        code: 0
- execute_command:
    # Recreate the instance so it will come up at the new machine type.
    command: compute instance-groups managed recreate-instances $$manager$$ --zone
      us-central1-f --instances $$instance1$$ --format text
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$/recreateInstances?alt=json
          method: POST
          headers: {}
          body:
            json:
              instances:
              - $$instance1$$
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '958'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '3291012357680651301'
            name: operation-1549034185593-580d6a06093a8-b4e212cb-ef5492da
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            operationType: compute.instanceGroupManagers.recreateInstances
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            targetId: '5537668278014041212'
            status: DONE
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 100
            insertTime: '2019-02-01T07:16:26.164-08:00'
            startTime: '2019-02-01T07:16:26.167-08:00'
            endTime: '2019-02-01T07:16:26.167-08:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/operations/operation-1549034185593-580d6a06093a8-b4e212cb-ef5492da
        poll_operation: true
    - expect_stderr: |
        Updated [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1531'
            Content-Type: application/json; charset=UTF-8
            ETag: '"eGEP2TTh4mbqSEe6_TTNZEfdPc0=/wwdoOpDhrwuZ8T5DsiJxBNARV1Y="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '5537668278014041212'
            creationTimestamp: '2019-02-01T07:15:31.257-08:00'
            name: $$manager$$
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
            versions:
            - instanceTemplate: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
              targetSize:
                calculated: 3
            instanceGroup: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
            baseInstanceName: $$manager$$
            fingerprint: 3yR47S12vfE=
            currentActions:
              none: 2
              creating: 0
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 1
              deleting: 0
              abandoning: 0
              restarting: 0
              refreshing: 0
            status:
              isStable: false
            targetSize: 3
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: OPPORTUNISTIC
              minimalAction: REPLACE
              maxSurge:
                fixed: 1
                calculated: 1
              maxUnavailable:
                fixed: 1
                calculated: 1
    - expect_stdout: |
        ---
        selfLink: $$instance1$$
        status:   SUCCESS
    - expect_exit:
        code: 0
- execute_command:
    command: compute instance-groups managed wait-until-stable $$manager$$ --timeout
      600 --zone us-central1-f --no-user-output-enabled
    validation_only: true
    events:
    - expect_exit:
        code: 0
- execute_command:
    # Check that the instance is on the new machine type.
    command: compute instances describe $$instance1$$ --format 'text(machineType)'
    validation_only: true
    events:
    - expect_stdout: |
        machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/machineTypes/f1-micro
    - expect_exit:
        code: 0


- execute_command:
    # Delete the instance.
    command: compute instance-groups managed delete-instances $$manager$$ --zone us-central1-f
      --instances $$instance1$$ --format none
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$/deleteInstances?alt=json
          method: POST
          headers: {}
          body:
            json:
              instances:
              - $$instance1$$
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '956'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '8082604587518385625'
            name: operation-1549034292896-580d6a6c5e2b6-98bba3f4-09571163
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            operationType: compute.instanceGroupManagers.deleteInstances
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            targetId: '5537668278014041212'
            status: DONE
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 100
            insertTime: '2019-02-01T07:18:14.720-08:00'
            startTime: '2019-02-01T07:18:14.723-08:00'
            endTime: '2019-02-01T07:18:14.723-08:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/operations/operation-1549034292896-580d6a6c5e2b6-98bba3f4-09571163
        poll_operation: true
    - expect_stderr: |
        Updated [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1531'
            Content-Type: application/json; charset=UTF-8
            ETag: '"6gD8LLH8wr347QISQtFIJUc-2uM=/gsc_LILqUjOI2jZdDo8XKBeBiIE="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '5537668278014041212'
            creationTimestamp: '2019-02-01T07:15:31.257-08:00'
            name: $$manager$$
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
            versions:
            - instanceTemplate: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
              targetSize:
                calculated: 2
            instanceGroup: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
            baseInstanceName: $$manager$$
            fingerprint: 3yR47S12vfE=
            currentActions:
              none: 2
              creating: 0
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 0
              deleting: 1
              abandoning: 0
              restarting: 0
              refreshing: 0
            status:
              isStable: false
            targetSize: 2
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: OPPORTUNISTIC
              minimalAction: REPLACE
              maxSurge:
                fixed: 1
                calculated: 1
              maxUnavailable:
                fixed: 1
                calculated: 1
    - expect_exit:
        code: 0
- execute_command:
    command: compute instance-groups managed wait-until-stable $$manager$$ --timeout
      600 --zone us-central1-f --no-user-output-enabled
    validation_only: true
    events:
    - expect_exit:
        code: 0
- execute_command:
    # Check that there are only 2 instances now.
    command: compute instance-groups managed list-instances $$manager$$ --zone us-central1-f
      --format 'text(instanceStatus,version.name)'
    validation_only: true
    events:
    - expect_stdout: |
        ---
        instanceStatus: RUNNING
        ---
        instanceStatus: RUNNING
    - expect_exit:
        code: 0


- execute_command:
    # Abandon an instance.
    command: compute instance-groups managed abandon-instances $$manager$$ --zone
      us-central1-f --instances $$instance2$$ --format none
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$/abandonInstances?alt=json
          method: POST
          headers: {}
          body:
            json:
              instances:
              - $$instance2$$
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '957'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '6039529146352786797'
            name: operation-1549034370131-580d6ab606634-a7086733-5a9ec4a2
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            operationType: compute.instanceGroupManagers.abandonInstances
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            targetId: '5537668278014041212'
            status: DONE
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 100
            insertTime: '2019-02-01T07:19:30.715-08:00'
            startTime: '2019-02-01T07:19:30.719-08:00'
            endTime: '2019-02-01T07:19:30.719-08:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/operations/operation-1549034370131-580d6ab606634-a7086733-5a9ec4a2
        poll_operation: true
    - expect_stderr: |
        Updated [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1531'
            Content-Type: application/json; charset=UTF-8
            ETag: '"q8zpKnG9FCFWS0sW3ov76TTM5rM=/9VHjCftSdSUOt57957iWYcOLew0="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '5537668278014041212'
            creationTimestamp: '2019-02-01T07:15:31.257-08:00'
            name: $$manager$$
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
            versions:
            - instanceTemplate: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
              targetSize:
                calculated: 1
            instanceGroup: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
            baseInstanceName: $$manager$$
            fingerprint: 3yR47S12vfE=
            currentActions:
              none: 1
              creating: 0
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 0
              deleting: 0
              abandoning: 1
              restarting: 0
              refreshing: 0
            status:
              isStable: false
            targetSize: 1
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: OPPORTUNISTIC
              minimalAction: REPLACE
              maxSurge:
                fixed: 1
                calculated: 1
              maxUnavailable:
                fixed: 1
                calculated: 1
    - expect_exit:
        code: 0
- execute_command:
    command: compute instance-groups managed wait-until-stable $$manager$$ --timeout
      600 --zone us-central1-f --no-user-output-enabled
    validation_only: true
    events:
    - expect_exit:
        code: 0
- execute_command:
    # Check that there is only 1 instance now.
    command: compute instance-groups managed list-instances $$manager$$ --zone us-central1-f
      --format 'text(instanceStatus,version.name)'
    validation_only: true
    events:
    - expect_stdout: |
        ---
        instanceStatus: RUNNING
    - expect_exit:
        code: 0


- execute_command:
    # Set some ports
    command: compute instance-groups managed set-named-ports $$manager$$ --zone us-central1-f
      --named-ports my-service:1234
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '854'
            Content-Type: application/json; charset=UTF-8
            ETag: '"fw-OwzQ5tKGyzlGerC4Cv58En7A=/qiIvkvltRKqIEu8r_fIqW6BkZro="'
            status: '200'
          body:
            kind: compute#instanceGroup
            id: '5537668278014041212'
            creationTimestamp: '2019-02-01T07:15:31.258-08:00'
            name: $$manager$$
            description: "This instance group is controlled by Instance Group Manager\
              \ '$$manager$$'. To modify instances in this group, use the Instance\
              \ Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
            network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
            fingerprint: 42WmSpB8rSM=
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
            size: 1
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$/setNamedPorts?alt=json
          method: POST
          headers: {}
          body:
            json:
              fingerprint: 42WmSpB8rSM=
              namedPorts:
              - name: my-service
                port: 1234
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '940'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '3575203527543872894'
            name: operation-1549034384299-580d6ac3895b9-0436f0dd-0016577a
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            operationType: compute.instanceGroups.setNamedPorts
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
            targetId: '5537668278014041212'
            status: DONE
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 100
            insertTime: '2019-02-01T07:19:45.578-08:00'
            startTime: '2019-02-01T07:19:45.581-08:00'
            endTime: '2019-02-01T07:19:45.581-08:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/operations/operation-1549034384299-580d6ac3895b9-0436f0dd-0016577a
        poll_operation: true
    - expect_stderr: |
        Updated [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '924'
            Content-Type: application/json; charset=UTF-8
            ETag: '"O6JAl12rRKpGAQmwkdavcxx2wyY=/CzKrYog5-4N8sKLyFvj6xIue_2Y="'
            status: '200'
          body:
            kind: compute#instanceGroup
            id: '5537668278014041212'
            creationTimestamp: '2019-02-01T07:15:31.258-08:00'
            name: $$manager$$
            description: "This instance group is controlled by Instance Group Manager\
              \ '$$manager$$'. To modify instances in this group, use the Instance\
              \ Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
            namedPorts:
            - name: my-service
              port: 1234
            network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
            fingerprint: ggTjPYfVy0U=
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
            size: 1
    - expect_exit:
        code: 0
- execute_command:
    # Check the ports.
    command: compute instance-groups managed get-named-ports $$manager$$ --zone us-central1-f
      --format text
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '924'
            Content-Type: application/json; charset=UTF-8
            ETag: '"6F9ALakRchGzr5CT23YS5U_mR9A=/RsG0DNo5Qqk5IfAQ5cOtwd_VfAo="'
            status: '200'
          body:
            kind: compute#instanceGroup
            id: '5537668278014041212'
            creationTimestamp: '2019-02-01T07:15:31.258-08:00'
            name: $$manager$$
            description: "This instance group is controlled by Instance Group Manager\
              \ '$$manager$$'. To modify instances in this group, use the Instance\
              \ Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
            namedPorts:
            - name: my-service
              port: 1234
            network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
            fingerprint: ggTjPYfVy0U=
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
            size: 1
    - expect_stdout: |
        ---
        name: my-service
        port: 1234
    - expect_exit:
        code: 0


- generate_resource_id:
    reference: targetpool
    prefix: mig-zonal
- execute_command:
    command: compute target-pools create $$targetpool$$ --region us-central1 --format
      none
    validation_only: true
    events:
    - expect_stderr: |
        Created [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1/targetPools/$$targetpool$$].
    - expect_exit:
        code: 0
- execute_command:
    # Set the target pool
    command: compute instance-groups managed set-target-pools $$manager$$ --zone us-central1-f
      --target-pools $$targetpool$$ --format 'text(targetPools)'
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: PATCH
          headers: {}
          body:
            json:
              targetPools:
              - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1/targetPools/$$targetpool$$
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '825'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '7883334125211999606'
            name: operation-1549034392752-580d6acb9932e-d628da53-5c5523c9
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            operationType: patch
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            targetId: '5537668278014041212'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2019-02-01T07:19:53.638-08:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/operations/operation-1549034392752-580d6acb9932e-d628da53-5c5523c9
        poll_operation: true
    - expect_stderr: |
        Updated [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1767'
            Content-Type: application/json; charset=UTF-8
            ETag: '"pnQ6RbiFm3wN6zYyieCPJsNnK-c=/xqzPDsbLukxpF6w5HJIL2pzcUKs="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '5537668278014041212'
            creationTimestamp: '2019-02-01T07:15:31.257-08:00'
            name: $$manager$$
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
            versions:
            - instanceTemplate: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
              targetSize:
                calculated: 1
            instanceGroup: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroups/$$manager$$
            targetPools:
            - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1/targetPools/$$targetpool$$
            baseInstanceName: $$manager$$
            fingerprint: VUPq1S7nvd8=
            currentActions:
              none: 0
              creating: 0
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 0
              deleting: 0
              abandoning: 0
              restarting: 0
              refreshing: 1
            status:
              isStable: false
            targetSize: 1
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: OPPORTUNISTIC
              minimalAction: REPLACE
              maxSurge:
                fixed: 1
                calculated: 1
              maxUnavailable:
                fixed: 1
                calculated: 1
            namedPorts:
            - name: my-service
              port: 1234
    - expect_stdout: |
        ---
        targetPools[0]: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1/targetPools/$$targetpool$$
    - expect_exit:
        code: 0


- execute_command:
    command: compute target-pools delete $$targetpool$$ --region us-central1 --format
      none
    validation_only: true
    cleanup_for: targetpool
    events:
    - expect_prompt_continue:
        message: |
          The following target pools will be deleted:
           - [$$targetpool$$] in [us-central1]
        user_input: y
    - expect_stderr: |
        Deleted [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1/targetPools/$$targetpool$$].
    - expect_exit:
        code: 0

- execute_command:
    command: compute instance-groups managed delete $$manager$$ --zone us-central1-f
    cleanup_for: manager
    events:
    - expect_prompt_continue:
        message: |
          The following instance group managers will be deleted:
           - [$$manager$$] in [us-central1-f]
        user_input: y
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/autoscalers?alt=json&maxResults=500
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '244'
            Content-Type: application/json; charset=UTF-8
            ETag: '"3SmSFVKV5cXbsZfaPUGWkMP1SPU=/6GEAPmx4KFAPZeEPc_hVk3Xkc-M="'
            status: '200'
          body:
            kind: compute#autoscalerList
            id: projects/cloud-sdk-integration-testing/zones/us-central1-f/autoscalers
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/autoscalers
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '856'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '6613663757253598535'
            name: operation-1549034407492-580d6ad9a7c77-7b196c0f-79f485dc
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            operationType: compute.instanceGroupManagers.delete
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$
            targetId: '5537668278014041212'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2019-02-01T07:20:08.108-08:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/operations/operation-1549034407492-580d6ad9a7c77-7b196c0f-79f485dc
        poll_operation: true
    - expect_stderr: |
        Deleted [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instanceGroupManagers/$$manager$$].
    - expect_progress_tracker:
        message: Deleting Managed Instance Group
        status: SUCCESS
    - expect_exit:
        code: 0


- execute_command:
    command: compute instance-templates delete $$template2$$
    cleanup_for: template2
    validation_only: true
    events:
    - expect_prompt_continue:
        message: |
          The following instance templates will be deleted:
           - [$$template2$$]
        user_input: y
    - expect_stderr: |
        Deleted [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$].
    - expect_exit:
        code: 0

- execute_command:
    command: compute instance-templates delete $$template1$$
    cleanup_for: template1
    validation_only: true
    events:
    - expect_prompt_continue:
        message: |
          The following instance templates will be deleted:
           - [$$template1$$]
        user_input: y
    - expect_stderr: |
        Deleted [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$].
    - expect_exit:
        code: 0
