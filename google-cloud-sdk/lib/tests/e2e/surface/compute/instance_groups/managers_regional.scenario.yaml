title: Basic tests of a regional managed instance group.
release_tracks: [GA]
summary:
# This summary is generated automatically on update and should not be edited.
- execute:
  - command: compute instance-templates create $$template1$$ --machine-type n1-standard-1
      --format 'text(name,properties.machineType)'
  - stderr: |
      Created [https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$\].
  - stdout: |
      ---
      name:                   $$template1$$
      properties.machineType: n1-standard-1
- execute:
  - command: compute instance-templates create $$template2$$ --machine-type f1-micro
      --format 'text(name,properties.machineType)'
  - stderr: |
      Created [https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$\].
  - stdout: |
      ---
      name:                   $$template2$$
      properties.machineType: f1-micro
- execute:
  - command: compute instance-groups managed create $$manager$$ --region us-central1
      --base-instance-name $$manager$$ --size 0 --template $$template1$$ --format
      'text(name,region,targetSize)'
  - stderr: |
      Created [https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$\].
  - stdout: |
      ---
      name:       $$manager$$
      region:     https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
      targetSize: 0
- execute:
  - command: compute instance-groups managed resize $$manager$$ --region us-central1
      --size 3 --format 'text(name,region,targetSize)'
  - stderr: |
      Updated [https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$\].
  - stdout: |
      ---
      name:       $$manager$$
      region:     https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
      targetSize: 3
- execute:
  - command: compute instance-groups managed wait-until-stable $$manager$$ --timeout
      600 --region us-central1 --no-user-output-enabled
- execute:
  - command: compute instance-groups managed list-instances $$manager$$ --region us-central1
      --format 'text(instanceStatus,version.name)'
  - stdout: |
      ---
      instanceStatus: RUNNING
      ---
      instanceStatus: RUNNING
      ---
      instanceStatus: RUNNING
- execute:
  - command: compute instances describe $$instance1$$ --format 'text(machineType)'
  - stdout: |
      machineType: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-b/machineTypes/n1-standard-1
- execute:
  - command: compute instance-groups managed set-instance-template $$manager$$ --region
      us-central1 --template $$template2$$ --format none
  - stderr: |
      Updated [https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$\].
- execute:
  - command: compute instance-groups managed recreate-instances $$manager$$ --region
      us-central1 --instances $$instance1$$ --format text
  - stderr: |
      Updated [https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$\].
  - stdout: |
      ---
      selfLink: $$instance1$$
      status:   SUCCESS
- execute:
  - command: compute instance-groups managed wait-until-stable $$manager$$ --timeout
      600 --region us-central1 --no-user-output-enabled
- execute:
  - command: compute instances describe $$instance1$$ --format 'text(machineType)'
  - stdout: |
      machineType: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-b/machineTypes/f1-micro
- execute:
  - command: compute instance-groups managed delete-instances $$manager$$ --region
      us-central1 --instances $$instance1$$ --format none
  - stderr: |
      Updated [https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$\].
- execute:
  - command: compute instance-groups managed wait-until-stable $$manager$$ --timeout
      600 --region us-central1 --no-user-output-enabled
- execute:
  - command: compute instance-groups managed list-instances $$manager$$ --region us-central1
      --format 'text(instanceStatus,version.name)'
  - stdout: |
      ---
      instanceStatus: RUNNING
      ---
      instanceStatus: RUNNING
- execute:
  - command: compute instance-groups managed abandon-instances $$manager$$ --region
      us-central1 --instances $$instance2$$ --format none
  - stderr: |
      Updated [https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$\].
- execute:
  - command: compute instance-groups managed wait-until-stable $$manager$$ --timeout
      600 --region us-central1 --no-user-output-enabled
- execute:
  - command: compute instance-groups managed list-instances $$manager$$ --region us-central1
      --format 'text(instanceStatus,version.name)'
  - stdout: |
      ---
      instanceStatus: RUNNING
- execute:
  - command: compute instance-groups managed set-named-ports $$manager$$ --region
      us-central1 --named-ports my-service:1234
  - stderr: |
      Updated [https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/$$manager$$\].
- execute:
  - command: compute instance-groups managed get-named-ports $$manager$$ --region
      us-central1 --format text
  - stdout: |
      ---
      name: my-service
      port: 1234
- execute:
  - command: compute instance-groups managed delete $$manager$$ --region us-central1
  - prompt:
    - message: |
        The following region instance group managers will be deleted:
         - [$$manager$$] in [us-central1]
    - input: y
  - stderr: |
      Deleted [https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$\].
  - progress_tracker:
    - message: Deleting Managed Instance Group
    - status: SUCCESS
- execute:
  - command: compute instance-templates delete $$template2$$
  - prompt:
    - message: |
        The following instance templates will be deleted:
         - [$$template2$$]
    - input: y
  - stderr: |
      Deleted [https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$\].
- execute:
  - command: compute instance-templates delete $$template1$$
  - prompt:
    - message: |
        The following instance templates will be deleted:
         - [$$template1$$]
    - input: y
  - stderr: |
      Deleted [https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$\].
actions:
- define_reference:
    reference: compute-uri
    value: compute.googleapis.com/compute
- generate_resource_id:
    reference: template1
    prefix: mig-regional
- execute_command:
    command: compute instance-templates create $$template1$$ --machine-type n1-standard-1
      --format 'text(name,properties.machineType)'
    validation_only: true
    events:
    - expect_stderr:
        matches: |
            Created \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$\].
    - expect_stdout: |
        ---
        name:                   $$template1$$
        properties.machineType: n1-standard-1
    - expect_exit:
        code: 0

- generate_resource_id:
    reference: template2
    prefix: mig-regional
- execute_command:
    command: compute instance-templates create $$template2$$ --machine-type f1-micro
      --format 'text(name,properties.machineType)'
    validation_only: true
    events:
    - expect_stderr:
        matches: |
            Created \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$\].
    - expect_stdout: |
        ---
        name:                   $$template2$$
        properties.machineType: f1-micro
    - expect_exit:
        code: 0


- generate_resource_id:
    reference: manager
    prefix: mig-regional
- execute_command:
    # Create an empty MIG from template 1.
    command: compute instance-groups managed create $$manager$$ --region us-central1
      --base-instance-name $$manager$$ --size 0 --template $$template1$$ --format
      'text(name,region,targetSize)'
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers?alt=json
          method: POST
          headers: {}
          body:
            json:
              baseInstanceName: $$manager$$
              instanceTemplate: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
              name: $$manager$$
              region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
              targetSize: 0
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '861'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '6773449296717667948'
            name: operation-1549033601689-580d67d92e792-03874d95-ffdb8106
            operationType: compute.instanceGroupManagers.insert
            targetLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$
            targetId: '7513382117829107308'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2019-02-01T07:06:43.808-08:00'
            selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/operations/operation-1549033601689-580d67d92e792-03874d95-ffdb8106
            region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
        poll_operation: true
    - expect_stderr:
        matches: |
            Created \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$\].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1961'
            Content-Type: application/json; charset=UTF-8
            ETag: '"yuRKoHGrpXd-10pgATrfL4E5Idw=/adFzQBg9_hEUnA01ljyQOrOCekM="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '7513382117829107308'
            creationTimestamp: '2019-02-01T07:06:43.712-08:00'
            name: $$manager$$
            region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
            distributionPolicy:
              zones:
              - zone: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-b
              - zone: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-c
              - zone: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
            versions:
            - instanceTemplate: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
              targetSize:
                calculated: 0
            instanceGroup: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/$$manager$$
            baseInstanceName: $$manager$$
            fingerprint: _Rsa3KjDJyA=
            currentActions:
              none: 0
              creating: 0
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 0
              deleting: 0
              abandoning: 0
              restarting: 0
              refreshing: 0
            status:
              isStable: true
            targetSize: 0
            selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: OPPORTUNISTIC
              minimalAction: REPLACE
              maxSurge:
                fixed: 3
                calculated: 3
              maxUnavailable:
                fixed: 3
                calculated: 3
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups?alt=json&maxResults=500
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '4013'
            Content-Type: application/json; charset=UTF-8
            ETag: '"P_2vFOMOFEONFwfCK65-JMnTKsc=/-u4vysPanZpxwnXCORX5me3wKxo="'
            status: '200'
          body:
            kind: compute#regionInstanceGroupList
            id: projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups
            items:
            - kind: compute#instanceGroup
              id: '8927813993426968195'
              creationTimestamp: '2019-02-01T07:06:20.836-08:00'
              name: managed-instance-group-auto-healing-20190201-150617-c6uv
              description: "This instance group is controlled by Regional Instance\
                \ Group Manager 'managed-instance-group-auto-healing-20190201-150617-c6uv'.\
                \ To modify instances in this group, use the Regional Instance Group\
                \ Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/managed-instance-group-auto-healing-20190201-150617-c6uv
              size: 0
              region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
            - kind: compute#instanceGroup
              id: '7513382117829107308'
              creationTimestamp: '2019-02-01T07:06:43.715-08:00'
              name: $$manager$$
              description: "This instance group is controlled by Regional Instance\
                \ Group Manager '$$manager$$'. To modify instances in this group,\
                \ use the Regional Instance Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/$$manager$$
              size: 0
              region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
            - kind: compute#instanceGroup
              id: '362694910714437220'
              creationTimestamp: '2019-02-01T07:06:51.267-08:00'
              name: mig-stop-regional-20190201-150648-8q37
              description: "This instance group is controlled by Regional Instance\
                \ Group Manager 'mig-stop-regional-20190201-150648-8q37'. To modify\
                \ instances in this group, use the Regional Instance Group Manager\
                \ API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/mig-stop-regional-20190201-150648-8q37
              size: 0
              region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
            - kind: compute#instanceGroup
              id: '4089449204663574584'
              creationTimestamp: '2019-02-01T06:59:35.270-08:00'
              name: mig-updater-regional-20190201-145932-hmry
              description: "This instance group is controlled by Regional Instance\
                \ Group Manager 'mig-updater-regional-20190201-145932-hmry'. To modify\
                \ instances in this group, use the Regional Instance Group Manager\
                \ API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
              network: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/networks/default
              fingerprint: 42WmSpB8rSM=
              selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/mig-updater-regional-20190201-145932-hmry
              size: 0
              region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
            selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/autoscalers?alt=json&maxResults=500
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '250'
            Content-Type: application/json; charset=UTF-8
            ETag: '"SC_TnR0FrM4wiJAfk3U-s0pAjhE=/ZR7KM0ftkf9Tqo_x77lnPh0DMzU="'
            status: '200'
          body:
            kind: compute#regionAutoscalerList
            id: projects/cloud-sdk-integration-testing/regions/us-central1/autoscalers
            selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/autoscalers
    - expect_stdout:
        matches: |
          ---
          name:       $$manager$$
          region:     https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1
          targetSize: 0
    - expect_exit:
        code: 0


- execute_command:
    # Increase the size to 3.
    command: compute instance-groups managed resize $$manager$$ --region us-central1
      --size 3 --format 'text(name,region,targetSize)'
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$/resize?alt=json&size=3
          method: POST
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '861'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '7924116089523003000'
            name: operation-1549033622438-580d67ecf8226-9fef45da-a25aa14c
            operationType: compute.instanceGroupManagers.resize
            targetLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$
            targetId: '7513382117829107308'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2019-02-01T07:07:03.699-08:00'
            selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/operations/operation-1549033622438-580d67ecf8226-9fef45da-a25aa14c
            region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
        poll_operation: true
    - expect_stderr:
        matches: |
          Updated \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$\].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1962'
            Content-Type: application/json; charset=UTF-8
            ETag: '"lMWY4k12Ovj6-aX74C3ib1Y9eKg=/BsR8jokDsyjInQ016nT2eXTv3jg="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '7513382117829107308'
            creationTimestamp: '2019-02-01T07:06:43.712-08:00'
            name: $$manager$$
            region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
            distributionPolicy:
              zones:
              - zone: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-b
              - zone: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-c
              - zone: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
            versions:
            - instanceTemplate: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$
              targetSize:
                calculated: 3
            instanceGroup: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/$$manager$$
            baseInstanceName: $$manager$$
            fingerprint: _Rsa3KjDJyA=
            currentActions:
              none: 0
              creating: 3
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 0
              deleting: 0
              abandoning: 0
              restarting: 0
              refreshing: 0
            status:
              isStable: false
            targetSize: 3
            selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: OPPORTUNISTIC
              minimalAction: REPLACE
              maxSurge:
                fixed: 3
                calculated: 3
              maxUnavailable:
                fixed: 3
                calculated: 3
    - expect_stdout:
        matches: |
          ---
          name:       $$manager$$
          region:     https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1
          targetSize: 3
    - expect_exit:
        code: 0
- execute_command:
    command: compute instance-groups managed wait-until-stable $$manager$$ --timeout
      600 --region us-central1 --no-user-output-enabled
    validation_only: true
    events:
    - expect_exit:
        code: 0


- execute_command:
    # Check that there are 3 instances and extract 2 of the ids.
    command: compute instance-groups managed list-instances $$manager$$ --region us-central1
      --format 'text(instanceStatus,version.name)'
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$/listManagedInstances?alt=json&maxResults=500
          method: POST
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '821'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            managedInstances:
            - instance: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-b/instances/mig-regional-20190201-150641-uo5j-mmdm
              id: '6573914324555390577'
              instanceStatus: RUNNING
              currentAction: NONE
            - instance: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-c/instances/mig-regional-20190201-150641-uo5j-k72q
              id: '3826715700001103475'
              instanceStatus: RUNNING
              currentAction: NONE
            - instance: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instances/$$manager$$-9fd6
              id: '7521307771304271439'
              instanceStatus: RUNNING
              currentAction: NONE
        expect_response:
          extract_references:
          - field: managedInstances[0].instance
            reference: instance1
          - field: managedInstances[1].instance
            reference: instance2
          body:
            json: {}
    - expect_stdout: |
        ---
        instanceStatus: RUNNING
        ---
        instanceStatus: RUNNING
        ---
        instanceStatus: RUNNING
    - expect_exit:
        code: 0


- execute_command:
    # Check that the instance is on the old machine type.
    command: compute instances describe $$instance1$$ --format 'text(machineType)'
    validation_only: true
    events:
    - expect_stdout:
        matches: |
          machineType: https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-b/machineTypes/n1-standard-1
    - expect_exit:
        code: 0


- execute_command:
    # Change to template 2.
    command: compute instance-groups managed set-instance-template $$manager$$ --region
      us-central1 --template $$template2$$ --format none
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$?alt=json
          method: PATCH
          headers: {}
          body:
            json:
              instanceTemplate: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '830'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '6148225998291328573'
            name: operation-1549033680212-580d6824112c8-a219ac09-ab81d627
            operationType: patch
            targetLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$
            targetId: '7513382117829107308'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2019-02-01T07:08:02.034-08:00'
            selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/operations/operation-1549033680212-580d6824112c8-a219ac09-ab81d627
            region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
        poll_operation: true
    - expect_stderr:
        matches: |
          Updated \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$\].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1961'
            Content-Type: application/json; charset=UTF-8
            ETag: '"XajErv4cgqYHLbsJuispy5iK8j4=/YX4RwKWSd5nkIOulHj8qXhxb-04="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '7513382117829107308'
            creationTimestamp: '2019-02-01T07:06:43.712-08:00'
            name: $$manager$$
            region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
            distributionPolicy:
              zones:
              - zone: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-b
              - zone: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-c
              - zone: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
            versions:
            - instanceTemplate: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
              targetSize:
                calculated: 3
            instanceGroup: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/$$manager$$
            baseInstanceName: $$manager$$
            fingerprint: P_A0C1YIgiw=
            currentActions:
              none: 3
              creating: 0
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 0
              deleting: 0
              abandoning: 0
              restarting: 0
              refreshing: 0
            status:
              isStable: true
            targetSize: 3
            selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: OPPORTUNISTIC
              minimalAction: REPLACE
              maxSurge:
                fixed: 3
                calculated: 3
              maxUnavailable:
                fixed: 3
                calculated: 3
    - expect_exit:
        code: 0
- execute_command:
    # Recreate the instance so it will come up at the new machine type.
    command: compute instance-groups managed recreate-instances $$manager$$ --region
      us-central1 --instances $$instance1$$ --format text
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$/listManagedInstances?alt=json&maxResults=500
          method: POST
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '821'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            managedInstances:
            - instance: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-b/instances/mig-regional-20190201-150641-uo5j-mmdm
              id: '6573914324555390577'
              instanceStatus: RUNNING
              currentAction: NONE
            - instance: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-c/instances/mig-regional-20190201-150641-uo5j-k72q
              id: '3826715700001103475'
              instanceStatus: RUNNING
              currentAction: NONE
            - instance: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instances/$$manager$$-9fd6
              id: '7521307771304271439'
              instanceStatus: RUNNING
              currentAction: NONE
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$/recreateInstances?alt=json
          method: POST
          headers: {}
          body:
            json:
              instances:
              - $$instance1$$
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '872'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '4701326248699878960'
            name: operation-1549033695060-580d68323a372-41980afd-974c1711
            operationType: compute.instanceGroupManagers.recreateInstances
            targetLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$
            targetId: '7513382117829107308'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2019-02-01T07:08:15.683-08:00'
            selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/operations/operation-1549033695060-580d68323a372-41980afd-974c1711
            region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
        poll_operation: true
    - expect_stderr:
        matches: |
          Updated \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$\].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1962'
            Content-Type: application/json; charset=UTF-8
            ETag: '"3lk5cHIxzAZHpqBevezd0VXj_Dg=/F9EUUSoRNWn1UIP19GFoGvtp15s="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '7513382117829107308'
            creationTimestamp: '2019-02-01T07:06:43.712-08:00'
            name: $$manager$$
            region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
            distributionPolicy:
              zones:
              - zone: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-b
              - zone: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-c
              - zone: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
            versions:
            - instanceTemplate: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
              targetSize:
                calculated: 3
            instanceGroup: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/$$manager$$
            baseInstanceName: $$manager$$
            fingerprint: P_A0C1YIgiw=
            currentActions:
              none: 2
              creating: 0
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 1
              deleting: 0
              abandoning: 0
              restarting: 0
              refreshing: 0
            status:
              isStable: false
            targetSize: 3
            selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: OPPORTUNISTIC
              minimalAction: REPLACE
              maxSurge:
                fixed: 3
                calculated: 3
              maxUnavailable:
                fixed: 3
                calculated: 3
    - expect_stdout: |
        ---
        selfLink: $$instance1$$
        status:   SUCCESS
    - expect_exit:
        code: 0
- execute_command:
    command: compute instance-groups managed wait-until-stable $$manager$$ --timeout
      600 --region us-central1 --no-user-output-enabled
    validation_only: true
    events:
    - expect_exit:
        code: 0
- execute_command:
    # Check that the instance is on the new machine type.
    command: compute instances describe $$instance1$$ --format 'text(machineType)'
    validation_only: true
    events:
    - expect_stdout:
        matches: |
          machineType: https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-b/machineTypes/f1-micro
    - expect_exit:
        code: 0


- execute_command:
    # Delete the instance.
    command: compute instance-groups managed delete-instances $$manager$$ --region
      us-central1 --instances $$instance1$$ --format none
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$/listManagedInstances?alt=json&maxResults=500
          method: POST
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '821'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            managedInstances:
            - instance: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-b/instances/mig-regional-20190201-150641-uo5j-mmdm
              id: '1553149511750770645'
              instanceStatus: RUNNING
              currentAction: NONE
            - instance: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-c/instances/mig-regional-20190201-150641-uo5j-k72q
              id: '3826715700001103475'
              instanceStatus: RUNNING
              currentAction: NONE
            - instance: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instances/$$manager$$-9fd6
              id: '7521307771304271439'
              instanceStatus: RUNNING
              currentAction: NONE
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$/deleteInstances?alt=json
          method: POST
          headers: {}
          body:
            json:
              instances:
              - $$instance1$$
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '869'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '894833537553391489'
            name: operation-1549033837790-580d68ba58627-7e4d1f78-330cdc2b
            operationType: compute.instanceGroupManagers.deleteInstances
            targetLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$
            targetId: '7513382117829107308'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2019-02-01T07:10:38.525-08:00'
            selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/operations/operation-1549033837790-580d68ba58627-7e4d1f78-330cdc2b
            region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
        poll_operation: true
    - expect_stderr:
        matches: |
          Updated \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$\].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1962'
            Content-Type: application/json; charset=UTF-8
            ETag: '"ZQMTno7ls_ou2O2CiclM1Bk-0Oc=/yvV8KIBzgyg4YmMisPaaUBSl3eE="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '7513382117829107308'
            creationTimestamp: '2019-02-01T07:06:43.712-08:00'
            name: $$manager$$
            region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
            distributionPolicy:
              zones:
              - zone: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-b
              - zone: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-c
              - zone: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
            versions:
            - instanceTemplate: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
              targetSize:
                calculated: 2
            instanceGroup: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/$$manager$$
            baseInstanceName: $$manager$$
            fingerprint: P_A0C1YIgiw=
            currentActions:
              none: 2
              creating: 0
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 0
              deleting: 1
              abandoning: 0
              restarting: 0
              refreshing: 0
            status:
              isStable: false
            targetSize: 2
            selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: OPPORTUNISTIC
              minimalAction: REPLACE
              maxSurge:
                fixed: 3
                calculated: 3
              maxUnavailable:
                fixed: 3
                calculated: 3
    - expect_exit:
        code: 0
- execute_command:
    command: compute instance-groups managed wait-until-stable $$manager$$ --timeout
      600 --region us-central1 --no-user-output-enabled
    validation_only: true
    events:
    - expect_exit:
        code: 0
- execute_command:
    # Check that there are only 2 instances now.
    command: compute instance-groups managed list-instances $$manager$$ --region us-central1
      --format 'text(instanceStatus,version.name)'
    validation_only: true
    events:
    - expect_stdout: |
        ---
        instanceStatus: RUNNING
        ---
        instanceStatus: RUNNING
    - expect_exit:
        code: 0


- execute_command:
    # Abandon an instance.
    command: compute instance-groups managed abandon-instances $$manager$$ --region
      us-central1 --instances $$instance2$$ --format none
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$/listManagedInstances?alt=json&maxResults=500
          method: POST
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '557'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            managedInstances:
            - instance: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-c/instances/mig-regional-20190201-150641-uo5j-k72q
              id: '3826715700001103475'
              instanceStatus: RUNNING
              currentAction: NONE
            - instance: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f/instances/$$manager$$-9fd6
              id: '7521307771304271439'
              instanceStatus: RUNNING
              currentAction: NONE
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$/abandonInstances?alt=json
          method: POST
          headers: {}
          body:
            json:
              instances:
              - $$instance2$$
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '871'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '6567805867448196913'
            name: operation-1549033949518-580d6924e5a3f-1ee3f7a6-47f26de6
            operationType: compute.instanceGroupManagers.abandonInstances
            targetLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$
            targetId: '7513382117829107308'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2019-02-01T07:12:30.257-08:00'
            selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/operations/operation-1549033949518-580d6924e5a3f-1ee3f7a6-47f26de6
            region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
        poll_operation: true
    - expect_stderr:
        matches: |
          Updated \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$\].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '1962'
            Content-Type: application/json; charset=UTF-8
            ETag: '"HKBIV_nXYM6sqAz3rU8JqPL25H0=/MjMULFexbjoigibhB30N9EO1amQ="'
            status: '200'
          body:
            kind: compute#instanceGroupManager
            id: '7513382117829107308'
            creationTimestamp: '2019-02-01T07:06:43.712-08:00'
            name: $$manager$$
            region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
            distributionPolicy:
              zones:
              - zone: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-b
              - zone: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-c
              - zone: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/us-central1-f
            instanceTemplate: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
            versions:
            - instanceTemplate: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$
              targetSize:
                calculated: 1
            instanceGroup: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/$$manager$$
            baseInstanceName: $$manager$$
            fingerprint: P_A0C1YIgiw=
            currentActions:
              none: 1
              creating: 0
              creatingWithoutRetries: 0
              verifying: 0
              recreating: 0
              deleting: 0
              abandoning: 1
              restarting: 0
              refreshing: 0
            status:
              isStable: false
            targetSize: 1
            selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$
            updatePolicy:
              type: OPPORTUNISTIC
              minimalAction: REPLACE
              maxSurge:
                fixed: 3
                calculated: 3
              maxUnavailable:
                fixed: 3
                calculated: 3
    - expect_exit:
        code: 0
- execute_command:
    command: compute instance-groups managed wait-until-stable $$manager$$ --timeout
      600 --region us-central1 --no-user-output-enabled
    validation_only: true
    events:
    - expect_exit:
        code: 0
- execute_command:
    # Check that there is only 1 instance now.
    command: compute instance-groups managed list-instances $$manager$$ --region us-central1
      --format 'text(instanceStatus,version.name)'
    validation_only: true
    events:
    - expect_stdout: |
        ---
        instanceStatus: RUNNING
    - expect_exit:
        code: 0


- execute_command:
    # Set some ports
    command: compute instance-groups managed set-named-ports $$manager$$ --region
      us-central1 --named-ports my-service:1234
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '883'
            Content-Type: application/json; charset=UTF-8
            ETag: '"yNc0qOZNq6iSMxfstGWBiUOTsqQ=/jJYfLjQlGog9lC5cbdIMnn8yCfw="'
            status: '200'
          body:
            kind: compute#instanceGroup
            id: '7513382117829107308'
            creationTimestamp: '2019-02-01T07:06:43.715-08:00'
            name: $$manager$$
            description: "This instance group is controlled by Regional Instance Group\
              \ Manager '$$manager$$'. To modify instances in this group, use the\
              \ Regional Instance Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
            network: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/networks/default
            fingerprint: 42WmSpB8rSM=
            selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/$$manager$$
            size: 1
            region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/$$manager$$/setNamedPorts?alt=json
          method: POST
          headers: {}
          body:
            json:
              fingerprint: 42WmSpB8rSM=
              namedPorts:
              - name: my-service
                port: 1234
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '945'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '6816038140885196575'
            name: operation-1549033967312-580d6935ddfe7-c7d00030-7877155f
            operationType: compute.instanceGroups.setNamedPorts
            targetLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/$$manager$$
            targetId: '7513382117829107308'
            status: DONE
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 100
            insertTime: '2019-02-01T07:12:48.417-08:00'
            startTime: '2019-02-01T07:12:48.423-08:00'
            endTime: '2019-02-01T07:12:48.423-08:00'
            selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/operations/operation-1549033967312-580d6935ddfe7-c7d00030-7877155f
            region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
        poll_operation: true
    - expect_stderr:
        matches: |
          Updated \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/$$manager$$\].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '953'
            Content-Type: application/json; charset=UTF-8
            ETag: '"Zn7XQl0Dyo8vE76lwTBeip3KhW8=/kAh0KEba0GwKUTecoldeyQ1UyT8="'
            status: '200'
          body:
            kind: compute#instanceGroup
            id: '7513382117829107308'
            creationTimestamp: '2019-02-01T07:06:43.715-08:00'
            name: $$manager$$
            description: "This instance group is controlled by Regional Instance Group\
              \ Manager '$$manager$$'. To modify instances in this group, use the\
              \ Regional Instance Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
            namedPorts:
            - name: my-service
              port: 1234
            network: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/networks/default
            fingerprint: ggTjPYfVy0U=
            selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/$$manager$$
            size: 1
            region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
    - expect_exit:
        code: 0
- execute_command:
    # Check the ports.
    command: compute instance-groups managed get-named-ports $$manager$$ --region
      us-central1 --format text
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/$$manager$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '953'
            Content-Type: application/json; charset=UTF-8
            ETag: '"GlLPNBs-AeAppCmb1Zng8LccCL8=/7ttKFf-poSGuc5O5bxvGo0mhhjE="'
            status: '200'
          body:
            kind: compute#instanceGroup
            id: '7513382117829107308'
            creationTimestamp: '2019-02-01T07:06:43.715-08:00'
            name: $$manager$$
            description: "This instance group is controlled by Regional Instance Group\
              \ Manager '$$manager$$'. To modify instances in this group, use the\
              \ Regional Instance Group Manager API: https://cloud.google.com/compute/docs/reference/latest/instanceGroupManagers"
            namedPorts:
            - name: my-service
              port: 1234
            network: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/networks/default
            fingerprint: ggTjPYfVy0U=
            selfLink: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroups/$$manager$$
            size: 1
            region: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1
    - expect_stdout: |
        ---
        name: my-service
        port: 1234
    - expect_exit:
        code: 0


- execute_command:
    command: compute instance-groups managed delete $$manager$$ --region us-central1
    cleanup_for: manager
    events:
    - expect_prompt_continue:
        message: |
          The following region instance group managers will be deleted:
           - [$$manager$$] in [us-central1]
        user_input: y
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/autoscalers?alt=json&maxResults=500
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '250'
            Content-Type: application/json; charset=UTF-8
            ETag: '"m6cum0mmJo5OZFpdhF72gdCGs88=/YiEHyLvAPFqaIaF6WAB47f7WYTA="'
            status: '200'
          body:
            kind: compute#regionAutoscalerList
            id: projects/cloud-sdk-integration-testing/regions/us-central1/autoscalers
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1/autoscalers
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '861'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '6829728194522373916'
            name: operation-1549033970953-580d693956e7a-540c9e1a-9800e113
            operationType: compute.instanceGroupManagers.delete
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$
            targetId: '7513382117829107308'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2019-02-01T07:12:51.491-08:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1/operations/operation-1549033970953-580d693956e7a-540c9e1a-9800e113
            region: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1
        poll_operation: true
    - expect_stderr: |
        Deleted [https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1/instanceGroupManagers/$$manager$$].
    - expect_progress_tracker:
        message: Deleting Managed Instance Group
        status: SUCCESS
    - expect_exit:
        code: 0


- execute_command:
    command: compute instance-templates delete $$template2$$
    cleanup_for: template2
    validation_only: true
    events:
    - expect_prompt_continue:
        message: |
          The following instance templates will be deleted:
           - [$$template2$$]
        user_input: y
    - expect_stderr:
        matches: |
            Deleted \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template2$$\].
    - expect_exit:
        code: 0

- execute_command:
    command: compute instance-templates delete $$template1$$
    cleanup_for: template1
    validation_only: true
    events:
    - expect_prompt_continue:
        message: |
          The following instance templates will be deleted:
           - [$$template1$$]
        user_input: y
    - expect_stderr:
        matches: |
            Deleted \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/instanceTemplates/$$template1$$\].
    - expect_exit:
        code: 0
