title: SetServiceAccountTest
summary:
# This summary is generated automatically on update and should not be edited.
- execute:
  - command: |
      compute instances create $$gcloud-compute-test$$ --zone $$my-zone$$
      --format "text(status,serviceAccounts)"
  - stderr: |-
      Created \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$\].
      $
  - stdout: |
      ---
      serviceAccounts[0].email:     462803083913-compute@developer.gserviceaccount.com
      serviceAccounts[0].scopes[0]: https://www.googleapis.com/auth/devstorage.read_only
      serviceAccounts[0].scopes[1]: https://www.googleapis.com/auth/logging.write
      serviceAccounts[0].scopes[2]: https://www.googleapis.com/auth/monitoring.write
      serviceAccounts[0].scopes[3]: https://www.googleapis.com/auth/pubsub
      serviceAccounts[0].scopes[4]: https://www.googleapis.com/auth/service.management.readonly
      serviceAccounts[0].scopes[5]: https://www.googleapis.com/auth/servicecontrol
      serviceAccounts[0].scopes[6]: https://www.googleapis.com/auth/trace.append
      status:                       RUNNING
- execute:
  - command: compute instances set-service-account --service-account $$service-account$$
      --zone $$my-zone$$ $$gcloud-compute-test$$
  - error: |
      1: Could not fetch resource:
       - The instance must be stopped before the service account can be changed.
- execute:
  - command: compute instances stop --zone $$my-zone$$ $$gcloud-compute-test$$
  - progress_tracker:
    - message: Stopping instance(s) $$gcloud-compute-test$$
    - status: SUCCESS
  - stderr: |-
      Updated \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$\].
      $
- execute:
  - command: compute instances set-service-account --service-account $$service-account$$
      --zone $$my-zone$$ $$gcloud-compute-test$$
  - stderr: |-
      Updated \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$\].
      $
- execute:
  - command: compute instances set-service-account --scopes "" --zone $$my-zone$$
      $$gcloud-compute-test$$
  - stderr: |-
      Updated \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$\].
      $
- execute:
  - command: compute instances set-service-account --no-service-account --no-scopes
      --zone $$my-zone$$ $$gcloud-compute-test$$
  - stderr: |-
      Updated \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$\].
      $
- execute:
  - command: compute instances delete $$gcloud-compute-test$$ --zone $$my-zone$$ --quiet
  - stderr: |-
      Deleted \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$\].
      $
actions:
- define_reference:
    reference: compute-uri
    value: compute.googleapis.com/compute
- define_reference:
    reference: my-zone
    value: us-central1-f
- define_reference:
    reference: service-account
    value: cloud-sdk-integration-testing@appspot.gserviceaccount.com
- generate_resource_id:
    reference: gcloud-compute-test
    prefix: gcloud-compute-test-sa
- execute_command:
    command: |
      compute instances create $$gcloud-compute-test$$ --zone $$my-zone$$
      --format "text(status,serviceAccounts)"
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '510'
            Content-Type: application/json; charset=UTF-8
            ETag: '"DW4_B-AKxFvWLGI4g2b6YGwTdHQ=/gbUu0WmM55RBHNRsfUwtyk_nWAU="'
            status: '200'
          body:
            kind: compute#zone
            id: '2004'
            creationTimestamp: '1969-12-31T16:00:00.000-08:00'
            name: $$my-zone$$
            description: $$my-zone$$
            status: UP
            region: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/regions/us-central1
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$
            availableCpuPlatforms:
            - Intel Skylake
            - Intel Broadwell
            - Intel Haswell
            - Intel Ivy Bridge
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          omit_fields:
          - commonInstanceMetadata
          - quotas
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '408822'
            Content-Type: application/json; charset=UTF-8
            ETag: '"5SVajR_GNtOp7DHpytc6gdGv1Ko=/JOrcFN_iRBJ-3xRVxZLCnewJC6Y="'
            status: '200'
          body:
            kind: compute#project
            id: '17966956004057981335'
            creationTimestamp: '2014-09-30T07:55:22.502-07:00'
            name: cloud-sdk-integration-testing
            usageExportLocation:
              bucketName: cloud-sdk-integration-test-usage
              reportNamePrefix: ''
            enabledFeatures:
            - alpha-api
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing
            defaultServiceAccount: 462803083913-compute@developer.gserviceaccount.com
            xpnProjectStatus: UNSPECIFIED_XPN_PROJECT_STATUS
            defaultNetworkTier: PREMIUM
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances?alt=json
          method: POST
          headers: {}
          body:
            json:
              canIpForward: false
              deletionProtection: false
              disks:
              - autoDelete: true
                boot: true
                initializeParams:
                  sourceImage: https://$$compute-uri$$/v1/projects/debian-cloud/global/images/family/debian-10
                mode: READ_WRITE
                type: PERSISTENT
              machineType: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/machineTypes/n1-standard-1
              metadata: {}
              name: $$gcloud-compute-test$$
              networkInterfaces:
              - accessConfigs:
                - name: external-nat
                  type: ONE_TO_ONE_NAT
                network: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/global/networks/default
              scheduling:
                automaticRestart: true
              serviceAccounts:
              - email: default
                scopes:
                - https://www.googleapis.com/auth/devstorage.read_only
                - https://www.googleapis.com/auth/logging.write
                - https://www.googleapis.com/auth/monitoring.write
                - https://www.googleapis.com/auth/pubsub
                - https://www.googleapis.com/auth/service.management.readonly
                - https://www.googleapis.com/auth/servicecontrol
                - https://www.googleapis.com/auth/trace.append
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '827'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '3440185226268889600'
            name: operation-1541434606022-579ed3622ed73-53e782d2-1b76f77c
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$
            operationType: insert
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$
            targetId: '7400368896811586049'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2018-11-05T08:16:47.370-08:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/operations/operation-1541434606022-579ed3622ed73-53e782d2-1b76f77c
        poll_operation: true
    - expect_stderr:
        matches: |
          Created \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$\].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '2574'
            Content-Type: application/json; charset=UTF-8
            ETag: '"rUj6g6mgsHcguojZ6i6XuJj9cvI=/5TFMy220YMNZIvBRcgs1AQhnQ2w="'
            status: '200'
          body:
            kind: compute#instance
            id: '7400368896811586049'
            creationTimestamp: '2018-11-05T08:16:47.198-08:00'
            name: $$gcloud-compute-test$$
            tags:
              fingerprint: 42WmSpB8rSM=
            machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/machineTypes/n1-standard-1
            status: RUNNING
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$
            canIpForward: false
            networkInterfaces:
            - kind: compute#networkInterface
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              networkIP: 10.240.2.229
              name: nic0
              accessConfigs:
              - kind: compute#accessConfig
                type: ONE_TO_ONE_NAT
                name: external-nat
                natIP: 35.239.98.232
                networkTier: PREMIUM
              fingerprint: w7g792thjGE=
            disks:
            - kind: compute#attachedDisk
              type: PERSISTENT
              mode: READ_WRITE
              source: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/disks/$$gcloud-compute-test$$
              deviceName: persistent-disk-0
              index: 0
              boot: true
              autoDelete: true
              licenses:
              - https://www.googleapis.com/compute/v1/projects/debian-cloud/global/licenses/debian-9-stretch
              interface: SCSI
              guestOsFeatures:
              - type: VIRTIO_SCSI_MULTIQUEUE
            metadata:
              kind: compute#metadata
              fingerprint: 4_QxQ57NQak=
            serviceAccounts:
            - email: 462803083913-compute@developer.gserviceaccount.com
              scopes:
              - https://www.googleapis.com/auth/devstorage.read_only
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring.write
              - https://www.googleapis.com/auth/pubsub
              - https://www.googleapis.com/auth/service.management.readonly
              - https://www.googleapis.com/auth/servicecontrol
              - https://www.googleapis.com/auth/trace.append
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$
            scheduling:
              onHostMaintenance: MIGRATE
              automaticRestart: true
              preemptible: false
            cpuPlatform: Intel Ivy Bridge
            labelFingerprint: 42WmSpB8rSM=
            startRestricted: false
            deletionProtection: false
    - expect_stdout: |
        ---
        serviceAccounts[0].email:     462803083913-compute@developer.gserviceaccount.com
        serviceAccounts[0].scopes[0]: https://www.googleapis.com/auth/devstorage.read_only
        serviceAccounts[0].scopes[1]: https://www.googleapis.com/auth/logging.write
        serviceAccounts[0].scopes[2]: https://www.googleapis.com/auth/monitoring.write
        serviceAccounts[0].scopes[3]: https://www.googleapis.com/auth/pubsub
        serviceAccounts[0].scopes[4]: https://www.googleapis.com/auth/service.management.readonly
        serviceAccounts[0].scopes[5]: https://www.googleapis.com/auth/servicecontrol
        serviceAccounts[0].scopes[6]: https://www.googleapis.com/auth/trace.append
        status:                       RUNNING
    - expect_exit:
        code: 0
- execute_command:
    command: compute instances set-service-account --service-account $$service-account$$
      --zone $$my-zone$$ $$gcloud-compute-test$$
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '2574'
            Content-Type: application/json; charset=UTF-8
            ETag: '"l8C3NM2I8gyn5yr9061iUFBKsRM=/HiM-sLQjk526H478y9REw5kkvew="'
            status: '200'
          body:
            kind: compute#instance
            id: '7400368896811586049'
            creationTimestamp: '2018-11-05T08:16:47.198-08:00'
            name: $$gcloud-compute-test$$
            tags:
              fingerprint: 42WmSpB8rSM=
            machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/machineTypes/n1-standard-1
            status: RUNNING
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$
            canIpForward: false
            networkInterfaces:
            - kind: compute#networkInterface
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              networkIP: 10.240.2.229
              name: nic0
              accessConfigs:
              - kind: compute#accessConfig
                type: ONE_TO_ONE_NAT
                name: external-nat
                natIP: 35.239.98.232
                networkTier: PREMIUM
              fingerprint: w7g792thjGE=
            disks:
            - kind: compute#attachedDisk
              type: PERSISTENT
              mode: READ_WRITE
              source: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/disks/$$gcloud-compute-test$$
              deviceName: persistent-disk-0
              index: 0
              boot: true
              autoDelete: true
              licenses:
              - https://www.googleapis.com/compute/v1/projects/debian-cloud/global/licenses/debian-9-stretch
              interface: SCSI
              guestOsFeatures:
              - type: VIRTIO_SCSI_MULTIQUEUE
            metadata:
              kind: compute#metadata
              fingerprint: 4_QxQ57NQak=
            serviceAccounts:
            - email: 462803083913-compute@developer.gserviceaccount.com
              scopes:
              - https://www.googleapis.com/auth/devstorage.read_only
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring.write
              - https://www.googleapis.com/auth/pubsub
              - https://www.googleapis.com/auth/service.management.readonly
              - https://www.googleapis.com/auth/servicecontrol
              - https://www.googleapis.com/auth/trace.append
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$
            scheduling:
              onHostMaintenance: MIGRATE
              automaticRestart: true
              preemptible: false
            cpuPlatform: Intel Ivy Bridge
            labelFingerprint: 42WmSpB8rSM=
            startRestricted: false
            deletionProtection: false
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$/setServiceAccount?alt=json
          method: POST
          headers: {}
          body:
            json:
              email: $$service-account$$
              scopes:
              - https://www.googleapis.com/auth/devstorage.read_only
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring.write
              - https://www.googleapis.com/auth/pubsub
              - https://www.googleapis.com/auth/service.management.readonly
              - https://www.googleapis.com/auth/servicecontrol
              - https://www.googleapis.com/auth/trace.append
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '838'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '6198716985322099699'
            name: operation-1541434651955-579ed38dfcf39-30b4c335-4322cf33
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$
            operationType: setServiceAccount
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$
            targetId: '7400368896811586049'
            status: DONE
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 100
            insertTime: '2018-11-05T08:17:32.781-08:00'
            startTime: '2018-11-02T10:24:58.049-07:00'
            endTime: '2018-11-02T10:24:59.247-07:00'
            error:
              errors:
                code: INVALID_USAGE
                message: The instance must be stopped before the service account can
                  be changed.
            httpErrorStatusCode: 400
            httpErrorMessage: BAD REQUEST
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/operations/operation-1541434651955-579ed38dfcf39-30b4c335-4322cf33
        poll_operation: true
    - expect_exit:
        code: 1
        message: |
          Could not fetch resource:
           - The instance must be stopped before the service account can be changed.
- execute_command:
    command: compute instances stop --zone $$my-zone$$ $$gcloud-compute-test$$
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$/stop?alt=json
          method: POST
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '825'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '2536578975397696458'
            name: operation-1541434660284-579ed395ee661-d7b55459-00139be3
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$
            operationType: stop
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$
            targetId: '7400368896811586049'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2018-11-05T08:17:41.265-08:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/operations/operation-1541434660284-579ed395ee661-d7b55459-00139be3
        poll_operation: true
    - expect_progress_tracker:
        message: Stopping instance(s) $$gcloud-compute-test$$
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '2550'
            Content-Type: application/json; charset=UTF-8
            ETag: '"kSXoQ_jDWpPueYIQGlKAkVcAdD4=/KAtka_gpL9P4pu_Lx8l38rD6P50="'
            status: '200'
          body:
            kind: compute#instance
            id: '7400368896811586049'
            creationTimestamp: '2018-11-05T08:16:47.198-08:00'
            name: $$gcloud-compute-test$$
            tags:
              fingerprint: 42WmSpB8rSM=
            machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/machineTypes/n1-standard-1
            status: TERMINATED
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$
            canIpForward: false
            networkInterfaces:
            - kind: compute#networkInterface
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              networkIP: 10.240.2.229
              name: nic0
              accessConfigs:
              - kind: compute#accessConfig
                type: ONE_TO_ONE_NAT
                name: external-nat
                networkTier: PREMIUM
              fingerprint: CmjXJsEr9ww=
            disks:
            - kind: compute#attachedDisk
              type: PERSISTENT
              mode: READ_WRITE
              source: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/disks/$$gcloud-compute-test$$
              deviceName: persistent-disk-0
              index: 0
              boot: true
              autoDelete: true
              licenses:
              - https://www.googleapis.com/compute/v1/projects/debian-cloud/global/licenses/debian-9-stretch
              interface: SCSI
              guestOsFeatures:
              - type: VIRTIO_SCSI_MULTIQUEUE
            metadata:
              kind: compute#metadata
              fingerprint: 4_QxQ57NQak=
            serviceAccounts:
            - email: 462803083913-compute@developer.gserviceaccount.com
              scopes:
              - https://www.googleapis.com/auth/devstorage.read_only
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring.write
              - https://www.googleapis.com/auth/pubsub
              - https://www.googleapis.com/auth/service.management.readonly
              - https://www.googleapis.com/auth/servicecontrol
              - https://www.googleapis.com/auth/trace.append
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$
            scheduling:
              onHostMaintenance: MIGRATE
              automaticRestart: true
              preemptible: false
            cpuPlatform: Unknown CPU Platform
            labelFingerprint: 42WmSpB8rSM=
            startRestricted: false
            deletionProtection: false
    - expect_stderr:
        matches: |
          Updated \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$\].
    - expect_exit:
        code: 0
- execute_command:
    command: compute instances set-service-account --service-account $$service-account$$
      --zone $$my-zone$$ $$gcloud-compute-test$$
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '2550'
            Content-Type: application/json; charset=UTF-8
            ETag: '"VA_Eq0LI8eKOqVDoFuxMvf9eLIM=/OdF8DnFEaRYp4NQWb0L4rU5MWss="'
            status: '200'
          body:
            kind: compute#instance
            id: '7400368896811586049'
            creationTimestamp: '2018-11-05T08:16:47.198-08:00'
            name: $$gcloud-compute-test$$
            tags:
              fingerprint: 42WmSpB8rSM=
            machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/machineTypes/n1-standard-1
            status: TERMINATED
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$
            canIpForward: false
            networkInterfaces:
            - kind: compute#networkInterface
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              networkIP: 10.240.2.229
              name: nic0
              accessConfigs:
              - kind: compute#accessConfig
                type: ONE_TO_ONE_NAT
                name: external-nat
                networkTier: PREMIUM
              fingerprint: CmjXJsEr9ww=
            disks:
            - kind: compute#attachedDisk
              type: PERSISTENT
              mode: READ_WRITE
              source: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/disks/$$gcloud-compute-test$$
              deviceName: persistent-disk-0
              index: 0
              boot: true
              autoDelete: true
              licenses:
              - https://www.googleapis.com/compute/v1/projects/debian-cloud/global/licenses/debian-9-stretch
              interface: SCSI
              guestOsFeatures:
              - type: VIRTIO_SCSI_MULTIQUEUE
            metadata:
              kind: compute#metadata
              fingerprint: 4_QxQ57NQak=
            serviceAccounts:
            - email: 462803083913-compute@developer.gserviceaccount.com
              scopes:
              - https://www.googleapis.com/auth/devstorage.read_only
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring.write
              - https://www.googleapis.com/auth/pubsub
              - https://www.googleapis.com/auth/service.management.readonly
              - https://www.googleapis.com/auth/servicecontrol
              - https://www.googleapis.com/auth/trace.append
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$
            scheduling:
              onHostMaintenance: MIGRATE
              automaticRestart: true
              preemptible: false
            cpuPlatform: Unknown CPU Platform
            labelFingerprint: 42WmSpB8rSM=
            startRestricted: false
            deletionProtection: false
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$/setServiceAccount?alt=json
          method: POST
          headers: {}
          body:
            json:
              email: $$service-account$$
              scopes:
              - https://www.googleapis.com/auth/devstorage.read_only
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring.write
              - https://www.googleapis.com/auth/pubsub
              - https://www.googleapis.com/auth/service.management.readonly
              - https://www.googleapis.com/auth/servicecontrol
              - https://www.googleapis.com/auth/trace.append
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '838'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '7835646961629647642'
            name: operation-1541434869553-579ed45d81768-5b1490c8-e34432b1
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$
            operationType: setServiceAccount
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$
            targetId: '7400368896811586049'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2018-11-05T08:21:09.938-08:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/operations/operation-1541434869553-579ed45d81768-5b1490c8-e34432b1
        poll_operation: true
    - expect_stderr:
        matches: |
          Updated \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$\].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '2557'
            Content-Type: application/json; charset=UTF-8
            ETag: '"57HrLIETkJS_Ci9inPHSPvKgyQ0=/UysAZ1pAK00dPAxs5Li5BT2seBI="'
            status: '200'
          body:
            kind: compute#instance
            id: '7400368896811586049'
            creationTimestamp: '2018-11-05T08:16:47.198-08:00'
            name: $$gcloud-compute-test$$
            tags:
              fingerprint: 42WmSpB8rSM=
            machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/machineTypes/n1-standard-1
            status: TERMINATED
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$
            canIpForward: false
            networkInterfaces:
            - kind: compute#networkInterface
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              networkIP: 10.240.2.229
              name: nic0
              accessConfigs:
              - kind: compute#accessConfig
                type: ONE_TO_ONE_NAT
                name: external-nat
                networkTier: PREMIUM
              fingerprint: CmjXJsEr9ww=
            disks:
            - kind: compute#attachedDisk
              type: PERSISTENT
              mode: READ_WRITE
              source: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/disks/$$gcloud-compute-test$$
              deviceName: persistent-disk-0
              index: 0
              boot: true
              autoDelete: true
              licenses:
              - https://www.googleapis.com/compute/v1/projects/debian-cloud/global/licenses/debian-9-stretch
              interface: SCSI
              guestOsFeatures:
              - type: VIRTIO_SCSI_MULTIQUEUE
            metadata:
              kind: compute#metadata
              fingerprint: 4_QxQ57NQak=
            serviceAccounts:
            - email: $$service-account$$
              scopes:
              - https://www.googleapis.com/auth/devstorage.read_only
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring.write
              - https://www.googleapis.com/auth/pubsub
              - https://www.googleapis.com/auth/service.management.readonly
              - https://www.googleapis.com/auth/servicecontrol
              - https://www.googleapis.com/auth/trace.append
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$
            scheduling:
              onHostMaintenance: MIGRATE
              automaticRestart: true
              preemptible: false
            cpuPlatform: Unknown CPU Platform
            labelFingerprint: 42WmSpB8rSM=
            startRestricted: false
            deletionProtection: false
    - expect_exit:
        code: 0
- execute_command:
    command: compute instances set-service-account --scopes "" --zone $$my-zone$$
      $$gcloud-compute-test$$
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '2557'
            Content-Type: application/json; charset=UTF-8
            ETag: '"wivhH7zlcJEMO46GmUmubjbrqII=/MAN74X11sRNMIsN0x6bOJlTyqYE="'
            status: '200'
          body:
            kind: compute#instance
            id: '7400368896811586049'
            creationTimestamp: '2018-11-05T08:16:47.198-08:00'
            name: $$gcloud-compute-test$$
            tags:
              fingerprint: 42WmSpB8rSM=
            machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/machineTypes/n1-standard-1
            status: TERMINATED
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$
            canIpForward: false
            networkInterfaces:
            - kind: compute#networkInterface
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              networkIP: 10.240.2.229
              name: nic0
              accessConfigs:
              - kind: compute#accessConfig
                type: ONE_TO_ONE_NAT
                name: external-nat
                networkTier: PREMIUM
              fingerprint: CmjXJsEr9ww=
            disks:
            - kind: compute#attachedDisk
              type: PERSISTENT
              mode: READ_WRITE
              source: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/disks/$$gcloud-compute-test$$
              deviceName: persistent-disk-0
              index: 0
              boot: true
              autoDelete: true
              licenses:
              - https://www.googleapis.com/compute/v1/projects/debian-cloud/global/licenses/debian-9-stretch
              interface: SCSI
              guestOsFeatures:
              - type: VIRTIO_SCSI_MULTIQUEUE
            metadata:
              kind: compute#metadata
              fingerprint: 4_QxQ57NQak=
            serviceAccounts:
            - email: $$service-account$$
              scopes:
              - https://www.googleapis.com/auth/devstorage.read_only
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring.write
              - https://www.googleapis.com/auth/pubsub
              - https://www.googleapis.com/auth/service.management.readonly
              - https://www.googleapis.com/auth/servicecontrol
              - https://www.googleapis.com/auth/trace.append
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$
            scheduling:
              onHostMaintenance: MIGRATE
              automaticRestart: true
              preemptible: false
            cpuPlatform: Unknown CPU Platform
            labelFingerprint: 42WmSpB8rSM=
            startRestricted: false
            deletionProtection: false
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$/setServiceAccount?alt=json
          method: POST
          headers: {}
          body:
            json:
              email: $$service-account$$
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '838'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '6621838634835104532'
            name: operation-1541434874931-579ed462a273a-584d3f9f-686c1354
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$
            operationType: setServiceAccount
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$
            targetId: '7400368896811586049'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2018-11-05T08:21:15.333-08:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/operations/operation-1541434874931-579ed462a273a-584d3f9f-686c1354
        poll_operation: true
    - expect_stderr:
        matches: |
          Updated \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$\].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '2149'
            Content-Type: application/json; charset=UTF-8
            ETag: '"VBDK1h0ExpD7bYPSiEzTManZDws=/Hf0s_qiBMEdrp-t_wEy3XfAzaNQ="'
            status: '200'
          body:
            kind: compute#instance
            id: '7400368896811586049'
            creationTimestamp: '2018-11-05T08:16:47.198-08:00'
            name: $$gcloud-compute-test$$
            tags:
              fingerprint: 42WmSpB8rSM=
            machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/machineTypes/n1-standard-1
            status: TERMINATED
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$
            canIpForward: false
            networkInterfaces:
            - kind: compute#networkInterface
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              networkIP: 10.240.2.229
              name: nic0
              accessConfigs:
              - kind: compute#accessConfig
                type: ONE_TO_ONE_NAT
                name: external-nat
                networkTier: PREMIUM
              fingerprint: CmjXJsEr9ww=
            disks:
            - kind: compute#attachedDisk
              type: PERSISTENT
              mode: READ_WRITE
              source: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/disks/$$gcloud-compute-test$$
              deviceName: persistent-disk-0
              index: 0
              boot: true
              autoDelete: true
              licenses:
              - https://www.googleapis.com/compute/v1/projects/debian-cloud/global/licenses/debian-9-stretch
              interface: SCSI
              guestOsFeatures:
              - type: VIRTIO_SCSI_MULTIQUEUE
            metadata:
              kind: compute#metadata
              fingerprint: 4_QxQ57NQak=
            serviceAccounts:
            - email: $$service-account$$
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$
            scheduling:
              onHostMaintenance: MIGRATE
              automaticRestart: true
              preemptible: false
            cpuPlatform: Unknown CPU Platform
            labelFingerprint: 42WmSpB8rSM=
            startRestricted: false
            deletionProtection: false
    - expect_exit:
        code: 0
- execute_command:
    command: compute instances set-service-account --no-service-account --no-scopes
      --zone $$my-zone$$ $$gcloud-compute-test$$
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$/setServiceAccount?alt=json
          method: POST
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '838'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '1753857181822603499'
            name: operation-1541434883584-579ed46ae3002-b3c97b30-61770353
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$
            operationType: setServiceAccount
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$
            targetId: '7400368896811586049'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2018-11-05T08:21:24.369-08:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/operations/operation-1541434883584-579ed46ae3002-b3c97b30-61770353
        poll_operation: true
    - expect_stderr:
        matches: |
          Updated \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$\].
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '2043'
            Content-Type: application/json; charset=UTF-8
            ETag: '"irS3PqVYXj_bfyiNHgY7RYvEX3M=/6mDCcEUxyYu2utRpu1jOnJIPrao="'
            status: '200'
          body:
            kind: compute#instance
            id: '7400368896811586049'
            creationTimestamp: '2018-11-05T08:16:47.198-08:00'
            name: $$gcloud-compute-test$$
            tags:
              fingerprint: 42WmSpB8rSM=
            machineType: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/machineTypes/n1-standard-1
            status: TERMINATED
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$
            canIpForward: false
            networkInterfaces:
            - kind: compute#networkInterface
              network: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/global/networks/default
              networkIP: 10.240.2.229
              name: nic0
              accessConfigs:
              - kind: compute#accessConfig
                type: ONE_TO_ONE_NAT
                name: external-nat
                networkTier: PREMIUM
              fingerprint: CmjXJsEr9ww=
            disks:
            - kind: compute#attachedDisk
              type: PERSISTENT
              mode: READ_WRITE
              source: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/disks/$$gcloud-compute-test$$
              deviceName: persistent-disk-0
              index: 0
              boot: true
              autoDelete: true
              licenses:
              - https://www.googleapis.com/compute/v1/projects/debian-cloud/global/licenses/debian-9-stretch
              interface: SCSI
              guestOsFeatures:
              - type: VIRTIO_SCSI_MULTIQUEUE
            metadata:
              kind: compute#metadata
              fingerprint: 4_QxQ57NQak=
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$
            scheduling:
              onHostMaintenance: MIGRATE
              automaticRestart: true
              preemptible: false
            cpuPlatform: Unknown CPU Platform
            labelFingerprint: 42WmSpB8rSM=
            startRestricted: false
            deletionProtection: false
    - expect_exit:
        code: 0
- execute_command:
    cleanup_for: gcloud-compute-test
    command: compute instances delete $$gcloud-compute-test$$ --zone $$my-zone$$ --quiet
    events:
    - api_call:
        expect_request:
          uri: https://$$compute-uri$$/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '827'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '1805520299749134566'
            name: operation-1541434888640-579ed46fb5602-d8c950a8-6ce33bb0
            zone: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$
            operationType: delete
            targetLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$
            targetId: '7400368896811586049'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2018-11-05T08:21:29.973-08:00'
            selfLink: https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/operations/operation-1541434888640-579ed46fb5602-d8c950a8-6ce33bb0
        poll_operation: true
    - expect_stderr:
        matches: |
          Deleted \[https://.*.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/$$my-zone$$/instances/$$gcloud-compute-test$$\].
    - expect_exit:
        code: 0
