skip:
  reason: Failing
  bug: b/121390766
title: test simulate maintenance event
release_tracks:
- ALPHA
- BETA
- GA
summary:
# This summary is generated automatically on update and should not be edited.
- execute:
  - command: |
      compute instances create $$gcloud-compute-test1$$ --zone us-central1-f --format="disable"
  - stderr: |
      Created [https://www.googleapis.com/compute/$$api_version$$/projects/cloud-sdk-integration-testing/zones/us-central1-f/instances/$$gcloud-compute-test1$$].
- execute:
  - command: compute instances simulate-maintenance-event $$gcloud-compute-test1$$
      --zone us-central1-f
  - progress_tracker:
    - message: Simulating maintenance on instance(s) [https://www.googleapis.com/compute/$$api_version$$/projects/cloud-sdk-integration-testing/zones/us-central1-f/instances/$$gcloud-compute-test1$$]
    - status: SUCCESS
- execute:
  - command: |
      compute operations list --filter="targetLink=us-central1-f/instances/$$gcloud-compute-test1$$
      AND operationType=compute.instances.migrateOnHostMaintenance"
      --format="text(operationType, targetLink.scope(), status)"
  - stdout: |
      ---
      operationType: compute.instances.migrateOnHostMaintenance
      status:        DONE
      targetLink:    us-central1-f/instances/$$gcloud-compute-test1$$
- execute:
  - command: compute instances delete $$gcloud-compute-test1$$ --zone us-central1-f
      --quiet
  - stderr: |
      Deleted [https://www.googleapis.com/compute/$$api_version$$/projects/cloud-sdk-integration-testing/zones/us-central1-f/instances/$$gcloud-compute-test1$$].
actions:
- define_reference:
    reference: api_version
    track_values:
      ALPHA: alpha
      BETA: beta
      GA: v1
- generate_resource_id:
    reference: gcloud-compute-test1
    prefix: gcloud-compute-test
- execute_command:
    command: |
      compute instances create $$gcloud-compute-test1$$ --zone us-central1-f --format="disable"
    validation_only: true
    events:
    - expect_stderr: |
        Created [https://www.googleapis.com/compute/$$api_version$$/projects/cloud-sdk-integration-testing/zones/us-central1-f/instances/$$gcloud-compute-test1$$].
    - expect_exit:
        code: 0
- execute_command:
    command: compute instances simulate-maintenance-event $$gcloud-compute-test1$$
      --zone us-central1-f
    events:
    - api_call:
        expect_request:
          uri: https://www.googleapis.com/compute/$$api_version$$/projects/cloud-sdk-integration-testing/zones/us-central1-f/instances/$$gcloud-compute-test1$$/simulateMaintenanceEvent?alt=json
          method: POST
          headers: {}
          body:
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '842'
            Content-Type: application/json; charset=UTF-8
            status: '200'
          body:
            kind: compute#operation
            id: '3963025016983028918'
            name: operation-1542404696691-57acf140bd139-b25b8499-9b097f40
            zone: https://www.googleapis.com/compute/$$api_version$$/projects/cloud-sdk-integration-testing/zones/us-central1-f
            operationType: simulateMaintenanceEvent
            targetLink: https://www.googleapis.com/compute/$$api_version$$/projects/cloud-sdk-integration-testing/zones/us-central1-f/instances/$$gcloud-compute-test1$$
            targetId: '1270407571265717463'
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            progress: 0
            insertTime: '2018-11-16T13:44:57.165-08:00'
            selfLink: https://www.googleapis.com/compute/$$api_version$$/projects/cloud-sdk-integration-testing/zones/us-central1-f/operations/operation-1542404696691-57acf140bd139-b25b8499-9b097f40
        poll_operation: true
    - expect_progress_tracker:
        message: Simulating maintenance on instance(s) [https://www.googleapis.com/compute/$$api_version$$/projects/cloud-sdk-integration-testing/zones/us-central1-f/instances/$$gcloud-compute-test1$$]
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://www.googleapis.com/compute/$$api_version$$/projects/cloud-sdk-integration-testing/zones/us-central1-f/instances/$$gcloud-compute-test1$$?alt=json
          method: GET
          headers: {}
          body:
        return_response:
          headers:
            Cache-Control: private, max-age=0
            Content-Length: '2565'
            Content-Type: application/json; charset=UTF-8
            ETag: '"aPLDvogLSfknDXkG3m8wrF7ZsoM=/Zzb43dz3-fyiLB4WVKqxmOkNW-U="'
            status: '200'
          body:
            kind: compute#instance
            id: '1270407571265717463'
            creationTimestamp: '2018-11-16T13:44:28.473-08:00'
            name: $$gcloud-compute-test1$$
            tags:
              fingerprint: 42WmSpB8rSM=
            machineType: https://www.googleapis.com/compute/$$api_version$$/projects/cloud-sdk-integration-testing/zones/us-central1-f/machineTypes/n1-standard-1
            status: RUNNING
            zone: https://www.googleapis.com/compute/$$api_version$$/projects/cloud-sdk-integration-testing/zones/us-central1-f
            canIpForward: false
            networkInterfaces:
            - kind: compute#networkInterface
              network: https://www.googleapis.com/compute/$$api_version$$/projects/cloud-sdk-integration-testing/global/networks/default
              networkIP: 10.240.0.17
              name: nic0
              accessConfigs:
              - kind: compute#accessConfig
                type: ONE_TO_ONE_NAT
                name: external-nat
                natIP: 35.232.193.178
                networkTier: PREMIUM
              fingerprint: 1wTriq0nwc4=
            disks:
            - kind: compute#attachedDisk
              type: PERSISTENT
              mode: READ_WRITE
              source: https://www.googleapis.com/compute/$$api_version$$/projects/cloud-sdk-integration-testing/zones/us-central1-f/disks/$$gcloud-compute-test1$$
              deviceName: persistent-disk-0
              index: 0
              boot: true
              autoDelete: true
              licenses:
              - https://www.googleapis.com/compute/$$api_version$$/projects/debian-cloud/global/licenses/debian-9-stretch
              interface: SCSI
              guestOsFeatures:
              - type: VIRTIO_SCSI_MULTIQUEUE
            metadata:
              kind: compute#metadata
              fingerprint: 4_QxQ57NQak=
            serviceAccounts:
            - email: 462803083913-compute@developer.gserviceaccount.com
              scopes:
              - https://www.googleapis.com/auth/devstorage.read_only
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring.write
              - https://www.googleapis.com/auth/pubsub
              - https://www.googleapis.com/auth/service.management.readonly
              - https://www.googleapis.com/auth/servicecontrol
              - https://www.googleapis.com/auth/trace.append
            selfLink: https://www.googleapis.com/compute/$$api_version$$/projects/cloud-sdk-integration-testing/zones/us-central1-f/instances/$$gcloud-compute-test1$$
            scheduling:
              onHostMaintenance: MIGRATE
              automaticRestart: true
              preemptible: false
            cpuPlatform: Intel Ivy Bridge
            labelFingerprint: 42WmSpB8rSM=
            startRestricted: false
            deletionProtection: false
    - expect_exit:
        code: 0
- execute_command:
    command: |
      compute operations list --filter="targetLink=us-central1-f/instances/$$gcloud-compute-test1$$
      AND operationType=compute.instances.migrateOnHostMaintenance"
      --format="text(operationType, targetLink.scope(), status)"
    validation_only: true
    events:
    - expect_stdout: |
        ---
        operationType: compute.instances.migrateOnHostMaintenance
        status:        DONE
        targetLink:    us-central1-f/instances/$$gcloud-compute-test1$$
    - expect_exit:
        code: 0
- execute_command:
    command: compute instances delete $$gcloud-compute-test1$$ --zone us-central1-f
      --quiet
    validation_only: true
    events:
    - expect_stderr: |
        Deleted [https://www.googleapis.com/compute/$$api_version$$/projects/cloud-sdk-integration-testing/zones/us-central1-f/instances/$$gcloud-compute-test1$$].
    - expect_exit:
        code: 0
    cleanup_for: gcloud-compute-test1
