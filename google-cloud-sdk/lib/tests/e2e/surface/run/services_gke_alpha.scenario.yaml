title: Serverless deploy to gke cluster with knative addon.
release_tracks: [ALPHA]
summary:
# This summary is generated automatically on update and should not be edited.
- set_property: run/cluster do-not-delete-gke-knative-test-cluster
- set_property: run/cluster_location us-central1-a
- set_property: run/platform gke
- execute:
  - command: run deploy --image gcr.io/knative-samples/helloworld-nodejs $$service-name$$
  - stderr: |
      Deploying container to Cloud Run on GKE service [$$service-name$$] in namespace [default] of cluster [do-not-delete-gke-knative-test-cluster]
  - staged_progress_tracker:
    - message: Deploying new service...
    - status: SUCCESS
    - succeeded_stages: &id001
      - Creating Revision...
      - Routing traffic...
  - stderr: |
      Service [$$service-name$$] revision [$$service-revision-name$$] has been deployed and is serving 100 percent of traffic at $$service-name$$.default.example.com
- execute:
  - command: run services describe $$service-name$$ --format="value(metadata.name)"
  - stdout: |
      $$service-name$$
- execute:
  - command: run services update $$service-name$$ --memory 512Mi --concurrency 3 --update-env-vars
      FOO=bar --connectivity internal --min-instances 0 --max-instances 2
  - staged_progress_tracker:
    - message: Deploying...
    - status: SUCCESS
  - stderr: |-
      Service \[$$service-name$$\] revision \[$$service-name$$-[a-z0-9]+\] is active and serving traffic at $$service-name$$\.default\..*
      $
- execute:
  - command: run services replace service.yaml
  - stderr: |
      Deploying container to Cloud Run on GKE service [$$service-name$$] in namespace [default] of cluster [do-not-delete-gke-knative-test-cluster]
  - staged_progress_tracker:
    - message: Deploying...
    - status: SUCCESS
  - stderr: |
      Service [$$service-name$$] revision [$$service-name$$-xjn8m] has been deployed and is serving 100 percent of traffic at $$service-name$$.default.example.com
- execute:
  - command: run deploy --image gcr.io/knative-samples/helloworld-nodejs $$service-name2$$
      --min-instances 1 --max-instances default
  - stderr: |
      Deploying container to Cloud Run on GKE service [$$service-name2$$] in namespace [default] of cluster [do-not-delete-gke-knative-test-cluster]
  - staged_progress_tracker:
    - message: Deploying new service...
    - status: SUCCESS
    - succeeded_stages: &id002
      - Creating Revision...
      - Routing traffic...
  - stderr: |
      Service [$$service-name2$$] revision [$$service-revision-name2$$] has been deployed and is serving 100 percent of traffic at $$service-name2$$.default.example.com
- execute:
  - command: run services delete $$service-name$$ -q
  - stderr: |
      Deleted service [$$service-name$$].
- execute:
  - command: run services delete $$service-name2$$ -q
  - stderr: |
      Deleted service [$$service-name2$$].
actions:

- set_property:
    # container/use_client_certificate: true
    # auth/disable_ssl_validation: true
    run/cluster: do-not-delete-gke-knative-test-cluster
    run/cluster_location: us-central1-a
    run/platform: gke

- generate_resource_id:
    reference: service-name
    prefix: service-name

- generate_resource_id:
    reference: service-name2
    prefix: service-name2

# Deploy service with minimal settings for update below
# To test a deploy of a setting update the deploy below.
- execute_command:
    command: run deploy --image gcr.io/knative-samples/helloworld-nodejs $$service-name$$
    events:
    - api_call:
        expect_request:
          uri: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/locations/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '8431'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            name: do-not-delete-gke-knative-test-cluster
            nodeConfig:
              machineType: n1-standard-2
              diskSizeGb: 100
              oauthScopes:
              - https://www.googleapis.com/auth/cloud-platform
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring.write
              - https://www.googleapis.com/auth/pubsub
              imageType: COS
              serviceAccount: default
              diskType: pd-standard
            masterAuth:
              username: admin
              password: password
              clusterCaCertificate: ==
              clientCertificate: ==
              clientKey: ==
            loggingService: logging.googleapis.com/kubernetes
            monitoringService: monitoring.googleapis.com/kubernetes
            network: default
            clusterIpv4Cidr: 10.64.0.0/14
            addonsConfig:
              httpLoadBalancing:
                disabled: true
              horizontalPodAutoscaling:
                disabled: true
              kubernetesDashboard:
                disabled: true
              networkPolicyConfig:
                disabled: true
            nodePools:
            - name: default-pool
              config:
                machineType: n1-standard-2
                diskSizeGb: 100
                oauthScopes:
                - https://www.googleapis.com/auth/cloud-platform
                - https://www.googleapis.com/auth/logging.write
                - https://www.googleapis.com/auth/monitoring.write
                - https://www.googleapis.com/auth/pubsub
                imageType: COS
                serviceAccount: default
                diskType: pd-standard
              initialNodeCount: 3
              autoscaling:
                enabled: true
                minNodeCount: 1
                maxNodeCount: 10
              management:
                autoRepair: true
              podIpv4CidrSize: 24
              selfLink: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster/nodePools/default-pool
              version: 1.11.7-gke.12
              instanceGroupUrls:
              - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-gke-kn-default-pool-2c29644d-grp
              status: RUNNING
            locations:
            - us-central1-a
            labelFingerprint: a9dc16a7
            legacyAbac: {}
            networkConfig:
              network: projects/cloud-sdk-integration-testing/global/networks/default
            defaultMaxPodsConstraint:
              maxPodsPerNode: '110'
            selfLink: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster
            zone: us-central1-a
            endpoint: 35.239.121.203
            initialClusterVersion: 1.11.6-gke.6
            currentMasterVersion: 1.12.7-gke.25
            currentNodeVersion: 1.11.7-gke.12
            createTime: '2019-02-10T22:30:24+00:00'
            status: RUNNING
            nodeIpv4CidrSize: 24
            servicesIpv4Cidr: 10.67.240.0/20
            instanceGroupUrls:
            - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-gke-kn-default-pool-2c29644d-grp
            currentNodeCount: 4
            location: us-central1-a
    - api_call:
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-length: '292'
            content-type: application/json
            status: '404'
          body:
            kind: Status
            apiVersion: v1
            metadata: {}
            status: Failure
            message: services.serving.knative.dev "$$service-name$$" not found
            reason: NotFound
            details:
              name: $$service-name$$
              group: serving.knative.dev
              kind: services
            code: 404
    - expect_stderr: |
        Deploying container to Cloud Run on GKE service [$$service-name$$] in namespace [default] of cluster [do-not-delete-gke-knative-test-cluster]
    - api_call:
        repeatable: true
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-length: '292'
            content-type: application/json
            status: '404'
          body:
            kind: Status
            apiVersion: v1
            metadata: {}
            status: Failure
            message: services.serving.knative.dev "$$service-name$$" not found
            reason: NotFound
            details:
              name: $$service-name$$
              group: serving.knative.dev
              kind: services
            code: 404
    - api_call:
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services\?alt=json
          method: POST
          headers: {}
          body:
            json:
              apiVersion: serving.knative.dev/v1alpha1
              kind: Service
              metadata:
                annotations: {}
                initializers: {}
                labels: {}
                name: $$service-name$$
                namespace: default
              spec:
                runLatest:
                  configuration:
                    revisionTemplate:
                      metadata:
                        annotations: {}
                        initializers: {}
                        labels: {}
                      spec:
                        container:
                          image: gcr.io/knative-samples/helloworld-nodejs
              status: {}
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-length: '1108'
            content-type: application/json
            status: '201'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 1
              name: $$service-name$$
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              runLatest:
                configuration:
                  revisionTemplate:
                    metadata:
                      creationTimestamp: '2019-07-23T18:13:29Z'
                      initializers:
                        pending: null
                      labels:
                        client.knative.dev/nonce: dmwqrjmbba
                    spec:
                      container:
                        image: gcr.io/knative-samples/helloworld-nodejs
                        name: ''
                        resources:
                          requests:
                            cpu: 400m
                      timeoutSeconds: 300
    - api_call:
        repeatable: true
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-length: '1860'
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 1
              name: $$service-name$$
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              runLatest:
                configuration:
                  revisionTemplate:
                    metadata:
                      creationTimestamp: '2019-07-23T18:13:29Z'
                      initializers:
                        pending: null
                      labels:
                        client.knative.dev/nonce: dmwqrjmbba
                    spec:
                      container:
                        image: gcr.io/knative-samples/helloworld-nodejs
                        name: ''
                        resources:
                          requests:
                            cpu: 400m
                      timeoutSeconds: 300
            status:
              address:
                hostname: $$service-name$$.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:01Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:01Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:01Z'
                status: 'True'
                type: RoutesReady
              domain: $$service-name$$.default.example.com
              domainInternal: $$service-name$$.default.svc.cluster.local
              latestCreatedRevisionName: $$service-name$$-rev01
              latestReadyRevisionName: $$service-name$$-rev01
              observedGeneration: 1
              traffic:
              - percent: 100
                revisionName: $$service-name$$-rev01
    - expect_staged_progress_tracker:
        message: Deploying new service...
        status: SUCCESS
        succeeded_stages: *id001
    - api_call:
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-length: '1860'
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 1
              name: $$service-name$$
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              runLatest:
                configuration:
                  revisionTemplate:
                    metadata:
                      creationTimestamp: '2019-07-23T18:13:29Z'
                      initializers:
                        pending: null
                      labels:
                        client.knative.dev/nonce: dmwqrjmbba
                    spec:
                      container:
                        image: gcr.io/knative-samples/helloworld-nodejs
                        name: ''
                        resources:
                          requests:
                            cpu: 400m
                      timeoutSeconds: 300
            status:
              address:
                hostname: $$service-name$$.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:02Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:02Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:02Z'
                status: 'True'
                type: RoutesReady
              domain: $$service-name$$.default.example.com
              domainInternal: $$service-name$$.default.svc.cluster.local
              latestCreatedRevisionName: $$service-name$$-rev01
              latestReadyRevisionName: $$service-name$$-rev01
              observedGeneration: 1
              traffic:
              - percent: 100
                revisionName: $$service-name$$-rev01
        expect_response:
          extract_references:
          - field: status.latestCreatedRevisionName
            reference: service-revision-name
          body:
            json: {}
    - expect_stderr: |
        Service [$$service-name$$] revision [$$service-revision-name$$] has been deployed and is serving 100 percent of traffic at $$service-name$$.default.example.com
    - expect_exit:
        code: 0
- execute_command:
    # Describe the service we just deployed
    command: run services describe $$service-name$$ --format="value(metadata.name)"
    events:
    - api_call:
        expect_request:
          uri: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/locations/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '8431'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            name: do-not-delete-gke-knative-test-cluster
            nodeConfig:
              machineType: n1-standard-2
              diskSizeGb: 100
              oauthScopes:
              - https://www.googleapis.com/auth/cloud-platform
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring.write
              - https://www.googleapis.com/auth/pubsub
              imageType: COS
              serviceAccount: default
              diskType: pd-standard
            masterAuth:
              username: admin
              password: password
              clusterCaCertificate: ==
              clientCertificate: ==
              clientKey: ==
            loggingService: logging.googleapis.com/kubernetes
            monitoringService: monitoring.googleapis.com/kubernetes
            network: default
            clusterIpv4Cidr: 10.64.0.0/14
            addonsConfig:
              httpLoadBalancing:
                disabled: true
              horizontalPodAutoscaling:
                disabled: true
              kubernetesDashboard:
                disabled: true
              networkPolicyConfig:
                disabled: true
            nodePools:
            - name: default-pool
              config:
                machineType: n1-standard-2
                diskSizeGb: 100
                oauthScopes:
                - https://www.googleapis.com/auth/cloud-platform
                - https://www.googleapis.com/auth/logging.write
                - https://www.googleapis.com/auth/monitoring.write
                - https://www.googleapis.com/auth/pubsub
                imageType: COS
                serviceAccount: default
                diskType: pd-standard
              initialNodeCount: 3
              autoscaling:
                enabled: true
                minNodeCount: 1
                maxNodeCount: 10
              management:
                autoRepair: true
              podIpv4CidrSize: 24
              selfLink: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster/nodePools/default-pool
              version: 1.11.7-gke.12
              instanceGroupUrls:
              - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-gke-kn-default-pool-2c29644d-grp
              status: RUNNING
            locations:
            - us-central1-a
            labelFingerprint: a9dc16a7
            legacyAbac: {}
            networkConfig:
              network: projects/cloud-sdk-integration-testing/global/networks/default
            defaultMaxPodsConstraint:
              maxPodsPerNode: '110'
            selfLink: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster
            zone: us-central1-a
            endpoint: 35.239.121.203
            initialClusterVersion: 1.11.6-gke.6
            currentMasterVersion: 1.12.7-gke.25
            currentNodeVersion: 1.11.7-gke.12
            createTime: '2019-02-10T22:30:24+00:00'
            status: RUNNING
            nodeIpv4CidrSize: 24
            servicesIpv4Cidr: 10.67.240.0/20
            instanceGroupUrls:
            - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-gke-kn-default-pool-2c29644d-grp
            currentNodeCount: 4
            location: us-central1-a
    - api_call:
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-length: '1860'
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 1
              name: $$service-name$$
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              runLatest:
                configuration:
                  revisionTemplate:
                    metadata:
                      creationTimestamp: '2019-07-23T18:13:29Z'
                      initializers:
                        pending: null
                      labels:
                        client.knative.dev/nonce: dmwqrjmbba
                    spec:
                      container:
                        image: gcr.io/knative-samples/helloworld-nodejs
                        name: ''
                        resources:
                          requests:
                            cpu: 400m
                      timeoutSeconds: 300
            status:
              address:
                hostname: $$service-name$$.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:03Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:03Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:03Z'
                status: 'True'
                type: RoutesReady
              domain: $$service-name$$.default.example.com
              domainInternal: $$service-name$$.default.svc.cluster.local
              latestCreatedRevisionName: $$service-name$$-rev01
              latestReadyRevisionName: $$service-name$$-rev01
              observedGeneration: 1
              traffic:
              - percent: 100
                revisionName: $$service-name$$-rev01
    - expect_stdout: |
        $$service-name$$
    - expect_exit:
        code: 0
- execute_command:
    command: run services update $$service-name$$ --memory 512Mi --concurrency 3 --update-env-vars
      FOO=bar --connectivity internal --min-instances 0 --max-instances 2
    events:
    - api_call:
        expect_request:
          uri: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/locations/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '8431'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            name: do-not-delete-gke-knative-test-cluster
            nodeConfig:
              machineType: n1-standard-2
              diskSizeGb: 100
              oauthScopes:
              - https://www.googleapis.com/auth/cloud-platform
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring.write
              - https://www.googleapis.com/auth/pubsub
              imageType: COS
              serviceAccount: default
              diskType: pd-standard
            masterAuth:
              username: admin
              password: password
              clusterCaCertificate: ==
              clientCertificate: ==
              clientKey: ==
            loggingService: logging.googleapis.com/kubernetes
            monitoringService: monitoring.googleapis.com/kubernetes
            network: default
            clusterIpv4Cidr: 10.64.0.0/14
            addonsConfig:
              httpLoadBalancing:
                disabled: true
              horizontalPodAutoscaling:
                disabled: true
              kubernetesDashboard:
                disabled: true
              networkPolicyConfig:
                disabled: true
            nodePools:
            - name: default-pool
              config:
                machineType: n1-standard-2
                diskSizeGb: 100
                oauthScopes:
                - https://www.googleapis.com/auth/cloud-platform
                - https://www.googleapis.com/auth/logging.write
                - https://www.googleapis.com/auth/monitoring.write
                - https://www.googleapis.com/auth/pubsub
                imageType: COS
                serviceAccount: default
                diskType: pd-standard
              initialNodeCount: 3
              autoscaling:
                enabled: true
                minNodeCount: 1
                maxNodeCount: 10
              management:
                autoRepair: true
              podIpv4CidrSize: 24
              selfLink: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster/nodePools/default-pool
              version: 1.11.7-gke.12
              instanceGroupUrls:
              - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-gke-kn-default-pool-2c29644d-grp
              status: RUNNING
            locations:
            - us-central1-a
            labelFingerprint: a9dc16a7
            legacyAbac: {}
            networkConfig:
              network: projects/cloud-sdk-integration-testing/global/networks/default
            defaultMaxPodsConstraint:
              maxPodsPerNode: '110'
            selfLink: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster
            zone: us-central1-a
            endpoint: 35.239.121.203
            initialClusterVersion: 1.11.6-gke.6
            currentMasterVersion: 1.12.7-gke.25
            currentNodeVersion: 1.11.7-gke.12
            createTime: '2019-02-10T22:30:24+00:00'
            status: RUNNING
            nodeIpv4CidrSize: 24
            servicesIpv4Cidr: 10.67.240.0/20
            instanceGroupUrls:
            - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-gke-kn-default-pool-2c29644d-grp
            currentNodeCount: 4
            location: us-central1-a
    - api_call:
        expect_request:
          uri:
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-length: '1860'
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 1
              name: $$service-name$$
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              runLatest:
                configuration:
                  revisionTemplate:
                    metadata:
                      creationTimestamp: '2019-07-23T18:13:29Z'
                      initializers:
                        pending: null
                      labels:
                        client.knative.dev/nonce: dmwqrjmbba
                    spec:
                      container:
                        image: gcr.io/knative-samples/helloworld-nodejs
                        name: ''
                        resources:
                          requests:
                            cpu: 400m
                      timeoutSeconds: 300
            status:
              address:
                hostname: $$service-name$$.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:04Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:04Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:04Z'
                status: 'True'
                type: RoutesReady
              domain: $$service-name$$.default.example.com
              domainInternal: $$service-name$$.default.svc.cluster.local
              latestCreatedRevisionName: $$service-name$$-rev01
              latestReadyRevisionName: $$service-name$$-rev01
              observedGeneration: 1
              traffic:
              - percent: 100
                revisionName: $$service-name$$-rev01
    - api_call:
        expect_request:
          uri:
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/revisions\?alt=json&labelSelector=client.knative.dev%2Fnonce\+%3D\+.*
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            items:
            - apiVersion: serving.knative.dev/v1alpha1
              kind: Revision
              metadata:
                annotations:
                  serving.knative.dev/lastPinned: '1566434631'
                creationTimestamp: '2019-07-23T18:13:29Z'
                generateName: $$service-name$$-
                generation: 1
                labels:
                  client.knative.dev/nonce: dmwqrjmbba
                  serving.knative.dev/configuration: $$service-name$$
                  serving.knative.dev/configurationGeneration: '1'
                  serving.knative.dev/configurationMetadataGeneration: '1'
                  serving.knative.dev/service: $$service-name$$
                name: service-name-20190822-004346-40vj-6bxsb
                namespace: default
                ownerReferences:
                - apiVersion: serving.knative.dev/v1alpha1
                  blockOwnerDeletion: true
                  controller: true
                  kind: Configuration
                  name: $$service-name$$
                  uid: 92610cc6-ad75-11e9-b545-42010a800168
                resourceVersion: '51639050'
                selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/revisions/service-name-20190822-004346-40vj-6bxsb
                uid: 92610cc6-ad75-11e9-b545-42010a800168
              spec:
                container:
                  image: gcr.io/knative-samples/helloworld-nodejs
                  name: ''
                  resources:
                    requests:
                      cpu: 400m
                timeoutSeconds: 300
              status:
                conditions:
                - lastTransitionTime: '2019-07-23T20:10:05Z'
                  severity: Info
                  status: 'True'
                  type: Active
                - lastTransitionTime: '2019-07-23T20:10:05Z'
                  status: 'True'
                  type: BuildSucceeded
                - lastTransitionTime: '2019-07-23T20:10:05Z'
                  status: 'True'
                  type: ContainerHealthy
                - lastTransitionTime: '2019-07-23T20:10:05Z'
                  status: 'True'
                  type: Ready
                - lastTransitionTime: '2019-07-23T20:10:05Z'
                  status: 'True'
                  type: ResourcesAvailable
                imageDigest: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
                logUrl: https://console.cloud.google.com/logs/viewer?advancedFilter=resource.type%3D%22k8s_container%22%0Aresource.labels.container_name%3D%22user-container%22%0Alabels.%22k8s-pod%2Fserving_knative_dev%2FrevisionUID%22%3D%22e7048d12-c475-11e9-8219-42010a80009c%22
                observedGeneration: 1
                serviceName: service-name-20190822-004346-40vj-6bxsb-service
            kind: RevisionList
            metadata:
              continue: ''
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/revisions
    - api_call:
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: PUT
          headers: {}
          body:
            json:
              apiVersion: serving.knative.dev/v1alpha1
              kind: Service
              metadata:
                annotations:
                  client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                  serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                  serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                generation: 1
                labels:
                  serving.knative.dev/visibility: cluster-local
                name: $$service-name$$
                namespace: default
                selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$
              spec:
                runLatest:
                  configuration:
                    revisionTemplate:
                      metadata:
                        annotations:
                          autoscaling.knative.dev/maxScale: '2'
                        initializers: {}
                        labels: {}
                      spec:
                        container:
                          env:
                          - name: FOO
                            value: bar
                          image: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
                          name: ''
                          resources:
                            limits:
                              memory: 512Mi
                            requests:
                              cpu: 400m
                        containerConcurrency: 3
                        timeoutSeconds: 300
              status: {}
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 2
              labels:
                serving.knative.dev/visibility: cluster-local
              name: $$service-name$$
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              runLatest:
                configuration:
                  revisionTemplate:
                    metadata:
                      annotations:
                        autoscaling.knative.dev/maxScale: '2'
                      creationTimestamp: '2019-07-23T18:13:29Z'
                      initializers:
                        pending: null
                      labels:
                        client.knative.dev/nonce: dmwqrjmbba
                        serving.knative.dev/visibility: cluster-local
                    spec:
                      container:
                        env:
                        - name: FOO
                          value: bar
                        image: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
                        name: ''
                        resources:
                          limits:
                            memory: 512Mi
                          requests:
                            cpu: 400m
                      containerConcurrency: 3
                      timeoutSeconds: 300
            status:
              address:
                hostname: $$service-name$$.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:06Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:06Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:06Z'
                status: 'True'
                type: RoutesReady
              domain: $$service-name$$.default.example.com
              domainInternal: $$service-name$$.default.svc.cluster.local
              latestCreatedRevisionName: $$service-name$$-rev01
              latestReadyRevisionName: $$service-name$$-rev01
              observedGeneration: 1
              traffic:
              - percent: 100
                revisionName: $$service-name$$-rev01
    - api_call:
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 2
              labels:
                serving.knative.dev/visibility: cluster-local
              name: $$service-name$$
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              runLatest:
                configuration:
                  revisionTemplate:
                    metadata:
                      annotations:
                        autoscaling.knative.dev/maxScale: '2'
                      creationTimestamp: '2019-07-23T18:13:29Z'
                      initializers:
                        pending: null
                      labels:
                        client.knative.dev/nonce: dmwqrjmbba
                        serving.knative.dev/visibility: cluster-local
                    spec:
                      container:
                        env:
                        - name: FOO
                          value: bar
                        image: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
                        name: ''
                        resources:
                          limits:
                            memory: 512Mi
                          requests:
                            cpu: 400m
                      containerConcurrency: 3
                      timeoutSeconds: 300
            status:
              address:
                hostname: $$service-name$$.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:07Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:07Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:07Z'
                status: 'True'
                type: RoutesReady
              domain: $$service-name$$.default.svc.cluster.local
              domainInternal: $$service-name$$.default.svc.cluster.local
              latestCreatedRevisionName: $$service-name$$-rev01
              latestReadyRevisionName: $$service-name$$-rev01
              observedGeneration: 2
              traffic:
              - percent: 100
                revisionName: $$service-name$$-rev01
        repeatable: true
    - expect_staged_progress_tracker:
        message: Deploying...
        status: SUCCESS
    - api_call:
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 2
              labels:
                serving.knative.dev/visibility: cluster-local
              name: $$service-name$$
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              runLatest:
                configuration:
                  revisionTemplate:
                    metadata:
                      annotations:
                        autoscaling.knative.dev/maxScale: '2'
                      creationTimestamp: '2019-07-23T18:13:29Z'
                      initializers:
                        pending: null
                      labels:
                        client.knative.dev/nonce: dmwqrjmbba
                        serving.knative.dev/visibility: cluster-local
                    spec:
                      container:
                        env:
                        - name: FOO
                          value: bar
                        image: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
                        name: ''
                        resources:
                          limits:
                            memory: 512Mi
                          requests:
                            cpu: 400m
                      containerConcurrency: 3
                      timeoutSeconds: 300
            status:
              address:
                hostname: $$service-name$$.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:08Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:08Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:08Z'
                status: 'True'
                type: RoutesReady
              domain: $$service-name$$.default.svc.cluster.local
              domainInternal: $$service-name$$.default.svc.cluster.local
              latestCreatedRevisionName: $$service-name$$-rev01
              latestReadyRevisionName: $$service-name$$-rev01
              observedGeneration: 2
              traffic:
              - percent: 100
                revisionName: $$service-name$$-rev01
    - api_call:
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/routes/$$service-name$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-length: '1477'
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Route
            metadata:
              creationTimestamp: '2019-07-23T18:13:29Z'
              finalizers:
              - routes.serving.knative.dev
              generation: 1
              labels:
                serving.knative.dev/service: $$service-name$$
                serving.knative.dev/visibility: cluster-local
              name: $$service-name$$
              namespace: default
              ownerReferences:
              - apiVersion: serving.knative.dev/v1alpha1
                blockOwnerDeletion: true
                controller: true
                kind: Service
                name: $$service-name$$
                uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/routes/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              traffic:
              - configurationName: $$service-name$$
                percent: 100
            status:
              address:
                hostname: $$service-name$$.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:09Z'
                status: 'True'
                type: AllTrafficAssigned
              - lastTransitionTime: '2019-07-23T20:10:09Z'
                status: 'True'
                type: IngressReady
              - lastTransitionTime: '2019-07-23T20:10:09Z'
                status: 'True'
                type: Ready
              domain: $$service-name$$.default.svc.cluster.local
              domainInternal: $$service-name$$.default.svc.cluster.local
              observedGeneration: 1
              traffic:
              - percent: 100
                revisionName: $$service-name$$-rev01
    - expect_stderr:
        # TODO(b/138313012): Update
        matches: |
          Service \[$$service-name$$\] revision \[$$service-name$$-[a-z0-9]+\] is active and serving traffic at $$service-name$$\.default\..*
    - expect_exit:
        code: 0
- write_file:
    path: service.yaml
    contents: |
      apiVersion: serving.knative.dev/v1alpha1
      kind: Service
      metadata:
        name: $$service-name$$
        namespace: default
      spec:
        runLatest:
          configuration:
            revisionTemplate:
              spec:
                container:
                  image: gcr.io/cloudrun/hello
                  name: ''
- execute_command:
    command: run services replace service.yaml
    events:
    - api_call:
        expect_request:
          uri: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/locations/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '8431'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            name: do-not-delete-gke-knative-test-cluster
            nodeConfig:
              machineType: n1-standard-2
              diskSizeGb: 100
              oauthScopes:
              - https://www.googleapis.com/auth/cloud-platform
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring.write
              - https://www.googleapis.com/auth/pubsub
              imageType: COS
              serviceAccount: default
              diskType: pd-standard
            masterAuth:
              username: admin
              password: password
              clusterCaCertificate: ==
              clientCertificate: ==
              clientKey: ==
            loggingService: logging.googleapis.com/kubernetes
            monitoringService: monitoring.googleapis.com/kubernetes
            network: default
            clusterIpv4Cidr: 10.64.0.0/14
            addonsConfig:
              httpLoadBalancing:
                disabled: true
              horizontalPodAutoscaling:
                disabled: true
              kubernetesDashboard:
                disabled: true
              networkPolicyConfig:
                disabled: true
            nodePools:
            - name: default-pool
              config:
                machineType: n1-standard-2
                diskSizeGb: 100
                oauthScopes:
                - https://www.googleapis.com/auth/cloud-platform
                - https://www.googleapis.com/auth/logging.write
                - https://www.googleapis.com/auth/monitoring.write
                - https://www.googleapis.com/auth/pubsub
                imageType: COS
                serviceAccount: default
                diskType: pd-standard
              initialNodeCount: 3
              autoscaling:
                enabled: true
                minNodeCount: 1
                maxNodeCount: 10
              management:
                autoRepair: true
              podIpv4CidrSize: 24
              selfLink: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster/nodePools/default-pool
              version: 1.11.7-gke.12
              instanceGroupUrls:
              - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-gke-kn-default-pool-2c29644d-grp
              status: RUNNING
            locations:
            - us-central1-a
            labelFingerprint: a9dc16a7
            legacyAbac: {}
            networkConfig:
              network: projects/cloud-sdk-integration-testing/global/networks/default
            defaultMaxPodsConstraint:
              maxPodsPerNode: '110'
            selfLink: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster
            zone: us-central1-a
            endpoint: 35.239.121.203
            initialClusterVersion: 1.11.6-gke.6
            currentMasterVersion: 1.12.7-gke.25
            currentNodeVersion: 1.11.7-gke.12
            createTime: '2019-02-10T22:30:24+00:00'
            status: RUNNING
            nodeIpv4CidrSize: 24
            servicesIpv4Cidr: 10.67.240.0/20
            instanceGroupUrls:
            - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-gke-kn-default-pool-2c29644d-grp
            currentNodeCount: 4
            location: us-central1-a
    - api_call:
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 2
              labels:
                serving.knative.dev/visibility: cluster-local
              name: $$service-name$$
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              runLatest:
                configuration:
                  revisionTemplate:
                    metadata:
                      annotations:
                        autoscaling.knative.dev/maxScale: '2'
                      creationTimestamp: '2019-07-23T18:13:29Z'
                      initializers:
                        pending: null
                      labels:
                        client.knative.dev/nonce: dmwqrjmbba
                        serving.knative.dev/visibility: cluster-local
                    spec:
                      container:
                        env:
                        - name: FOO
                          value: bar
                        image: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
                        name: ''
                        resources:
                          limits:
                            memory: 512Mi
                          requests:
                            cpu: 400m
                      containerConcurrency: 3
                      timeoutSeconds: 300
            status:
              address:
                hostname: $$service-name$$.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:10Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:10Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:10Z'
                status: 'True'
                type: RoutesReady
              domain: $$service-name$$.default.svc.cluster.local
              domainInternal: $$service-name$$.default.svc.cluster.local
              latestCreatedRevisionName: $$service-name$$-rev01
              latestReadyRevisionName: $$service-name$$-rev01
              observedGeneration: 2
              traffic:
              - percent: 100
                revisionName: $$service-name$$-rev01
    - expect_stderr: |
        Deploying container to Cloud Run on GKE service [$$service-name$$] in namespace [default] of cluster [do-not-delete-gke-knative-test-cluster]
    - api_call:
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 2
              labels:
                serving.knative.dev/visibility: cluster-local
              name: $$service-name$$
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              runLatest:
                configuration:
                  revisionTemplate:
                    metadata:
                      annotations:
                        autoscaling.knative.dev/maxScale: '2'
                      creationTimestamp: '2019-07-23T18:13:29Z'
                      initializers:
                        pending: null
                      labels:
                        client.knative.dev/nonce: dmwqrjmbba
                        serving.knative.dev/visibility: cluster-local
                    spec:
                      container:
                        env:
                        - name: FOO
                          value: bar
                        image: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
                        name: ''
                        resources:
                          limits:
                            memory: 512Mi
                          requests:
                            cpu: 400m
                      containerConcurrency: 3
                      timeoutSeconds: 300
            status:
              address:
                hostname: $$service-name$$.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:11Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:11Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:11Z'
                status: 'True'
                type: RoutesReady
              domain: $$service-name$$.default.svc.cluster.local
              domainInternal: $$service-name$$.default.svc.cluster.local
              latestCreatedRevisionName: $$service-name$$-rev01
              latestReadyRevisionName: $$service-name$$-rev01
              observedGeneration: 2
              traffic:
              - percent: 100
                revisionName: $$service-name$$-rev01
    - api_call:
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: PUT
          headers: {}
          body:
            json:
              apiVersion: serving.knative.dev/v1alpha1
              kind: Service
              metadata:
                name: $$service-name$$
                namespace: default
              spec: {}
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-length: '1496'
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              annotations:
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 3
              name: $$service-name$$
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              runLatest:
                configuration:
                  revisionTemplate:
                    metadata:
                      creationTimestamp: '2019-07-23T18:13:29Z'
                    spec:
                      container:
                        image: gcr.io/cloudrun/hello
                        name: ''
                        resources:
                          requests:
                            cpu: 400m
                      timeoutSeconds: 300
            status:
              address:
                hostname: $$service-name$$.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:12Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:12Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:12Z'
                status: 'True'
                type: RoutesReady
              domain: $$service-name$$.default.svc.cluster.local
              domainInternal: $$service-name$$.default.svc.cluster.local
              latestCreatedRevisionName: $$service-name$$-rev01
              latestReadyRevisionName: $$service-name$$-rev01
              observedGeneration: 2
              traffic:
              - percent: 100
                revisionName: $$service-name$$-rev01
        repeatable: true
    - api_call:
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-length: '1490'
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              annotations:
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 3
              name: $$service-name$$
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              runLatest:
                configuration:
                  revisionTemplate:
                    metadata:
                      creationTimestamp: '2019-07-23T18:13:29Z'
                    spec:
                      container:
                        image: gcr.io/cloudrun/hello
                        name: ''
                        resources:
                          requests:
                            cpu: 400m
                      timeoutSeconds: 300
            status:
              address:
                hostname: $$service-name$$.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:13Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:13Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:13Z'
                status: 'True'
                type: RoutesReady
              domain: $$service-name$$.default.example.com
              domainInternal: $$service-name$$.default.svc.cluster.local
              latestCreatedRevisionName: $$service-name$$-rev01
              latestReadyRevisionName: $$service-name$$-rev01
              observedGeneration: 3
              traffic:
              - percent: 100
                revisionName: $$service-name$$-rev01
        repeatable: true
    - expect_staged_progress_tracker:
        message: Deploying...
        status: SUCCESS
    - api_call:
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-length: '1490'
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              annotations:
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 3
              name: $$service-name$$
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              runLatest:
                configuration:
                  revisionTemplate:
                    metadata:
                      creationTimestamp: '2019-07-23T18:13:29Z'
                    spec:
                      container:
                        image: gcr.io/cloudrun/hello
                        name: ''
                        resources:
                          requests:
                            cpu: 400m
                      timeoutSeconds: 300
            status:
              address:
                hostname: $$service-name$$.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:14Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:14Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:14Z'
                status: 'True'
                type: RoutesReady
              domain: $$service-name$$.default.example.com
              domainInternal: $$service-name$$.default.svc.cluster.local
              latestCreatedRevisionName: $$service-name$$-rev01
              latestReadyRevisionName: $$service-name$$-rev01
              observedGeneration: 3
              traffic:
              - percent: 100
                revisionName: $$service-name$$-rev01
        expect_response:
          extract_references:
          - field: status.latestCreatedRevisionName
            reference: service-revision-name
          body:
            json: {}
    - expect_stderr: |
        Service [$$service-name$$] revision [$$service-revision-name$$] has been deployed and is serving 100 percent of traffic at $$service-name$$.default.example.com
    - expect_exit:
        code: 0
- execute_command:
    command: run deploy --image gcr.io/knative-samples/helloworld-nodejs $$service-name2$$
      --min-instances 1 --max-instances default
    events:
    - api_call:
        expect_request:
          uri: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/locations/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '8431'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            name: do-not-delete-gke-knative-test-cluster
            nodeConfig:
              machineType: n1-standard-2
              diskSizeGb: 100
              oauthScopes:
              - https://www.googleapis.com/auth/cloud-platform
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring.write
              - https://www.googleapis.com/auth/pubsub
              imageType: COS
              serviceAccount: default
              diskType: pd-standard
            masterAuth:
              username: admin
              password: password
              clusterCaCertificate: ==
              clientCertificate: ==
              clientKey: ==
            loggingService: logging.googleapis.com/kubernetes
            monitoringService: monitoring.googleapis.com/kubernetes
            network: default
            clusterIpv4Cidr: 10.64.0.0/14
            addonsConfig:
              httpLoadBalancing:
                disabled: true
              horizontalPodAutoscaling:
                disabled: true
              kubernetesDashboard:
                disabled: true
              networkPolicyConfig:
                disabled: true
            nodePools:
            - name: default-pool
              config:
                machineType: n1-standard-2
                diskSizeGb: 100
                oauthScopes:
                - https://www.googleapis.com/auth/cloud-platform
                - https://www.googleapis.com/auth/logging.write
                - https://www.googleapis.com/auth/monitoring.write
                - https://www.googleapis.com/auth/pubsub
                imageType: COS
                serviceAccount: default
                diskType: pd-standard
              initialNodeCount: 3
              autoscaling:
                enabled: true
                minNodeCount: 1
                maxNodeCount: 10
              management:
                autoRepair: true
              podIpv4CidrSize: 24
              selfLink: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster/nodePools/default-pool
              version: 1.11.7-gke.12
              instanceGroupUrls:
              - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-gke-kn-default-pool-2c29644d-grp
              status: RUNNING
            locations:
            - us-central1-a
            labelFingerprint: a9dc16a7
            legacyAbac: {}
            networkConfig:
              network: projects/cloud-sdk-integration-testing/global/networks/default
            defaultMaxPodsConstraint:
              maxPodsPerNode: '110'
            selfLink: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster
            zone: us-central1-a
            endpoint: 35.239.121.203
            initialClusterVersion: 1.11.6-gke.6
            currentMasterVersion: 1.12.7-gke.25
            currentNodeVersion: 1.11.7-gke.12
            createTime: '2019-02-10T22:30:24+00:00'
            status: RUNNING
            nodeIpv4CidrSize: 24
            servicesIpv4Cidr: 10.67.240.0/20
            instanceGroupUrls:
            - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-gke-kn-default-pool-2c29644d-grp
            currentNodeCount: 4
            location: us-central1-a
    - api_call:
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name2$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-length: '294'
            content-type: application/json
            status: '404'
          body:
            kind: Status
            apiVersion: v1
            metadata: {}
            status: Failure
            message: services.serving.knative.dev "$$service-name2$$" not found
            reason: NotFound
            details:
              name: $$service-name2$$
              group: serving.knative.dev
              kind: services
            code: 404
    - expect_stderr: |
        Deploying container to Cloud Run on GKE service [$$service-name2$$] in namespace [default] of cluster [do-not-delete-gke-knative-test-cluster]
    - api_call:
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name2$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-length: '294'
            content-type: application/json
            status: '404'
          body:
            kind: Status
            apiVersion: v1
            metadata: {}
            status: Failure
            message: services.serving.knative.dev "$$service-name2$$" not found
            reason: NotFound
            details:
              name: $$service-name2$$
              group: serving.knative.dev
              kind: services
            code: 404
    - api_call:
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services\?alt=json
          method: POST
          headers: {}
          body:
            json:
              apiVersion: serving.knative.dev/v1alpha1
              kind: Service
              metadata:
                annotations:
                  client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                initializers: {}
                labels: {}
                name: $$service-name2$$
                namespace: default
              spec:
                runLatest:
                  configuration:
                    revisionTemplate:
                      metadata:
                        annotations: {}
                        initializers: {}
                      spec:
                        container:
                          image: gcr.io/knative-samples/helloworld-nodejs
              status:
                address: {}
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-length: '1165'
            content-type: application/json
            status: '201'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 1
              name: $$service-name2$$
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name2$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              runLatest:
                configuration:
                  revisionTemplate:
                    metadata:
                      annotations:
                        autoscaling.knative.dev/minScale: '1'
                      creationTimestamp: '2019-07-23T18:13:29Z'
                      initializers:
                        pending: null
                      labels:
                        client.knative.dev/nonce: dmwqrjmbba
                    spec:
                      container:
                        image: gcr.io/knative-samples/helloworld-nodejs
                        name: ''
                        resources:
                          requests:
                            cpu: 400m
                      timeoutSeconds: 300
    - api_call:
        repeatable: true
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name2$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-length: '1923'
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 1
              name: $$service-name2$$
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name2$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              runLatest:
                configuration:
                  revisionTemplate:
                    metadata:
                      annotations:
                        autoscaling.knative.dev/minScale: '1'
                      creationTimestamp: '2019-07-23T18:13:29Z'
                      initializers:
                        pending: null
                      labels:
                        client.knative.dev/nonce: dmwqrjmbba
                    spec:
                      container:
                        image: gcr.io/knative-samples/helloworld-nodejs
                        name: ''
                        resources:
                          requests:
                            cpu: 400m
                      timeoutSeconds: 300
            status:
              address:
                hostname: $$service-name2$$.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:15Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:15Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:15Z'
                status: 'True'
                type: RoutesReady
              domain: $$service-name2$$.default.example.com
              domainInternal: $$service-name2$$.default.svc.cluster.local
              latestCreatedRevisionName: $$service-name2$$-rev01
              latestReadyRevisionName: $$service-name2$$-rev01
              observedGeneration: 1
              traffic:
              - percent: 100
                revisionName: $$service-name2$$-rev01
    - expect_staged_progress_tracker:
        message: Deploying new service...
        status: SUCCESS
        succeeded_stages: *id002
    - api_call:
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name2$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-length: '1923'
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 1
              name: $$service-name2$$
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name2$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              runLatest:
                configuration:
                  revisionTemplate:
                    metadata:
                      annotations:
                        autoscaling.knative.dev/minScale: '1'
                      creationTimestamp: '2019-07-23T18:13:29Z'
                      initializers:
                        pending: null
                      labels:
                        client.knative.dev/nonce: dmwqrjmbba
                    spec:
                      container:
                        image: gcr.io/knative-samples/helloworld-nodejs
                        name: ''
                        resources:
                          requests:
                            cpu: 400m
                      timeoutSeconds: 300
            status:
              address:
                hostname: $$service-name2$$.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:16Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:16Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:16Z'
                status: 'True'
                type: RoutesReady
              domain: $$service-name2$$.default.example.com
              domainInternal: $$service-name2$$.default.svc.cluster.local
              latestCreatedRevisionName: $$service-name2$$-rev01
              latestReadyRevisionName: $$service-name2$$-rev01
              observedGeneration: 1
              traffic:
              - percent: 100
                revisionName: $$service-name2$$-rev01
        repeatable: true
        expect_response:
          extract_references:
          - field: status.latestCreatedRevisionName
            reference: service-revision-name2
          body:
            json: {}
    - expect_stderr: |
        Service [$$service-name2$$] revision [$$service-revision-name2$$] has been deployed and is serving 100 percent of traffic at $$service-name2$$.default.example.com
    - expect_exit:
        code: 0
- execute_command:
    command: run services delete $$service-name$$ -q
    cleanup_for: service-name
    events:
    - api_call:
        expect_request:
          uri: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/locations/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '8431'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            name: do-not-delete-gke-knative-test-cluster
            nodeConfig:
              machineType: n1-standard-2
              diskSizeGb: 100
              oauthScopes:
              - https://www.googleapis.com/auth/cloud-platform
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring.write
              - https://www.googleapis.com/auth/pubsub
              imageType: COS
              serviceAccount: default
              diskType: pd-standard
            masterAuth:
              username: admin
              password: password
              clusterCaCertificate: ==
              clientCertificate: ==
              clientKey: ==
            loggingService: logging.googleapis.com/kubernetes
            monitoringService: monitoring.googleapis.com/kubernetes
            network: default
            clusterIpv4Cidr: 10.64.0.0/14
            addonsConfig:
              httpLoadBalancing:
                disabled: true
              horizontalPodAutoscaling:
                disabled: true
              kubernetesDashboard:
                disabled: true
              networkPolicyConfig:
                disabled: true
            nodePools:
            - name: default-pool
              config:
                machineType: n1-standard-2
                diskSizeGb: 100
                oauthScopes:
                - https://www.googleapis.com/auth/cloud-platform
                - https://www.googleapis.com/auth/logging.write
                - https://www.googleapis.com/auth/monitoring.write
                - https://www.googleapis.com/auth/pubsub
                imageType: COS
                serviceAccount: default
                diskType: pd-standard
              initialNodeCount: 3
              autoscaling:
                enabled: true
                minNodeCount: 1
                maxNodeCount: 10
              management:
                autoRepair: true
              podIpv4CidrSize: 24
              selfLink: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster/nodePools/default-pool
              version: 1.11.7-gke.12
              instanceGroupUrls:
              - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-gke-kn-default-pool-2c29644d-grp
              status: RUNNING
            locations:
            - us-central1-a
            labelFingerprint: a9dc16a7
            legacyAbac: {}
            networkConfig:
              network: projects/cloud-sdk-integration-testing/global/networks/default
            defaultMaxPodsConstraint:
              maxPodsPerNode: '110'
            selfLink: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster
            zone: us-central1-a
            endpoint: 35.239.121.203
            initialClusterVersion: 1.11.6-gke.6
            currentMasterVersion: 1.12.7-gke.25
            currentNodeVersion: 1.11.7-gke.12
            createTime: '2019-02-10T22:30:24+00:00'
            status: RUNNING
            nodeIpv4CidrSize: 24
            servicesIpv4Cidr: 10.67.240.0/20
            instanceGroupUrls:
            - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-gke-kn-default-pool-2c29644d-grp
            currentNodeCount: 4
            location: us-central1-a
    - api_call:
        expect_request:
          uri:
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-length: '217'
            content-type: application/json
            status: '200'
          body:
            kind: Status
            apiVersion: v1
            metadata: {}
            status: Success
            details:
              name: $$service-name$$
              group: serving.knative.dev
              kind: services
              uid: 92610cc6-ad75-11e9-b545-42010a800168
    - expect_stderr: |
        Deleted service [$$service-name$$].
    - expect_exit:
        code: 0

- execute_command:
    command: run services delete $$service-name2$$ -q
    cleanup_for: service-name2
    events:
    - api_call:
        expect_request:
          uri: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/locations/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '8431'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            name: do-not-delete-gke-knative-test-cluster
            nodeConfig:
              machineType: n1-standard-2
              diskSizeGb: 100
              oauthScopes:
              - https://www.googleapis.com/auth/cloud-platform
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring.write
              - https://www.googleapis.com/auth/pubsub
              imageType: COS
              serviceAccount: default
              diskType: pd-standard
            masterAuth:
              username: admin
              password: password
              clusterCaCertificate: ==
              clientCertificate: ==
              clientKey: ==
            loggingService: logging.googleapis.com/kubernetes
            monitoringService: monitoring.googleapis.com/kubernetes
            network: default
            clusterIpv4Cidr: 10.64.0.0/14
            addonsConfig:
              httpLoadBalancing:
                disabled: true
              horizontalPodAutoscaling:
                disabled: true
              kubernetesDashboard:
                disabled: true
              networkPolicyConfig:
                disabled: true
            nodePools:
            - name: default-pool
              config:
                machineType: n1-standard-2
                diskSizeGb: 100
                oauthScopes:
                - https://www.googleapis.com/auth/cloud-platform
                - https://www.googleapis.com/auth/logging.write
                - https://www.googleapis.com/auth/monitoring.write
                - https://www.googleapis.com/auth/pubsub
                imageType: COS
                serviceAccount: default
                diskType: pd-standard
              initialNodeCount: 3
              autoscaling:
                enabled: true
                minNodeCount: 1
                maxNodeCount: 10
              management:
                autoRepair: true
              podIpv4CidrSize: 24
              selfLink: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster/nodePools/default-pool
              version: 1.11.7-gke.12
              instanceGroupUrls:
              - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-gke-kn-default-pool-2c29644d-grp
              status: RUNNING
            locations:
            - us-central1-a
            labelFingerprint: a9dc16a7
            legacyAbac: {}
            networkConfig:
              network: projects/cloud-sdk-integration-testing/global/networks/default
            defaultMaxPodsConstraint:
              maxPodsPerNode: '110'
            selfLink: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster
            zone: us-central1-a
            endpoint: 35.239.121.203
            initialClusterVersion: 1.11.6-gke.6
            currentMasterVersion: 1.12.7-gke.25
            currentNodeVersion: 1.11.7-gke.12
            createTime: '2019-02-10T22:30:24+00:00'
            status: RUNNING
            nodeIpv4CidrSize: 24
            servicesIpv4Cidr: 10.67.240.0/20
            instanceGroupUrls:
            - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-gke-kn-default-pool-2c29644d-grp
            currentNodeCount: 4
            location: us-central1-a
    - api_call:
        expect_request:
          uri:
            # The uri hostname varies. With python2 it would be kubernetes.default. With
            # python3 it would be monkey patched into IP address of the gke cluster. For the monkey
            # patch information: CL/217804288.
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name2$$\?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-length: '218'
            content-type: application/json
            status: '200'
          body:
            kind: Status
            apiVersion: v1
            metadata: {}
            status: Success
            details:
              name: $$service-name2$$
              group: serving.knative.dev
              kind: services
              uid: 92610cc6-ad75-11e9-b545-42010a800168
    - expect_stderr: |
        Deleted service [$$service-name2$$].
    - expect_exit:
        code: 0
