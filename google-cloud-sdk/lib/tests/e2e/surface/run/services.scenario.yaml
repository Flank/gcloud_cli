# Tests for features supported in both the ALPHA and BETA tracks.
# Add tests for ALPHA only features to services_alpha.scenario.yaml
title: serverless services deploy, update describe and delete.
release_tracks: [BETA, GA]  # Will include ALPHA again when v1 is rolled out to both.
summary:
# This summary is generated automatically on update and should not be edited.
- set_property: run/platform managed
- execute:
  - command: run deploy --region us-central1 --image gcr.io/knative-samples/helloworld-nodejs
      $$service-name$$
  - prompt:
    - prompt_string: Allow unauthenticated invocations to [$$service-name$$]
    - input: y
  - stderr: |
      Deploying container to Cloud Run service [$$service-name$$] in project [cloud-sdk-integration-testing] region [us-central1]
  - staged_progress_tracker:
    - message: Deploying new service...
    - status: SUCCESS
    - succeeded_stages: &id001
      - Setting IAM Policy...
      - Creating Revision...
      - Routing traffic...
  - stderr: |
      Service [$$service-name$$] revision [$$service-revision-name$$] has been deployed and is serving 100 percent of traffic at https://$$service-name$$-ixwc4imo7a-uc.a.run.app
- execute:
  - command: run services describe $$service-name$$ --region us-central1 --format='text(status.conditions[].status,status.conditions[].type)'
  - stdout: |
      status.conditions[0].status: True
      status.conditions[0].type:   Ready
      status.conditions[1].status: True
      status.conditions[1].type:   ConfigurationsReady
      status.conditions[2].status: True
      status.conditions[2].type:   RoutesReady
- execute:
  - command: run services update --region us-central1 $$service-name$$ --memory 512Mi
      --add-cloudsql-instances foo,bar --concurrency 3 --update-env-vars FOO=bar
  - staged_progress_tracker:
    - message: Deploying...
    - status: SUCCESS
  - stderr: |
      Service [$$service-name$$] revision [$$service-revision-name-2$$] is active and serving traffic at https://$$service-name$$-ixwc4imo7a-uc.a.run.app
- execute:
  - command: run deploy --region us-central1 --image gcr.io/knative-samples/helloworld-nodejs
      $$service-name2$$ --async
  - prompt:
    - prompt_string: Allow unauthenticated invocations to [$$service-name2$$]
    - input: y
  - stderr: |
      Deploying container to Cloud Run service [$$service-name2$$] in project [cloud-sdk-integration-testing] region [us-central1]
  - stderr: |
      Service [$$service-name2$$] is deploying asynchronously.
- execute:
  - command: run services update --region us-central1 $$service-name$$ --memory 1024Mi
      --async
  - stderr: |
      Deploying asynchronously.
- execute:
  - command: run services delete $$service-name2$$ --region us-central1 --quiet
  - stderr: |
      Deleted service [$$service-name2$$].
- execute:
  - command: run services delete $$service-name$$ --region us-central1 --quiet
  - stderr: |
      Deleted service [$$service-name$$].
actions:
- set_property:
    run/platform: managed
- generate_resource_id:
    reference: service-name
    prefix: service-name
- generate_resource_id:
    reference: service-name2
    prefix: service-name2
- execute_command:
    # Use the prebuilt image as documented in serverless quickstart page: https://cloud.google.com/serverless-engine/docs/quickstarts/prebuilt-deploy
    command: run deploy --region us-central1 --image gcr.io/knative-samples/helloworld-nodejs
      $$service-name$$
    events:
    - api_call:
        repeatable: true
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '1016'
            content-type: application/json; charset=UTF-8
            status: '404'
          body:
            error:
              code: 404
              message: Resource '$$service-name$$' of kind 'SERVICE' in region 'us-central1'
                in project 'cloud-sdk-integration-testing' does not exist.
              status: NOT_FOUND
              details:
              - '@type': type.googleapis.com/google.rpc.DebugInfo
                detail: |-
                  [ORIGINAL ERROR] generic::not_found: userFacingMessage: Resource '$$service-name$$' of kind 'SERVICE' in region 'us-central1' in project 'cloud-sdk-integration-testing' does not exist.;
                  com.google.cloud.eventprocessing.serverless.error.NotFoundException: userFacingMessage: Resource '$$service-name$$' of kind 'SERVICE' in region 'us-central1' in project 'cloud-sdk-integration-testing' does not exist.;  Code: NOT_FOUND [google.rpc.error_details_ext] { message: "Resource \'$$service-name$$\' of kind \'SERVICE\' in region \'us-central1\' in project \'cloud-sdk-integration-testing\' does not exist." }
    - api_call:
        expect_request:
          uri: https://run.googleapis.com/v1alpha1/projects/cloud-sdk-integration-testing/locations/us-central1/services/$$service-name$$:testIamPermissions?alt=json
          method: POST
          headers: {}
          body:
            json:
              permissions:
              - run.services.setIamPolicy
        return_response:
          headers:
            cache-control: private
            content-length: '59'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            permissions:
            - run.services.setIamPolicy
    - expect_prompt_continue:
        prompt_string: Allow unauthenticated invocations to [$$service-name$$]
        user_input: y
    - expect_stderr: |
        Deploying container to Cloud Run service [$$service-name$$] in project [cloud-sdk-integration-testing] region [us-central1]
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '1016'
            content-type: application/json; charset=UTF-8
            status: '404'
          body:
            error:
              code: 404
              message: Resource '$$service-name$$' of kind 'SERVICE' in region 'us-central1'
                in project 'cloud-sdk-integration-testing' does not exist.
              status: NOT_FOUND
              details:
              - '@type': type.googleapis.com/google.rpc.DebugInfo
                detail: |-
                  [ORIGINAL ERROR] generic::not_found: userFacingMessage: Resource '$$service-name$$' of kind 'SERVICE' in region 'us-central1' in project 'cloud-sdk-integration-testing' does not exist.;
                  com.google.cloud.eventprocessing.serverless.error.NotFoundException: userFacingMessage: Resource '$$service-name$$' of kind 'SERVICE' in region 'us-central1' in project 'cloud-sdk-integration-testing' does not exist.;  Code: NOT_FOUND [google.rpc.error_details_ext] { message: "Resource \'$$service-name$$\' of kind \'SERVICE\' in region \'us-central1\' in project \'cloud-sdk-integration-testing\' does not exist." }
        repeatable: true
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services?alt=json
          method: POST
          headers: {}
          body:
            json:
              apiVersion: serving.knative.dev/v1alpha1
              kind: Service
              metadata:
                annotations:
                  client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                  run.googleapis.com/client-name: gcloud
                initializers: {}
                labels: {}
                name: $$service-name$$
                namespace: cloud-sdk-integration-testing
              spec:
                template:
                  metadata:
                    annotations:
                      run.googleapis.com/client-name: gcloud
                  spec:
                    containers:
                    - image: gcr.io/knative-samples/helloworld-nodejs
              status:
                address: {}
        return_response:
          headers:
            cache-control: private
            content-length: '1443'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              name: $$service-name$$
              namespace: cloud-sdk-integration-testing
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 1
              labels:
                cloud.googleapis.com/location: us-central1
              annotations:
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
              creationTimestamp: '2019-07-23T18:13:29Z'
            spec:
              traffic:
              - percent: 100
                latestRevision: true
              template:
                metadata:
                  name: $$service-name$$-00001-jak
                  annotations:
                    run.googleapis.com/client-name: gcloud
                spec:
                  containerConcurrency: 0
                  containers:
                  - image: gcr.io/knative-samples/helloworld-nodejs
            status: {}
    - api_call:
        expect_request:
          uri: https://run.googleapis.com/v1alpha1/projects/cloud-sdk-integration-testing/locations/us-central1/services/$$service-name$$:getIamPolicy?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '21'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            etag: ACAB
    - api_call:
        expect_request:
          uri: https://run.googleapis.com/v1alpha1/projects/cloud-sdk-integration-testing/locations/us-central1/services/$$service-name$$:setIamPolicy?alt=json
          method: POST
          headers: {}
          body:
            json:
              policy:
                bindings:
                - members:
                  - allUsers
                  role: roles/run.invoker
                etag: ACAB
        return_response:
          headers:
            cache-control: private
            content-length: '159'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            version: 1
            etag: BwWWPF6+5IM=
            bindings:
            - role: roles/run.invoker
              members:
              - allUsers
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '2542'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              name: $$service-name$$
              namespace: cloud-sdk-integration-testing
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 1
              labels:
                cloud.googleapis.com/location: us-central1
              annotations:
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
              creationTimestamp: '2019-07-23T18:13:29Z'
            spec:
              traffic:
              - percent: 100
                latestRevision: true
              template:
                metadata:
                  name: $$service-name$$-00001-jak
                  annotations:
                    run.googleapis.com/client-name: gcloud
                spec:
                  containerConcurrency: 0
                  containers:
                  - image: gcr.io/knative-samples/helloworld-nodejs
            status:
              conditions:
              - type: Ready
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: ConfigurationsReady
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: RoutesReady
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              domain: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              address:
                hostname: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
                url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              observedGeneration: 1
              traffic:
              - revisionName: $$service-name$$-00001-jak
                percent: 100
              latestReadyRevisionName: $$service-name$$-00001-jak
              latestCreatedRevisionName: $$service-name$$-00001-jak
        repeatable: true
    - expect_staged_progress_tracker:
        message: Deploying new service...
        status: SUCCESS
        succeeded_stages: *id001
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '2542'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              name: $$service-name$$
              namespace: cloud-sdk-integration-testing
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 1
              labels:
                cloud.googleapis.com/location: us-central1
              annotations:
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
              creationTimestamp: '2019-07-23T18:13:29Z'
            spec:
              traffic:
              - percent: 100
                latestRevision: true
              template:
                metadata:
                  name: $$service-name$$-00001-jak
                  annotations:
                    run.googleapis.com/client-name: gcloud
                spec:
                  containerConcurrency: 0
                  containers:
                  - image: gcr.io/knative-samples/helloworld-nodejs
            status:
              conditions:
              - type: Ready
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: ConfigurationsReady
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: RoutesReady
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              domain: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              address:
                hostname: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
                url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              observedGeneration: 1
              traffic:
              - revisionName: $$service-name$$-00001-jak
                percent: 100
              latestReadyRevisionName: $$service-name$$-00001-jak
              latestCreatedRevisionName: $$service-name$$-00001-jak
        expect_response:
          extract_references:
          - field: status.latestCreatedRevisionName
            reference: service-revision-name
          body:
            json: {}
    - expect_stderr: |
        Service [$$service-name$$] revision [$$service-revision-name$$] has been deployed and is serving 100 percent of traffic at https://$$service-name$$-ixwc4imo7a-uc.a.run.app
    - expect_exit:
        code: 0
- execute_command:
    # Describe the service we just deployed
    command: run services describe $$service-name$$ --region us-central1 --format='text(status.conditions[].status,status.conditions[].type)'
    events:
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '2542'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              name: $$service-name$$
              namespace: cloud-sdk-integration-testing
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 1
              labels:
                cloud.googleapis.com/location: us-central1
              annotations:
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
              creationTimestamp: '2019-07-23T18:13:29Z'
            spec:
              traffic:
              - percent: 100
                latestRevision: true
              template:
                metadata:
                  name: $$service-revision-name$$
                  annotations:
                    run.googleapis.com/client-name: gcloud
                spec:
                  containerConcurrency: 0
                  containers:
                  - image: gcr.io/knative-samples/helloworld-nodejs
            status:
              conditions:
              - type: Ready
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: ConfigurationsReady
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: RoutesReady
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              domain: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              address:
                hostname: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
                url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              observedGeneration: 1
              traffic:
              - revisionName: $$service-revision-name$$
                percent: 100
              latestReadyRevisionName: $$service-revision-name$$
              latestCreatedRevisionName: $$service-revision-name$$
    - expect_stdout: |
        status.conditions[0].status: True
        status.conditions[0].type:   Ready
        status.conditions[1].status: True
        status.conditions[1].type:   ConfigurationsReady
        status.conditions[2].status: True
        status.conditions[2].type:   RoutesReady

    - expect_exit:
        code: 0

- execute_command:
    command: run services update --region us-central1 $$service-name$$ --memory 512Mi
      --add-cloudsql-instances foo,bar --concurrency 3 --update-env-vars FOO=bar
    events:
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '2542'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              name: $$service-name$$
              namespace: cloud-sdk-integration-testing
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 1
              labels:
                cloud.googleapis.com/location: us-central1
              annotations:
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
              creationTimestamp: '2019-07-23T18:13:29Z'
            spec:
              traffic:
              - percent: 100
                latestRevision: true
              template:
                metadata:
                  name: $$service-revision-name$$
                  annotations:
                    run.googleapis.com/client-name: gcloud
                spec:
                  containerConcurrency: 0
                  containers:
                  - image: gcr.io/knative-samples/helloworld-nodejs
            status:
              conditions:
              - type: Ready
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: ConfigurationsReady
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: RoutesReady
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              domain: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              address:
                hostname: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
                url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              observedGeneration: 1
              traffic:
              - revisionName: $$service-revision-name$$
                percent: 100
              latestReadyRevisionName: $$service-revision-name$$
              latestCreatedRevisionName: $$service-revision-name$$
    - api_call:
        repeatable: true
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/revisions/$$service-revision-name$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '2716'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Revision
            metadata:
              name: $$service-revision-name$$
              namespace: cloud-sdk-integration-testing
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/revisions/$$service-revision-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 1
              labels:
                serving.knative.dev/route: $$service-name$$
                serving.knative.dev/configuration: $$service-name$$
                serving.knative.dev/configurationGeneration: '1'
                serving.knative.dev/service: $$service-name$$
                cloud.googleapis.com/location: us-central1
              annotations:
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              ownerReferences:
              - apiVersion: serving.knative.dev/v1alpha1
                kind: Configuration
                name: $$service-name$$
                uid: 92610cc6-ad75-11e9-b545-42010a800168
                controller: true
                blockOwnerDeletion: true
              creationTimestamp: '2019-07-23T18:13:29Z'
            spec:
              containerConcurrency: 80
              containers:
              - image: gcr.io/knative-samples/helloworld-nodejs
            status:
              logUrl: https://console.cloud.google.com/logs/viewer?project=cloud-sdk-integration-testing&resource=cloud_run_revision/service_name/$$service-name$$/revision_name/$$service-revision-name$$&advancedFilter=resource.type%3D%22cloud_run_revision%22%0Aresource.labels.service_name%3D%22$$service-name$$%22%0Aresource.labels.revision_name%3D%22$$service-revision-name$$%22
              conditions:
              - type: Ready
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: Active
                status: 'True'
                severity: Info
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: ContainerHealthy
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: ResourcesAvailable
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              observedGeneration: 1
              imageDigest: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
    - api_call:
        repeatable: true
        optional: true
        expect_request:
          uri:
            matches: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/revisions/.*
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '3407'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Revision
            metadata:
              name: $$service-revision-name$$
              namespace: cloud-sdk-integration-testing
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/revisions/$$service-revision-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 1
              creationTimestamp: '2019-07-23T18:13:29Z'
              labels:
                serving.knative.dev/route: $$service-name$$
                serving.knative.dev/configuration: $$service-name$$
                client.knative.dev/nonce: dmwqrjmbba
                serving.knative.dev/configurationGeneration: '1'
                serving.knative.dev/service: $$service-name$$
                cloud.googleapis.com/location: us-central1
              annotations:
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
              ownerReferences:
              - kind: Configuration
                name: $$service-name$$
                uid: 92610cc6-ad75-11e9-b545-42010a800168
                apiVersion: serving.knative.dev/v1alpha1
                controller: true
                blockOwnerDeletion: true
            spec:
              container:
                image: gcr.io/knative-samples/helloworld-nodejs
              servingState: ACTIVE
            status:
              logUrl: https://console.cloud.google.com/logs/viewer?project=cloud-sdk-integration-testing&resource=cloud_run_revision/service_name/$$service-name$$/revision_name/$$service-revision-name$$&advancedFilter=resource.type%3D%22cloud_run_revision%22%0Aresource.labels.service_name%3D%22$$service-name$$%22%0Aresource.labels.revision_name%3D%22$$service-revision-name$$%22
              conditions:
              - type: Ready
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: ResourcesAvailable
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: ContainerHealthy
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: Active
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              observedGeneration: 1
              imageDigest: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$?alt=json
          method: PUT
          headers: {}
          body:
            json:
              apiVersion: serving.knative.dev/v1alpha1
              kind: Service
              metadata:
                annotations:
                  client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                generation: 1
                labels:
                  cloud.googleapis.com/location: us-central1
                name: $$service-name$$
                namespace: cloud-sdk-integration-testing
                selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$
              spec: {}
              status:
                observedGeneration: 1
        return_response:
          headers:
            cache-control: private
            content-length: '3043'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              name: $$service-name$$
              namespace: cloud-sdk-integration-testing
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 2
              labels:
                cloud.googleapis.com/location: us-central1
              annotations:
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
              creationTimestamp: '2019-07-23T18:13:29Z'
            spec:
              traffic:
              - percent: 100
                latestRevision: true
              template:
                metadata:
                  name: $$service-name$$-00002-zag
                  annotations:
                    run.googleapis.com/client-name: gcloud
                    run.googleapis.com/cloudsql-instances: cloud-sdk-integration-testing:us-central1:foo,cloud-sdk-integration-testing:us-central1:bar
                spec:
                  containerConcurrency: 3
                  containers:
                  - image: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
                    env:
                    - name: FOO
                      value: bar
                    resources:
                      limits:
                        memory: 512Mi
            status:
              conditions:
              - type: Ready
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: ConfigurationsReady
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: RoutesReady
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              domain: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              address:
                hostname: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
                url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              observedGeneration: 1
              traffic:
              - revisionName: $$service-revision-name$$
                percent: 100
              latestReadyRevisionName: $$service-revision-name$$
              latestCreatedRevisionName: $$service-revision-name$$
    - api_call:
        repeatable: true
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '3043'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              name: $$service-name$$
              namespace: cloud-sdk-integration-testing
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 2
              labels:
                cloud.googleapis.com/location: us-central1
              annotations:
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
              creationTimestamp: '2019-07-23T18:13:29Z'
            spec:
              traffic:
              - percent: 100
                latestRevision: true
              template:
                metadata:
                  name: $$service-name$$-00002-zag
                  annotations:
                    run.googleapis.com/client-name: gcloud
                    run.googleapis.com/cloudsql-instances: cloud-sdk-integration-testing:us-central1:foo,cloud-sdk-integration-testing:us-central1:bar
                spec:
                  containerConcurrency: 3
                  containers:
                  - image: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
                    env:
                    - name: FOO
                      value: bar
                    resources:
                      limits:
                        memory: 512Mi
            status:
              conditions:
              - type: Ready
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: ConfigurationsReady
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: RoutesReady
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              domain: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              address:
                hostname: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
                url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              observedGeneration: 2
              traffic:
              - revisionName: $$service-name$$-00002-zag
                percent: 100
              latestReadyRevisionName: $$service-name$$-00002-zag
              latestCreatedRevisionName: $$service-name$$-00002-zag
    - expect_staged_progress_tracker:
        message: Deploying...
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '3043'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              name: $$service-name$$
              namespace: cloud-sdk-integration-testing
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 2
              labels:
                cloud.googleapis.com/location: us-central1
              annotations:
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
              creationTimestamp: '2019-07-23T18:13:29Z'
            spec:
              traffic:
              - percent: 100
                latestRevision: true
              template:
                metadata:
                  name: $$service-name$$-00002-zag
                  annotations:
                    run.googleapis.com/client-name: gcloud
                    run.googleapis.com/cloudsql-instances: cloud-sdk-integration-testing:us-central1:foo,cloud-sdk-integration-testing:us-central1:bar
                spec:
                  containerConcurrency: 3
                  containers:
                  - image: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
                    env:
                    - name: FOO
                      value: bar
                    resources:
                      limits:
                        memory: 512Mi
            status:
              conditions:
              - type: Ready
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: ConfigurationsReady
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: RoutesReady
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              domain: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              address:
                hostname: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
                url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              observedGeneration: 2
              traffic:
              - revisionName: $$service-name$$-00002-zag
                percent: 100
              latestReadyRevisionName: $$service-name$$-00002-zag
              latestCreatedRevisionName: $$service-name$$-00002-zag
        expect_response:
          extract_references:
          - field: status.latestCreatedRevisionName
            reference: service-revision-name-2
          body:
            json: {}
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/routes/$$service-name$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '2312'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Route
            metadata:
              name: $$service-name$$
              namespace: cloud-sdk-integration-testing
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/routes/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 1
              creationTimestamp: '2019-07-23T18:13:29Z'
              labels:
                serving.knative.dev/service: $$service-name$$
                cloud.googleapis.com/location: us-central1
              annotations:
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
              ownerReferences:
              - kind: Service
                name: $$service-name$$
                uid: 92610cc6-ad75-11e9-b545-42010a800168
                apiVersion: serving.knative.dev/v1alpha1
                controller: true
                blockOwnerDeletion: true
            spec:
              traffic:
              - configurationName: $$service-name$$
                percent: 100
            status:
              domain: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              traffic:
              - revisionName: $$service-revision-name-2$$
                percent: 100
              conditions:
              - type: Ready
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              observedGeneration: 1
              domainInternal: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              address:
                hostname: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
                url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
    - expect_stderr: |
        Service [$$service-name$$] revision [$$service-revision-name-2$$] is active and serving traffic at https://$$service-name$$-ixwc4imo7a-uc.a.run.app
    - expect_exit:
        code: 0
- execute_command:
    # Use the prebuilt image as documented in serverless quickstart page: https://cloud.google.com/serverless-engine/docs/quickstarts/prebuilt-deploy
    command: run deploy --region us-central1 --image gcr.io/knative-samples/helloworld-nodejs
      $$service-name2$$ --async
    events:
    - api_call:
        repeatable: true
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name2$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '1020'
            content-type: application/json; charset=UTF-8
            status: '404'
          body:
            error:
              code: 404
              message: Resource '$$service-name2$$' of kind 'SERVICE' in region 'us-central1'
                in project 'cloud-sdk-integration-testing' does not exist.
              status: NOT_FOUND
              details:
              - '@type': type.googleapis.com/google.rpc.DebugInfo
                detail: |-
                  [ORIGINAL ERROR] generic::not_found: userFacingMessage: Resource '$$service-name2$$' of kind 'SERVICE' in region 'us-central1' in project 'cloud-sdk-integration-testing' does not exist.;
                  com.google.cloud.eventprocessing.serverless.error.NotFoundException: userFacingMessage: Resource '$$service-name2$$' of kind 'SERVICE' in region 'us-central1' in project 'cloud-sdk-integration-testing' does not exist.;  Code: NOT_FOUND [google.rpc.error_details_ext] { message: "Resource \'$$service-name2$$\' of kind \'SERVICE\' in region \'us-central1\' in project \'cloud-sdk-integration-testing\' does not exist." }
    - api_call:
        expect_request:
          uri: https://run.googleapis.com/v1alpha1/projects/cloud-sdk-integration-testing/locations/us-central1/services/$$service-name2$$:testIamPermissions?alt=json
          method: POST
          headers: {}
          body:
            json:
              permissions:
              - run.services.setIamPolicy
        return_response:
          headers:
            cache-control: private
            content-length: '59'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            permissions:
            - run.services.setIamPolicy
    - expect_prompt_continue:
        prompt_string: Allow unauthenticated invocations to [$$service-name2$$]
        user_input: y
    - expect_stderr: |
        Deploying container to Cloud Run service [$$service-name2$$] in project [cloud-sdk-integration-testing] region [us-central1]
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name2$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '1020'
            content-type: application/json; charset=UTF-8
            status: '404'
          body:
            error:
              code: 404
              message: Resource '$$service-name2$$' of kind 'SERVICE' in region 'us-central1'
                in project 'cloud-sdk-integration-testing' does not exist.
              status: NOT_FOUND
              details:
              - '@type': type.googleapis.com/google.rpc.DebugInfo
                detail: |-
                  [ORIGINAL ERROR] generic::not_found: userFacingMessage: Resource '$$service-name2$$' of kind 'SERVICE' in region 'us-central1' in project 'cloud-sdk-integration-testing' does not exist.;
                  com.google.cloud.eventprocessing.serverless.error.NotFoundException: userFacingMessage: Resource '$$service-name2$$' of kind 'SERVICE' in region 'us-central1' in project 'cloud-sdk-integration-testing' does not exist.;  Code: NOT_FOUND [google.rpc.error_details_ext] { message: "Resource \'$$service-name2$$\' of kind \'SERVICE\' in region \'us-central1\' in project \'cloud-sdk-integration-testing\' does not exist." }
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services?alt=json
          method: POST
          headers: {}
          body:
            json:
              apiVersion: serving.knative.dev/v1alpha1
              kind: Service
              metadata:
                annotations:
                  client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                  run.googleapis.com/client-name: gcloud
                initializers: {}
                labels: {}
                name: $$service-name2$$
                namespace: cloud-sdk-integration-testing
              spec:
                template:
                  metadata:
                    annotations:
                      run.googleapis.com/client-name: gcloud
                  spec:
                    containers:
                    - image: gcr.io/knative-samples/helloworld-nodejs
              status:
                address: {}
        return_response:
          headers:
            cache-control: private
            content-length: '1446'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              name: $$service-name2$$
              namespace: cloud-sdk-integration-testing
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name2$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 1
              labels:
                cloud.googleapis.com/location: us-central1
              annotations:
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
              creationTimestamp: '2019-07-23T18:13:29Z'
            spec:
              traffic:
              - percent: 100
                latestRevision: true
              template:
                metadata:
                  name: $$service-name2$$-00001-zoc
                  annotations:
                    run.googleapis.com/client-name: gcloud
                spec:
                  containerConcurrency: 0
                  containers:
                  - image: gcr.io/knative-samples/helloworld-nodejs
            status: {}
    - api_call:
        expect_request:
          uri: https://run.googleapis.com/v1alpha1/projects/cloud-sdk-integration-testing/locations/us-central1/services/$$service-name2$$:getIamPolicy?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '21'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            etag: ACAB
    - api_call:
        expect_request:
          uri: https://run.googleapis.com/v1alpha1/projects/cloud-sdk-integration-testing/locations/us-central1/services/$$service-name2$$:setIamPolicy?alt=json
          method: POST
          headers: {}
          body:
            json:
              policy:
                bindings:
                - members:
                  - allUsers
                  role: roles/run.invoker
        return_response:
          headers:
            cache-control: private
            content-length: '159'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            version: 1
            etag: BwWWPGG25tM=
            bindings:
            - role: roles/run.invoker
              members:
              - allUsers
    - expect_stderr: |
        Service [$$service-name2$$] is deploying asynchronously.
    - expect_exit:
        code: 0
- execute_command:
    # Use the prebuilt image as documented in serverless quickstart page: https://cloud.google.com/serverless-engine/docs/quickstarts/prebuilt-deploy
    command: run services update --region us-central1 $$service-name$$ --memory 1024Mi
      --async
    events:
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '3043'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              name: $$service-name$$
              namespace: cloud-sdk-integration-testing
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 2
              labels:
                cloud.googleapis.com/location: us-central1
              annotations:
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
              creationTimestamp: '2019-07-23T18:13:29Z'
            spec:
              traffic:
              - percent: 100
                latestRevision: true
              template:
                metadata:
                  name: $$service-revision-name-2$$
                  annotations:
                    run.googleapis.com/client-name: gcloud
                    run.googleapis.com/cloudsql-instances: cloud-sdk-integration-testing:us-central1:foo,cloud-sdk-integration-testing:us-central1:bar
                spec:
                  containerConcurrency: 3
                  containers:
                  - image: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
                    env:
                    - name: FOO
                      value: bar
                    resources:
                      limits:
                        memory: 512Mi
            status:
              conditions:
              - type: Ready
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: ConfigurationsReady
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: RoutesReady
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              domain: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              address:
                hostname: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
                url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              observedGeneration: 2
              traffic:
              - revisionName: $$service-revision-name-2$$
                percent: 100
              latestReadyRevisionName: $$service-revision-name-2$$
              latestCreatedRevisionName: $$service-revision-name-2$$
    - api_call:
        repeatable: true
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$?alt=json
          method: PUT
          headers: {}
          body:
            json:
              apiVersion: serving.knative.dev/v1alpha1
              kind: Service
              metadata:
                annotations:
                  client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                generation: 2
                labels:
                  cloud.googleapis.com/location: us-central1
                name: $$service-name$$
                namespace: cloud-sdk-integration-testing
                selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$
              spec:
                template:
                  metadata:
                    annotations:
                      run.googleapis.com/cloudsql-instances: cloud-sdk-integration-testing:us-central1:foo,cloud-sdk-integration-testing:us-central1:bar
                  spec:
                    containerConcurrency: 3
                    containers:
                    - image: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
                      env:
                      - name: FOO
                        value: bar
                      resources:
                        limits:
                          memory: 1024Mi
              status:
                conditions:
                - status: 'True'
                  type: Ready
                - status: 'True'
                  type: ConfigurationsReady
                - status: 'True'
                  type: RoutesReady
                observedGeneration: 2
        return_response:
          headers:
            cache-control: private
            content-length: '3044'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              name: $$service-name$$
              namespace: cloud-sdk-integration-testing
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 3
              labels:
                cloud.googleapis.com/location: us-central1
              annotations:
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
              creationTimestamp: '2019-07-23T18:13:29Z'
            spec:
              traffic:
              - percent: 100
                latestRevision: true
              template:
                metadata:
                  name: $$service-name$$-00003-qow
                  annotations:
                    run.googleapis.com/client-name: gcloud
                    run.googleapis.com/cloudsql-instances: cloud-sdk-integration-testing:us-central1:foo,cloud-sdk-integration-testing:us-central1:bar
                spec:
                  containerConcurrency: 3
                  containers:
                  - image: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
                    env:
                    - name: FOO
                      value: bar
                    resources:
                      limits:
                        memory: 1024Mi
            status:
              conditions:
              - type: Ready
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: ConfigurationsReady
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              - type: RoutesReady
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:28Z'
              domain: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              address:
                hostname: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
                url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              url: https://$$service-name$$-ixwc4imo7a-uc.a.run.app
              observedGeneration: 2
              traffic:
              - revisionName: $$service-revision-name-2$$
                percent: 100
              latestReadyRevisionName: $$service-revision-name-2$$
              latestCreatedRevisionName: $$service-revision-name-2$$
    - expect_stderr: |
        Deploying asynchronously.
    - expect_exit:
        code: 0
- execute_command:
    # Clean up the test service
    command: run services delete $$service-name2$$ --region us-central1 --quiet
    cleanup_for: service-name2
    events:
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name2$$?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '3'
            content-type: application/json; charset=UTF-8
            status: '200'
          body: |
            {}
    - expect_stderr: |
        Deleted service [$$service-name2$$].
    - expect_exit:
        code: 0

- execute_command:
    # Clean up the test service
    command: run services delete $$service-name$$ --region us-central1 --quiet
    cleanup_for: service-name
    events:
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1alpha1/namespaces/cloud-sdk-integration-testing/services/$$service-name$$?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '3'
            content-type: application/json; charset=UTF-8
            status: '200'
          body: |
            {}
    - expect_stderr: |
        Deleted service [$$service-name$$].
    - expect_exit:
        code: 0
