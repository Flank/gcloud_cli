title: Serverless connection to knative cluster by client cert.
release_tracks: [ALPHA]
summary:
# This summary is generated automatically on update and should not be edited.
- set_property: run/platform kubernetes
- execute:
  - command: run deploy --kubeconfig robot-kubeconfig.yaml --image "gcr.io/knative-samples/helloworld-nodejs"
      $$service-name$$
  - stderr: |
      Deploying container to Kubernetes Cluster service [$$service-name$$] in namespace [default] of context [gke_cloud-sdk-integration-testing_us-central1-a_do-not-delete-gke-knative-test-cluster] referenced by config file [robot-kubeconfig.yaml]
  - staged_progress_tracker:
    - message: Deploying new service...
    - status: SUCCESS
    - succeeded_stages: &id001
      - Creating Revision...
      - Routing traffic...
  - stderr: |
      Service [$$service-name$$] revision [$$service-name$$-hrsx6] has been deployed and is serving 100 percent of traffic at $$service-name$$.default.example.com
- execute:
  - command: run services delete --kubeconfig robot-kubeconfig.yaml $$service-name$$
      -q
  - stderr: |
      Deleted service [$$service-name$$].
actions:
- load_resource:
    path: tests/e2e/surface/run/test_data/robot-kubeconfig.yaml
- set_property:
    run/platform: kubernetes
- generate_resource_id:
    reference: service-name
    prefix: service-name
- execute_command:
    command: run deploy --kubeconfig robot-kubeconfig.yaml --image "gcr.io/knative-samples/helloworld-nodejs"
      $$service-name$$
    events:
    - api_call:
        expect_request:
          uri:
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: c41baf0f-8043-495c-8298-17c915b2d4d6
            content-length: '292'
            content-type: application/json
            status: '404'
          body:
            kind: Status
            apiVersion: v1
            metadata: {}
            status: Failure
            message: services.serving.knative.dev "$$service-name$$" not found
            reason: NotFound
            details:
              name: $$service-name$$
              group: serving.knative.dev
              kind: services
            code: 404
    - expect_stderr: |
        Deploying container to Kubernetes Cluster service [$$service-name$$] in namespace [default] of context [gke_cloud-sdk-integration-testing_us-central1-a_do-not-delete-gke-knative-test-cluster] referenced by config file [robot-kubeconfig.yaml]
    - api_call:
        expect_request:
          uri:
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: 8961bc5e-9ca5-43b3-b9fa-78f75ea8a345
            content-length: '292'
            content-type: application/json
            status: '404'
          body:
            kind: Status
            apiVersion: v1
            metadata: {}
            status: Failure
            message: services.serving.knative.dev "$$service-name$$" not found
            reason: NotFound
            details:
              name: $$service-name$$
              group: serving.knative.dev
              kind: services
            code: 404
    - api_call:
        expect_request:
          uri:
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services\?alt=json
          method: POST
          headers: {}
          body:
            json:
              apiVersion: serving.knative.dev/v1alpha1
              kind: Service
              metadata:
                annotations:
                  client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                  run.googleapis.com/client-name: gcloud
                initializers: {}
                labels: {}
                name: $$service-name$$
                namespace: default
              spec:
                runLatest:
                  configuration:
                    revisionTemplate:
                      metadata:
                        annotations: {}
                        initializers: {}
                      spec:
                        container:
                          image: gcr.io/knative-samples/helloworld-nodejs
              status:
                address: {}
        return_response:
          headers:
            audit-id: 2922a3af-34a0-4265-8169-c55953fc689d
            content-length: '968'
            content-type: application/json
            status: '201'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: robot
                serving.knative.dev/lastModifier: robot
              creationTimestamp: '2019-08-26T22:12:38Z'
              generation: 1
              name: $$service-name$$
              namespace: default
              resourceVersion: '66517193'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$
              uid: 9d1c6693-c84e-11e9-8219-42010a80009c
            spec:
              runLatest:
                configuration:
                  revisionTemplate:
                    metadata:
                      creationTimestamp: null
                      initializers:
                        pending: null
                      labels:
                        client.knative.dev/nonce: qyirkywmsa
                    spec:
                      container:
                        image: gcr.io/knative-samples/helloworld-nodejs
                        name: ''
                        resources:
                          requests:
                            cpu: 400m
                      timeoutSeconds: 300
    - api_call:
        expect_request:
          uri:
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: d4fabd0e-d67f-4e5b-aa61-1c0b4f7dac03
            content-length: '1720'
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: robot
                serving.knative.dev/lastModifier: robot
              creationTimestamp: '2019-08-26T22:12:38Z'
              generation: 1
              name: $$service-name$$
              namespace: default
              resourceVersion: '66517291'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$
              uid: 9d1c6693-c84e-11e9-8219-42010a80009c
            spec:
              runLatest:
                configuration:
                  revisionTemplate:
                    metadata:
                      creationTimestamp: null
                      initializers:
                        pending: null
                      labels:
                        client.knative.dev/nonce: qyirkywmsa
                    spec:
                      container:
                        image: gcr.io/knative-samples/helloworld-nodejs
                        name: ''
                        resources:
                          requests:
                            cpu: 400m
                      timeoutSeconds: 300
            status:
              address:
                hostname: $$service-name$$.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-08-26T22:12:40Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-08-26T22:12:40Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-08-26T22:12:40Z'
                status: 'True'
                type: RoutesReady
              domain: $$service-name$$.default.example.com
              domainInternal: $$service-name$$.default.svc.cluster.local
              latestCreatedRevisionName: $$service-name$$-hrsx6
              latestReadyRevisionName: $$service-name$$-hrsx6
              observedGeneration: 1
              traffic:
              - percent: 100
                revisionName: $$service-name$$-hrsx6
        repeatable: true
    - expect_staged_progress_tracker:
        message: Deploying new service...
        status: SUCCESS
        succeeded_stages: *id001
    - api_call:
        expect_request:
          uri:
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b724e8fb-25ea-4621-8f9c-c1f610681617
            content-length: '1720'
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1alpha1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: robot
                serving.knative.dev/lastModifier: robot
              creationTimestamp: '2019-08-26T22:12:38Z'
              generation: 1
              name: $$service-name$$
              namespace: default
              resourceVersion: '66517291'
              selfLink: /apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$
              uid: 9d1c6693-c84e-11e9-8219-42010a80009c
            spec:
              runLatest:
                configuration:
                  revisionTemplate:
                    metadata:
                      creationTimestamp: null
                      initializers:
                        pending: null
                      labels:
                        client.knative.dev/nonce: qyirkywmsa
                    spec:
                      container:
                        image: gcr.io/knative-samples/helloworld-nodejs
                        name: ''
                        resources:
                          requests:
                            cpu: 400m
                      timeoutSeconds: 300
            status:
              address:
                hostname: $$service-name$$.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-08-26T22:12:40Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-08-26T22:12:40Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-08-26T22:12:40Z'
                status: 'True'
                type: RoutesReady
              domain: $$service-name$$.default.example.com
              domainInternal: $$service-name$$.default.svc.cluster.local
              latestCreatedRevisionName: $$service-name$$-hrsx6
              latestReadyRevisionName: $$service-name$$-hrsx6
              observedGeneration: 1
              traffic:
              - percent: 100
                revisionName: $$service-name$$-hrsx6
        repeatable: true
    - expect_stderr:
        matches: |
          Service \[$$service-name$$\] revision \[$$service-name$$-.*\] has been deployed and is serving 100 percent of traffic at $$service-name$$.default.example.com
    - expect_exit:
        code: 0
- execute_command:
    command: run services delete --kubeconfig robot-kubeconfig.yaml $$service-name$$
      -q
    cleanup_for: service-name
    events:
    - api_call:
        expect_request:
          uri:
            matches: https://.*/apis/serving.knative.dev/v1alpha1/namespaces/default/services/$$service-name$$\?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: 40ed614f-6d70-4637-83b9-96a68e2934a6
            content-length: '217'
            content-type: application/json
            status: '200'
          body:
            kind: Status
            apiVersion: v1
            metadata: {}
            status: Success
            details:
              name: $$service-name$$
              group: serving.knative.dev
              kind: services
              uid: 9d1c6693-c84e-11e9-8219-42010a80009c
    - expect_stderr: |
        Deleted service [$$service-name$$].
    - expect_exit:
        code: 0
