title: A test of filestore backup restoration.
release_tracks: [BETA]
summary:
# This summary is generated by http://go/gcloud-scenario-tests on update and should not be edited.
- execute:
  - command: filestore instances create $$instance$$ --zone us-east1-c --tier STANDARD
      --file-share=name="my_vol",capacity=1TB --network=name=filestore-net
  - progress_tracker:
    - message: Waiting for [$$operation-basename$$] to finish
    - status: SUCCESS
- execute:
  - command: filestore backups create $$backup$$ --region us-east1 --instance $$instance$$
      --instance-zone us-east1-c --file-share="my_vol"
  - stderr: |
      Create request issued
  - progress_tracker:
    - message: Waiting for operation [$$operation$$] to complete
    - status: SUCCESS
  - stderr: |
      Created backup.
- execute:
  - command: filestore instances restore '$$instance$$' --zone us-east1-c --source-backup
      $$backup$$ --source-backup-region us-east1 --file-share my_vol --format "yaml(name,state,tier,fileShares)"
  - prompt:
    - message: |
        You are about to override existing data in [$$instance$$].
    - input: y
  - stderr: |
      Request issued for: [$$instance$$]
  - progress_tracker:
    - message: Waiting for operation [$$operation$$] to complete
    - status: SUCCESS
  - stdout: |
      fileShares:
      - capacityGb: '1024'
        name: my_vol
        sourceBackup: projects/cloud-sdk-integration-testing/locations/us-east1/backups/$$backup$$
      name: projects/cloud-sdk-integration-testing/locations/us-east1-c/instances/$$instance$$
      state: READY
      tier: STANDARD
- execute:
  - command: filestore instances delete $$instance$$ --zone us-east1-c --async
  - prompt:
    - message: |-
        You are about to delete Cloud Filestore instance projects/cloud-sdk-integration-testing/locations/us-east1-c/instances/$$instance$$.
        Are you sure?
    - input: y
  - stderr: |-
      Check the status of the deletion by listing all instances:
        \$ gcloud beta filestore instances list *
      $
- execute:
  - command: filestore backups delete $$backup$$ --region us-east1 --async
  - prompt:
    - message: |
        You are about to delete a backup
    - input: y
  - stderr: |-
      Delete request issued
      Check operation \[.+\] for status\.
      $
actions:
- define_reference:
    reference: api-version
    track_values:
      BETA: v1beta1

- generate_resource_id:
    reference: instance
    prefix: filestore-backup-restore-test

- execute_command:
    command: filestore instances create $$instance$$ --zone us-east1-c --tier STANDARD
      --file-share=name="my_vol",capacity=1TB --network=name=filestore-net
    events:
    - api_call:
        expect_request:
          uri: https://file.googleapis.com/$$api-version$$/projects/cloud-sdk-integration-testing/locations/us-east1-c/instances?alt=json&instanceId=$$instance$$
          method: POST
          headers: {}
          body:
            json:
              fileShares:
              - capacityGb: '1024'
                name: my_vol
              networks:
              - network: filestore-net
              tier: STANDARD
        return_response:
          headers:
            cache-control: private
            content-length: '525'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/cloud-sdk-integration-testing/locations/us-east1-c/operations/operation-1599610780722-5aed6685d26a4-3f056209-4182013f
            metadata:
              '@type': type.googleapis.com/google.cloud.common.OperationMetadata
              createTime: '2020-09-09T00:19:42.954310487Z'
              target: projects/cloud-sdk-integration-testing/locations/us-east1-c/instances/$$instance$$
              verb: create
              cancelRequested: false
              apiVersion: $$api-version$$
            done: false
          status: 200
        poll_operation: true
    - expect_progress_tracker:
        message: Waiting for [$$operation-basename$$] to finish
        status: SUCCESS
    - expect_exit:
        code: 0
- generate_resource_id:
    reference: backup
    prefix: filestore-backup-restore-test

- execute_command:
    command: filestore backups create $$backup$$ --region us-east1 --instance $$instance$$
      --instance-zone us-east1-c --file-share="my_vol"
    events:
    - api_call:
        expect_request:
          uri: https://file.googleapis.com/$$api-version$$/projects/cloud-sdk-integration-testing/locations/us-east1/backups?alt=json&backupId=$$backup$$
          method: POST
          headers: {}
          body:
            json:
              sourceFileShare: my_vol
              sourceInstance: projects/cloud-sdk-integration-testing/locations/us-east1-c/instances/$$instance$$
        return_response:
          headers:
            cache-control: private
            content-length: '519'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/cloud-sdk-integration-testing/locations/us-east1/operations/operation-1599610990322-5aed674db61e2-1f4d4e55-55d8caf2
            metadata:
              '@type': type.googleapis.com/google.cloud.common.OperationMetadata
              createTime: '2020-09-09T00:23:10.394290112Z'
              target: projects/cloud-sdk-integration-testing/locations/us-east1/backups/$$backup$$
              verb: create
              cancelRequested: false
              apiVersion: $$api-version$$
            done: false
          status: 200
        poll_operation: true
    - expect_stderr: |
        Create request issued
    - expect_progress_tracker:
        message: Waiting for operation [$$operation$$] to complete
        status: SUCCESS
    - expect_stderr: |
        Created backup.
    - expect_exit:
        code: 0

- execute_command:
    command: filestore instances restore '$$instance$$' --zone us-east1-c --source-backup
      $$backup$$ --source-backup-region us-east1 --file-share my_vol --format "yaml(name,state,tier,fileShares)"
    events:
    - expect_prompt_continue:
        message: |
          You are about to override existing data in [$$instance$$].
        user_input: y
    - api_call:
        expect_request:
          uri: https://file.googleapis.com/$$api-version$$/projects/cloud-sdk-integration-testing/locations/us-east1-c/instances/$$instance$$:restore?alt=json
          method: POST
          headers: {}
          body:
            json:
              fileShare: my_vol
              sourceBackup: projects/cloud-sdk-integration-testing/locations/us-east1/backups/$$backup$$
        return_response:
          headers:
            cache-control: private
            content-length: '526'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/cloud-sdk-integration-testing/locations/us-east1-c/operations/operation-1599611016983-5aed67672344b-988ccce5-bfb9b761
            metadata:
              '@type': type.googleapis.com/google.cloud.common.OperationMetadata
              createTime: '2020-09-09T00:23:37.040600304Z'
              target: projects/cloud-sdk-integration-testing/locations/us-east1-c/instances/$$instance$$
              verb: restore
              cancelRequested: false
              apiVersion: $$api-version$$
            done: false
          status: 200
        poll_operation: true
    - expect_stderr: |
        Request issued for: [$$instance$$]
    - expect_progress_tracker:
        message: Waiting for operation [$$operation$$] to complete
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://file.googleapis.com/$$api-version$$/projects/cloud-sdk-integration-testing/locations/us-east1-c/instances/$$instance$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '622'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/cloud-sdk-integration-testing/locations/us-east1-c/instances/$$instance$$
            state: READY
            createTime: '2020-09-09T00:19:42.949572658Z'
            tier: STANDARD
            fileShares:
            - name: my_vol
              capacityGb: '1024'
              sourceBackup: projects/cloud-sdk-integration-testing/locations/us-east1/backups/$$backup$$
            networks:
            - network: filestore-net
              reservedIpRange: 10.89.80.168/29
              ipAddresses:
              - 10.89.80.170
          status: 200
    - expect_stdout: |
        fileShares:
        - capacityGb: '1024'
          name: my_vol
          sourceBackup: projects/cloud-sdk-integration-testing/locations/us-east1/backups/$$backup$$
        name: projects/cloud-sdk-integration-testing/locations/us-east1-c/instances/$$instance$$
        state: READY
        tier: STANDARD
    - expect_exit:
        code: 0

- execute_command:
    command: filestore instances delete $$instance$$ --zone us-east1-c --async
    cleanup_for: instance
    validation_only: true
    events:
    - expect_prompt_continue:
        message: |-
          You are about to delete Cloud Filestore instance projects/cloud-sdk-integration-testing/locations/us-east1-c/instances/$$instance$$.
          Are you sure?
        user_input: y
    - expect_stderr:
        matches: |
          Check the status of the deletion by listing all instances:
            \$ gcloud beta filestore instances list *
    - expect_exit:
        code: 0

- execute_command:
    command: filestore backups delete $$backup$$ --region us-east1 --async
    cleanup_for: backup
    validation_only: true
    events:
    - expect_prompt_continue:
        message: |
          You are about to delete a backup
        user_input: y
    - expect_stderr:
        matches: |
          Delete request issued
          Check operation \[.+\] for status\.
    - expect_exit:
        code: 0
