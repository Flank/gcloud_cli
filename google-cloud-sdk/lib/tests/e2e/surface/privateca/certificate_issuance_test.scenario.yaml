title: Issue a certificate from an existing root, describe it, and revoke it.
release_tracks: [BETA]
summary:
# This summary is generated by http://go/gcloud-scenario-tests on update and should not be edited.
- execute:
  - command: privateca roots create $$ca-id$$ --kms-key-version $$kms-key-version$$
      --subject "CN=Certificate Issuance E2E Test, O=Google LLC" --reusable-config
      root-unconstrained --bucket $$bucket$$
  - progress_tracker: []
  - stderr: |
      Created Certificate Authority [projects/$$project$$/locations/$$location$$/certificateAuthorities/$$ca-id$$].
- execute:
  - command: privateca certificates create $$cert-id$$ --issuer $$ca-id$$ --issuer-location
      $$location$$ --csr test_csr.pem --validity P1D
  - stderr: |
      Created Certificate [$$cert-name$$].
- execute:
  - command: privateca certificates describe $$cert-id$$ --issuer $$ca-id$$ --issuer-location
      $$location$$ --format "yaml(pemCsr, name, lifetime)"
  - stdout: |
      lifetime: P1D
      name: $$cert-name$$
      pemCsr: |
        -----BEGIN CERTIFICATE REQUEST-----
        MIIC/TCCAeUCAQAwgZkxCzAJBgNVBAYTAlVTMRMwEQYDVQQIDApXYXNoaW5ndG9u
        MREwDwYDVQQHDAhLaXJrbGFuZDEPMA0GA1UECgwGR29vZ2xlMQwwCgYDVQQLDANM
        TEMxGDAWBgNVBAMMD2djbG91ZF9lMmVfdGVzdDEpMCcGCSqGSIb3DQEJARYacHJp
        dmF0ZS1jYS10ZWFtQGdvb2dsZS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAw
        ggEKAoIBAQDYl5pPYmY3Z+AdrsYVrfMCICx8QT2kPvb5NDcqY29uGGE46Hp6AazT
        Ig5+Y3tCnFoKwXgDggTQ4Y23pjCHBnos1z+4mXf0dB+dYgE+u9IyYhqHajP61qmP
        haMltzxH1Eq0SA6xuNe1zC07Wg7XzMujb3cC+dqhKditTAUZYbzQ/S5E1/n8mXwe
        0B53XbHUnL5HZSl0mCL9ZLEboV7+ha0aiImR/wnLcVfP19bIxjadSOHFClHk/Zsx
        RPqN2C8FQG1VXidCo6HUxyI7J6ROKUtRY2km8b+/lknUnUVk6WHXkwwB3iYiTtNq
        lrE+XD91yWeF/cxz46RYmluGMFUuc+vxAgMBAAGgHjAcBgkqhkiG9w0BCQ4xDzAN
        MAsGA1UdDwQEAwIHgDANBgkqhkiG9w0BAQsFAAOCAQEAa8O7qoOWNt9S6o5xpzZZ
        n7PCB/yh95WdHDpiW/zVuYkXPBEr+SKfbIFLdFXhi7TaLHBJrpTws5k3ZuLSGQ38
        9aJTwdvEUNUG17w6qfJAWf+80YNJ1cLGAZKtYA1iEKG4RUbHtVEelbb+eyEimP/T
        R4vTPTnngYqyT+pS+iL1iaPkQEQQu4fQ9DZGAJRRw7af5jrV6pPyb+9dzckgi5Ut
        xlBxSOz2tJb5uw6poVxNN8cxdiOPKLsyJA4Uy6IpctzEyxG0qSMGcL4BM8W7H2Ti
        LNTFz6Vx/o/r5FgfxEo2Zzg+iYxlBqyDEosWyYN1kuK0cwqm0H0d1BQ3h46tKQS7
        7Q==
        -----END CERTIFICATE REQUEST-----
- execute:
  - command: privateca certificates revoke --certificate $$cert-id$$ --issuer $$ca-id$$
      --issuer-location $$location$$ --reason key-compromise
  - prompt:
    - message: You are about to revoke Certificate [projects/$$project$$/locations/$$location$$/certificateAuthorities/$$ca-id$$/certificates/$$cert-id$$]
    - input: y
  - stderr: |-
      Revoked certificate \[[^\]]+\] at \d{4}-\d{2}-\d{2}T[0-9-.:]+.
      $
- execute:
  - command: privateca roots disable $$ca-id$$ --location $$location$$
  - progress_tracker:
    - message: Disabling Root CA
    - status: SUCCESS
  - stderr: |
      Disabled Root CA [projects/$$project$$/locations/$$location$$/certificateAuthorities/$$ca-id$$].
- execute:
  - command: privateca roots delete $$ca-id$$ --location $$location$$
  - prompt:
    - message: You are about to schedule Certificate Authority [projects/$$project$$/locations/$$location$$/certificateAuthorities/$$ca-id$$]
        for deletion in 30 days
    - input: y
  - progress_tracker:
    - message: Scheduling Root CA for deletion
    - status: SUCCESS
  - stderr: .*Scheduled Root CA \[projects/$$project$$/locations/$$location$$/certificateAuthorities/$$ca-id$$\]
      for deletion at .*$
actions:
- define_reference:
    reference: project
    value: cloud-sdk-integration-testing
- define_reference:
    reference: location
    value: us-central1
- define_reference:
    reference: kms-key-version
    value: projects/cloud-sdk-integration-testing/locations/us-central1/keyRings/do-not-delete-keyring/cryptoKeys/do-not-delete-key-rsa-2048/cryptoKeyVersions/1
- define_reference:
    reference: bucket
    value: do-not-delete-privateca-gcloud-tests
- generate_resource_id:
    reference: ca-id
    prefix: gcloud-test
    delimiter: '-'
- load_resource:
    path: tests/e2e/surface/privateca/test_data/test_csr.pem
- generate_resource_id:
    reference: cert-id
    prefix: gcloud-test
    delimiter: '-'
    requires_cleanup: false
- set_property:
    privateca/location: us-central1
- execute_command:
    command: privateca roots create $$ca-id$$ --kms-key-version $$kms-key-version$$
      --subject "CN=Certificate Issuance E2E Test, O=Google LLC" --reusable-config
      root-unconstrained --bucket $$bucket$$
    validation_only: true
    validate_remote_api_calls: false
    events:
    - expect_stderr: |
        WARNING: CA Service is currently in preview.

        Please remember that all resources created during preview will be deleted
        when CA service transitions to General Availability (GA). Relying on these
        certificate authorities for production traffic is discouraged.
    - expect_progress_tracker:
      - message: Creating Certificate Authority.
      - status: SUCCESS
    - expect_stderr: |
        Created Certificate Authority [projects/$$project$$/locations/$$location$$/certificateAuthorities/$$ca-id$$].
    - expect_exit:
        code: 0
- execute_command:
    command: privateca certificates create $$cert-id$$ --issuer $$ca-id$$ --issuer-location
      $$location$$ --csr test_csr.pem --validity P1D
    events:
    - api_call:
        expect_request:
          uri: https://privateca.googleapis.com/v1beta1/projects/$$project$$/locations/$$location$$/certificateAuthorities/$$ca-id$$?alt=json
          method: GET
          body: null
        return_response:
          headers:
            status: '200'
          body:
            name: projects/$$project$$/locations/$$location$$/certificateAuthorities/$$ca-id$$
            tier: ENTERPRISE
    - expect_stderr: |
        WARNING: CA Service is currently in preview.

        Please remember that all resources created during preview will be deleted
        when CA service transitions to General Availability (GA). Relying on these
        certificates for production traffic is discouraged.
    - api_call:
        expect_request:
          uri:
            matches: https://privateca\.googleapis\.com/v1beta1/projects/$$project$$/locations/$$location$$/certificateAuthorities/$$ca-id$$/certificates\?alt=json&certificateId=$$cert-id$$&requestId=[^&]+$
          method: POST
          headers: {}
          body:
            json:
              lifetime: 86400s
              pemCsr: |
                -----BEGIN CERTIFICATE REQUEST-----
                MIIC/TCCAeUCAQAwgZkxCzAJBgNVBAYTAlVTMRMwEQYDVQQIDApXYXNoaW5ndG9u
                MREwDwYDVQQHDAhLaXJrbGFuZDEPMA0GA1UECgwGR29vZ2xlMQwwCgYDVQQLDANM
                TEMxGDAWBgNVBAMMD2djbG91ZF9lMmVfdGVzdDEpMCcGCSqGSIb3DQEJARYacHJp
                dmF0ZS1jYS10ZWFtQGdvb2dsZS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAw
                ggEKAoIBAQDYl5pPYmY3Z+AdrsYVrfMCICx8QT2kPvb5NDcqY29uGGE46Hp6AazT
                Ig5+Y3tCnFoKwXgDggTQ4Y23pjCHBnos1z+4mXf0dB+dYgE+u9IyYhqHajP61qmP
                haMltzxH1Eq0SA6xuNe1zC07Wg7XzMujb3cC+dqhKditTAUZYbzQ/S5E1/n8mXwe
                0B53XbHUnL5HZSl0mCL9ZLEboV7+ha0aiImR/wnLcVfP19bIxjadSOHFClHk/Zsx
                RPqN2C8FQG1VXidCo6HUxyI7J6ROKUtRY2km8b+/lknUnUVk6WHXkwwB3iYiTtNq
                lrE+XD91yWeF/cxz46RYmluGMFUuc+vxAgMBAAGgHjAcBgkqhkiG9w0BCQ4xDzAN
                MAsGA1UdDwQEAwIHgDANBgkqhkiG9w0BAQsFAAOCAQEAa8O7qoOWNt9S6o5xpzZZ
                n7PCB/yh95WdHDpiW/zVuYkXPBEr+SKfbIFLdFXhi7TaLHBJrpTws5k3ZuLSGQ38
                9aJTwdvEUNUG17w6qfJAWf+80YNJ1cLGAZKtYA1iEKG4RUbHtVEelbb+eyEimP/T
                R4vTPTnngYqyT+pS+iL1iaPkQEQQu4fQ9DZGAJRRw7af5jrV6pPyb+9dzckgi5Ut
                xlBxSOz2tJb5uw6poVxNN8cxdiOPKLsyJA4Uy6IpctzEyxG0qSMGcL4BM8W7H2Ti
                LNTFz6Vx/o/r5FgfxEo2Zzg+iYxlBqyDEosWyYN1kuK0cwqm0H0d1BQ3h46tKQS7
                7Q==
                -----END CERTIFICATE REQUEST-----
        return_response:
          headers:
            cache-control: private
            content-length: '546'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/$$project$$/locations/$$location$$/certificateAuthorities/$$ca-id$$/certificates/$$cert-id$$
        expect_response:
          body:
            json: {}
          extract_references:
          - field: name
            reference: cert-name
    - expect_stderr: |
        Created Certificate [$$cert-name$$].
    - expect_exit:
        code: 0
- execute_command:
    command: privateca certificates describe $$cert-name$$ --format "yaml(pemCsr, name, lifetime)"
    events:
    - api_call:
        expect_request:
          uri: https://privateca.googleapis.com/v1beta1/$$cert-name$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '6320'
            content-type: application/json; charset=UTF-8
          body:
            name: $$cert-name$$
            pemCsr: |
              -----BEGIN CERTIFICATE REQUEST-----
              MIIC/TCCAeUCAQAwgZkxCzAJBgNVBAYTAlVTMRMwEQYDVQQIDApXYXNoaW5ndG9u
              MREwDwYDVQQHDAhLaXJrbGFuZDEPMA0GA1UECgwGR29vZ2xlMQwwCgYDVQQLDANM
              TEMxGDAWBgNVBAMMD2djbG91ZF9lMmVfdGVzdDEpMCcGCSqGSIb3DQEJARYacHJp
              dmF0ZS1jYS10ZWFtQGdvb2dsZS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAw
              ggEKAoIBAQDYl5pPYmY3Z+AdrsYVrfMCICx8QT2kPvb5NDcqY29uGGE46Hp6AazT
              Ig5+Y3tCnFoKwXgDggTQ4Y23pjCHBnos1z+4mXf0dB+dYgE+u9IyYhqHajP61qmP
              haMltzxH1Eq0SA6xuNe1zC07Wg7XzMujb3cC+dqhKditTAUZYbzQ/S5E1/n8mXwe
              0B53XbHUnL5HZSl0mCL9ZLEboV7+ha0aiImR/wnLcVfP19bIxjadSOHFClHk/Zsx
              RPqN2C8FQG1VXidCo6HUxyI7J6ROKUtRY2km8b+/lknUnUVk6WHXkwwB3iYiTtNq
              lrE+XD91yWeF/cxz46RYmluGMFUuc+vxAgMBAAGgHjAcBgkqhkiG9w0BCQ4xDzAN
              MAsGA1UdDwQEAwIHgDANBgkqhkiG9w0BAQsFAAOCAQEAa8O7qoOWNt9S6o5xpzZZ
              n7PCB/yh95WdHDpiW/zVuYkXPBEr+SKfbIFLdFXhi7TaLHBJrpTws5k3ZuLSGQ38
              9aJTwdvEUNUG17w6qfJAWf+80YNJ1cLGAZKtYA1iEKG4RUbHtVEelbb+eyEimP/T
              R4vTPTnngYqyT+pS+iL1iaPkQEQQu4fQ9DZGAJRRw7af5jrV6pPyb+9dzckgi5Ut
              xlBxSOz2tJb5uw6poVxNN8cxdiOPKLsyJA4Uy6IpctzEyxG0qSMGcL4BM8W7H2Ti
              LNTFz6Vx/o/r5FgfxEo2Zzg+iYxlBqyDEosWyYN1kuK0cwqm0H0d1BQ3h46tKQS7
              7Q==
              -----END CERTIFICATE REQUEST-----
            lifetime: 86400s
    - expect_stdout: |
        lifetime: P1D
        name: $$cert-name$$
        pemCsr: |
          -----BEGIN CERTIFICATE REQUEST-----
          MIIC/TCCAeUCAQAwgZkxCzAJBgNVBAYTAlVTMRMwEQYDVQQIDApXYXNoaW5ndG9u
          MREwDwYDVQQHDAhLaXJrbGFuZDEPMA0GA1UECgwGR29vZ2xlMQwwCgYDVQQLDANM
          TEMxGDAWBgNVBAMMD2djbG91ZF9lMmVfdGVzdDEpMCcGCSqGSIb3DQEJARYacHJp
          dmF0ZS1jYS10ZWFtQGdvb2dsZS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAw
          ggEKAoIBAQDYl5pPYmY3Z+AdrsYVrfMCICx8QT2kPvb5NDcqY29uGGE46Hp6AazT
          Ig5+Y3tCnFoKwXgDggTQ4Y23pjCHBnos1z+4mXf0dB+dYgE+u9IyYhqHajP61qmP
          haMltzxH1Eq0SA6xuNe1zC07Wg7XzMujb3cC+dqhKditTAUZYbzQ/S5E1/n8mXwe
          0B53XbHUnL5HZSl0mCL9ZLEboV7+ha0aiImR/wnLcVfP19bIxjadSOHFClHk/Zsx
          RPqN2C8FQG1VXidCo6HUxyI7J6ROKUtRY2km8b+/lknUnUVk6WHXkwwB3iYiTtNq
          lrE+XD91yWeF/cxz46RYmluGMFUuc+vxAgMBAAGgHjAcBgkqhkiG9w0BCQ4xDzAN
          MAsGA1UdDwQEAwIHgDANBgkqhkiG9w0BAQsFAAOCAQEAa8O7qoOWNt9S6o5xpzZZ
          n7PCB/yh95WdHDpiW/zVuYkXPBEr+SKfbIFLdFXhi7TaLHBJrpTws5k3ZuLSGQ38
          9aJTwdvEUNUG17w6qfJAWf+80YNJ1cLGAZKtYA1iEKG4RUbHtVEelbb+eyEimP/T
          R4vTPTnngYqyT+pS+iL1iaPkQEQQu4fQ9DZGAJRRw7af5jrV6pPyb+9dzckgi5Ut
          xlBxSOz2tJb5uw6poVxNN8cxdiOPKLsyJA4Uy6IpctzEyxG0qSMGcL4BM8W7H2Ti
          LNTFz6Vx/o/r5FgfxEo2Zzg+iYxlBqyDEosWyYN1kuK0cwqm0H0d1BQ3h46tKQS7
          7Q==
          -----END CERTIFICATE REQUEST-----
    - expect_exit:
        code: 0
- execute_command:
    command: privateca certificates revoke --certificate $$cert-name$$ --reason key-compromise
    events:
    - expect_prompt_continue:
        message: You are about to revoke Certificate [$$cert-name$$]
        user_input: y
    - api_call:
        expect_request:
          uri: https://privateca.googleapis.com/v1beta1/$$cert-name$$:revoke?alt=json
          method: POST
          headers: {}
          body:
            json:
              reason: KEY_COMPROMISE
        return_response:
          headers:
            cache-control: private
            content-length: '546'
            content-type: application/json; charset=UTF-8
          body:
            name: $$cert-name$$
            revocationDetails:
              revocationState: REVOCATION_REASON_UNSPECIFIED
              revocationTime: '2020-04-17T15:14:00.105-07:00'
    - expect_stderr:
        matches: |
          Revoked certificate \[$$cert-name$$\] at \d{4}-\d{2}-\d{2}T[0-9-.:]+.
    - expect_exit:
        code: 0
- execute_command:
    command: privateca roots disable $$ca-id$$ --location $$location$$
    validation_only: true
    validate_remote_api_calls: false
    events:
    - expect_progress_tracker:
        message: Disabling Root CA
        status: SUCCESS
    - expect_stderr: |
        Disabled Root CA [projects/$$project$$/locations/$$location$$/certificateAuthorities/$$ca-id$$].
    - expect_exit:
        code: 0
- execute_command:
    command: privateca roots delete $$ca-id$$ --location $$location$$
    validation_only: true
    validate_remote_api_calls: false
    cleanup_for: ca-id
    events:
    - expect_prompt_continue:
        message: You are about to schedule Certificate Authority [projects/$$project$$/locations/$$location$$/certificateAuthorities/$$ca-id$$]
          for deletion in 30 days
        user_input: y
    - expect_progress_tracker:
        message: Scheduling Root CA for deletion
        status: SUCCESS
    - expect_stderr:
        matches: .*Scheduled Root CA \[projects/$$project$$/locations/$$location$$/certificateAuthorities/$$ca-id$$\]
          for deletion at .*
    - expect_exit:
        code: 0
