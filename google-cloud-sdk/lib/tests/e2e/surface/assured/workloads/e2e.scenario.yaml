title: Workloads e2e tests
release_tracks: [BETA]
summary:
# This summary is generated by http://go/gcloud-scenario-tests on update and should not be edited.
- execute:
  - command: assured workloads create --organization=531459884741 --location=us-central1
      --display-name=$$workload-display-name$$ --compliance-regime=FEDRAMP_MODERATE
      --billing-account="billingAccounts/0172AD-FDF25F-A4A2E9" --next-rotation-time=2040-1-30T10:15:00.00Z
      --rotation-period=172800s --external-identifier gcloud-2e2
  - stderr: |
      Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
  - progress_tracker:
    - message: Creating Assured Workloads environment
    - status: SUCCESS
  - stderr: |
      Created Assured Workloads environment [$$workload$$].
- execute:
  - command: assured workloads list --organization=531459884741 --location=us-central1
      --page-size=5 --limit=1 --filter="name=$$workload$$"
  - stderr: |
      Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
  - stdout: .*goog-aw-external-identifier:\ gcloud-2e2.*name:\ $$workload$$.*$
- execute:
  - command: assured workloads describe $$workload$$
  - stderr: |
      Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
  - stdout: .*goog-aw-external-identifier:\ gcloud-2e2.*name:\ $$workload$$.*$
- execute:
  - command: assured workloads update $$workload$$ --display-name=$$workload-display-name-updated$$
      --etag=$$workload-etag$$ --labels goog-aw-external-identifier=gcloud-2e2,update=true
  - stderr: |
      Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
  - stderr: |
      Updated Assured Workloads environment [$$workload$$].
- execute:
  - command: projects delete $$proj0$$
  - prompt:
    - message: Your project will be deleted.
    - input: y
  - stderr: Deleted\ \[https://cloudresourcemanager.googleapis.com/v1/projects/$$proj0$$.*$
- execute:
  - command: projects delete $$proj1$$
  - prompt:
    - message: Your project will be deleted.
    - input: y
  - stderr: Deleted\ \[https://cloudresourcemanager.googleapis.com/v1/projects/$$proj1$$.*$
- execute:
  - command: assured workloads delete $$workload$$
  - prompt:
    - message: You are about to delete Workload [$$workload$$]
    - input: y
  - stderr: |
      Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
  - stderr: |
      Deleted Assured Workloads environment [$$workload$$].
actions:
- generate_resource_id:
    reference: workload-display-name
    prefix: gcloud1  # the generated ID must be under <=30 long - field limit
    requires_cleanup: false
- generate_resource_id:
    reference: workload-display-name-updated
    prefix: gcloud2  # the generated ID must be under <=30 long - field limit
    requires_cleanup: false
- execute_command:
    # Create a workload
    command: assured workloads create --organization=531459884741 --location=us-central1
      --display-name=$$workload-display-name$$ --compliance-regime=FEDRAMP_MODERATE
      --billing-account="billingAccounts/0172AD-FDF25F-A4A2E9" --next-rotation-time=2040-1-30T10:15:00.00Z
      --rotation-period=172800s --external-identifier gcloud-2e2
    events:
    - expect_stderr: |
        Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
    - api_call:
        poll_operation: false
        expect_request:
          uri: https://us-central1-assuredworkloads.googleapis.com/v1beta1/organizations/531459884741/locations/us-central1/workloads?alt=json&externalId=gcloud-2e2
          method: POST
          body: |
            {
              "billingAccount": "billingAccounts/0172AD-FDF25F-A4A2E9",
              "complianceRegime": "FEDRAMP_MODERATE",
              "displayName": "$$workload-display-name$$",
              "fedrampModerateSettings": {
                "kmsSettings": {
                  "nextRotationTime": "2030-12-30T10:15:00.00Z",
                  "rotationPeriod": "172800s"
                }
              },
              "labels": {
                "labelkey1": "labelvalue1",
                "labelkey2": "labelvalue2"
              }
            }
        return_response:
          headers:
            cache-control: private
            content-length: '449'
            content-type: application/json; charset=UTF-8
          body:
            name: organizations/531459884741/locations/us-central1/operations/6880d9bb-fcbd-4266-abd9-0a50b17b25f9
            metadata:
              '@type': type.googleapis.com/google.cloud.assuredworkloads.v1beta1.CreateWorkloadOperationMetadata
              createTime: '2020-10-02T11:44:24.139612Z'
              displayName: $$workload-display-name$$
              parent: organizations/531459884741/locations/us-central1
              complianceRegime: FEDRAMP_MODERATE
          status: 200
        expect_response:
          extract_references:
          - field: name
            reference: operation
          body:
            text:
              matches: .*name\":\s\"organizations/531459884741/locations/us-central1/operations/.+
    - api_call:
        repeatable: true
        expect_request:
          uri: https://us-central1-assuredworkloads.googleapis.com/v1beta1/$$operation$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '1045'
            content-type: application/json; charset=UTF-8
          body:
            name: organizations/531459884741/locations/us-central1/operations/6880d9bb-fcbd-4266-abd9-0a50b17b25f9
            metadata:
              '@type': type.googleapis.com/google.cloud.assuredworkloads.v1beta1.CreateWorkloadOperationMetadata
              createTime: '2020-10-02T11:44:24.139612Z'
              displayName: $$workload-display-name$$
              parent: organizations/531459884741/locations/us-central1
              complianceRegime: FEDRAMP_MODERATE
            done: true
            response:
              '@type': type.googleapis.com/google.cloud.assuredworkloads.v1beta1.Workload
              name: organizations/531459884741/locations/us-central1/workloads/00-d7bba3a2-c06c-4f2f-ab31-fd1
              displayName: $$workload-display-name$$
              resources:
              - resourceId: '517409730008'
              - resourceId: '367657392053'
              complianceRegime: FEDRAMP_MODERATE
              createTime: '2020-10-02T11:44:41.307Z'
              etag: '570764601'
              labels:
                goog-aw-external-identifier: gcloud-2e2
    - expect_progress_tracker:
        message: Creating Assured Workloads environment
        status: SUCCESS
    - api_call:
        expect_request:
          uri:
            matches: https://us-central1-assuredworkloads.googleapis.com/v1beta1/organizations/531459884741/locations/us-central1/workloads/[0-9a-z\-]+\?alt=json
          method: GET
          body: None
        return_response:
          body:
            name: organizations/531459884741/locations/us-central1/workloads/00-d7bba3a2-c06c-4f2f-ab31-fd1
            displayName: $$workload-display-name$$
            resources:
            - resourceId: '367657392053'
            - resourceId: '517409730008'
            complianceRegime: FEDRAMP_MODERATE
            createTime: '2020-10-02T11:44:41.307Z'
            etag: '570764601'
            labels:
              goog-aw-external-identifier: gcloud-2e2
          status: 200
          headers:
            cache-control: private
            content-length: '448'
            content-type: application/json; charset=UTF-8
        expect_response:
          extract_references:
          - field: name
            reference: workload
          - field: etag
            reference: workload-etag
          - field: resources[0].resourceId
            reference: proj0
          - field: resources[1].resourceId
            reference: proj1
          body:
            json: {}
    - expect_stderr: |
        Created Assured Workloads environment [$$workload$$].
    - expect_exit:
        code: 0
- execute_command:
    # List workloads
    command: assured workloads list --organization=531459884741 --location=us-central1
      --page-size=5 --limit=1 --filter="name=$$workload$$"
    events:
    - expect_stderr: |
        Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
    - api_call:
        expect_request:
          uri: https://us-central1-assuredworkloads.googleapis.com/v1beta1/organizations/531459884741/locations/us-central1/workloads?alt=json&pageSize=5
          method: GET
          body: null
        expect_response:
          body:
            json: {}
        return_response:
          headers:
            cache-control: private
            content-length: '2548'
            content-type: application/json; charset=UTF-8
          body:
            workloads:
            - name: organizations/531459884741/locations/us-central1/workloads/00-d7bba3a2-c06c-4f2f-ab31-fd1
              displayName: $$workload-display-name$$
              resources:
              - resourceId: '367657392053'
              - resourceId: '517409730008'
              complianceRegime: FEDRAMP_MODERATE
              createTime: '2020-10-02T11:44:41.307Z'
              etag: '570764601'
              labels:
                goog-aw-external-identifier: gcloud-2e2
            - name: organizations/531459884741/locations/us-central1/workloads/00-b59b1541-9f7a-4ad3-989d-bca
              displayName: $$workload-display-name$$
              resources:
              - resourceId: '715063991237'
              - resourceId: '855546662011'
              complianceRegime: FEDRAMP_MODERATE
              createTime: '2020-10-01T22:21:16.984Z'
              etag: '-1473101715'
              labels:
                goog-aw-external-identifier: gcloud-2e2
            - name: organizations/531459884741/locations/us-central1/workloads/00-4159af5a-036f-4de5-b4b5-f46
              displayName: $$workload-display-name$$
              resources:
              - resourceId: '119872912238'
              - resourceId: '234834106074'
              complianceRegime: FEDRAMP_MODERATE
              createTime: '2020-10-01T22:21:16.959Z'
              etag: '-1749368715'
              labels:
                goog-aw-external-identifier: gcloud-2e2
            - name: organizations/531459884741/locations/us-central1/workloads/00-53bc30f4-0acf-421b-81de-93f
              displayName: $$workload-display-name$$
              resources:
              - resourceId: '488170670143'
              - resourceId: '788077346858'
              complianceRegime: FEDRAMP_MODERATE
              createTime: '2020-10-01T22:21:12.674Z'
              etag: '-511155792'
              labels:
                goog-aw-external-identifier: gcloud-2e2
            - name: organizations/531459884741/locations/us-central1/workloads/00-7d220645-d20c-44d8-b909-6f2
              displayName: $$workload-display-name$$
              complianceRegime: FEDRAMP_MODERATE
              createTime: '2020-10-01T22:13:59.610Z'
              etag: '162318985'
              labels:
                goog-aw-external-identifier: gcloud-2e2
            nextPageToken: CjIKBginqdn7BQoGCIC576ICCiAqHjAwLTdkMjIwNjQ1LWQyMGMtNDRkOC1iOTA5LTZmMg==
          status: 200
    - expect_stdout:
        matches: .*goog-aw-external-identifier:\ gcloud-2e2.*name:\ $$workload$$.*
    - expect_exit:
        code: 0
- execute_command:
    # Describe workload
    command: assured workloads describe $$workload$$
    events:
    - expect_stderr: |
        Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
    - api_call:
        expect_request:
          uri: https://us-central1-assuredworkloads.googleapis.com/v1beta1/$$workload$$?alt=json
          method: GET
          body: null
        expect_response:
          body:
            json: {}
        return_response:
          headers:
            cache-control: private
            content-length: '448'
            content-type: application/json; charset=UTF-8
          body:
            name: organizations/531459884741/locations/us-central1/workloads/00-d7bba3a2-c06c-4f2f-ab31-fd1
            displayName: $$workload-display-name$$
            resources:
            - resourceId: '367657392053'
            - resourceId: '517409730008'
            complianceRegime: FEDRAMP_MODERATE
            createTime: '2020-10-02T11:44:41.307Z'
            etag: '570764601'
            labels:
              goog-aw-external-identifier: gcloud-2e2
          status: 200
    - expect_stdout:
        matches: .*goog-aw-external-identifier:\ gcloud-2e2.*name:\ $$workload$$.*
    - expect_exit:
        code: 0
- execute_command:
    # Update workload name and add labels
    command: assured workloads update $$workload$$ --display-name=$$workload-display-name-updated$$
      --etag=$$workload-etag$$ --labels goog-aw-external-identifier=gcloud-2e2,update=true
    events:
    - expect_stderr: |
        Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
    - api_call:
        expect_request:
          uri: https://us-central1-assuredworkloads.googleapis.com/v1beta1/$$workload$$?alt=json&updateMask=workload.display_name%2Cworkload.labels
          method: PATCH
          body:
            json:
              displayName: $$workload-display-name-updated$$
              etag: $$workload-etag$$
              labels:
                goog-aw-external-identifier: gcloud-2e2
                update: 'true'
        expect_response:
          body:
            json:
              name: $$workload$$
              displayName: $$workload-display-name-updated$$
              labels:
                goog-aw-external-identifier: gcloud-2e2
                update: 'true'
        return_response:
          headers:
            cache-control: private
            content-length: '471'
            content-type: application/json; charset=UTF-8
          body:
            name: organizations/531459884741/locations/us-central1/workloads/00-d7bba3a2-c06c-4f2f-ab31-fd1
            displayName: $$workload-display-name-updated$$
            resources:
            - resourceId: '367657392053'
            - resourceId: '517409730008'
            complianceRegime: FEDRAMP_MODERATE
            createTime: '2020-10-02T11:44:41.307Z'
            etag: '-975979467'
            labels:
              goog-aw-external-identifier: gcloud-2e2
              update: 'true'
          status: 200
    - expect_stderr: |
        Updated Assured Workloads environment [$$workload$$].
    - expect_exit:
        code: 0
- execute_command:
    # Delete workload project 0
    command: projects delete $$proj0$$
    validation_only: true
    events:
    - expect_prompt_continue:
        message: Your project will be deleted.
        user_input: y
    - expect_stderr:
        matches: Deleted\ \[https://cloudresourcemanager.googleapis.com/v1/projects/$$proj0$$.*
    - expect_exit:
        code: 0
- execute_command:
    # Delete workload project 1
    command: projects delete $$proj1$$
    validation_only: true
    events:
    - expect_prompt_continue:
        message: Your project will be deleted.
        user_input: y
    - expect_stderr:
        matches: Deleted\ \[https://cloudresourcemanager.googleapis.com/v1/projects/$$proj1$$.*
    - expect_exit:
        code: 0
- execute_command:
    # Delete empty workload
    command: assured workloads delete $$workload$$
    events:
    - expect_prompt_continue:
        message: You are about to delete Workload [$$workload$$]
        user_input: y
    - expect_stderr: |
        Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
    - api_call:
        expect_request:
          uri: https://us-central1-assuredworkloads.googleapis.com/v1beta1/$$workload$$?alt=json
          method: DELETE
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '3'
            content-type: application/json; charset=UTF-8
          body: |
            {}
          status: 200
    - expect_stderr: |
        Deleted Assured Workloads environment [$$workload$$].
    - expect_exit:
        code: 0
