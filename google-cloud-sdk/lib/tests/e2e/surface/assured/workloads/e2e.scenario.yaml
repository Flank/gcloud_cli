title: Workloads e2e tests
release_tracks: [BETA]
summary:
# This summary is generated by http://go/gcloud-scenario-tests on update and should not be edited.
- execute:
  - command: assured workloads create --organization=531459884741 --location=us-central1
      --display-name=gcloud-e2e-workloads --compliance-regime=FEDRAMP_MODERATE --billing-account="billingAccounts/0172AD-FDF25F-A4A2E9"
      --next-rotation-time=2040-1-30T10:15:00.00Z --rotation-period=172800s --external-identifier
      gcloud-2e2
  - stderr: |
      Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
  - progress_tracker:
    - message: Creating Assured Workloads environment
    - status: SUCCESS
  - stderr: |
      Created Assured Workloads environment [$$workload$$].
- execute:
  - command: assured workloads list organizations/531459884741/locations/us-central1
      --page-size=5 --limit=1 --filter="name=$$workload$$"
  - stderr: |
      Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
  - stdout: .*goog-aw-external-identifier:\ gcloud-2e2.*name:\ $$workload$$.*$
- execute:
  - command: assured workloads describe $$workload$$
  - stderr: |
      Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
  - stdout: .*goog-aw-external-identifier:\ gcloud-2e2.*name:\ $$workload$$.*$
- execute:
  - command: assured workloads update $$workload$$ --display-name=gcloud-e2e-workloads-updated
      --etag=$$workload-etag$$ --labels goog-aw-external-identifier=gcloud-2e2,update=true
  - stderr: |
      Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
  - stderr: |
      Updated Assured Workloads environment [$$workload$$].
- execute:
  - command: projects delete $$proj0$$
  - prompt:
    - message: Your project will be deleted.
    - input: y
  - stderr: Deleted\ \[https://cloudresourcemanager.googleapis.com/v1/projects/$$proj0$$.*$
- execute:
  - command: projects delete $$proj1$$
  - prompt:
    - message: Your project will be deleted.
    - input: y
  - stderr: Deleted\ \[https://cloudresourcemanager.googleapis.com/v1/projects/$$proj1$$.*$
- execute:
  - command: assured workloads delete $$workload$$
  - prompt:
    - message: You are about to delete Workload [$$workload$$]
    - input: y
  - stderr: |
      Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
  - stderr: |
      Deleted Assured Workloads environment [$$workload$$].
actions:
- execute_command:
    # Create a workload
    command: assured workloads create --organization=531459884741 --location=us-central1
      --display-name=gcloud-e2e-workloads --compliance-regime=FEDRAMP_MODERATE --billing-account="billingAccounts/0172AD-FDF25F-A4A2E9"
      --next-rotation-time=2040-1-30T10:15:00.00Z --rotation-period=172800s --external-identifier
      gcloud-2e2
    events:
    - expect_stderr: |
        Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
    - api_call:
        poll_operation: false
        expect_request:
          uri: https://us-central1-assuredworkloads.googleapis.com/v1beta1/organizations/531459884741/locations/us-central1/workloads?alt=json&externalId=gcloud-2e2
          method: POST
          body: |
            {
              "billingAccount": "billingAccounts/0172AD-FDF25F-A4A2E9",
              "complianceRegime": "FEDRAMP_MODERATE",
              "displayName": "gcloud-e2e-workloads",
              "fedrampModerateSettings": {
                "kmsSettings": {
                  "nextRotationTime": "2030-12-30T10:15:00.00Z",
                  "rotationPeriod": "172800s"
                }
              },
              "labels": {
                "labelkey1": "labelvalue1",
                "labelkey2": "labelvalue2"
              }
            }
        return_response:
          headers:
            cache-control: private
            content-length: '441'
            content-type: application/json; charset=UTF-8
          body:
            name: organizations/531459884741/locations/us-central1/operations/18fabd85-a94a-4240-85ea-203ceb6a8937
            metadata:
              '@type': type.googleapis.com/google.cloud.assuredworkloads.v1beta1.CreateWorkloadOperationMetadata
              createTime: '2020-09-03T14:11:51.323064Z'
              displayName: gcloud-e2e-workloads
              parent: organizations/531459884741/locations/us-central1
              complianceRegime: FEDRAMP_MODERATE
          status: 200
        expect_response:
          extract_references:
          - field: name
            reference: operation
          body:
            text:
              matches: .*name\":\s\"organizations/531459884741/locations/us-central1/operations/.+
    - api_call:
        repeatable: true
        expect_request:
          uri: https://us-central1-assuredworkloads.googleapis.com/v1beta1/$$operation$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '1029'
            content-type: application/json; charset=UTF-8
          body:
            name: organizations/531459884741/locations/us-central1/operations/18fabd85-a94a-4240-85ea-203ceb6a8937
            metadata:
              '@type': type.googleapis.com/google.cloud.assuredworkloads.v1beta1.CreateWorkloadOperationMetadata
              createTime: '2020-09-03T14:11:51.323064Z'
              displayName: gcloud-e2e-workloads
              parent: organizations/531459884741/locations/us-central1
              complianceRegime: FEDRAMP_MODERATE
            done: true
            response:
              '@type': type.googleapis.com/google.cloud.assuredworkloads.v1beta1.Workload
              name: organizations/531459884741/locations/us-central1/workloads/00-3ebf33c0-817f-417d-b855-6d6
              displayName: gcloud-e2e-workloads
              resources:
              - resourceId: '493031002111'
              - resourceId: '240392851323'
              complianceRegime: FEDRAMP_MODERATE
              createTime: '2020-09-03T14:12:03.103Z'
              etag: '-59382269'
              labels:
                goog-aw-external-identifier: gcloud-2e2
    - expect_progress_tracker:
        message: Creating Assured Workloads environment
        status: SUCCESS
    - api_call:
        expect_request:
          uri:
            matches: https://us-central1-assuredworkloads.googleapis.com/v1beta1/organizations/531459884741/locations/us-central1/workloads/[0-9a-z\-]+\?alt=json
          method: GET
          body: None
        return_response:
          body:
            name: organizations/531459884741/locations/us-central1/workloads/00-3ebf33c0-817f-417d-b855-6d6
            displayName: gcloud-e2e-workloads
            resources:
            - resourceId: '240392851323'
            - resourceId: '493031002111'
            complianceRegime: FEDRAMP_MODERATE
            createTime: '2020-09-03T14:12:03.103Z'
            etag: '-59382269'
            labels:
              goog-aw-external-identifier: gcloud-2e2
          status: 200
          headers:
            cache-control: private
            content-length: '440'
            content-type: application/json; charset=UTF-8
        expect_response:
          extract_references:
          - field: name
            reference: workload
          - field: etag
            reference: workload-etag
          - field: resources[0].resourceId
            reference: proj0
          - field: resources[1].resourceId
            reference: proj1
          body:
            json: {}
    - expect_stderr: |
        Created Assured Workloads environment [$$workload$$].
    - expect_exit:
        code: 0
- execute_command:
    # List workloads
    command: assured workloads list organizations/531459884741/locations/us-central1
      --page-size=5 --limit=1 --filter="name=$$workload$$"
    events:
    - expect_stderr: |
        Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
    - api_call:
        expect_request:
          uri: https://us-central1-assuredworkloads.googleapis.com/v1beta1/organizations/531459884741/locations/us-central1/workloads?alt=json&pageSize=5
          method: GET
          body: null
        expect_response:
          body:
            json: {}
        return_response:
          headers:
            cache-control: private
            content-length: '2686'
            content-type: application/json; charset=UTF-8
          body:
            workloads:
            - name: organizations/531459884741/locations/us-central1/workloads/00-3ebf33c0-817f-417d-b855-6d6
              displayName: gcloud-e2e-workloads
              resources:
              - resourceId: '240392851323'
              - resourceId: '493031002111'
              complianceRegime: FEDRAMP_MODERATE
              createTime: '2020-09-03T14:12:03.103Z'
              etag: '-59382269'
              labels:
                goog-aw-external-identifier: gcloud-2e2
            - name: organizations/531459884741/locations/us-central1/workloads/00-6e416852-6a4f-4ac3-97bc-600
              displayName: gcloud-e2e-workloads
              resources:
              - resourceId: '4962050984'
              - resourceId: '146235302208'
              complianceRegime: FEDRAMP_MODERATE
              createTime: '2020-09-03T08:12:30.073Z'
              etag: '-1726899842'
              labels:
                goog-aw-external-identifier: gcloud-2e2
            - name: organizations/531459884741/locations/us-central1/workloads/00-e0b7b939-1d26-41b3-8061-42f
              displayName: gcloud-e2e-workloads
              resources:
              - resourceId: '48876275424'
              - resourceId: '484959073005'
              complianceRegime: FEDRAMP_MODERATE
              createTime: '2020-09-01T19:01:46.555Z'
              etag: '1958112834'
              labels:
                goog-aw-external-identifier: gcloud-2e2
            - name: organizations/531459884741/locations/us-central1/workloads/00-8c2bf280-0c05-49ae-aad4-46f
              displayName: gcloud-e2e-workloads
              resources:
              - resourceId: '19191270817'
              - resourceId: '425451496967'
              complianceRegime: FEDRAMP_MODERATE
              createTime: '2020-09-01T19:01:45.807Z'
              etag: '1470443945'
              labels:
                goog-aw-external-identifier: gcloud-2e2
            - name: organizations/531459884741/locations/us-central1/workloads/00-28d1f0f4-b056-4643-8eae-22d
              displayName: gcloud-e2e-workloads
              resources:
              - resourceId: '337674887595'
              - resourceId: '750773131666'
              complianceRegime: FEDRAMP_MODERATE
              createTime: '2020-09-01T19:01:03.867Z'
              etag: '-1787746689'
              labels:
                goog-aw-external-identifier: gcloud-2e2
            nextPageToken: CjIKBgjvtLr6BQoGCMC9tZ0DCiAqHjAwLTI4ZDFmMGY0LWIwNTYtNDY0My04ZWFlLTIyZA==
          status: 200
    - expect_stdout:
        matches: .*goog-aw-external-identifier:\ gcloud-2e2.*name:\ $$workload$$.*
    - expect_exit:
        code: 0
- execute_command:
    # Describe workload
    command: assured workloads describe $$workload$$
    events:
    - expect_stderr: |
        Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
    - api_call:
        expect_request:
          uri: https://us-central1-assuredworkloads.googleapis.com/v1beta1/$$workload$$?alt=json
          method: GET
          body: null
        expect_response:
          body:
            json: {}
        return_response:
          headers:
            cache-control: private
            content-length: '440'
            content-type: application/json; charset=UTF-8
          body:
            name: organizations/531459884741/locations/us-central1/workloads/00-3ebf33c0-817f-417d-b855-6d6
            displayName: gcloud-e2e-workloads
            resources:
            - resourceId: '240392851323'
            - resourceId: '493031002111'
            complianceRegime: FEDRAMP_MODERATE
            createTime: '2020-09-03T14:12:03.103Z'
            etag: '-59382269'
            labels:
              goog-aw-external-identifier: gcloud-2e2
          status: 200
    - expect_stdout:
        matches: .*goog-aw-external-identifier:\ gcloud-2e2.*name:\ $$workload$$.*
    - expect_exit:
        code: 0
- execute_command:
    # Update workload name and add labels
    command: assured workloads update $$workload$$ --display-name=gcloud-e2e-workloads-updated
      --etag=$$workload-etag$$ --labels goog-aw-external-identifier=gcloud-2e2,update=true
    events:
    - expect_stderr: |
        Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
    - api_call:
        expect_request:
          uri: https://us-central1-assuredworkloads.googleapis.com/v1beta1/$$workload$$?alt=json&updateMask=workload.display_name%2Cworkload.labels
          method: PATCH
          body:
            json:
              displayName: gcloud-e2e-workloads-updated
              etag: $$workload-etag$$
              labels:
                goog-aw-external-identifier: gcloud-2e2
                update: 'true'
        expect_response:
          body:
            json:
              name: $$workload$$
              displayName: gcloud-e2e-workloads-updated
              labels:
                goog-aw-external-identifier: gcloud-2e2
                update: 'true'
        return_response:
          headers:
            cache-control: private
            content-length: '471'
            content-type: application/json; charset=UTF-8
          body:
            name: organizations/531459884741/locations/us-central1/workloads/00-3ebf33c0-817f-417d-b855-6d6
            displayName: gcloud-e2e-workloads-updated
            resources:
            - resourceId: '240392851323'
            - resourceId: '493031002111'
            complianceRegime: FEDRAMP_MODERATE
            createTime: '2020-09-03T14:12:03.103Z'
            etag: '-882213967'
            labels:
              goog-aw-external-identifier: gcloud-2e2
              update: 'true'
          status: 200
    - expect_stderr: |
        Updated Assured Workloads environment [$$workload$$].
    - expect_exit:
        code: 0
- execute_command:
    # Delete workload project 0
    command: projects delete $$proj0$$
    validation_only: true
    events:
    - expect_prompt_continue:
        message: Your project will be deleted.
        user_input: y
    - expect_stderr:
        matches: Deleted\ \[https://cloudresourcemanager.googleapis.com/v1/projects/$$proj0$$.*
    - expect_exit:
        code: 0
- execute_command:
    # Delete workload project 1
    command: projects delete $$proj1$$
    validation_only: true
    events:
    - expect_prompt_continue:
        message: Your project will be deleted.
        user_input: y
    - expect_stderr:
        matches: Deleted\ \[https://cloudresourcemanager.googleapis.com/v1/projects/$$proj1$$.*
    - expect_exit:
        code: 0
- execute_command:
    # Delete empty workload
    command: assured workloads delete $$workload$$
    events:
    - expect_prompt_continue:
        message: You are about to delete Workload [$$workload$$]
        user_input: y
    - expect_stderr: |
        Using endpoint [https://us-central1-assuredworkloads.googleapis.com/]
    - api_call:
        expect_request:
          uri: https://us-central1-assuredworkloads.googleapis.com/v1beta1/$$workload$$?alt=json
          method: DELETE
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '3'
            content-type: application/json; charset=UTF-8
          body: |
            {}
          status: 200
    - expect_stderr: |
        Deleted Assured Workloads environment [$$workload$$].
    - expect_exit:
        code: 0
