title: Cloud Game Servers multi-cluster crud test
release_tracks: [ALPHA]
summary:
# This summary is generated by http://go/gcloud-scenario-tests on update and should not be edited.
- execute:
  - command: |
      game servers realms create -q --no-user-output-enabled $$realm-id$$ --location $$location$$ --time-zone EST
- execute:
  - command: |
      game servers clusters create $$gsc-id-1$$ --location $$location$$ --realm
        $$realm-id$$ --gke-cluster $$gke-cluster-id$$
        --namespace default --allocation-priority p2 --no-dry-run
  - stderr: |
      Create request issued for: [$$gsc-id-1$$]
  - progress_tracker:
    - message: Waiting for [$$operation-basename$$] to finish
    - status: SUCCESS
  - stderr: |
      Created game server cluster: [$$gsc-id-1$$]
- execute:
  - command: |
      game servers clusters update $$gsc-id-1$$ --realm $$realm-id$$ --location $$location$$
      --allocation-priority p4 --no-dry-run
  - stderr: |
      Update request issued for: [$$gsc-id-1$$]
  - progress_tracker:
    - message: Waiting for [$$operation-basename$$] to finish
    - status: SUCCESS
  - stderr: |
      Updated game server cluster: [$$gsc-id-1$$]
  - stdout: |
      allocationPriority: P4
      connectionInfo:
        gkeClusterReference:
          cluster: $$gke-cluster-id$$
        namespace: default
      name: projects/cloud-sdk-integration-testing/locations/$$location$$/realms/$$realm-id$$/gameServerClusters/$$gsc-id-1$$
- execute:
  - command: |
      game servers clusters list --location $$location$$ --realm $$realm-id$$
  - stdout: |-
      .*$$gsc-id-1$$.*$$location$$.*$$realm-id$$.*$$gke-cluster-id$$.*
      $
- execute:
  - command: |
      game servers clusters delete -q --no-user-output-enabled $$gsc-id-1$$ --realm=$$realm-id$$ --location $$location$$ --no-dry-run
- execute:
  - command: |
      game servers realms delete -q --no-user-output-enabled $$realm-id$$ --location $$location$$
actions:
- generate_resource_id:
    reference: gsc-id-1
    prefix: gsc
- generate_resource_id:
    reference: realm-id
    prefix: realm

- define_reference:
    reference: location
    value: us-east1
- define_reference:
    reference: api-version
    track_values:
      ALPHA: v1alpha
- define_reference:
    reference: gke-cluster-id
    value: projects/mcgs-component-autopush/locations/us-central1/clusters/gke-shared-agones-reference-only

- execute_command:
    command: |
      game servers realms create -q --no-user-output-enabled $$realm-id$$ --location $$location$$ --time-zone EST
    validation_only: true
    events:
    - expect_exit:
        code: 0
- execute_command:
    command: |
      game servers clusters create $$gsc-id-1$$ --location $$location$$ --realm
        $$realm-id$$ --gke-cluster $$gke-cluster-id$$
        --namespace default --allocation-priority p2 --no-dry-run
    events:
    - expect_stderr: |
        Create request issued for: [$$gsc-id-1$$]
    - api_call:
        expect_request:
          uri: https://gameservices.googleapis.com/$$api-version$$/projects/cloud-sdk-integration-testing/locations/$$location$$/realms/$$realm-id$$/gameServerClusters?alt=json&gameServerClusterId=$$gsc-id-1$$
          method: POST
          headers: {}
          body:
            json:
              connectionInfo:
                gkeClusterReference:
                  cluster: $$gke-cluster-id$$
                namespace: default
              allocation_priority: P2
        return_response:
          headers:
            cache-control: private
            content-length: '552'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/cloud-sdk-integration-testing/locations/us-east1/operations/operation-1602017096239-5b106abf20ae6-813b992f-6c16febb
            metadata:
              '@type': type.googleapis.com/google.cloud.gaming.$$api-version$$.OperationMetadata
              createTime: '2020-10-06T20:44:56.544665534Z'
              target: projects/cloud-sdk-integration-testing/locations/$$location$$/realms/$$realm-id$$/gameServerClusters/$$gsc-id-1$$
              verb: create
              requestedCancellation: false
              apiVersion: $$api-version$$
            done: false
          status: 200
        poll_operation: true
    - expect_progress_tracker:
        message: Waiting for [$$operation-basename$$] to finish
        status: SUCCESS
    - expect_stderr: |
        Created game server cluster: [$$gsc-id-1$$]
    - api_call:
        expect_request:
          uri: https://gameservices.googleapis.com/$$api-version$$/projects/cloud-sdk-integration-testing/locations/$$location$$/realms/$$realm-id$$/gameServerClusters/$$gsc-id-1$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '545'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/cloud-sdk-integration-testing/locations/$$location$$/realms/$$realm-id$$/gameServerClusters/$$gsc-id-1$$
            createTime: '2020-10-06T20:44:56.538156823Z'
            updateTime: '2020-10-06T20:44:56.962795138Z'
            connectionInfo:
              namespace: default
              gkeClusterReference:
                cluster: $$gke-cluster-id$$
            etag: xQrhK5VynS4N9ZeA5EQn5KeilTAPkMOzRHc6raU-4Gw
            allocationPriority: P2
          status: 200
    - expect_exit:
        code: 0
- execute_command:
    command: |
      game servers clusters update $$gsc-id-1$$ --realm $$realm-id$$ --location $$location$$
      --allocation-priority p4 --no-dry-run
    events:
    - api_call:
        expect_request:
          uri: https://gameservices.googleapis.com/$$api-version$$/projects/cloud-sdk-integration-testing/locations/$$location$$/realms/$$realm-id$$/gameServerClusters/$$gsc-id-1$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '545'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/cloud-sdk-integration-testing/locations/$$location$$/realms/$$realm-id$$/gameServerClusters/$$gsc-id-1$$
            createTime: '2020-10-06T20:44:56.538156823Z'
            updateTime: '2020-10-06T20:44:56.962795138Z'
            connectionInfo:
              namespace: default
              gkeClusterReference:
                cluster: $$gke-cluster-id$$
            etag: xQrhK5VynS4N9ZeA5EQn5KeilTAPkMOzRHc6raU-4Gw
            allocationPriority: P2
    - expect_stderr: |
        Update request issued for: [$$gsc-id-1$$]
    - api_call:
        expect_request:
          uri: https://gameservices.googleapis.com/$$api-version$$/projects/cloud-sdk-integration-testing/locations/$$location$$/realms/$$realm-id$$/gameServerClusters/$$gsc-id-1$$?alt=json&updateMask=allocationPriority
          method: PATCH
          headers: {}
          body:
            json:
              allocationPriority: P4
              connectionInfo:
                gkeClusterReference:
                  cluster: $$gke-cluster-id$$
                namespace: default
              name: projects/cloud-sdk-integration-testing/locations/$$location$$/realms/$$realm-id$$/gameServerClusters/$$gsc-id-1$$
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '552'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/cloud-sdk-integration-testing/locations/us-east1/operations/operation-1602017098552-5b106ac15537b-df1349be-375c2254
            metadata:
              '@type': type.googleapis.com/google.cloud.gaming.$$api-version$$.OperationMetadata
              createTime: '2020-10-06T20:44:58.564389625Z'
              target: projects/cloud-sdk-integration-testing/locations/$$location$$/realms/$$realm-id$$/gameServerClusters/$$gsc-id-1$$
              verb: update
              requestedCancellation: false
              apiVersion: $$api-version$$
            done: false
        poll_operation: true
    - expect_progress_tracker:
        message: Waiting for [$$operation-basename$$] to finish
        status: SUCCESS
    - expect_stderr: |
        Updated game server cluster: [$$gsc-id-1$$]
    - api_call:
        expect_request:
          uri: https://gameservices.googleapis.com/$$api-version$$/projects/cloud-sdk-integration-testing/locations/$$location$$/realms/$$realm-id$$/gameServerClusters/$$gsc-id-1$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '545'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/cloud-sdk-integration-testing/locations/$$location$$/realms/$$realm-id$$/gameServerClusters/$$gsc-id-1$$
            createTime: '2020-10-06T20:44:56.538156823Z'
            updateTime: '2020-10-06T20:44:58.619163471Z'
            connectionInfo:
              namespace: default
              gkeClusterReference:
                cluster: $$gke-cluster-id$$
            etag: 3ELNmAQu7qHgURTVRChbv9XAJUDPecU6C1Wg7GHfquY
            allocationPriority: P4
    - expect_stdout:
        matches: |
          ^allocationPriority:\sP4.*$$gke-cluster-id$$.*projects/cloud-sdk-integration-testing/locations/$$location$$/realms/$$realm-id$$/gameServerClusters/$$gsc-id-1$$.*
    - expect_exit:
        code: 0
- execute_command:
    command: |
      game servers clusters list --location $$location$$ --realm $$realm-id$$
    events:
    - api_call:
        expect_request:
          uri: https://gameservices.googleapis.com/$$api-version$$/projects/cloud-sdk-integration-testing/locations/$$location$$/realms/$$realm-id$$/gameServerClusters?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '631'
            content-type: application/json; charset=UTF-8
          body:
            gameServerClusters:
            - name: projects/cloud-sdk-integration-testing/locations/$$location$$/realms/$$realm-id$$/gameServerClusters/$$gsc-id-1$$
              createTime: '2020-10-06T20:44:56.538156823Z'
              updateTime: '2020-10-06T20:44:58.619163471Z'
              connectionInfo:
                namespace: default
                gkeClusterReference:
                  cluster: $$gke-cluster-id$$
              etag: 3ELNmAQu7qHgURTVRChbv9XAJUDPecU6C1Wg7GHfquY
              allocationPriority: P4
          status: 200
    - expect_stdout:
        matches: |
          .*$$gsc-id-1$$.*$$location$$.*$$realm-id$$.*$$gke-cluster-id$$.*
    - expect_exit:
        code: 0
- execute_command:
    command: |
      game servers clusters delete -q --no-user-output-enabled $$gsc-id-1$$ --realm=$$realm-id$$ --location $$location$$ --no-dry-run
    validation_only: true
    cleanup_for: gsc-id-1
    events:
    - expect_exit:
        code: 0
- execute_command:
    command: |
      game servers realms delete -q --no-user-output-enabled $$realm-id$$ --location $$location$$
    validation_only: true
    cleanup_for: realm-id
    events:
    - expect_exit:
        code: 0
