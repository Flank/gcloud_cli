title: Test basic bucket operations
release_tracks: [ALPHA]
filters:
  DoNotRunOnPy2:
    reason: Storage does not support Python 2.
summary:
# This summary is generated by http://go/gcloud-scenario-tests on update and should not be edited.
- execute:
  - command: storage buckets create $$bucket$$ --format none
  - stderr: |
      Created bucket [$$bucket$$].
- execute:
  - command: storage cp test_data/c/c.txt gs://$$bucket$$/c.txt
- execute:
  - command: storage ls gs://$$bucket$$/c.txt --format 'text(path)'
  - stdout: |
      gs://$$bucket$$/c.txt
- execute:
  - command: storage delete gs://$$bucket$$ --recursive --num-threads=0
  - stderr: |
      WARNING: Deleting a bucket is irreversible and makes that bucket name available for others to claim.
  - prompt:
    - message: |-
        This command will delete the following buckets:
          $$bucket$$
    - input: y
  - prompt:
    - message: |-
        You are about to delete the following:
          gs://$$bucket$$
          gs://$$bucket$$/c.txt
    - input: y
  - progress_bar:
    - message: Deleting Files
  - stderr: |2

      Deleted [1] file.
  - stderr: |
      Deleted bucket [gs://$$bucket$$].
actions:
# Setup.
- write_file:
    path: test_data/c/c.txt
    contents: c/c.txt contents
- generate_resource_id:
    reference: bucket
    prefix: storage-bucket
- execute_command:
    command: storage buckets create $$bucket$$ --format none
    validation_only: true
    events:
    - expect_stderr: |
        Created bucket [$$bucket$$].
    - expect_exit:
        code: 0

- execute_command:
    # Copy a single file to a directory.
    command: storage cp test_data/c/c.txt gs://$$bucket$$/c.txt
    events:
    - api_call:
        expect_request:
          uri: https://storage.googleapis.com/storage/v1/b/$$bucket$$/o/c.txt?alt=json&projection=noAcl
          method: GET
          headers: {}
          body: null
        return_response:
          status: 404
          headers:
            cache-control: no-cache, no-store, max-age=0, must-revalidate
            content-length: '289'
            content-type: application/json; charset=UTF-8
            pragma: no-cache
            x-guploader-uploadid: ABg5-Uw6FhIXWwPxvxBHjA8QDaHpzU3IguELVF7af6DXbMSd8lsC0pXQXL0X1TL8IAxzeDOC2bYtCj567uZ2HmAbV3g
          body:
            error:
              code: 404
              message: 'No such object: $$bucket$$/c.txt'
              errors:
              - message: 'No such object: $$bucket$$/c.txt'
                domain: global
                reason: notFound
    - api_call:
        expect_request:
          uri: https://storage.googleapis.com/storage/v1/b/$$bucket$$/o?alt=json&delimiter=%2F&maxResults=1000&prefix=c.txt&projection=noAcl&versions=False
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private, max-age=0, must-revalidate, no-transform
            content-length: '32'
            content-type: application/json; charset=UTF-8
            x-guploader-uploadid: ABg5-Uwukh68jUyHfnCjMlXpRqcloVWYIfUSrlsJGrvpPACkToTEatuBufhu302dAFkgWKnYuOoxBx4-txFy3T_k-g
          body:
            kind: storage#objects
    - api_call:
        expect_request:
          uri: https://storage.googleapis.com/upload/storage/v1/b/$$bucket$$/o?alt=json&uploadType=multipart
          method: POST
          headers: {}
          body:
            text:
              matches: |
                --===============\d+==
                Content-Type: application/json
                MIME-Version: 1.0

                {"bucket": "$$bucket$$", "name": "c.txt"}
                --===============\d+==
                Content-Type: application/octet-stream
                MIME-Version: 1.0
                Content-Transfer-Encoding: binary

                c/c.txt contents
                --===============\d+==--
        return_response:
          status: 200
          headers:
            cache-control: no-cache, no-store, max-age=0, must-revalidate
            content-length: '815'
            content-type: application/json; charset=UTF-8
            etag: CLqn2dn8/OsCEAE=
            pragma: no-cache
            x-guploader-uploadid: ABg5-Ux9W2DjKgBGO-QEk6Wzt2r8YBoeF4u15zYJhQ-O4tQUv_G-RRHUb5DRwiR7Q5ViBhJ5xbF_eoWP8IQkNamPK3s
          body:
            kind: storage#object
            id: $$bucket$$/c.txt/1600784965194682
            selfLink: https://www.googleapis.com/storage/v1/b/$$bucket$$/o/c.txt
            mediaLink: https://storage.googleapis.com/download/storage/v1/b/$$bucket$$/o/c.txt?generation=1600784965194682&alt=media
            name: c.txt
            bucket: $$bucket$$
            generation: '1600784965194682'
            metageneration: '1'
            contentType: application/octet-stream
            storageClass: STANDARD
            size: '16'
            md5Hash: rRCEo+QDC0OMiG8j+ucmzA==
            crc32c: lM1yKQ==
            etag: CLqn2dn8/OsCEAE=
            timeCreated: '2020-09-22T14:29:25.194Z'
            updated: '2020-09-22T14:29:25.194Z'
            timeStorageClassUpdated: '2020-09-22T14:29:25.194Z'
    - expect_exit:
        code: 0
- execute_command:
    command: storage ls gs://$$bucket$$/c.txt --format 'text(path)'
    validation_only: true
    events:
    - expect_stdout: |
        gs://$$bucket$$/c.txt
    - expect_exit:
        code: 0
- execute_command:
    command: storage delete gs://$$bucket$$ --recursive --num-threads=0
    cleanup_for: bucket
    events:
    - api_call:
        expect_request:
          uri: https://storage.googleapis.com/storage/v1/b/$$bucket$$/o?alt=json&maxResults=1000
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private, max-age=0, must-revalidate, no-transform
            content-length: '941'
            content-type: application/json; charset=UTF-8
            x-guploader-uploadid: ABg5-Uz5z3DkDaWuxdXGzDgIBAFRCqVa0zdFkWimlPnycy5zmAXXrndPV82-FKzMDGVf7ZZleNoOrjpNlfn4J_AES9A
          body:
            kind: storage#objects
            items:
            - kind: storage#object
              id: $$bucket$$/c.txt/1600784965194682
              selfLink: https://www.googleapis.com/storage/v1/b/$$bucket$$/o/c.txt
              mediaLink: https://storage.googleapis.com/download/storage/v1/b/$$bucket$$/o/c.txt?generation=1600784965194682&alt=media
              name: c.txt
              bucket: $$bucket$$
              generation: '1600784965194682'
              metageneration: '1'
              contentType: application/octet-stream
              storageClass: STANDARD
              size: '16'
              md5Hash: rRCEo+QDC0OMiG8j+ucmzA==
              crc32c: lM1yKQ==
              etag: CLqn2dn8/OsCEAE=
              timeCreated: '2020-09-22T14:29:25.194Z'
              updated: '2020-09-22T14:29:25.194Z'
              timeStorageClassUpdated: '2020-09-22T14:29:25.194Z'
          status: 200
    - expect_stderr: |
        WARNING: Deleting a bucket is irreversible and makes that bucket name available for others to claim.
    - expect_prompt_continue:
        message: |-
          This command will delete the following buckets:
            $$bucket$$
        user_input: y
    - expect_prompt_continue:
        message: |-
          You are about to delete the following:
            gs://$$bucket$$
            gs://$$bucket$$/c.txt
        user_input: y
    - expect_progress_bar:
        message: Deleting Files
    - api_call:
        expect_request:
          uri: https://storage.googleapis.com/storage/v1/b/$$bucket$$/o/c.txt?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          status: 204
          headers:
            cache-control: no-cache, no-store, max-age=0, must-revalidate
            content-length: '0'
            content-type: application/json
            pragma: no-cache
            x-guploader-uploadid: ABg5-UzDOUdRJyapp184O3VQY5h1vmnHaKkVwN1uSM6CNRSNYHckuaoq3jqodruejiN939igOiA0gv5-skcpScUY7o0
          body: ''
    - expect_stderr: |2

        Deleted [1] file.
    - api_call:
        expect_request:
          uri: https://storage.googleapis.com/storage/v1/b/$$bucket$$?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          status: 204
          headers:
            cache-control: no-cache, no-store, max-age=0, must-revalidate
            content-length: '0'
            content-type: application/json
            pragma: no-cache
            x-guploader-uploadid: ABg5-UyBeadP6uDRJze_7vdoMi38CNBO_eb4w8Cx7unEYoOakmWbE1_RzvjeLtYl1dkAiljsxkf-37yNhdx9PQ9qlEY
          body: ''
    - expect_stderr: |
        Deleted bucket [gs://$$bucket$$].
    - expect_exit:
        code: 0
