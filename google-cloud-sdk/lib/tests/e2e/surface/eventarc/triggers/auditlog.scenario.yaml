filters:
  skip:
    reason: requires an optional flag to be specified
    bug: b/170938003
title: CRUD operations on an Audit Log trigger
release_tracks: [BETA]
summary:
# This summary is generated by http://go/gcloud-scenario-tests on update and should not be edited.
- set_property: eventarc/location global
- execute:
  - command: run deploy $$my-service$$ --allow-unauthenticated --image gcr.io/knative-samples/helloworld-nodejs
      --platform managed --region us-central1
  - stderr: 'Is None: False'
  - staged_progress_tracker:
    - message: Deploying new service...
    - status: SUCCESS
  - stderr: 'Is None: False'
- execute:
  - command: eventarc triggers create $$my-trigger$$ --matching-criteria type=google.cloud.audit.log.v1.written
      --matching-criteria serviceName=storage.googleapis.com --matching-criteria methodName=storage.buckets.create
      --matching-criteria resourceName=projects/_/buckets/my-bucket --destination-run-service
      $$my-service$$ --destination-run-path my-path --destination-run-region us-central1
  - progress_tracker:
    - message: Waiting for operation [$$operation-basename$$] to complete
    - status: SUCCESS
  - stderr: |
      WARNING: It may take up to 10 minutes for the new trigger to become active.
- execute:
  - command: eventarc triggers list --format 'yaml(name)'
  - stdout: |-
      .*name: projects/cloud-sdk-integration-testing/locations/global/triggers/$$my-trigger$$.*
      $
- execute:
  - command: eventarc triggers describe $$my-trigger$$ --format 'yaml(name)'
  - stdout: |
      name: projects/cloud-sdk-integration-testing/locations/global/triggers/$$my-trigger$$
- execute:
  - command: eventarc triggers update $$my-trigger$$ --matching-criteria type=google.cloud.audit.log.v1.written
      --matching-criteria serviceName=storage.googleapis.com --matching-criteria methodName=storage.objects.create
      --clear-destination-run-path
  - progress_tracker:
    - message: Waiting for operation [$$operation-basename$$] to complete
    - status: SUCCESS
  - stderr: |
      WARNING: It may take up to 10 minutes for the update to take full effect.
- execute:
  - command: eventarc triggers delete $$my-trigger$$
  - progress_tracker:
    - message: Waiting for operation [$$operation-basename$$] to complete
    - status: SUCCESS
- execute:
  - command: run services delete $$my-service$$ --platform managed --region us-central1
  - prompt:
    - input: y
  - stderr: 'Is None: False'
actions:

- set_property:
    eventarc/location: global

- generate_resource_id:
    reference: my-service
    prefix: run-service

- execute_command:
    command: run deploy $$my-service$$ --allow-unauthenticated --image gcr.io/knative-samples/helloworld-nodejs
      --platform managed --region us-central1
    validation_only: true
    events:
    - expect_stderr:
        is_none: false
    - expect_staged_progress_tracker:
        message: Deploying new service...
        status: SUCCESS
    - expect_stderr:
        is_none: false
    - expect_exit:
        code: 0

- generate_resource_id:
    reference: my-trigger
    prefix: eventarc-trigger

- execute_command:
    command: eventarc triggers create $$my-trigger$$ --matching-criteria type=google.cloud.audit.log.v1.written
      --matching-criteria serviceName=storage.googleapis.com --matching-criteria methodName=storage.buckets.create
      --matching-criteria resourceName=projects/_/buckets/my-bucket --destination-run-service
      $$my-service$$ --destination-run-path my-path --destination-run-region us-central1
    events:
    - api_call:
        expect_request:
          uri: https://eventarc.googleapis.com/v1beta1/projects/cloud-sdk-integration-testing/locations/global/triggers?alt=json&triggerId=$$my-trigger$$
          method: POST
          headers: {}
          body:
            json:
              destination:
                cloudRunService:
                  path: my-path
                  region: us-central1
                  service: $$my-service$$
              matchingCriteria:
              - attribute: type
                value: google.cloud.audit.log.v1.written
              - attribute: serviceName
                value: storage.googleapis.com
              - attribute: methodName
                value: storage.buckets.create
              - attribute: resourceName
                value: projects/_/buckets/my-bucket
              name: projects/cloud-sdk-integration-testing/locations/global/triggers/$$my-trigger$$
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '519'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/cloud-sdk-integration-testing/locations/global/operations/operation-1601586144615-5b0a2553a1af8-bc98b701-4ad20598
            metadata:
              '@type': type.googleapis.com/google.cloud.eventarc.v1beta1.OperationMetadata
              createTime: '2020-10-01T21:02:24.769647944Z'
              target: projects/cloud-sdk-integration-testing/locations/global/triggers/$$my-trigger$$
              verb: create
              requestedCancellation: false
              apiVersion: v1beta1
            done: false
        poll_operation: true
    - expect_progress_tracker:
        message: Waiting for operation [$$operation-basename$$] to complete
        status: SUCCESS
    - expect_stderr: |
        WARNING: It may take up to 10 minutes for the new trigger to become active.
    - expect_exit:
        code: 0

- execute_command:
    command: eventarc triggers list --format 'yaml(name)'
    events:
    - api_call:
        expect_request:
          uri: https://eventarc.googleapis.com/v1beta1/projects/cloud-sdk-integration-testing/locations/global/triggers?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '1241'
            content-type: application/json; charset=UTF-8
          body:
            triggers:
            - name: projects/cloud-sdk-integration-testing/locations/global/triggers/$$my-trigger$$
              createTime: '2020-10-01T21:02:24.679209147Z'
              updateTime: '2020-10-01T21:02:30.505480008Z'
              matchingCriteria:
              - attribute: resourceName
                value: projects/_/buckets/my-bucket
              - attribute: type
                value: google.cloud.audit.log.v1.written
              - attribute: serviceName
                value: storage.googleapis.com
              - attribute: methodName
                value: storage.buckets.create
              destination:
                cloudRunService:
                  service: $$my-service$$
                  path: my-path
                  region: us-central1
              transport:
                pubsub:
                  topic: projects/cloud-sdk-integration-testing/topics/eventarc-global-$$my-trigger$$-035
                  subscription: projects/cloud-sdk-integration-testing/subscriptions/eventarc-global-$$my-trigger$$-sub-035
    - expect_stdout:
        matches: |
          .*name: projects/cloud-sdk-integration-testing/locations/global/triggers/$$my-trigger$$.*
    - expect_exit:
        code: 0

- execute_command:
    command: eventarc triggers describe $$my-trigger$$ --format 'yaml(name)'
    events:
    - api_call:
        expect_request:
          uri: https://eventarc.googleapis.com/v1beta1/projects/cloud-sdk-integration-testing/locations/global/triggers/$$my-trigger$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '1073'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/cloud-sdk-integration-testing/locations/global/triggers/$$my-trigger$$
            createTime: '2020-10-01T21:02:24.679209147Z'
            updateTime: '2020-10-01T21:02:30.505480008Z'
            matchingCriteria:
            - attribute: type
              value: google.cloud.audit.log.v1.written
            - attribute: serviceName
              value: storage.googleapis.com
            - attribute: methodName
              value: storage.buckets.create
            - attribute: resourceName
              value: projects/_/buckets/my-bucket
            destination:
              cloudRunService:
                service: $$my-service$$
                path: my-path
                region: us-central1
            transport:
              pubsub:
                topic: projects/cloud-sdk-integration-testing/topics/eventarc-global-$$my-trigger$$-035
                subscription: projects/cloud-sdk-integration-testing/subscriptions/eventarc-global-$$my-trigger$$-sub-035
    - expect_stdout: |
        name: projects/cloud-sdk-integration-testing/locations/global/triggers/$$my-trigger$$
    - expect_exit:
        code: 0

- execute_command:
    command: eventarc triggers update $$my-trigger$$ --matching-criteria type=google.cloud.audit.log.v1.written
      --matching-criteria serviceName=storage.googleapis.com --matching-criteria methodName=storage.objects.create
      --clear-destination-run-path
    events:
    - api_call:
        expect_request:
          uri: https://eventarc.googleapis.com/v1beta1/projects/cloud-sdk-integration-testing/locations/global/triggers/$$my-trigger$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '1073'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/cloud-sdk-integration-testing/locations/global/triggers/$$my-trigger$$
            createTime: '2020-10-01T21:02:24.679209147Z'
            updateTime: '2020-10-01T21:02:30.505480008Z'
            matchingCriteria:
            - attribute: type
              value: google.cloud.audit.log.v1.written
            - attribute: serviceName
              value: storage.googleapis.com
            - attribute: methodName
              value: storage.buckets.create
            - attribute: resourceName
              value: projects/_/buckets/my-bucket
            destination:
              cloudRunService:
                service: $$my-service$$
                path: my-path
                region: us-central1
            transport:
              pubsub:
                topic: projects/cloud-sdk-integration-testing/topics/eventarc-global-$$my-trigger$$-035
                subscription: projects/cloud-sdk-integration-testing/subscriptions/eventarc-global-$$my-trigger$$-sub-035
    - api_call:
        expect_request:
          uri: https://eventarc.googleapis.com/v1beta1/projects/cloud-sdk-integration-testing/locations/global/triggers/$$my-trigger$$?alt=json&updateMask=destination.cloudRunService.path%2CmatchingCriteria
          method: PATCH
          headers: {}
          body:
            json:
              destination:
                cloudRunService: {}
              matchingCriteria:
              - attribute: type
                value: google.cloud.audit.log.v1.written
              - attribute: serviceName
                value: storage.googleapis.com
              - attribute: methodName
                value: storage.objects.create
              name: projects/cloud-sdk-integration-testing/locations/global/triggers/$$my-trigger$$
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '519'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/cloud-sdk-integration-testing/locations/global/operations/operation-1601586152128-5b0a255acc052-ec2ef854-dade5795
            metadata:
              '@type': type.googleapis.com/google.cloud.eventarc.v1beta1.OperationMetadata
              createTime: '2020-10-01T21:02:32.205723118Z'
              target: projects/cloud-sdk-integration-testing/locations/global/triggers/$$my-trigger$$
              verb: update
              requestedCancellation: false
              apiVersion: v1beta1
            done: false
        poll_operation: true
    - expect_progress_tracker:
        message: Waiting for operation [$$operation-basename$$] to complete
        status: SUCCESS
    - expect_stderr: |
        WARNING: It may take up to 10 minutes for the update to take full effect.
    - expect_exit:
        code: 0

- execute_command:
    command: eventarc triggers delete $$my-trigger$$
    cleanup_for: my-trigger
    events:
    - api_call:
        expect_request:
          uri: https://eventarc.googleapis.com/v1beta1/projects/cloud-sdk-integration-testing/locations/global/triggers/$$my-trigger$$?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '519'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/cloud-sdk-integration-testing/locations/global/operations/operation-1601586159349-5b0a2561aee5b-a7e2b626-ede57c62
            metadata:
              '@type': type.googleapis.com/google.cloud.eventarc.v1beta1.OperationMetadata
              createTime: '2020-10-01T21:02:39.443397458Z'
              target: projects/cloud-sdk-integration-testing/locations/global/triggers/$$my-trigger$$
              verb: delete
              requestedCancellation: false
              apiVersion: v1beta1
            done: false
        poll_operation: true
    - expect_progress_tracker:
        message: Waiting for operation [$$operation-basename$$] to complete
        status: SUCCESS
    - expect_exit:
        code: 0

- execute_command:
    command: run services delete $$my-service$$ --platform managed --region us-central1
    cleanup_for: my-service
    validation_only: true
    events:
    - expect_prompt_continue:
        user_input: y
    - expect_stderr:
        is_none: false
    - expect_exit:
        code: 0
