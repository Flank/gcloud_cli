filters:
  skip:
    reason: various backend errors
    bug: b/167184603
title: Create and delete a Cloud Audit Logs trigger
release_tracks: [ALPHA, BETA]
summary:
# This summary is generated by http://go/gcloud-scenario-tests on update and should not be edited.
- set_property: run/platform gke
- set_property: run/region us-central1
- set_property: run/cluster do-not-delete-knative-test-eventing
- set_property: run/cluster_location us-central1-a
- execute:
  - command: |
      run deploy $$event-display$$ --namespace=default --image=gcr.io/knative-releases/knative.dev/eventing-contrib/cmd/event_display@sha256:070f31589d919779a83adf3cc0f0b0e3f5f063eb57a67d53e5e8d0c5eefb57ba
  - stderr: |
      Deploying container to Cloud Run for Anthos service [$$event-display$$] in namespace [default] of cluster [do-not-delete-knative-test-eventing]
  - staged_progress_tracker:
    - message: Deploying new service...
    - status: SUCCESS
    - succeeded_stages: &id001
      - Creating Revision...
      - Routing traffic...
  - stderr: |
      Service \[$$event-display$$\] revision \[$$event-display$$.*\] has been deployed and is serving 100 percent of traffic.
      Service URL: http://$$event-display$$.default.example.com
      $
- execute:
  - command: events triggers create $$my-trigger$$ --namespace default --target-service=event-display
      --type=google.cloud.audit.log.v1.written --parameters serviceName=pubsub.googleapis.com
      --parameters methodName=google.pubsub.v1.Publisher.CreateTopic
  - staged_progress_tracker:
    - message: Initializing trigger...
    - status: SUCCESS
- execute:
  - command: events triggers list --filter "metadata.selfLink:$$my-trigger$$"
  - stdout: |2
         TRIGGER                       EVENT TYPE                         TARGET
      +  $$my-trigger$$  google.cloud.audit.log.v1.written  event-display
- execute:
  - command: events triggers delete $$my-trigger$$
  - prompt:
    - message: Trigger [$$my-trigger$$] will be deleted.
    - input: y
  - stderr: |
      Deleted trigger [$$my-trigger$$].
- execute:
  - command: run services delete $$event-display$$
  - prompt:
    - input: y
  - stderr: |
      Deleted service [$$event-display$$].

actions:
- set_property:
    run/platform: gke
- set_property:
    run/region: us-central1
- set_property:
    run/cluster: do-not-delete-knative-test-eventing
- set_property:
    run/cluster_location: us-central1-a
- generate_resource_id:
    reference: event-display
    prefix: service
- execute_command:
    command: |
      run deploy $$event-display$$ --namespace=default --image=gcr.io/knative-releases/knative.dev/eventing-contrib/cmd/event_display@sha256:070f31589d919779a83adf3cc0f0b0e3f5f063eb57a67d53e5e8d0c5eefb57ba
    validation_only: true
    events:
    - expect_stderr: |
        Deploying container to Cloud Run for Anthos service [$$event-display$$] in namespace [default] of cluster [do-not-delete-knative-test-eventing]
    - expect_staged_progress_tracker:
        message: Deploying new service...
        status: SUCCESS
        succeeded_stages: *id001
    - expect_stderr:
        matches: |
          Service \[$$event-display$$\] revision \[$$event-display$$.*\] has been deployed and is serving 100 percent of traffic.
          Service URL: http://$$event-display$$.default.example.com
    - expect_exit:
        code: 0
- generate_resource_id:
    reference: my-trigger
    prefix: trigger


- execute_command:
    command: events triggers create $$my-trigger$$ --namespace default --target-service=$$event-display$$
      --type=google.cloud.audit.log.v1.written --parameters serviceName=pubsub.googleapis.com
      --parameters methodName=google.pubsub.v1.Publisher.CreateTopic
    validation_only: true
    events:
    - expect_staged_progress_tracker:
        message: Initializing trigger...
        status: SUCCESS
    - expect_exit:
        code: 0
- execute_command:
    command: events triggers list --filter "metadata.selfLink:$$my-trigger$$"
    events:
    - api_call:
        expect_request:
          uri: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/locations/us-central1-a/clusters/do-not-delete-knative-test-eventing?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '5558'
            content-type: application/json; charset=UTF-8
          body:
            name: do-not-delete-knative-test-eventing
            nodeConfig:
              machineType: n1-standard-4
              diskSizeGb: 100
              oauthScopes:
              - https://www.googleapis.com/auth/devstorage.read_only
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring
              - https://www.googleapis.com/auth/service.management.readonly
              - https://www.googleapis.com/auth/servicecontrol
              - https://www.googleapis.com/auth/trace.append
              metadata:
                disable-legacy-endpoints: 'true'
              imageType: COS
              serviceAccount: default
              diskType: pd-standard
              shieldedInstanceConfig:
                enableIntegrityMonitoring: true
            masterAuth:
              clusterCaCertificate: ==
            loggingService: logging.googleapis.com/kubernetes
            monitoringService: monitoring.googleapis.com/kubernetes
            network: default
            clusterIpv4Cidr: 10.36.0.0/14
            addonsConfig:
              httpLoadBalancing: {}
              horizontalPodAutoscaling: {}
              kubernetesDashboard:
                disabled: true
              networkPolicyConfig:
                disabled: true
              cloudRunConfig: {}
            nodePools:
            - name: default-pool
              config:
                machineType: n1-standard-4
                diskSizeGb: 100
                oauthScopes:
                - https://www.googleapis.com/auth/devstorage.read_only
                - https://www.googleapis.com/auth/logging.write
                - https://www.googleapis.com/auth/monitoring
                - https://www.googleapis.com/auth/service.management.readonly
                - https://www.googleapis.com/auth/servicecontrol
                - https://www.googleapis.com/auth/trace.append
                metadata:
                  disable-legacy-endpoints: 'true'
                imageType: COS
                serviceAccount: default
                diskType: pd-standard
                shieldedInstanceConfig:
                  enableIntegrityMonitoring: true
              initialNodeCount: 3
              autoscaling:
                enabled: true
                minNodeCount: 3
                maxNodeCount: 10
              management:
                autoUpgrade: true
                autoRepair: true
              podIpv4CidrSize: 24
              locations:
              - us-central1-a
              selfLink: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/clusters/do-not-delete-knative-test-eventing/nodePools/default-pool
              version: 1.16.13-gke.1
              instanceGroupUrls:
              - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-knativ-default-pool-388e6a0c-grp
              status: RUNNING
              upgradeSettings:
                maxSurge: 1
            locations:
            - us-central1-a
            labelFingerprint: a9dc16a7
            legacyAbac: {}
            ipAllocationPolicy:
              useRoutes: true
            maintenancePolicy:
              resourceVersion: e3b0c442
            networkConfig:
              network: projects/cloud-sdk-integration-testing/global/networks/default
            databaseEncryption:
              state: DECRYPTED
            shieldedNodes: {}
            selfLink: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/clusters/do-not-delete-knative-test-eventing
            zone: us-central1-a
            endpoint: 35.184.117.128
            initialClusterVersion: 1.16.13-gke.1
            currentMasterVersion: 1.16.13-gke.1
            currentNodeVersion: 1.16.13-gke.1
            createTime: '2020-08-20T23:32:58+00:00'
            status: RUNNING
            nodeIpv4CidrSize: 24
            servicesIpv4Cidr: 10.39.240.0/20
            instanceGroupUrls:
            - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-knativ-default-pool-388e6a0c-grp
            currentNodeCount: 3
            location: us-central1-a
    - api_call:
        expect_request:
          uri:
            matches: https://.*/apis/eventing.knative.dev/v1beta1/namespaces/default/triggers\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            audit-id: 5a4b3615-a23d-43a6-b6f5-b4137e0878b6
            cache-control: no-cache, private
            content-length: '2026'
            content-type: application/json
          body:
            apiVersion: eventing.knative.dev/v1beta1
            items:
            - apiVersion: eventing.knative.dev/v1beta1
              kind: Trigger
              metadata:
                annotations:
                  eventing.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                  eventing.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                  knative-eventing-injection: enabled
                  knative.dev/dependency: '{"apiVersion": "events.cloud.google.com/v1beta1",
                    "kind": "CloudAuditLogsSource", "name": "source-for-$$my-trigger$$",
                    "namespace": "default"}'
                creationTimestamp: '2020-08-21T03:49:46Z'
                finalizers:
                - googlecloud
                generation: 1
                labels:
                  eventing.knative.dev/broker: default
                name: $$my-trigger$$
                namespace: default
                resourceVersion: '80853'
                selfLink: /apis/eventing.knative.dev/v1beta1/namespaces/default/triggers/$$my-trigger$$
                uid: 3bb4904c-588b-4552-a41b-dc567548be22
              spec:
                broker: default
                filter:
                  attributes:
                    knsourcetrigger: link0.47797583364796103
                    type: google.cloud.audit.log.v1.written
                subscriber:
                  ref:
                    apiVersion: serving.knative.dev/v1alpha1
                    kind: Service
                    name: $$event-display$$
                    namespace: default
              status:
                conditions:
                - lastTransitionTime: '2020-08-21T03:49:47Z'
                  status: 'True'
                  type: BrokerReady
                - lastTransitionTime: '2020-08-21T03:49:49Z'
                  status: 'True'
                  type: DependencyReady
                - lastTransitionTime: '2020-08-21T03:49:49Z'
                  status: 'True'
                  type: Ready
                - lastTransitionTime: '2020-08-21T03:49:47Z'
                  status: 'True'
                  type: SubscriberResolved
                - lastTransitionTime: '2020-08-21T03:49:47Z'
                  status: 'True'
                  type: SubscriptionReady
                - lastTransitionTime: '2020-08-21T03:49:47Z'
                  status: 'True'
                  type: TopicReady
                observedGeneration: 1
                subscriberUri: http://$$event-display$$.default.svc.cluster.local
            kind: TriggerList
            metadata:
              continue: ''
              resourceVersion: '80862'
              selfLink: /apis/eventing.knative.dev/v1beta1/namespaces/default/triggers
    - expect_stdout: |2
           TRIGGER                       EVENT TYPE                         TARGET
        +  $$my-trigger$$  google.cloud.audit.log.v1.written  $$event-display$$
    - expect_exit:
        code: 0
- execute_command:
    command: events triggers delete $$my-trigger$$
    cleanup_for: my-trigger
    events:
    - expect_prompt_continue:
        message: Trigger [$$my-trigger$$] will be deleted.
        user_input: y
    - api_call:
        expect_request:
          uri: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/locations/us-central1-a/clusters/do-not-delete-knative-test-eventing?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '5558'
            content-type: application/json; charset=UTF-8
          body:
            name: do-not-delete-knative-test-eventing
            nodeConfig:
              machineType: n1-standard-4
              diskSizeGb: 100
              oauthScopes:
              - https://www.googleapis.com/auth/devstorage.read_only
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring
              - https://www.googleapis.com/auth/service.management.readonly
              - https://www.googleapis.com/auth/servicecontrol
              - https://www.googleapis.com/auth/trace.append
              metadata:
                disable-legacy-endpoints: 'true'
              imageType: COS
              serviceAccount: default
              diskType: pd-standard
              shieldedInstanceConfig:
                enableIntegrityMonitoring: true
            masterAuth:
              clusterCaCertificate: ==
            loggingService: logging.googleapis.com/kubernetes
            monitoringService: monitoring.googleapis.com/kubernetes
            network: default
            clusterIpv4Cidr: 10.36.0.0/14
            addonsConfig:
              httpLoadBalancing: {}
              horizontalPodAutoscaling: {}
              kubernetesDashboard:
                disabled: true
              networkPolicyConfig:
                disabled: true
              cloudRunConfig: {}
            nodePools:
            - name: default-pool
              config:
                machineType: n1-standard-4
                diskSizeGb: 100
                oauthScopes:
                - https://www.googleapis.com/auth/devstorage.read_only
                - https://www.googleapis.com/auth/logging.write
                - https://www.googleapis.com/auth/monitoring
                - https://www.googleapis.com/auth/service.management.readonly
                - https://www.googleapis.com/auth/servicecontrol
                - https://www.googleapis.com/auth/trace.append
                metadata:
                  disable-legacy-endpoints: 'true'
                imageType: COS
                serviceAccount: default
                diskType: pd-standard
                shieldedInstanceConfig:
                  enableIntegrityMonitoring: true
              initialNodeCount: 3
              autoscaling:
                enabled: true
                minNodeCount: 3
                maxNodeCount: 10
              management:
                autoUpgrade: true
                autoRepair: true
              podIpv4CidrSize: 24
              locations:
              - us-central1-a
              selfLink: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/clusters/do-not-delete-knative-test-eventing/nodePools/default-pool
              version: 1.16.13-gke.1
              instanceGroupUrls:
              - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-knativ-default-pool-388e6a0c-grp
              status: RUNNING
              upgradeSettings:
                maxSurge: 1
            locations:
            - us-central1-a
            labelFingerprint: a9dc16a7
            legacyAbac: {}
            ipAllocationPolicy:
              useRoutes: true
            maintenancePolicy:
              resourceVersion: e3b0c442
            networkConfig:
              network: projects/cloud-sdk-integration-testing/global/networks/default
            databaseEncryption:
              state: DECRYPTED
            shieldedNodes: {}
            selfLink: https://container.googleapis.com/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/clusters/do-not-delete-knative-test-eventing
            zone: us-central1-a
            endpoint: 35.184.117.128
            initialClusterVersion: 1.16.13-gke.1
            currentMasterVersion: 1.16.13-gke.1
            currentNodeVersion: 1.16.13-gke.1
            createTime: '2020-08-20T23:32:58+00:00'
            status: RUNNING
            nodeIpv4CidrSize: 24
            servicesIpv4Cidr: 10.39.240.0/20
            instanceGroupUrls:
            - https://www.googleapis.com/compute/v1/projects/cloud-sdk-integration-testing/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-knativ-default-pool-388e6a0c-grp
            currentNodeCount: 3
            location: us-central1-a
    - api_call:
        expect_request:
          uri:
            matches: https://.*/apis/eventing.knative.dev/v1beta1/namespaces/default/triggers/$$my-trigger$$\?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            audit-id: 550aab5c-2064-40ba-bdf4-8d78ced39403
            cache-control: no-cache, private
            content-length: '1894'
            content-type: application/json
          body:
            apiVersion: eventing.knative.dev/v1beta1
            kind: Trigger
            metadata:
              annotations:
                eventing.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                eventing.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                knative-eventing-injection: enabled
                knative.dev/dependency: '{"apiVersion": "events.cloud.google.com/v1beta1",
                  "kind": "CloudAuditLogsSource", "name": "source-for-$$my-trigger$$",
                  "namespace": "default"}'
              creationTimestamp: '2020-08-21T03:49:46Z'
              deletionGracePeriodSeconds: 0
              deletionTimestamp: '2020-08-21T03:49:52Z'
              finalizers:
              - googlecloud
              generation: 2
              labels:
                eventing.knative.dev/broker: default
              name: $$my-trigger$$
              namespace: default
              resourceVersion: '80866'
              selfLink: /apis/eventing.knative.dev/v1beta1/namespaces/default/triggers/$$my-trigger$$
              uid: 3bb4904c-588b-4552-a41b-dc567548be22
            spec:
              broker: default
              filter:
                attributes:
                  knsourcetrigger: link0.47797583364796103
                  type: google.cloud.audit.log.v1.written
              subscriber:
                ref:
                  apiVersion: serving.knative.dev/v1alpha1
                  kind: Service
                  name: $$event-display$$
                  namespace: default
            status:
              conditions:
              - lastTransitionTime: '2020-08-21T03:49:47Z'
                status: 'True'
                type: BrokerReady
              - lastTransitionTime: '2020-08-21T03:49:49Z'
                status: 'True'
                type: DependencyReady
              - lastTransitionTime: '2020-08-21T03:49:49Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2020-08-21T03:49:47Z'
                status: 'True'
                type: SubscriberResolved
              - lastTransitionTime: '2020-08-21T03:49:47Z'
                status: 'True'
                type: SubscriptionReady
              - lastTransitionTime: '2020-08-21T03:49:47Z'
                status: 'True'
                type: TopicReady
              observedGeneration: 1
              subscriberUri: http://$$event-display$$.default.svc.cluster.local
    - expect_stderr: |
        Deleted trigger [$$my-trigger$$].
    - expect_exit:
        code: 0
- execute_command:
    command: run services delete $$event-display$$
    validation_only: true
    cleanup_for: event-display
    events:
    - expect_prompt_continue:
        user_input: y
    - expect_stderr: |
        Deleted service [$$event-display$$].
    - expect_exit:
        code: 0
