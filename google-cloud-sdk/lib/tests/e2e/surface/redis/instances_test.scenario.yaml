title: instances create/list/update/describe/delete scenario test
release_tracks: [GA]
skip:
  reason: failing
  bug: b/119025858

summary:
# This summary is generated automatically on update and should not be edited.
- execute:
  - command: redis instances create --region us-central1 $$redis-instance$$ --network="do-not-delete-redis-network"
  - stderr: |
      Create request issued for: [$$redis-instance$$]
  - progress_tracker:
    - message: Waiting for operation [$$operation-basename$$] to complete
    - status: SUCCESS
  - stderr: |
      Created instance [$$redis-instance$$].
- execute:
  - command: redis instances list --region="us-central1" --format="text(name,state)"
      --filter="name=projects/cloud-sdk-integration-testing/locations/us-central1/instances/$$redis-instance$$"
  - stdout: |
      ---
      name:  projects/cloud-sdk-integration-testing/locations/us-central1/instances/$$redis-instance$$
      state: READY
- execute:
  - command: redis instances update $$redis-instance$$ --region="us-central1" --display-name="a_fancy_redis_instance"
      --format="text(displayName)"
  - stderr: |
      Request issued for: [$$redis-instance$$]
  - progress_tracker:
    - message: Waiting for operation [$$operation-basename$$] to complete
    - status: SUCCESS
  - stderr: |
      Updated instance [$$redis-instance$$].
  - stdout: |
      displayName: a_fancy_redis_instance
- execute:
  - command: redis instances describe --region="us-central1" $$redis-instance$$ --format="text(displayName)"
  - stdout: |
      displayName: a_fancy_redis_instance
- execute:
  - command: redis instances delete --region="us-central1" $$redis-instance$$
  - prompt:
    - message: |
        You are about to delete instance [$$redis-instance$$] in [us-central1].
        Any associated data will be lost.
    - input: y
  - stderr: |
      Delete request issued for: [$$redis-instance$$]
  - progress_tracker:
    - message: Waiting for operation [$$operation-basename$$] to complete
    - status: SUCCESS
  - stderr: |
      Deleted instance [$$redis-instance$$].
actions:
- generate_resource_id:
    reference: redis-instance
    prefix: redis-instance
- execute_command:
    command: redis instances create --region us-central1 $$redis-instance$$ --network="do-not-delete-redis-network"
    events:
    - api_call:
        expect_request:
          uri: https://redis.googleapis.com/v1/projects/cloud-sdk-integration-testing/locations/us-central1/instances?alt=json&instanceId=$$redis-instance$$
          method: POST
          headers: {}
          body:
            json:
              authorizedNetwork: projects/cloud-sdk-integration-testing/global/networks/do-not-delete-redis-network
              memorySizeGb: 1
              tier: BASIC
        return_response:
          headers:
            cache-control: private
            content-length: '509'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            name: projects/cloud-sdk-integration-testing/locations/us-central1/operations/operation-1541007658205-57989ce104157-cbc4cd8a-2ee36d3c
            metadata:
              '@type': type.googleapis.com/google.cloud.redis.v1.OperationMetadata
              createTime: '2018-10-31T17:40:58.622599620Z'
              target: projects/cloud-sdk-integration-testing/locations/us-central1/instances/$$redis-instance$$
              verb: create
              cancelRequested: false
              apiVersion: v1
            done: false
        expect_response:
          extract_references:
          - field: name
            reference: operation
            modifiers:
              basename: true
          body:
            json: {}
        poll_operation: true
    - expect_stderr: |
        Create request issued for: [$$redis-instance$$]
    - expect_progress_tracker:
        message: Waiting for operation [$$operation-basename$$] to complete
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://redis.googleapis.com/v1/projects/cloud-sdk-integration-testing/locations/us-central1/instances/$$redis-instance$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '617'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            name: projects/cloud-sdk-integration-testing/locations/us-central1/instances/$$redis-instance$$
            locationId: us-central1-b
            redisVersion: REDIS_3_2
            reservedIpRange: 10.0.0.0/29
            host: 10.0.0.3
            port: 6379
            currentLocationId: us-central1-b
            createTime: '2018-10-31T17:40:58.616617866Z'
            state: READY
            tier: BASIC
            memorySizeGb: 1
            authorizedNetwork: projects/cloud-sdk-integration-testing/global/networks/do-not-delete-redis-network
            persistenceIamIdentity: serviceAccount:139285888481-compute@developer.gserviceaccount.com
        repeatable: true
    - expect_stderr: |
        Created instance [$$redis-instance$$].
    - expect_exit:
        code: 0
- execute_command:
    command: redis instances list --region="us-central1" --format="text(name,state)"
      --filter="name=projects/cloud-sdk-integration-testing/locations/us-central1/instances/$$redis-instance$$"
    events:
    - api_call:
        expect_request:
          uri: https://redis.googleapis.com/v1/projects/cloud-sdk-integration-testing/locations/us-central1/instances?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '5407'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            instances:
            - name: projects/cloud-sdk-integration-testing/locations/us-central1/instances/$$redis-instance$$
              locationId: us-central1-b
              redisVersion: REDIS_3_2
              reservedIpRange: 10.0.0.0/29
              host: 10.0.0.3
              port: 6379
              currentLocationId: us-central1-b
              createTime: '2018-10-31T17:40:58.616617866Z'
              state: READY
              tier: BASIC
              memorySizeGb: 1
              authorizedNetwork: projects/cloud-sdk-integration-testing/global/networks/do-not-delete-redis-network
              persistenceIamIdentity: serviceAccount:139285888481-compute@developer.gserviceaccount.com
            - name: projects/cloud-sdk-integration-testing/locations/us-central1/instances/std-387
              locationId: us-central1-f
              alternativeLocationId: us-central1-b
              redisVersion: REDIS_3_2
              reservedIpRange: 10.0.0.0/29
              host: 10.0.0.4
              port: 6379
              currentLocationId: us-central1-f
              createTime: '2018-08-31T23:09:00.988707770Z'
              state: READY
              tier: STANDARD_HA
              memorySizeGb: 2
              authorizedNetwork: projects/cloud-sdk-integration-testing/global/networks/do-not-delete-redis-test
              persistenceIamIdentity: serviceAccount:139285888481-compute@developer.gserviceaccount.com
            - name: projects/cloud-sdk-integration-testing/locations/us-central1/instances/std-279
              locationId: us-central1-f
              alternativeLocationId: us-central1-a
              redisVersion: REDIS_3_2
              reservedIpRange: 10.0.0.8/29
              host: 10.0.0.12
              port: 6379
              currentLocationId: us-central1-f
              createTime: '2018-08-31T18:13:14.951851244Z'
              state: READY
              tier: STANDARD_HA
              memorySizeGb: 2
              authorizedNetwork: projects/cloud-sdk-integration-testing/global/networks/redis-network
              persistenceIamIdentity: serviceAccount:139285888481-compute@developer.gserviceaccount.com
            - name: projects/cloud-sdk-integration-testing/locations/us-central1/instances/std-987
              locationId: us-central1-f
              alternativeLocationId: us-central1-b
              redisVersion: REDIS_3_2
              reservedIpRange: 10.128.0.0/29
              host: 10.128.0.4
              port: 6379
              currentLocationId: us-central1-f
              createTime: '2018-08-31T20:59:39.975039885Z'
              state: READY
              tier: STANDARD_HA
              memorySizeGb: 2
              authorizedNetwork: projects/cloud-sdk-integration-testing/global/networks/do-not-delete-redis-network
              persistenceIamIdentity: serviceAccount:139285888481-compute@developer.gserviceaccount.com
            - name: projects/cloud-sdk-integration-testing/locations/us-central1/instances/test2
              locationId: us-central1-f
              redisVersion: REDIS_3_2
              reservedIpRange: 10.0.0.8/29
              host: 10.0.0.11
              port: 6379
              currentLocationId: us-central1-f
              createTime: '2018-05-09T16:44:21.567265Z'
              state: READY
              tier: BASIC
              memorySizeGb: 1
              authorizedNetwork: projects/cloud-sdk-integration-testing/global/networks/do-not-delete-redis-test
              persistenceIamIdentity: serviceAccount:139285888481-compute@developer.gserviceaccount.com
            - name: projects/cloud-sdk-integration-testing/locations/us-central1/instances/bsc-387
              displayName: fancy-instance
              locationId: us-central1-c
              redisVersion: REDIS_3_2
              reservedIpRange: 10.0.0.16/29
              host: 10.0.0.19
              port: 6379
              currentLocationId: us-central1-c
              createTime: '2018-08-31T23:17:47.859053723Z'
              state: READY
              tier: BASIC
              memorySizeGb: 2
              authorizedNetwork: projects/cloud-sdk-integration-testing/global/networks/do-not-delete-redis-test
              persistenceIamIdentity: serviceAccount:139285888481-compute@developer.gserviceaccount.com
            - name: projects/cloud-sdk-integration-testing/locations/us-central1/instances/bsc-457
              locationId: us-central1-c
              redisVersion: REDIS_3_2
              reservedIpRange: 10.0.0.16/29
              host: 10.0.0.19
              port: 6379
              currentLocationId: us-central1-c
              createTime: '2018-08-31T18:32:50.725982072Z'
              state: READY
              tier: BASIC
              memorySizeGb: 1
              authorizedNetwork: projects/cloud-sdk-integration-testing/global/networks/redis-network
              persistenceIamIdentity: serviceAccount:139285888481-compute@developer.gserviceaccount.com
            - name: projects/cloud-sdk-integration-testing/locations/us-central1/instances/bsc-456
              locationId: us-central1-b
              redisVersion: REDIS_3_2
              reservedIpRange: 10.0.0.0/29
              host: 10.0.0.3
              port: 6379
              currentLocationId: us-central1-b
              createTime: '2018-08-31T18:28:16.958199607Z'
              state: READY
              tier: BASIC
              memorySizeGb: 1
              authorizedNetwork: projects/cloud-sdk-integration-testing/global/networks/redis-network
              persistenceIamIdentity: serviceAccount:139285888481-compute@developer.gserviceaccount.com
    - expect_stdout: |
        ---
        name:  projects/cloud-sdk-integration-testing/locations/us-central1/instances/$$redis-instance$$
        state: READY
    - expect_exit:
        code: 0
- execute_command:
    command: redis instances update $$redis-instance$$ --region="us-central1" --display-name="a_fancy_redis_instance"
      --format="text(displayName)"
    events:
    - api_call:
        expect_request:
          uri: https://redis.googleapis.com/v1/projects/cloud-sdk-integration-testing/locations/us-central1/instances/$$redis-instance$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '617'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            name: projects/cloud-sdk-integration-testing/locations/us-central1/instances/$$redis-instance$$
            locationId: us-central1-b
            redisVersion: REDIS_3_2
            reservedIpRange: 10.0.0.0/29
            host: 10.0.0.3
            port: 6379
            currentLocationId: us-central1-b
            createTime: '2018-10-31T17:40:58.616617866Z'
            state: READY
            tier: BASIC
            memorySizeGb: 1
            authorizedNetwork: projects/cloud-sdk-integration-testing/global/networks/do-not-delete-redis-network
            persistenceIamIdentity: serviceAccount:139285888481-compute@developer.gserviceaccount.com
    - api_call:
        expect_request:
          uri: https://redis.googleapis.com/v1/projects/cloud-sdk-integration-testing/locations/us-central1/instances/$$redis-instance$$?alt=json&updateMask=display_name
          method: PATCH
          headers: {}
          body:
            json:
              authorizedNetwork: projects/cloud-sdk-integration-testing/global/networks/do-not-delete-redis-network
              displayName: a_fancy_redis_instance
              name: projects/cloud-sdk-integration-testing/locations/us-central1/instances/$$redis-instance$$
              state: READY
        return_response:
          headers:
            cache-control: private
            content-length: '509'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            name: projects/cloud-sdk-integration-testing/locations/us-central1/operations/operation-1541007866225-57989da766384-b08bb232-39e64615
            metadata:
              '@type': type.googleapis.com/google.cloud.redis.v1.OperationMetadata
              createTime: '2018-10-31T17:44:26.323157647Z'
              target: projects/cloud-sdk-integration-testing/locations/us-central1/instances/$$redis-instance$$
              verb: update
              cancelRequested: false
              apiVersion: v1
            done: false
        poll_operation: true
    - expect_stderr: |
        Request issued for: [$$redis-instance$$]
    - expect_progress_tracker:
        message: Waiting for operation [$$operation-basename$$] to complete
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://redis.googleapis.com/v1/projects/cloud-sdk-integration-testing/locations/us-central1/instances/$$redis-instance$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '660'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            name: projects/cloud-sdk-integration-testing/locations/us-central1/instances/$$redis-instance$$
            displayName: a_fancy_redis_instance
            locationId: us-central1-b
            redisVersion: REDIS_3_2
            reservedIpRange: 10.0.0.0/29
            host: 10.0.0.3
            port: 6379
            currentLocationId: us-central1-b
            createTime: '2018-10-31T17:40:58.616617866Z'
            state: READY
            tier: BASIC
            memorySizeGb: 1
            authorizedNetwork: projects/cloud-sdk-integration-testing/global/networks/do-not-delete-redis-network
            persistenceIamIdentity: serviceAccount:139285888481-compute@developer.gserviceaccount.com
    - expect_stderr: |
        Updated instance [$$redis-instance$$].
    - expect_stdout: |
        displayName: a_fancy_redis_instance
    - expect_exit:
        code: 0
- execute_command:
    command: redis instances describe --region="us-central1" $$redis-instance$$ --format="text(displayName)"
    events:
    - api_call:
        expect_request:
          uri: https://redis.googleapis.com/v1/projects/cloud-sdk-integration-testing/locations/us-central1/instances/$$redis-instance$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '660'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            name: projects/cloud-sdk-integration-testing/locations/us-central1/instances/$$redis-instance$$
            displayName: a_fancy_redis_instance
            locationId: us-central1-b
            redisVersion: REDIS_3_2
            reservedIpRange: 10.0.0.0/29
            host: 10.0.0.3
            port: 6379
            currentLocationId: us-central1-b
            createTime: '2018-10-31T17:40:58.616617866Z'
            state: READY
            tier: BASIC
            memorySizeGb: 1
            authorizedNetwork: projects/cloud-sdk-integration-testing/global/networks/do-not-delete-redis-network
            persistenceIamIdentity: serviceAccount:139285888481-compute@developer.gserviceaccount.com
    - expect_stdout: |
        displayName: a_fancy_redis_instance
    - expect_exit:
        code: 0
- execute_command:
    command: redis instances delete --region="us-central1" $$redis-instance$$
    events:
    - expect_prompt_continue:
        message: |
          You are about to delete instance [$$redis-instance$$] in [us-central1].
          Any associated data will be lost.
        user_input: y
    - api_call:
        expect_request:
          uri: https://redis.googleapis.com/v1/projects/cloud-sdk-integration-testing/locations/us-central1/instances/$$redis-instance$$?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '509'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            name: projects/cloud-sdk-integration-testing/locations/us-central1/operations/operation-1541007868579-57989da9a4e3f-1e02c30c-b73a9fe0
            metadata:
              '@type': type.googleapis.com/google.cloud.redis.v1.OperationMetadata
              createTime: '2018-10-31T17:44:28.599688157Z'
              target: projects/cloud-sdk-integration-testing/locations/us-central1/instances/$$redis-instance$$
              verb: delete
              cancelRequested: false
              apiVersion: v1
            done: false
        expect_response:
          extract_references:
          - field: name
            reference: operation
            modifiers:
              basename: true
          body:
            json: {}
        poll_operation: true
    - expect_stderr: |
        Delete request issued for: [$$redis-instance$$]
    - expect_progress_tracker:
        message: Waiting for operation [$$operation-basename$$] to complete
        status: SUCCESS
    - expect_stderr: |
        Deleted instance [$$redis-instance$$].
    - expect_exit:
        code: 0
    cleanup_for: redis-instance
