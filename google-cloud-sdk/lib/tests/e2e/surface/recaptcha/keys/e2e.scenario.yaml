title: recaptcha keys e2e test scenario
release_tracks: [ALPHA]
summary:
# This summary is generated automatically on update and should not be edited.
- execute:
  - command: |
      recaptcha keys create --labels="foo=bar,cleanup=$$recaptcha-key-test$$"
      --display-name testKey --web --domains=google.com --integration-type=checkbox --security-preference=balance
  - stderr: |
      Created [$$site-key$$].
- execute:
  - command: |
      recaptcha keys update $$site-key$$ --labels=foo=baz,cleanup=$$recaptcha-key-test$$ --allow-amp-traffic --security-preference=usability
      --display-name updated-key --web --domains=google.com --security-preference=usability --format 'value(name)'
  - stderr: |
      Updated key [$$site-key$$].
  - stdout: |
      projects/462803083913/keys/$$site-key$$
- execute:
  - command: |
      recaptcha keys list --filter=name:$$site-key$$
  - stdout: |
      SITE_KEY                                  DISPLAY_NAME
      $$site-key$$  updated-key
- execute:
  - command: |
      recaptcha keys delete $$site-key$$ -q
  - stderr: |
      Deleted key [$$site-key$$].
- execute:
  - command: |
      recaptcha keys list --filter=name:$$site-key$$
  - stderr: |
      Listed 0 items.
- execute:
  - command: |
      recaptcha keys create --labels=foo=bar --display-name testKey --web --allow-all-domains --allow-amp-traffic --integration-type=SCORE
  - stderr: |
      Created [$$site-key-all-domains$$].
- execute:
  - command: |
      recaptcha keys delete $$site-key-all-domains$$
  - prompt:
    - message: You are about to delete key [$$site-key-all-domains$$]
    - input: y
  - stderr: |
      Deleted key [$$site-key-all-domains$$].
actions:
- generate_resource_id:
    reference: recaptcha-key-test
    prefix: recaptcha-key-test
- execute_command:
    command: |
      recaptcha keys create --labels="foo=bar,cleanup=$$recaptcha-key-test$$"
      --display-name testKey --web --domains=google.com --integration-type=checkbox --security-preference=balance
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/cloud-sdk-integration-testing?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '350'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            projectNumber: '462803083913'
            projectId: cloud-sdk-integration-testing
            lifecycleState: ACTIVE
            name: Cloud SDK Integration Testing
            labels:
              service-account-downloaded-notification-opt-out: 'true'
            createTime: '2014-09-30T14:51:18.935Z'
            parent:
              type: folder
              id: '396521612403'
    - api_call:
        expect_request:
          uri: https://recaptchaenterprise.googleapis.com/v1/projects/462803083913/keys?alt=json
          method: POST
          headers: {}
          body:
            json:
              displayName: testKey
              labels:
                foo: bar
              webSettings:
                allowedDomains:
                - google.com
                challengeSecurityPreference: BALANCE
                integrationType: CHECKBOX
        expect_response:
          extract_references:
          - field: name
            reference: site-key
            modifiers:
              basename: true
          body:
            json: {}
        return_response:
          headers:
            cache-control: private
            content-length: '420'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            name: projects/462803083913/keys/6LeIzt4UAAAAACopspcbMFkNIIcis7AMSf3jDZcq
            displayName: testKey
            webSettings:
              allowAllDomains: false
              allowedDomains:
              - google.com
              allowAmpTraffic: false
              integrationType: CHECKBOX
              challengeSecurityPreference: BALANCE
            labels:
              foo: bar
              cleanup: $$recaptcha-key-test$$
    - expect_stderr: |
        Created [$$site-key$$].
    - expect_exit:
        code: 0
- execute_command:
    command: |
      recaptcha keys update $$site-key$$ --labels=foo=baz,cleanup=$$recaptcha-key-test$$ --allow-amp-traffic --security-preference=usability
      --display-name updated-key --web --domains=google.com --security-preference=usability --format 'value(name)'
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/cloud-sdk-integration-testing?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '350'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            projectNumber: '462803083913'
            projectId: cloud-sdk-integration-testing
            lifecycleState: ACTIVE
            name: Cloud SDK Integration Testing
            labels:
              service-account-downloaded-notification-opt-out: 'true'
            createTime: '2014-09-30T14:51:18.935Z'
            parent:
              type: folder
              id: '396521612403'
    - api_call:
        expect_request:
          uri: https://recaptchaenterprise.googleapis.com/v1/projects/462803083913/keys/$$site-key$$?alt=json&updateMask=displayName%2Clabels%2CwebSettings.allowAmpTraffic%2CwebSettings.allowedDomains%2CwebSettings.challengeSecurityPreference
          method: PATCH
          headers: {}
          body:
            json:
              displayName: updated-key
              labels:
                foo: baz
              webSettings:
                allowAmpTraffic: true
                allowedDomains:
                - google.com
                challengeSecurityPreference: USABILITY
        return_response:
          headers:
            cache-control: private
            content-length: '466'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            name: projects/462803083913/keys/6LeIzt4UAAAAACopspcbMFkNIIcis7AMSf3jDZcq
            displayName: updated-key
            webSettings:
              allowAllDomains: false
              allowedDomains:
              - google.com
              allowAmpTraffic: false
              integrationType: CHECKBOX
              challengeSecurityPreference: USABILITY
            labels:
              foo: baz
              cleanup: $$recaptcha-key-test$$
            createTime: '2020-03-05T16:05:18Z'
    - expect_stderr: |
        Updated key [$$site-key$$].
    - expect_stdout: |
        projects/462803083913/keys/$$site-key$$
    - expect_exit:
        code: 0
- execute_command:
    command: |
      recaptcha keys list --filter=name:$$site-key$$
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/cloud-sdk-integration-testing?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '350'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            projectNumber: '462803083913'
            projectId: cloud-sdk-integration-testing
            lifecycleState: ACTIVE
            name: Cloud SDK Integration Testing
            labels:
              service-account-downloaded-notification-opt-out: 'true'
            createTime: '2014-09-30T14:51:18.935Z'
            parent:
              type: folder
              id: '396521612403'
    - api_call:
        expect_request:
          uri: https://recaptchaenterprise.googleapis.com/v1/projects/462803083913/keys?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '581'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            keys:
            - name: projects/462803083913/keys/6LeIzt4UAAAAACopspcbMFkNIIcis7AMSf3jDZcq
              displayName: updated-key
              webSettings:
                allowAllDomains: false
                allowedDomains:
                - google.com
                allowAmpTraffic: false
                integrationType: CHECKBOX
                challengeSecurityPreference: USABILITY
              labels:
                cleanup: $$recaptcha-key-test$$
                foo: baz
              createTime: '2020-03-05T16:05:18Z'
            nextPageToken: ''
    - expect_stdout: |
        SITE_KEY                                  DISPLAY_NAME
        $$site-key$$  updated-key
    - expect_exit:
        code: 0
- execute_command:
    command: |
      recaptcha keys delete $$site-key$$ -q
    cleanup_for: recaptcha-key-test
    validation_only: true
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/cloud-sdk-integration-testing?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '350'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            projectNumber: '462803083913'
            projectId: cloud-sdk-integration-testing
            lifecycleState: ACTIVE
            name: Cloud SDK Integration Testing
            labels:
              service-account-downloaded-notification-opt-out: 'true'
            createTime: '2014-09-30T14:51:18.935Z'
            parent:
              type: folder
              id: '396521612403'
    - api_call:
        expect_request:
          uri: https://recaptchaenterprise.googleapis.com/v1/projects/462803083913/keys/$$site-key$$?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '3'
            content-type: application/json; charset=UTF-8
            status: '200'
          body: |
            {}
    - expect_stderr: |
        Deleted key [$$site-key$$].
    - expect_exit:
        code: 0
- execute_command:
    command: |
      recaptcha keys list --filter=name:$$site-key$$
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/cloud-sdk-integration-testing?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '350'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            projectNumber: '462803083913'
            projectId: cloud-sdk-integration-testing
            lifecycleState: ACTIVE
            name: Cloud SDK Integration Testing
            labels:
              service-account-downloaded-notification-opt-out: 'true'
            createTime: '2014-09-30T14:51:18.935Z'
            parent:
              type: folder
              id: '396521612403'
    - api_call:
        expect_request:
          uri: https://recaptchaenterprise.googleapis.com/v1/projects/462803083913/keys?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '40'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            keys: []
            nextPageToken: ''
    - expect_stderr: |
        Listed 0 items.
    - expect_exit:
        code: 0
- execute_command:
    command: |
      recaptcha keys create --labels=foo=bar --display-name testKey --web --allow-all-domains --allow-amp-traffic --integration-type=SCORE
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/cloud-sdk-integration-testing?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '350'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            projectNumber: '462803083913'
            projectId: cloud-sdk-integration-testing
            lifecycleState: ACTIVE
            name: Cloud SDK Integration Testing
            labels:
              service-account-downloaded-notification-opt-out: 'true'
            createTime: '2014-09-30T14:51:18.935Z'
            parent:
              type: folder
              id: '396521612403'
    - api_call:
        expect_request:
          uri: https://recaptchaenterprise.googleapis.com/v1/projects/462803083913/keys?alt=json
          method: POST
          headers: {}
          body:
            json:
              displayName: testKey
              labels:
                foo: bar
              webSettings:
                integrationType: SCORE
        expect_response:
          extract_references:
          - field: name
            reference: site-key-all-domains
            modifiers:
              basename: true
          body:
            json: {}
        return_response:
          headers:
            cache-control: private
            content-length: '367'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            name: projects/462803083913/keys/6Le6AN8UAAAAADYx7-XxGhhpGv31bwwXdq6blmsc
            displayName: testKey
            webSettings:
              allowAllDomains: true
              allowedDomains: []
              allowAmpTraffic: true
              integrationType: SCORE
              challengeSecurityPreference: CHALLENGE_SECURITY_PREFERENCE_UNSPECIFIED
            labels:
              foo: bar
    - expect_stderr: |
        Created [$$site-key-all-domains$$].
    - expect_exit:
        code: 0
- execute_command:
    command: |
      recaptcha keys delete $$site-key-all-domains$$
    events:
    - expect_prompt_continue:
        message: You are about to delete key [$$site-key-all-domains$$]
        user_input: y
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/cloud-sdk-integration-testing?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '350'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            projectNumber: '462803083913'
            projectId: cloud-sdk-integration-testing
            lifecycleState: ACTIVE
            name: Cloud SDK Integration Testing
            labels:
              service-account-downloaded-notification-opt-out: 'true'
            createTime: '2014-09-30T14:51:18.935Z'
            parent:
              type: folder
              id: '396521612403'
    - api_call:
        expect_request:
          uri: https://recaptchaenterprise.googleapis.com/v1/projects/462803083913/keys/$$site-key-all-domains$$?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '3'
            content-type: application/json; charset=UTF-8
            status: '200'
          body: |
            {}
    - expect_stderr: |
        Deleted key [$$site-key-all-domains$$].
    - expect_exit:
        code: 0
