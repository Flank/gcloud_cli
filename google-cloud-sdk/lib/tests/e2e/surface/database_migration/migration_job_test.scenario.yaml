title: database-migration migration job create, describe, and delete scenario test.
release_tracks: [ALPHA]
summary:
# This summary is generated by http://go/gcloud-scenario-tests on update and should not be edited.
- execute:
  - command: database-migration connection-profiles create cloudsql $$test-dest$$
      --display-name=test-dest --database-version=MYSQL_5_6 --tier=db-n1-standard-1
      --source-id=do-not-delete-dms-source-cp --region=us-central1
  - stdout: .*$$test-dest$$.*
- execute:
  - command: database-migration migration-jobs create $$test-job$$ --region=us-central1
      --display-name=test-job --source=do-not-delete-dms-source-cp --destination=$$test-dest$$
      --type=ONE_TIME
  - stdout: .*$$test-job$$.*$
- execute:
  - command: database-migration migration-jobs describe $$test-job$$ --region=us-central1
  - stdout: .*$$test-job$$.*$
- execute:
  - command: database-migration migration-jobs delete $$test-job$$ --region=us-central1
  - prompt:
    - message: You are about to delete migration_job [$$test-job$$]
    - input: y
  - stderr: |
      Deleted migration_job [$$test-job$$].
- execute:
  - command: sql instances delete $$test-dest$$
  - prompt:
    - message: All of the instance data will be lost when the instance is deleted.
    - input: y
  - progress_tracker:
    - message: Deleting Cloud SQL instance
    - status: SUCCESS
  - stderr: |
      Deleted [https://sqladmin.googleapis.com/sql/v1beta4/projects/cloud-sdk-integration-testing/instances/$$test-dest$$].
- execute:
  - command: sql instances delete $$test-dest$$-master
  - prompt:
    - message: All of the instance data will be lost when the instance is deleted.
    - input: y
  - progress_tracker:
    - message: Deleting Cloud SQL instance
    - status: SUCCESS
  - stderr: |
      Deleted [https://sqladmin.googleapis.com/sql/v1beta4/projects/cloud-sdk-integration-testing/instances/$$test-dest$$-master].
actions:
- generate_resource_id:
    reference: test-dest
    prefix: datamigration-dest
- execute_command:
    command: database-migration connection-profiles create cloudsql $$test-dest$$
      --display-name=test-dest --database-version=MYSQL_5_6 --tier=db-n1-standard-1
      --source-id=do-not-delete-dms-source-cp --region=us-central1
    events:
    - api_call:
        expect_request:
          uri:
            matches: https://datamigration.googleapis.com/v1alpha2/projects/cloud-sdk-integration-testing/locations/us-central1/connectionProfiles\?alt=json&connectionProfileId=$$test-dest$$&requestId=.*
          method: POST
          headers: {}
          body:
            json:
              cloudsql:
                settings:
                  activationPolicy: SQL_ACTIVATION_POLICY_UNSPECIFIED
                  dataDiskType: SQL_DATA_DISK_TYPE_UNSPECIFIED
                  databaseVersion: MYSQL_5_6
                  ipConfig: {}
                  sourceId: projects/cloud-sdk-integration-testing/locations/us-central1/connectionProfiles/do-not-delete-dms-source-cp
                  tier: db-n1-standard-1
              displayName: test-dest
              name: $$test-dest$$
              provider: DATABASE_PROVIDER_UNSPECIFIED
              state: CREATING
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '543'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/cloud-sdk-integration-testing/locations/us-central1/operations/operation-1598480217617-5adcf2d8d327d-147196b4-597bc5e6
            metadata:
              '@type': type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata
              createTime: '2020-08-26T22:16:57.741524626Z'
              target: projects/cloud-sdk-integration-testing/locations/us-central1/connectionProfiles/$$test-dest$$
              verb: create
              requestedCancellation: false
              apiVersion: v1alpha2
            done: false
        poll_operation: true
    - expect_stdout:
        matches: .*$$test-dest$$.*
    - expect_exit:
        code: 0
- execute_command_until:
    command: database-migration connection-profiles describe $$test-dest$$ --region=us-central1
    timeout: 360
    exponential_sleep_multiplier: '1.1'
    exit_code: 0
    stdout:
      matches: .*READY.*

- generate_resource_id:
    reference: test-job
    prefix: datamigration-job
- execute_command:
    command: database-migration migration-jobs create $$test-job$$ --region=us-central1
      --display-name=test-job --source=do-not-delete-dms-source-cp --destination=$$test-dest$$
      --type=ONE_TIME
    events:
    - api_call:
        expect_request:
          uri:
            matches: https://datamigration.googleapis.com/v1alpha2/projects/cloud-sdk-integration-testing/locations/us-central1/migrationJobs\?alt=json&migrationJobId=$$test-job$$&requestId=.*
          method: POST
          headers: {}
          body:
            json:
              destination: projects/cloud-sdk-integration-testing/locations/us-central1/connectionProfiles/$$test-dest$$
              displayName: test-job
              name: $$test-job$$
              source: projects/cloud-sdk-integration-testing/locations/us-central1/connectionProfiles/do-not-delete-dms-source-cp
              state: CREATING
              type: ONE_TIME
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '537'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/cloud-sdk-integration-testing/locations/us-central1/operations/operation-1598480515938-5adcf3f55376a-40a8750f-474010d9
            metadata:
              '@type': type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata
              createTime: '2020-08-26T22:21:56.044714755Z'
              target: projects/cloud-sdk-integration-testing/locations/us-central1/migrationJobs/$$test-job$$
              verb: create
              requestedCancellation: false
              apiVersion: v1alpha2
            done: false
        poll_operation: false
        expect_response:
          extract_references:
          - field: name
            reference: operation
          body:
            json: {}
    - api_call:
        expect_request:
          uri: https://datamigration.googleapis.com/v1alpha2/$$operation$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '537'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/cloud-sdk-integration-testing/locations/us-central1/operations/operation-1598480515938-5adcf3f55376a-40a8750f-474010d9
            metadata:
              '@type': type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata
              createTime: '2020-08-26T22:21:56.044714755Z'
              target: projects/cloud-sdk-integration-testing/locations/us-central1/migrationJobs/$$test-job$$
              verb: create
              requestedCancellation: false
              apiVersion: v1alpha2
            done: false
    - expect_stdout:
        matches: .*$$test-job$$.*
    - expect_exit:
        code: 0
- execute_command:
    command: database-migration migration-jobs describe $$test-job$$ --region=us-central1
    events:
    - api_call:
        expect_request:
          uri: https://datamigration.googleapis.com/v1alpha2/projects/cloud-sdk-integration-testing/locations/us-central1/migrationJobs/$$test-job$$?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '656'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/cloud-sdk-integration-testing/locations/us-central1/migrationJobs/$$test-job$$
            createTime: '2020-08-26T22:21:56.039053507Z'
            updateTime: '2020-08-26T22:21:56.039053507Z'
            displayName: test-job
            state: CREATING
            type: ONE_TIME
            source: projects/cloud-sdk-integration-testing/locations/us-central1/connectionProfiles/do-not-delete-dms-source-cp
            destination: projects/cloud-sdk-integration-testing/locations/us-central1/connectionProfiles/$$test-dest$$
            destinationDatabase:
              provider: CLOUDSQL
            staticIpConnectivity: {}
    - expect_stdout:
        matches: .*$$test-job$$.*
    - expect_exit:
        code: 0
- execute_command:
    command: database-migration migration-jobs delete $$test-job$$ --region=us-central1
    events:
    - expect_prompt_continue:
        message: You are about to delete migration_job [$$test-job$$]
        user_input: y
    - api_call:
        expect_request:
          uri: https://datamigration.googleapis.com/v1alpha2/projects/cloud-sdk-integration-testing/locations/us-central1/migrationJobs/$$test-job$$?alt=json&force=False
          method: DELETE
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '537'
            content-type: application/json; charset=UTF-8
          body:
            name: projects/cloud-sdk-integration-testing/locations/us-central1/operations/operation-1598480517056-5adcf3f66463f-995fe00b-68a48c77
            metadata:
              '@type': type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata
              createTime: '2020-08-26T22:21:57.134010394Z'
              target: projects/cloud-sdk-integration-testing/locations/us-central1/migrationJobs/$$test-job$$
              verb: delete
              requestedCancellation: false
              apiVersion: v1alpha2
            done: false
        poll_operation: true
    - expect_stderr: |
        Deleted migration_job [$$test-job$$].
    - expect_exit:
        code: 0

- execute_command_until:
    command: database-migration migration-jobs describe $$test-job$$ --region=us-central1
    timeout: 60
    exponential_sleep_multiplier: '1.5'
    exit_code: 1

- execute_command:
    command: sql instances delete $$test-dest$$
    cleanup_for: test-job
    events:
    - expect_prompt_continue:
        message: All of the instance data will be lost when the instance is deleted.
        user_input: y
    - api_call:
        expect_request:
          uri: https://sqladmin.googleapis.com/sql/v1beta4/projects/cloud-sdk-integration-testing/instances/$$test-dest$$?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '674'
            content-type: application/json; charset=UTF-8
          body:
            kind: sql#operation
            targetLink: https://sqladmin.googleapis.com/sql/v1beta4/projects/cloud-sdk-integration-testing/instances/$$test-dest$$
            status: PENDING
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            insertTime: '2020-08-26T22:22:23.493Z'
            operationType: DELETE
            name: 43d3519e-8a2c-4207-a70d-aae20735d1eb
            targetId: $$test-dest$$
            selfLink: https://sqladmin.googleapis.com/sql/v1beta4/projects/cloud-sdk-integration-testing/operations/43d3519e-8a2c-4207-a70d-aae20735d1eb
            targetProject: cloud-sdk-integration-testing
        poll_operation: true
    - expect_progress_tracker:
        message: Deleting Cloud SQL instance
        status: SUCCESS
    - expect_stderr: |
        Deleted [https://sqladmin.googleapis.com/sql/v1beta4/projects/cloud-sdk-integration-testing/instances/$$test-dest$$].
    - expect_exit:
        code: 0
- execute_command:
    command: sql instances delete $$test-dest$$-master
    cleanup_for: test-dest
    events:
    - expect_prompt_continue:
        message: All of the instance data will be lost when the instance is deleted.
        user_input: y
    - api_call:
        expect_request:
          uri: https://sqladmin.googleapis.com/sql/v1beta4/projects/cloud-sdk-integration-testing/instances/$$test-dest$$-master?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '685'
            content-type: application/json; charset=UTF-8
          body:
            kind: sql#operation
            targetLink: https://sqladmin.googleapis.com/sql/v1beta4/projects/cloud-sdk-integration-testing/instances/$$test-dest$$-master
            status: DONE
            user: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            insertTime: '2020-08-26T22:23:58.732Z'
            operationType: DELETE
            name: 23b8cbb3-11ba-45d3-9996-61bb9bdd3227
            targetId: $$test-dest$$-master
            selfLink: https://sqladmin.googleapis.com/sql/v1beta4/projects/cloud-sdk-integration-testing/operations/23b8cbb3-11ba-45d3-9996-61bb9bdd3227
            targetProject: cloud-sdk-integration-testing
        poll_operation: true
    - expect_progress_tracker:
        message: Deleting Cloud SQL instance
        status: SUCCESS
    - expect_stderr: |
        Deleted [https://sqladmin.googleapis.com/sql/v1beta4/projects/cloud-sdk-integration-testing/instances/$$test-dest$$-master].
    - expect_exit:
        code: 0
