title: Edge device state describe test
release_tracks: [ALPHA]
summary:
# This summary is generated automatically on update and should not be edited.
- execute:
  - label: From YAML file
  - command: iot edge topic-bridge update my-device --registry my-registry --region
      us-central1 --rule-file rule_file.yaml
  - stderr: |
      Updated device [my-device].
  - stdout: |
      NAME       VERSION
      my-device  2
          +-------------------------------------------------------------------------------------+
          |                                        RULES                                        |
          +---------------+-----------+---------------+--------------------+--------------------+
          | SOURCE_DOMAIN | OPERATION | SOURCE_FILTER | DESTINATION_DOMAIN | REWRITE_TOPIC_NAME |
          +---------------+-----------+---------------+--------------------+--------------------+
          | EDGE          | REWRITE   | foo/#         | EDGE               | bar/#              |
          +---------------+-----------+---------------+--------------------+--------------------+
- execute:
  - label: From JSON file
  - command: iot edge topic-bridge update my-device --registry my-registry --region
      us-central1 --rule-file rule_file.json
  - stderr: |
      Updated device [my-device].
  - stdout: |
      NAME       VERSION
      my-device  2
          +-------------------------------------------------------------------------------------+
          |                                        RULES                                        |
          +---------------+-----------+---------------+--------------------+--------------------+
          | SOURCE_DOMAIN | OPERATION | SOURCE_FILTER | DESTINATION_DOMAIN | REWRITE_TOPIC_NAME |
          +---------------+-----------+---------------+--------------------+--------------------+
          | EDGE          | REWRITE   | foo/#         | EDGE               | bar/#              |
          +---------------+-----------+---------------+--------------------+--------------------+
actions:
- write_file:
    path: rule_file.yaml
    contents: |
      rules:
      - source_domain: EDGE
        source_filter: foo/#
        operation: REWRITE
        destination_domain: EDGE
        rewrite_topic_name: bar/#
- write_file:
    path: rule_file.json
    contents: |
      {
        "rules": [
          {
            "source_domain": "EDGE",
            "source_filter": "foo/#",
            "operation": "REWRITE",
            "destination_domain": "EDGE",
            "rewrite_topic_name": "bar/#"
          }]
      }
- execute_command:
    label: From YAML file
    command: iot edge topic-bridge update my-device --registry my-registry --region
      us-central1 --rule-file rule_file.yaml
    events:
    - api_call:
        expect_request:
          uri: https://edge.googleapis.com/v1alpha1/projects/fake-project/locations/us-central1/registries/my-registry/devices/my-device/topicBridgingTable?alt=json
          method: PUT
          headers: {}
          body: |
            {"name": "projects/fake-project/locations/us-central1/registries/my-registry/devices/my-device", "rules": [{"destinationDomain": "EDGE", "operation": "REWRITE", "rewriteTopicName": "bar/#", "sourceDomain": "EDGE", "sourceFilter": "foo/#"}]}
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "projects/fake-project/locations/us-central1/registries/my-registry/devices/my-device",
              "rules": [
                {
                  "sourceDomain": "EDGE",
                  "sourceFilter": "foo/#",
                  "operation": "REWRITE",
                  "destinationDomain": "EDGE",
                  "rewriteTopicName": "bar/#"
                }
              ],
              "version": "2"
            }
    - expect_stderr: |
        Updated device [my-device].
    - expect_stdout: |
        NAME       VERSION
        my-device  2
            +-------------------------------------------------------------------------------------+
            |                                        RULES                                        |
            +---------------+-----------+---------------+--------------------+--------------------+
            | SOURCE_DOMAIN | OPERATION | SOURCE_FILTER | DESTINATION_DOMAIN | REWRITE_TOPIC_NAME |
            +---------------+-----------+---------------+--------------------+--------------------+
            | EDGE          | REWRITE   | foo/#         | EDGE               | bar/#              |
            +---------------+-----------+---------------+--------------------+--------------------+
    - expect_exit:
        code: 0
- execute_command:
    label: From JSON file
    command: iot edge topic-bridge update my-device --registry my-registry --region
      us-central1 --rule-file rule_file.json
    events:
    - api_call:
        expect_request:
          uri: https://edge.googleapis.com/v1alpha1/projects/fake-project/locations/us-central1/registries/my-registry/devices/my-device/topicBridgingTable?alt=json
          method: PUT
          headers: {}
          body:
            json:
              name: projects/fake-project/locations/us-central1/registries/my-registry/devices/my-device
              rules:
              - destinationDomain: EDGE
                operation: REWRITE
                rewriteTopicName: bar/#
                sourceDomain: EDGE
                sourceFilter: foo/#
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "projects/fake-project/locations/us-central1/registries/my-registry/devices/my-device",
              "rules": [
                {
                  "sourceDomain": "EDGE",
                  "sourceFilter": "foo/#",
                  "operation": "REWRITE",
                  "destinationDomain": "EDGE",
                  "rewriteTopicName": "bar/#"
                }
              ],
              "version": "2"
            }
    - expect_stderr: |
        Updated device [my-device].
    - expect_stdout: |
        NAME       VERSION
        my-device  2
            +-------------------------------------------------------------------------------------+
            |                                        RULES                                        |
            +---------------+-----------+---------------+--------------------+--------------------+
            | SOURCE_DOMAIN | OPERATION | SOURCE_FILTER | DESTINATION_DOMAIN | REWRITE_TOPIC_NAME |
            +---------------+-----------+---------------+--------------------+--------------------+
            | EDGE          | REWRITE   | foo/#         | EDGE               | bar/#              |
            +---------------+-----------+---------------+--------------------+--------------------+
    - expect_exit:
        code: 0
