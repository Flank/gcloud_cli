title: cloud iot edge functions create test scenario
release_tracks: [ALPHA]
description: tests simple Edge Function creation
summary:
# This summary is generated automatically on update and should not be edited.
- execute:
  - command: |
      iot edge functions create foo --region asia-east1 --registry my-registry --device my-device --source gcr.io/cloud-iot-edge/samples/ml-camera-python:x86_64 --arch x86-64
  - stderr: |
      Created function [foo].
- execute:
  - command: |
      iot edge functions create foo --region asia-east1 --registry my-registry --device my-device --source gcr.io/cloud-iot-edge/samples/ml-camera-python:x86_64
      --env-vars KEY1=VALUE1,KEY2=VALUE2 --input-topic foo:input/topic/1,bar:input/topic2 --output-topic foo:output/topic/1,bar:output/topic2
      --device-binding /dev/video0:/dev/video1,/dev/gpio/1:r --volume-binding /tmp:ro,/tmp/data:/data --description "edge function"
      --memory 1GB --timeout 8s --function-type stream-processing --entry-point main --arch x86-64
  - stderr: |
      Created function [foo].
- execute:
  - command: |
      iot edge functions create foo --region asia-east1 --registry my-registry --device my-device --source gcr.io/cloud-iot-edge/samples/ml-camera-python:x86_64
      --env-vars-file env_vars.yaml --input-topic foo:input/topic/1,bar:input/topic2 --output-topic foo:output/topic/1,bar:output/topic2
      --device-binding /dev/video0:/dev/video1,/dev/gpio/1:r --volume-binding /tmp:ro,/tmp/data:/data --description "edge function"
      --memory 1GB --timeout 8s --function-type stream-processing --entry-point main --arch x86-64
  - stderr: |
      Created function [foo].
actions:
- execute_command:
    command: |
      iot edge functions create foo --region asia-east1 --registry my-registry --device my-device --source gcr.io/cloud-iot-edge/samples/ml-camera-python:x86_64 --arch x86-64
    events:
    - api_call:
        expect_request:
          uri: https://edge.googleapis.com/v1alpha1/projects/fake-project/locations/asia-east1/registries/my-registry/devices/my-device/functions?alt=json
          method: POST
          headers: {}
          body:
            json:
              dockerImageUri: gcr.io/cloud-iot-edge/samples/ml-camera-python:x86_64
              functionType: ON_DEMAND
              inputTopics:
              - topic: /function/foo/input
              name: projects/fake-project/locations/asia-east1/registries/my-registry/devices/my-device/functions/foo
              outputTopics:
              - topic: /function/foo/output
              requestTimeout: 540s
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "projects/fake-project/locations/asia-east1/registries/my-registry/devices/my-device/functions/foo",
              "dockerImageUri": "gcr.io/cloud-iot-edge/samples/ml-camera-python:x86_64",
              "inputTopics": [
                {
                  "topic": "/function/foo/input"
                }
              ],
              "outputTopics": [
                {
                  "topic": "/function/foo/output"
                }
              ],
              "functionType": "ON_DEMAND",
              "requestTimeout": "540s",
              "updateTime": "2019-03-03T12:07:57.142609957Z",
              "version": "1"
            }

    - expect_stderr: |
        Created function [foo].
    - expect_exit:
        code: 0
- execute_command:
    command: |
      iot edge functions create foo --region asia-east1 --registry my-registry --device my-device --source gcr.io/cloud-iot-edge/samples/ml-camera-python:x86_64
      --env-vars KEY1=VALUE1,KEY2=VALUE2 --input-topic foo:input/topic/1,bar:input/topic2 --output-topic foo:output/topic/1,bar:output/topic2
      --device-binding /dev/video0:/dev/video1,/dev/gpio/1:r --volume-binding /tmp:ro,/tmp/data:/data --description "edge function"
      --memory 1GB --timeout 8s --function-type stream-processing --entry-point main --arch x86-64
    events:
    - api_call:
        expect_request:
          uri: https://edge.googleapis.com/v1alpha1/projects/fake-project/locations/asia-east1/registries/my-registry/devices/my-device/functions?alt=json
          method: POST
          headers: {}
          body:
            json:
              availableMemoryMb: 1024
              description: edge function
              deviceBindings:
              - cgroupPermissions: rwm
                destination: /dev/video1
                source: /dev/video0
              - cgroupPermissions: r
                destination: /dev/gpio/1
                source: /dev/gpio/1
              dockerImageUri: gcr.io/cloud-iot-edge/samples/ml-camera-python:x86_64
              entryPoint: main
              environmentVariables:
                KEY1: VALUE1
                KEY2: VALUE2
              functionType: STREAM_PROCESSING
              inputTopics:
              - topic: /function/foo/input
              - id: foo
                topic: input/topic/1
              - id: bar
                topic: input/topic2
              name: projects/fake-project/locations/asia-east1/registries/my-registry/devices/my-device/functions/foo
              outputTopics:
              - topic: /function/foo/output
              - id: foo
                topic: output/topic/1
              - id: bar
                topic: output/topic2
              requestTimeout: 8s
              volumeBindings:
              - destination: /tmp
                readOnly: true
                source: /tmp
              - destination: /data
                readOnly: false
                source: /tmp/data
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "projects/fake-project/locations/asia-east1/registries/my-registry/devices/my-device/functions/foo",
              "description": "edge function",
              "dockerImageUri": "gcr.io/cloud-iot-edge/samples/ml-camera-python:x86_64",
              "environmentVariables": {
                "KEY2": "VALUE2",
                "KEY1": "VALUE1"
              },
              "availableMemoryMb": 1024,
              "volumeBindings": [
                {
                  "source": "/tmp",
                  "destination": "/tmp",
                  "readOnly": true
                },
                {
                  "source": "/tmp/data",
                  "destination": "/data"
                }
              ],
              "deviceBindings": [
                {
                  "source": "/dev/video0",
                  "destination": "/dev/video1",
                  "cgroupPermissions": "rwm"
                },
                {
                  "source": "/dev/gpio/1",
                  "destination": "/dev/gpio/1",
                  "cgroupPermissions": "r"
                }
              ],
              "inputTopics": [
                {
                  "topic": "/function/foo/input"
                },
                {
                  "topic": "input/topic/1",
                  "id": "foo"
                },
                {
                  "topic": "input/topic2",
                  "id": "bar"
                }
              ],
              "outputTopics": [
                {
                  "topic": "/function/foo/output"
                },
                {
                  "topic": "output/topic/1",
                  "id": "foo"
                },
                {
                  "topic": "output/topic2",
                  "id": "bar"
                }
              ],
              "functionType": "STREAM_PROCESSING",
              "entryPoint": "main",
              "requestTimeout": "8s",
              "updateTime": "2019-03-03T12:10:47.632092983Z",
              "version": "1"
            }


    - expect_stderr: |
        Created function [foo].
    - expect_exit:
        code: 0
- write_file:
    path: env_vars.yaml
    contents: |
      KEY1: VALUE1
      KEY2: VALUE2

- execute_command:
    command: |
      iot edge functions create foo --region asia-east1 --registry my-registry --device my-device --source gcr.io/cloud-iot-edge/samples/ml-camera-python:x86_64
      --env-vars-file env_vars.yaml --input-topic foo:input/topic/1,bar:input/topic2 --output-topic foo:output/topic/1,bar:output/topic2
      --device-binding /dev/video0:/dev/video1,/dev/gpio/1:r --volume-binding /tmp:ro,/tmp/data:/data --description "edge function"
      --memory 1GB --timeout 8s --function-type stream-processing --entry-point main --arch x86-64
    events:
    - api_call:
        expect_request:
          uri: https://edge.googleapis.com/v1alpha1/projects/fake-project/locations/asia-east1/registries/my-registry/devices/my-device/functions?alt=json
          method: POST
          headers: {}
          body:
            json:
              availableMemoryMb: 1024
              description: edge function
              deviceBindings:
              - cgroupPermissions: rwm
                destination: /dev/video1
                source: /dev/video0
              - cgroupPermissions: r
                destination: /dev/gpio/1
                source: /dev/gpio/1
              dockerImageUri: gcr.io/cloud-iot-edge/samples/ml-camera-python:x86_64
              entryPoint: main
              environmentVariables:
                KEY1: VALUE1
                KEY2: VALUE2
              functionType: STREAM_PROCESSING
              inputTopics:
              - topic: /function/foo/input
              - id: foo
                topic: input/topic/1
              - id: bar
                topic: input/topic2
              name: projects/fake-project/locations/asia-east1/registries/my-registry/devices/my-device/functions/foo
              outputTopics:
              - topic: /function/foo/output
              - id: foo
                topic: output/topic/1
              - id: bar
                topic: output/topic2
              requestTimeout: 8s
              volumeBindings:
              - destination: /tmp
                readOnly: true
                source: /tmp
              - destination: /data
                readOnly: false
                source: /tmp/data
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "projects/fake-project/locations/asia-east1/registries/my-registry/devices/my-device/functions/foo",
              "description": "edge function",
              "dockerImageUri": "gcr.io/cloud-iot-edge/samples/ml-camera-python:x86_64",
              "environmentVariables": {
                "KEY2": "VALUE2",
                "KEY1": "VALUE1"
              },
              "availableMemoryMb": 1024,
              "volumeBindings": [
                {
                  "source": "/tmp",
                  "destination": "/tmp",
                  "readOnly": true
                },
                {
                  "source": "/tmp/data",
                  "destination": "/data"
                }
              ],
              "deviceBindings": [
                {
                  "source": "/dev/video0",
                  "destination": "/dev/video1",
                  "cgroupPermissions": "rwm"
                },
                {
                  "source": "/dev/gpio/1",
                  "destination": "/dev/gpio/1",
                  "cgroupPermissions": "r"
                }
              ],
              "inputTopics": [
                {
                  "topic": "/function/foo/input"
                },
                {
                  "topic": "input/topic/1",
                  "id": "foo"
                },
                {
                  "topic": "input/topic2",
                  "id": "bar"
                }
              ],
              "outputTopics": [
                {
                  "topic": "/function/foo/output"
                },
                {
                  "topic": "output/topic/1",
                  "id": "foo"
                },
                {
                  "topic": "output/topic2",
                  "id": "bar"
                }
              ],
              "functionType": "STREAM_PROCESSING",
              "entryPoint": "main",
              "requestTimeout": "8s",
              "updateTime": "2019-03-03T12:13:42.685707159Z",
              "version": "1"
            }

    - expect_stderr: |
        Created function [foo].
    - expect_exit:
        code: 0
