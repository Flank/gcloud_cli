title: artifacts docker images describe
release_tracks: [ALPHA, BETA]
summary:
# This summary is generated by http://go/gcloud-scenario-tests on update and should not be edited.
- execute:
  - command: artifacts docker images describe us-west1-docker.pkg.dev/fake-project/docker-repo/ubuntu@sha256:abcxyz
  - stdout: |
      image_summary:
        digest: sha256:abcxyz
        fully_qualified_digest: us-west1-docker.pkg.dev/fake-project/docker-repo/ubuntu@sha256:abcxyz
        registry: us-west1-docker.pkg.dev
        repository: docker-repo
- execute:
  - command: artifacts docker images describe us-west1-docker.pkg.dev/fake-project/docker-repo/ubuntu:my-tag
  - stdout: |
      image_summary:
        digest: sha256:abcxyz
        fully_qualified_digest: us-west1-docker.pkg.dev/fake-project/docker-repo/ubuntu@sha256:abcxyz
        registry: us-west1-docker.pkg.dev
        repository: docker-repo
- execute:
  - command: artifacts docker images describe us-west1-docker.pkg.dev/fake-project/docker-repo/ubuntu@sha256:baddigest
  - error: |
      1: Image not found.

      A valid container image can be referenced by tag or digest, has the format of
        LOCATION-docker.pkg.dev/PROJECT-ID/REPOSITORY-ID/IMAGE:tag
        LOCATION-docker.pkg.dev/PROJECT-ID/REPOSITORY-ID/IMAGE@sha256:digest
- execute:
  - command: artifacts docker images describe us-west1-docker.pkg.dev/fake-project/docker-repo/ubuntu:badtag
  - error: |
      1: Image not found.

      A valid container image can be referenced by tag or digest, has the format of
        LOCATION-docker.pkg.dev/PROJECT-ID/REPOSITORY-ID/IMAGE:tag
        LOCATION-docker.pkg.dev/PROJECT-ID/REPOSITORY-ID/IMAGE@sha256:digest
actions:
- execute_command:
    # Describes an image with digest.
    command: artifacts docker images describe us-west1-docker.pkg.dev/fake-project/docker-repo/ubuntu@sha256:abcxyz
    events:
    - api_call:
        expect_request:
          uri: https://artifactregistry.googleapis.com/v1beta2/projects/fake-project/locations?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            locations:
            - name: projects/fake-project/locations/us-west1
              locationId: us-west1
    - api_call:
        expect_request:
          uri: https://artifactregistry.googleapis.com/v1beta2/projects/fake-project/locations/us-west1/repositories/docker-repo?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "projects/fake-project/locations/us-west1/repositories/docker-repo",
              "format": "DOCKER"
            }
    - api_call:
        expect_request:
          uri: https://artifactregistry.googleapis.com/v1beta2/projects/fake-project/locations/us-west1/repositories/docker-repo/packages/ubuntu/versions/sha256:abcxyz?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "projects/fake-project/locations/us-west1/repositories/docker-repo/versions/sha256:abcxyz",
              "related_tags": {}
            }
    - expect_stdout: |
        image_summary:
          digest: sha256:abcxyz
          fully_qualified_digest: us-west1-docker.pkg.dev/fake-project/docker-repo/ubuntu@sha256:abcxyz
          registry: us-west1-docker.pkg.dev
          repository: docker-repo
    - expect_exit:
        code: 0

- execute_command:
    # Describes an image with tag.
    command: artifacts docker images describe us-west1-docker.pkg.dev/fake-project/docker-repo/ubuntu:my-tag
    events:
    - api_call:
        expect_request:
          uri: https://artifactregistry.googleapis.com/v1beta2/projects/fake-project/locations?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            locations:
            - name: projects/fake-project/locations/us-west1
              locationId: us-west1
    - api_call:
        expect_request:
          uri: https://artifactregistry.googleapis.com/v1beta2/projects/fake-project/locations/us-west1/repositories/docker-repo?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "projects/fake-project/locations/us-west1/repositories/docker-repo",
              "format": "DOCKER"
            }
    - api_call:
        expect_request:
          uri: https://artifactregistry.googleapis.com/v1beta2/projects/fake-project/locations/us-west1/repositories/docker-repo/packages/ubuntu/tags/my-tag?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "projects/fake-project/locations/us-west1/repositories/docker-repo/tags/my-tag",
              "version": "projects/fake-project/locations/us-west1/repositories/docker-repo/packages/ubuntu/versions/sha256:abcxyz"
            }
    - expect_stdout: |
        image_summary:
          digest: sha256:abcxyz
          fully_qualified_digest: us-west1-docker.pkg.dev/fake-project/docker-repo/ubuntu@sha256:abcxyz
          registry: us-west1-docker.pkg.dev
          repository: docker-repo
    - expect_exit:
        code: 0

- execute_command:
    # Fails when the digest doesn't exist.
    command: artifacts docker images describe us-west1-docker.pkg.dev/fake-project/docker-repo/ubuntu@sha256:baddigest
    events:
    - api_call:
        expect_request:
          uri: https://artifactregistry.googleapis.com/v1beta2/projects/fake-project/locations?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            locations:
            - name: projects/fake-project/locations/us-west1
              locationId: us-west1
    - api_call:
        expect_request:
          uri: https://artifactregistry.googleapis.com/v1beta2/projects/fake-project/locations/us-west1/repositories/docker-repo?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "projects/fake-project/locations/us-west1/repositories/docker-repo",
              "format": "DOCKER"
            }
    - api_call:
        expect_request:
          uri: https://artifactregistry.googleapis.com/v1beta2/projects/fake-project/locations/us-west1/repositories/docker-repo/packages/ubuntu/versions/sha256:baddigest?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '404'
          body:
            error:
              code: '404'
              message: Requested entity was not found
    - expect_exit:
        code: 1
        message: |
          Image not found.

          A valid container image can be referenced by tag or digest, has the format of
            LOCATION-docker.pkg.dev/PROJECT-ID/REPOSITORY-ID/IMAGE:tag
            LOCATION-docker.pkg.dev/PROJECT-ID/REPOSITORY-ID/IMAGE@sha256:digest


- execute_command:
    # Fails when the the tag doesn't exist.
    command: artifacts docker images describe us-west1-docker.pkg.dev/fake-project/docker-repo/ubuntu:badtag
    events:
    - api_call:
        expect_request:
          uri: https://artifactregistry.googleapis.com/v1beta2/projects/fake-project/locations?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            locations:
            - name: projects/fake-project/locations/us-west1
              locationId: us-west1
    - api_call:
        expect_request:
          uri: https://artifactregistry.googleapis.com/v1beta2/projects/fake-project/locations/us-west1/repositories/docker-repo?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "projects/fake-project/locations/us-west1/repositories/docker-repo",
              "format": "DOCKER"
            }
    - api_call:
        expect_request:
          uri: https://artifactregistry.googleapis.com/v1beta2/projects/fake-project/locations/us-west1/repositories/docker-repo/packages/ubuntu/tags/badtag?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '404'
    - expect_exit:
        code: 1
        message: |
          Image not found.

          A valid container image can be referenced by tag or digest, has the format of
            LOCATION-docker.pkg.dev/PROJECT-ID/REPOSITORY-ID/IMAGE:tag
            LOCATION-docker.pkg.dev/PROJECT-ID/REPOSITORY-ID/IMAGE@sha256:digest
