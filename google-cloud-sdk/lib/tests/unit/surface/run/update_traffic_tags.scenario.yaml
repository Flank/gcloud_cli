title: update-traffic with traffic tags scenario
release_tracks: [ALPHA, BETA]
summary:
# This summary is generated automatically on update and should not be edited.
- set_property: run/platform managed
- set_property: run/region us-central1
- execute:
  - command: run services update-traffic testservice --set-tags=candidate=rev-1,head=LATEST
  - staged_progress_tracker:
    - message: Updating traffic...
    - status: SUCCESS
  - stdout: |
      Traffic: https://testservice-irvkrntpmq-uc.a.run.app
        100% rev-1                    candidate
          https://candidate---testservice-irvkrntpmq-uc.a.run.app
        0%   LATEST (currently rev-2) head
          https://head---testservice-irvkrntpmq-uc.a.run.app
- execute:
  - command: run services update-traffic testservice --clear-tags
  - staged_progress_tracker:
    - message: Updating traffic...
    - status: SUCCESS
  - stdout: |
      Traffic: https://testservice-irvkrntpmq-uc.a.run.app
        75% rev-1
        25% rev-2
- execute:
  - command: run services update-traffic testservice --remove-tags=with-percent,candidate,latest
  - staged_progress_tracker:
    - message: Updating traffic...
    - status: SUCCESS
  - stdout: |
      Traffic: https://testservice-irvkrntpmq-uc.a.run.app
        75% rev-1 current
          https://current---testservice-irvkrntpmq-uc.a.run.app
        25% rev-2 next
          https://next---testservice-irvkrntpmq-uc.a.run.app
- execute:
  - command: run services update-traffic testservice --update-tags=candidate=rev-2,latest=rev-4
  - staged_progress_tracker:
    - message: Updating traffic...
    - status: SUCCESS
  - stdout: |
      Traffic: https://testservice-irvkrntpmq-uc.a.run.app
        75% rev-1 current, with-percent
          https://current---testservice-irvkrntpmq-uc.a.run.app
          https://with-percent---testservice-irvkrntpmq-uc.a.run.app
        25% rev-2 candidate, next
          https://candidate---testservice-irvkrntpmq-uc.a.run.app
          https://next---testservice-irvkrntpmq-uc.a.run.app
        0%  rev-4 latest
          https://latest---testservice-irvkrntpmq-uc.a.run.app
- execute:
  - command: run services update-traffic testservice --update-tags=candidate=rev-2,latest=rev-4
      --remove-tags=with-percent,current
  - staged_progress_tracker:
    - message: Updating traffic...
    - status: SUCCESS
  - stdout: |
      Traffic: https://testservice-irvkrntpmq-uc.a.run.app
        75% rev-1
        25% rev-2 candidate, next
          https://candidate---testservice-irvkrntpmq-uc.a.run.app
          https://next---testservice-irvkrntpmq-uc.a.run.app
        0%  rev-4 latest
          https://latest---testservice-irvkrntpmq-uc.a.run.app
- execute:
  - command: run services update-traffic testservice --set-tags=candidate=rev-1,head=LATEST
  - staged_progress_tracker:
    - message: Updating traffic...
    - status: FAILURE
  - stdout: |
      Traffic: https://testservice-irvkrntpmq-uc.a.run.app
        100% rev-1                    candidate (currently tag1)
          https://tag1---testservice-irvkrntpmq-uc.a.run.app
        0%   LATEST (currently rev-2) head (currently tag2)
          https://tag2---testservice-irvkrntpmq-uc.a.run.app
  - error: '1: None'
- execute:
  - command: run services update-traffic testservice --set-tags=candidate=rev-1,head=LATEST
      --to-revisions=rev-2=20
  - staged_progress_tracker:
    - message: Updating traffic...
    - status: SUCCESS
  - stdout: |
      Traffic: https://testservice-irvkrntpmq-uc.a.run.app
        80% rev-1                    candidate
          https://candidate---testservice-irvkrntpmq-uc.a.run.app
        20% rev-2
        0%  LATEST (currently rev-2) head
          https://head---testservice-irvkrntpmq-uc.a.run.app
actions:
- set_property:
    run/platform: managed
    run/region: us-central1
- execute_command:
    command: run services update-traffic testservice --set-tags=candidate=rev-1,head=LATEST
    events:
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              labels:
                cloud.googleapis.com/location: us-central1
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                    image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 100
                revisionName: rev-1
              - tag: tag1
                revisionName: rev-1
              - tag: tag2
                revisionName: rev-2
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-2
              latestReadyRevisionName: rev-2
              observedGeneration: 1
              traffic:
              - percent: 100
                revisionName: rev-1
              - tag: tag1
                revisionName: rev-1
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              - tag: tag2
                revisionName: rev-2
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: PUT
          headers: {}
          body:
            json:
              apiVersion: serving.knative.dev/v1
              kind: Service
              metadata:
                annotations:
                  client.knative.dev/user-image: gcr.io/cloudrun/hello
                  serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                  serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                creationTimestamp: '2019-07-23T18:13:29Z'
                generation: 1
                labels:
                  cloud.googleapis.com/location: us-central1
                name: testservice
                namespace: '123456789'
                resourceVersion: '51639050'
                selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
                uid: 92610cc6-ad75-11e9-b545-42010a800168
              spec:
                template:
                  spec:
                    containers:
                    - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
                traffic:
                - percent: 100
                  revisionName: rev-1
                - revisionName: rev-1
                  tag: candidate
                - latestRevision: true
                  tag: head
              status:
                address:
                  url: https://testservice-irvkrntpmq-uc.a.run.app
                conditions:
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: ConfigurationsReady
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: Ready
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: RoutesReady
                latestCreatedRevisionName: rev-2
                latestReadyRevisionName: rev-2
                observedGeneration: 1
                traffic:
                - percent: 100
                  revisionName: rev-1
                - tag: tag1
                  revisionName: rev-1
                  url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
                - tag: tag2
                  revisionName: rev-2
                  url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
                url: https://testservice-irvkrntpmq-uc.a.run.app
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 2
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639051'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 100
                revisionName: rev-1
              - revisionName: rev-1
                tag: candidate
              - latestRevision: true
                tag: head
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-2
              latestReadyRevisionName: rev-2
              observedGeneration: 1
              traffic:
              - percent: 100
                revisionName: rev-1
              - tag: tag1
                revisionName: rev-1
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              - tag: tag2
                revisionName: rev-2
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 2
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 100
                revisionName: rev-1
              - revisionName: rev-1
                tag: candidate
              - latestRevision: true
                tag: head
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-2
              latestReadyRevisionName: rev-2
              observedGeneration: 2
              traffic:
              - percent: 100
                revisionName: rev-1
              - tag: candidate
                revisionName: rev-1
                url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
              - latestRevision: true
                tag: head
                url: https://head---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
        repeatable: true
    - expect_staged_progress_tracker:
        message: Updating traffic...
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 2
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 100
                revisionName: rev-1
              - revisionName: rev-1
                tag: candidate
              - latestRevision: true
                tag: head
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-2
              latestReadyRevisionName: rev-2
              observedGeneration: 2
              traffic:
              - percent: 100
                revisionName: rev-1
              - tag: candidate
                revisionName: rev-1
                url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
              - latestRevision: true
                tag: head
                url: https://head---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - expect_stdout: |
        Traffic: https://testservice-irvkrntpmq-uc.a.run.app
          100% rev-1                    candidate
            https://candidate---testservice-irvkrntpmq-uc.a.run.app
          0%   LATEST (currently rev-2) head
            https://head---testservice-irvkrntpmq-uc.a.run.app
    - expect_exit:
        code: 0
- execute_command:
    command: run services update-traffic testservice --update-tags=candidate=rev-1,head=LATEST --to-tags=head=50,tag2=25
    events:
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              labels:
                cloud.googleapis.com/location: us-central1
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                    image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 100
                revisionName: rev-1
              - tag: tag1
                revisionName: rev-1
              - tag: tag2
                revisionName: rev-2
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-2
              latestReadyRevisionName: rev-2
              observedGeneration: 1
              traffic:
              - percent: 100
                revisionName: rev-1
              - tag: tag1
                revisionName: rev-1
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              - tag: tag2
                revisionName: rev-2
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: PUT
          headers: {}
          body:
            json:
              apiVersion: serving.knative.dev/v1
              kind: Service
              metadata:
                annotations:
                  client.knative.dev/user-image: gcr.io/cloudrun/hello
                  serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                  serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                creationTimestamp: '2019-07-23T18:13:29Z'
                generation: 1
                labels:
                  cloud.googleapis.com/location: us-central1
                name: testservice
                namespace: '123456789'
                resourceVersion: '51639050'
                selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
                uid: 92610cc6-ad75-11e9-b545-42010a800168
              spec:
                template:
                  spec:
                    containers:
                    - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
                traffic:
                - percent: 25
                  revisionName: rev-1
                - percent: 25
                  revisionName: rev-2
                - latestRevision: true
                  percent: 50
                - revisionName: rev-1
                  tag: tag1
                - revisionName: rev-2
                  tag: tag2
                - revisionName: rev-1
                  tag: candidate
                - latestRevision: true
                  tag: head
              status:
                address:
                  url: https://testservice-irvkrntpmq-uc.a.run.app
                conditions:
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: ConfigurationsReady
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: Ready
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: RoutesReady
                latestCreatedRevisionName: rev-2
                latestReadyRevisionName: rev-2
                observedGeneration: 1
                traffic:
                - percent: 100
                  revisionName: rev-1
                - tag: tag1
                  revisionName: rev-1
                  url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
                - tag: tag2
                  revisionName: rev-2
                  url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
                url: https://testservice-irvkrntpmq-uc.a.run.app
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 2
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639051'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 100
                revisionName: rev-1
              - revisionName: rev-1
                tag: candidate
              - latestRevision: true
                tag: head
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-2
              latestReadyRevisionName: rev-2
              observedGeneration: 1
              traffic:
              - percent: 25
                revisionName: rev-1
              - percent: 25
                revisionName: rev-2
              - latestRevision: true
                percent: 50
              - tag: candidate
                revisionName: rev-1
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              - tag: head
                latestRevision: true
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              - tag: tag1
                revisionName: rev-1
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              - tag: tag2
                revisionName: rev-2
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 2
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 100
                revisionName: rev-1
              - revisionName: rev-1
                tag: candidate
              - latestRevision: true
                tag: head
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-2
              latestReadyRevisionName: rev-2
              observedGeneration: 2
              traffic:
              - percent: 25
                revisionName: rev-1
              - percent: 25
                revisionName: rev-2
              - latestRevision: true
                percent: 50
              - tag: candidate
                revisionName: rev-1
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              - tag: head
                latestRevision: true
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              - tag: tag1
                revisionName: rev-1
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              - tag: tag2
                revisionName: rev-2
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
        repeatable: true
    - expect_staged_progress_tracker:
        message: Updating traffic...
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 2
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 25
                revisionName: rev-1
              - percent: 25
                revisionName: rev-2
              - latestRevision: true
                percent: 50
              - revisionName: rev-1
                tag: tag1
              - revisionName: rev-2
                tag: tag2
              - revisionName: rev-1
                tag: candidate
              - latestRevision: true
                tag: head
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-2
              latestReadyRevisionName: rev-2
              observedGeneration: 2
              traffic:
              - percent: 25
                revisionName: rev-1
              - percent: 25
                revisionName: rev-2
              - latestRevision: true
                percent: 50
              - tag: candidate
                revisionName: rev-1
                url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
              - tag: head
                latestRevision: true
                url: https://head---testservice-irvkrntpmq-uc.a.run.app
              - tag: tag1
                revisionName: rev-1
                url: https://tag1---testservice-irvkrntpmq-uc.a.run.app
              - tag: tag2
                revisionName: rev-2
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - expect_stdout: |
        Traffic: https://testservice-irvkrntpmq-uc.a.run.app
          25% rev-1                    candidate, tag1
            https://candidate---testservice-irvkrntpmq-uc.a.run.app
            https://tag1---testservice-irvkrntpmq-uc.a.run.app
          25% rev-2                    tag2
            https://tag2---testservice-irvkrntpmq-uc.a.run.app
          50% LATEST (currently rev-2) head
            https://head---testservice-irvkrntpmq-uc.a.run.app
    - expect_exit:
        code: 0
- execute_command:
    command: run services update-traffic testservice --clear-tags
    events:
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 4
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 75
                revisionName: rev-1
                tag: with-percent
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: candidate
              - revisionName: rev-1
                tag: current
              - revisionName: rev-2
                tag: next
              - latestRevision: true
                tag: latest
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-4
              latestReadyRevisionName: rev-4
              observedGeneration: 4
              traffic:
              - percent: 75
                revisionName: rev-1
                tag: with-percent
                url: https://with-percent---testservice-irvkrntpmq-uc.a.run.app
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: candidate
                url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-1
                tag: current
                url: https://current---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-2
                tag: next
                url: https://next---testservice-irvkrntpmq-uc.a.run.app
              - latestRevision: true
                revisionName: rev-4
                tag: latest
                url: https://latest---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: PUT
          headers: {}
          body:
            json:
              apiVersion: serving.knative.dev/v1
              kind: Service
              metadata:
                annotations:
                  client.knative.dev/user-image: gcr.io/cloudrun/hello
                  serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                  serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                creationTimestamp: '2019-07-23T18:13:29Z'
                generation: 4
                labels:
                  cloud.googleapis.com/location: us-central1
                name: testservice
                namespace: '123456789'
                resourceVersion: '51639050'
                selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
                uid: 92610cc6-ad75-11e9-b545-42010a800168
              spec:
                template:
                  spec:
                    containers:
                    - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
                traffic:
                - percent: 75
                  revisionName: rev-1
                - percent: 25
                  revisionName: rev-2
              status:
                address:
                  url: https://testservice-irvkrntpmq-uc.a.run.app
                conditions:
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: ConfigurationsReady
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: Ready
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: RoutesReady
                latestCreatedRevisionName: rev-4
                latestReadyRevisionName: rev-4
                observedGeneration: 4
                traffic:
                - percent: 75
                  revisionName: rev-1
                  tag: with-percent
                  url: https://with-percent---testservice-irvkrntpmq-uc.a.run.app
                - percent: 25
                  revisionName: rev-2
                - revisionName: rev-1
                  tag: candidate
                  url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
                - revisionName: rev-1
                  tag: current
                  url: https://current---testservice-irvkrntpmq-uc.a.run.app
                - revisionName: rev-2
                  tag: next
                  url: https://next---testservice-irvkrntpmq-uc.a.run.app
                - latestRevision: true
                  revisionName: rev-4
                  tag: latest
                  url: https://latest---testservice-irvkrntpmq-uc.a.run.app
                url: https://testservice-irvkrntpmq-uc.a.run.app
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 5
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 75
                revisionName: rev-1
              - percent: 25
                revisionName: rev-2
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-4
              latestReadyRevisionName: rev-4
              observedGeneration: 4
              traffic:
              - percent: 75
                revisionName: rev-1
                tag: with-percent
                url: https://with-percent---testservice-irvkrntpmq-uc.a.run.app
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: candidate
                url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-1
                tag: current
                url: https://current---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-2
                tag: next
                url: https://next---testservice-irvkrntpmq-uc.a.run.app
              - latestRevision: true
                revisionName: rev-4
                tag: latest
                url: https://latest---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app

    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 5
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 75
                revisionName: rev-1
              - percent: 25
                revisionName: rev-2
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-4
              latestReadyRevisionName: rev-4
              observedGeneration: 5
              traffic:
              - percent: 75
                revisionName: rev-1
              - percent: 25
                revisionName: rev-2
              url: https://testservice-irvkrntpmq-uc.a.run.app
        repeatable: true
    - expect_staged_progress_tracker:
        message: Updating traffic...
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 5
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 75
                revisionName: rev-1
              - percent: 25
                revisionName: rev-2
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-4
              latestReadyRevisionName: rev-4
              observedGeneration: 5
              traffic:
              - percent: 75
                revisionName: rev-1
              - percent: 25
                revisionName: rev-2
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - expect_stdout: |
        Traffic: https://testservice-irvkrntpmq-uc.a.run.app
          75% rev-1
          25% rev-2
    - expect_exit:
        code: 0
- execute_command:
    command: run services update-traffic testservice --remove-tags=with-percent,candidate,latest
    events:
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 4
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 75
                revisionName: rev-1
                tag: with-percent
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: candidate
              - revisionName: rev-1
                tag: current
              - revisionName: rev-2
                tag: next
              - latestRevision: true
                tag: latest
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-4
              latestReadyRevisionName: rev-4
              observedGeneration: 4
              traffic:
              - percent: 75
                revisionName: rev-1
                tag: with-percent
                url: https://with-percent---testservice-irvkrntpmq-uc.a.run.app
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: candidate
                url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-1
                tag: current
                url: https://current---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-2
                tag: next
                url: https://next---testservice-irvkrntpmq-uc.a.run.app
              - latestRevision: true
                revisionName: rev-4
                tag: latest
                url: https://latest---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: PUT
          headers: {}
          body:
            json:
              apiVersion: serving.knative.dev/v1
              kind: Service
              metadata:
                annotations:
                  client.knative.dev/user-image: gcr.io/cloudrun/hello
                  serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                  serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                creationTimestamp: '2019-07-23T18:13:29Z'
                generation: 4
                labels:
                  cloud.googleapis.com/location: us-central1
                name: testservice
                namespace: '123456789'
                resourceVersion: '51639050'
                selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
                uid: 92610cc6-ad75-11e9-b545-42010a800168
              spec:
                template:
                  spec:
                    containers:
                    - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
                traffic:
                - percent: 75
                  revisionName: rev-1
                - percent: 25
                  revisionName: rev-2
                - revisionName: rev-1
                  tag: current
                - revisionName: rev-2
                  tag: next
              status:
                address:
                  url: https://testservice-irvkrntpmq-uc.a.run.app
                conditions:
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: ConfigurationsReady
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: Ready
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: RoutesReady
                latestCreatedRevisionName: rev-4
                latestReadyRevisionName: rev-4
                observedGeneration: 4
                traffic:
                - percent: 75
                  revisionName: rev-1
                  tag: with-percent
                  url: https://with-percent---testservice-irvkrntpmq-uc.a.run.app
                - percent: 25
                  revisionName: rev-2
                - revisionName: rev-1
                  tag: candidate
                  url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
                - revisionName: rev-1
                  tag: current
                  url: https://current---testservice-irvkrntpmq-uc.a.run.app
                - revisionName: rev-2
                  tag: next
                  url: https://next---testservice-irvkrntpmq-uc.a.run.app
                - latestRevision: true
                  revisionName: rev-4
                  tag: latest
                  url: https://latest---testservice-irvkrntpmq-uc.a.run.app
                url: https://testservice-irvkrntpmq-uc.a.run.app
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 5
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 75
                revisionName: rev-1
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: current
              - revisionName: rev-2
                tag: next
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-4
              latestReadyRevisionName: rev-4
              observedGeneration: 4
              traffic:
              - percent: 75
                revisionName: rev-1
                tag: with-percent
                url: https://with-percent---testservice-irvkrntpmq-uc.a.run.app
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: candidate
                url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-1
                tag: current
                url: https://current---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-2
                tag: next
                url: https://next---testservice-irvkrntpmq-uc.a.run.app
              - latestRevision: true
                revisionName: rev-4
                tag: latest
                url: https://latest---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 5
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 75
                revisionName: rev-1
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: current
              - revisionName: rev-2
                tag: next
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-4
              latestReadyRevisionName: rev-4
              observedGeneration: 5
              traffic:
              - percent: 75
                revisionName: rev-1
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: current
                url: https://current---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-2
                tag: next
                url: https://next---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
        repeatable: true
    - expect_staged_progress_tracker:
        message: Updating traffic...
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 5
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 75
                revisionName: rev-1
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: current
              - revisionName: rev-2
                tag: next
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-4
              latestReadyRevisionName: rev-4
              observedGeneration: 5
              traffic:
              - percent: 75
                revisionName: rev-1
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: current
                url: https://current---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-2
                tag: next
                url: https://next---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - expect_stdout: |
        Traffic: https://testservice-irvkrntpmq-uc.a.run.app
          75% rev-1 current
            https://current---testservice-irvkrntpmq-uc.a.run.app
          25% rev-2 next
            https://next---testservice-irvkrntpmq-uc.a.run.app
    - expect_exit:
        code: 0
- execute_command:
    command: run services update-traffic testservice --update-tags=candidate=rev-2,latest=rev-4
    events:
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 4
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 75
                revisionName: rev-1
                tag: with-percent
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: candidate
              - revisionName: rev-1
                tag: current
              - revisionName: rev-2
                tag: next
              - latestRevision: true
                tag: latest
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-4
              latestReadyRevisionName: rev-4
              observedGeneration: 4
              traffic:
              - percent: 75
                revisionName: rev-1
                tag: with-percent
                url: https://with-percent---testservice-irvkrntpmq-uc.a.run.app
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: candidate
                url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-1
                tag: current
                url: https://current---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-2
                tag: next
                url: https://next---testservice-irvkrntpmq-uc.a.run.app
              - latestRevision: true
                revisionName: rev-4
                tag: latest
                url: https://latest---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: PUT
          headers: {}
          body:
            json:
              apiVersion: serving.knative.dev/v1
              kind: Service
              metadata:
                annotations:
                  client.knative.dev/user-image: gcr.io/cloudrun/hello
                  serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                  serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                creationTimestamp: '2019-07-23T18:13:29Z'
                generation: 4
                labels:
                  cloud.googleapis.com/location: us-central1
                name: testservice
                namespace: '123456789'
                resourceVersion: '51639050'
                selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
                uid: 92610cc6-ad75-11e9-b545-42010a800168
              spec:
                template:
                  spec:
                    containers:
                    - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
                traffic:
                - percent: 75
                  revisionName: rev-1
                  tag: with-percent
                - percent: 25
                  revisionName: rev-2
                - revisionName: rev-1
                  tag: current
                - revisionName: rev-2
                  tag: next
                - revisionName: rev-2
                  tag: candidate
                - revisionName: rev-4
                  tag: latest
              status:
                address:
                  url: https://testservice-irvkrntpmq-uc.a.run.app
                conditions:
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: ConfigurationsReady
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: Ready
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: RoutesReady
                latestCreatedRevisionName: rev-4
                latestReadyRevisionName: rev-4
                observedGeneration: 4
                traffic:
                - percent: 75
                  revisionName: rev-1
                  tag: with-percent
                  url: https://with-percent---testservice-irvkrntpmq-uc.a.run.app
                - percent: 25
                  revisionName: rev-2
                - revisionName: rev-1
                  tag: candidate
                  url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
                - revisionName: rev-1
                  tag: current
                  url: https://current---testservice-irvkrntpmq-uc.a.run.app
                - revisionName: rev-2
                  tag: next
                  url: https://next---testservice-irvkrntpmq-uc.a.run.app
                - latestRevision: true
                  revisionName: rev-4
                  tag: latest
                  url: https://latest---testservice-irvkrntpmq-uc.a.run.app
                url: https://testservice-irvkrntpmq-uc.a.run.app
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 5
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 75
                revisionName: rev-1
                tag: with-percent
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: current
              - revisionName: rev-2
                tag: next
              - revisionName: rev-2
                tag: candidate
              - revisionName: rev-4
                tag: latest
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-4
              latestReadyRevisionName: rev-4
              observedGeneration: 4
              traffic:
              - percent: 75
                revisionName: rev-1
                tag: with-percent
                url: https://with-percent---testservice-irvkrntpmq-uc.a.run.app
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: candidate
                url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-1
                tag: current
                url: https://current---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-2
                tag: next
                url: https://next---testservice-irvkrntpmq-uc.a.run.app
              - latestRevision: true
                revisionName: rev-4
                tag: latest
                url: https://latest---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 5
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 75
                revisionName: rev-1
                tag: with-percent
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: current
              - revisionName: rev-2
                tag: next
              - revisionName: rev-2
                tag: candidate
              - revisionName: rev-4
                tag: latest
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-4
              latestReadyRevisionName: rev-4
              observedGeneration: 5
              traffic:
              - percent: 75
                revisionName: rev-1
                tag: with-percent
                url: https://with-percent---testservice-irvkrntpmq-uc.a.run.app
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: current
                url: https://current---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-2
                tag: next
                url: https://next---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-2
                tag: candidate
                url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-4
                tag: latest
                url: https://latest---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
        repeatable: true
    - expect_staged_progress_tracker:
        message: Updating traffic...
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 5
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 75
                revisionName: rev-1
                tag: with-percent
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: current
              - revisionName: rev-2
                tag: next
              - revisionName: rev-2
                tag: candidate
              - revisionName: rev-4
                tag: latest
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-4
              latestReadyRevisionName: rev-4
              observedGeneration: 5
              traffic:
              - percent: 75
                revisionName: rev-1
                tag: with-percent
                url: https://with-percent---testservice-irvkrntpmq-uc.a.run.app
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: current
                url: https://current---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-2
                tag: next
                url: https://next---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-2
                tag: candidate
                url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-4
                tag: latest
                url: https://latest---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - expect_stdout: |
        Traffic: https://testservice-irvkrntpmq-uc.a.run.app
          75% rev-1 current, with-percent
            https://current---testservice-irvkrntpmq-uc.a.run.app
            https://with-percent---testservice-irvkrntpmq-uc.a.run.app
          25% rev-2 candidate, next
            https://candidate---testservice-irvkrntpmq-uc.a.run.app
            https://next---testservice-irvkrntpmq-uc.a.run.app
          0%  rev-4 latest
            https://latest---testservice-irvkrntpmq-uc.a.run.app
    - expect_exit:
        code: 0
- execute_command:
    command: run services update-traffic testservice --update-tags=candidate=rev-2,latest=rev-4
      --remove-tags=with-percent,current
    events:
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 4
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 75
                revisionName: rev-1
                tag: with-percent
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: candidate
              - revisionName: rev-1
                tag: current
              - revisionName: rev-2
                tag: next
              - latestRevision: true
                tag: latest
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-4
              latestReadyRevisionName: rev-4
              observedGeneration: 4
              traffic:
              - percent: 75
                revisionName: rev-1
                tag: with-percent
                url: https://with-percent---testservice-irvkrntpmq-uc.a.run.app
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: candidate
                url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-1
                tag: current
                url: https://current---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-2
                tag: next
                url: https://next---testservice-irvkrntpmq-uc.a.run.app
              - latestRevision: true
                revisionName: rev-4
                tag: latest
                url: https://latest---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: PUT
          headers: {}
          body:
            json:
              apiVersion: serving.knative.dev/v1
              kind: Service
              metadata:
                annotations:
                  client.knative.dev/user-image: gcr.io/cloudrun/hello
                  serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                  serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                creationTimestamp: '2019-07-23T18:13:29Z'
                generation: 4
                labels:
                  cloud.googleapis.com/location: us-central1
                name: testservice
                namespace: '123456789'
                resourceVersion: '51639050'
                selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
                uid: 92610cc6-ad75-11e9-b545-42010a800168
              spec:
                template:
                  spec:
                    containers:
                    - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
                traffic:
                - percent: 75
                  revisionName: rev-1
                - percent: 25
                  revisionName: rev-2
                - revisionName: rev-2
                  tag: next
                - revisionName: rev-2
                  tag: candidate
                - revisionName: rev-4
                  tag: latest
              status:
                address:
                  url: https://testservice-irvkrntpmq-uc.a.run.app
                conditions:
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: ConfigurationsReady
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: Ready
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: RoutesReady
                latestCreatedRevisionName: rev-4
                latestReadyRevisionName: rev-4
                observedGeneration: 4
                traffic:
                - percent: 75
                  revisionName: rev-1
                  tag: with-percent
                  url: https://with-percent---testservice-irvkrntpmq-uc.a.run.app
                - percent: 25
                  revisionName: rev-2
                - revisionName: rev-1
                  tag: candidate
                  url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
                - revisionName: rev-1
                  tag: current
                  url: https://current---testservice-irvkrntpmq-uc.a.run.app
                - revisionName: rev-2
                  tag: next
                  url: https://next---testservice-irvkrntpmq-uc.a.run.app
                - latestRevision: true
                  revisionName: rev-4
                  tag: latest
                  url: https://latest---testservice-irvkrntpmq-uc.a.run.app
                url: https://testservice-irvkrntpmq-uc.a.run.app
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 5
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 75
                revisionName: rev-1
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-2
                tag: next
              - revisionName: rev-2
                tag: candidate
              - revisionName: rev-4
                tag: latest
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-4
              latestReadyRevisionName: rev-4
              observedGeneration: 4
              traffic:
              - percent: 75
                revisionName: rev-1
                tag: with-percent
                url: https://with-percent---testservice-irvkrntpmq-uc.a.run.app
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-1
                tag: candidate
                url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-1
                tag: current
                url: https://current---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-2
                tag: next
                url: https://next---testservice-irvkrntpmq-uc.a.run.app
              - latestRevision: true
                revisionName: rev-4
                tag: latest
                url: https://latest---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 5
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 75
                revisionName: rev-1
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-2
                tag: next
              - revisionName: rev-2
                tag: candidate
              - revisionName: rev-4
                tag: latest
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-4
              latestReadyRevisionName: rev-4
              observedGeneration: 5
              traffic:
              - percent: 75
                revisionName: rev-1
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-2
                tag: next
                url: https://next---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-2
                tag: candidate
                url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-4
                tag: latest
                url: https://latest---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
        repeatable: true
    - expect_staged_progress_tracker:
        message: Updating traffic...
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 5
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 75
                revisionName: rev-1
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-2
                tag: next
              - revisionName: rev-2
                tag: candidate
              - revisionName: rev-4
                tag: latest
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-4
              latestReadyRevisionName: rev-4
              observedGeneration: 5
              traffic:
              - percent: 75
                revisionName: rev-1
              - percent: 25
                revisionName: rev-2
              - revisionName: rev-2
                tag: next
                url: https://next---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-2
                tag: candidate
                url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
              - revisionName: rev-4
                tag: latest
                url: https://latest---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - expect_stdout: |
        Traffic: https://testservice-irvkrntpmq-uc.a.run.app
          75% rev-1
          25% rev-2 candidate, next
            https://candidate---testservice-irvkrntpmq-uc.a.run.app
            https://next---testservice-irvkrntpmq-uc.a.run.app
          0%  rev-4 latest
            https://latest---testservice-irvkrntpmq-uc.a.run.app
    - expect_exit:
        code: 0
- execute_command:
    command: run services update-traffic testservice --set-tags=candidate=rev-1,head=LATEST
    events:
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              labels:
                cloud.googleapis.com/location: us-central1
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                    image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 100
                revisionName: rev-1
              - tag: tag1
                revisionName: rev-1
              - tag: tag2
                revisionName: rev-2
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-2
              latestReadyRevisionName: rev-2
              observedGeneration: 1
              traffic:
              - percent: 100
                revisionName: rev-1
              - tag: tag1
                revisionName: rev-1
                url: https://tag1---testservice-irvkrntpmq-uc.a.run.app
              - tag: tag2
                revisionName: rev-2
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: PUT
          headers: {}
          body:
            json:
              apiVersion: serving.knative.dev/v1
              kind: Service
              metadata:
                annotations:
                  client.knative.dev/user-image: gcr.io/cloudrun/hello
                  serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                  serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                creationTimestamp: '2019-07-23T18:13:29Z'
                generation: 1
                labels:
                  cloud.googleapis.com/location: us-central1
                name: testservice
                namespace: '123456789'
                resourceVersion: '51639050'
                selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
                uid: 92610cc6-ad75-11e9-b545-42010a800168
              spec:
                template:
                  spec:
                    containers:
                    - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
                traffic:
                - percent: 100
                  revisionName: rev-1
                - revisionName: rev-1
                  tag: candidate
                - latestRevision: true
                  tag: head
              status:
                address:
                  url: https://testservice-irvkrntpmq-uc.a.run.app
                conditions:
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: ConfigurationsReady
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: Ready
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: RoutesReady
                latestCreatedRevisionName: rev-2
                latestReadyRevisionName: rev-2
                observedGeneration: 1
                traffic:
                - percent: 100
                  revisionName: rev-1
                - tag: tag1
                  revisionName: rev-1
                  url: https://tag1---testservice-irvkrntpmq-uc.a.run.app
                - tag: tag2
                  revisionName: rev-2
                  url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
                url: https://testservice-irvkrntpmq-uc.a.run.app
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 2
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639051'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 100
                revisionName: rev-1
              - revisionName: rev-1
                tag: candidate
              - latestRevision: true
                tag: head
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-2
              latestReadyRevisionName: rev-2
              observedGeneration: 1
              traffic:
              - percent: 100
                revisionName: rev-1
              - tag: tag1
                revisionName: rev-1
                url: https://tag1---testservice-irvkrntpmq-uc.a.run.app
              - tag: tag2
                revisionName: rev-2
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 2
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 100
                revisionName: rev-1
              - revisionName: rev-1
                tag: candidate
              - latestRevision: true
                tag: head
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'False'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'False'
                type: RoutesReady
              latestCreatedRevisionName: rev-2
              latestReadyRevisionName: rev-2
              observedGeneration: 2
              traffic:
              - percent: 100
                revisionName: rev-1
              - tag: tag1
                revisionName: rev-1
                url: https://tag1---testservice-irvkrntpmq-uc.a.run.app
              - tag: tag2
                revisionName: rev-2
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
        repeatable: true
    - expect_staged_progress_tracker:
        message: Updating traffic...
        status: FAILURE
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 2
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 100
                revisionName: rev-1
              - revisionName: rev-1
                tag: candidate
              - latestRevision: true
                tag: head
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'False'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'False'
                type: RoutesReady
              latestCreatedRevisionName: rev-2
              latestReadyRevisionName: rev-2
              observedGeneration: 2
              traffic:
              - percent: 100
                revisionName: rev-1
              - tag: tag1
                revisionName: rev-1
                url: https://tag1---testservice-irvkrntpmq-uc.a.run.app
              - tag: tag2
                revisionName: rev-2
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - expect_stdout: |
        Traffic: https://testservice-irvkrntpmq-uc.a.run.app
          100% rev-1                    candidate (currently tag1)
            https://tag1---testservice-irvkrntpmq-uc.a.run.app
          0%   LATEST (currently rev-2) head (currently tag2)
            https://tag2---testservice-irvkrntpmq-uc.a.run.app
    - expect_exit:
        code: 1
        message: None
- execute_command:
    command: run services update-traffic testservice --set-tags=candidate=rev-1,head=LATEST
      --to-revisions=rev-2=20
    events:
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              labels:
                cloud.googleapis.com/location: us-central1
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                    image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 100
                revisionName: rev-1
              - tag: tag1
                revisionName: rev-1
              - tag: tag2
                revisionName: rev-2
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-2
              latestReadyRevisionName: rev-2
              observedGeneration: 1
              traffic:
              - percent: 100
                revisionName: rev-1
              - tag: tag1
                revisionName: rev-1
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              - tag: tag2
                revisionName: rev-2
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: PUT
          headers: {}
          body:
            json:
              apiVersion: serving.knative.dev/v1
              kind: Service
              metadata:
                annotations:
                  client.knative.dev/user-image: gcr.io/cloudrun/hello
                  serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                  serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                creationTimestamp: '2019-07-23T18:13:29Z'
                generation: 1
                labels:
                  cloud.googleapis.com/location: us-central1
                name: testservice
                namespace: '123456789'
                resourceVersion: '51639050'
                selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
                uid: 92610cc6-ad75-11e9-b545-42010a800168
              spec:
                template:
                  spec:
                    containers:
                    - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
                traffic:
                - percent: 80
                  revisionName: rev-1
                - percent: 20
                  revisionName: rev-2
                - revisionName: rev-1
                  tag: candidate
                - latestRevision: true
                  tag: head
              status:
                address:
                  url: https://testservice-irvkrntpmq-uc.a.run.app
                conditions:
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: ConfigurationsReady
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: Ready
                - lastTransitionTime: '2019-07-23T20:10:28Z'
                  status: 'True'
                  type: RoutesReady
                latestCreatedRevisionName: rev-2
                latestReadyRevisionName: rev-2
                observedGeneration: 1
                traffic:
                - percent: 100
                  revisionName: rev-1
                - tag: tag1
                  revisionName: rev-1
                  url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
                - tag: tag2
                  revisionName: rev-2
                  url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
                url: https://testservice-irvkrntpmq-uc.a.run.app
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 2
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639051'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 80
                revisionName: rev-1
              - percent: 20
                revisionName: rev-2
              - revisionName: rev-1
                tag: candidate
              - latestRevision: true
                tag: head
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-2
              latestReadyRevisionName: rev-2
              observedGeneration: 1
              traffic:
              - percent: 100
                revisionName: rev-1
              - tag: tag1
                revisionName: rev-1
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              - tag: tag2
                revisionName: rev-2
                url: https://tag2---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 2
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 80
                revisionName: rev-1
              - percent: 20
                revisionName: rev-2
              - revisionName: rev-1
                tag: candidate
              - latestRevision: true
                tag: head
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:29Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-2
              latestReadyRevisionName: rev-2
              observedGeneration: 2
              traffic:
              - percent: 80
                revisionName: rev-1
              - percent: 20
                revisionName: rev-2
              - tag: candidate
                revisionName: rev-1
                url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
              - latestRevision: true
                tag: head
                url: https://head---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
        repeatable: true
    - expect_staged_progress_tracker:
        message: Updating traffic...
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/testservice?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/cloudrun/hello
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 2
              labels:
                cloud.googleapis.com/location: us-central1
              name: testservice
              namespace: '123456789'
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/123456789/services/testservice
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                spec:
                  containers:
                  - image: gcr.io/cloudrun/hello@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50
              traffic:
              - percent: 80
                revisionName: rev-1
              - percent: 20
                revisionName: rev-2
              - revisionName: rev-1
                tag: candidate
              - latestRevision: true
                tag: head
            status:
              address:
                url: https://testservice-irvkrntpmq-uc.a.run.app
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:28Z'
                status: 'True'
                type: RoutesReady
              latestCreatedRevisionName: rev-2
              latestReadyRevisionName: rev-2
              observedGeneration: 2
              traffic:
              - percent: 80
                revisionName: rev-1
              - percent: 20
                revisionName: rev-2
              - tag: candidate
                revisionName: rev-1
                url: https://candidate---testservice-irvkrntpmq-uc.a.run.app
              - latestRevision: true
                tag: head
                url: https://head---testservice-irvkrntpmq-uc.a.run.app
              url: https://testservice-irvkrntpmq-uc.a.run.app
    - expect_stdout: |
        Traffic: https://testservice-irvkrntpmq-uc.a.run.app
          80% rev-1                    candidate
            https://candidate---testservice-irvkrntpmq-uc.a.run.app
          20% rev-2
          0%  LATEST (currently rev-2) head
            https://head---testservice-irvkrntpmq-uc.a.run.app
    - expect_exit:
        code: 0
