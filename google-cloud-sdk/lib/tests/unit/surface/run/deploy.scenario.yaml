title: Tests that server giving new fields sends new fields, and vice versa.
release_tracks: [ALPHA, BETA]
summary:
# This summary is generated automatically on update and should not be edited.
- set_property: run/cluster do-not-delete-gke-knative-test-cluster
- set_property: run/cluster_location us-central1-a
- set_property: run/platform gke
- execute:
  - command: run deploy aacrhello --image gcr.io/knative-samples/helloworld-nodejs
      --no-traffic
  - stderr: |
      Deploying container to Cloud Run for Anthos service [aacrhello] in namespace [default] of cluster [do-not-delete-gke-knative-test-cluster]
  - staged_progress_tracker:
    - message: Deploying...
    - status: SUCCESS
  - stderr: |
      Service [aacrhello] revision [$$service-revision-name-3$$] has been deployed and is serving 0 percent of traffic.
actions:
- set_property:
    # container/use_client_certificate: true
    # auth/disable_ssl_validation: true
    run/region: us-central1
    run/platform: managed
- execute_command:
    command: run services update asdf --update-env-vars=FOO=bar --revision-suffix=a --tag=cool
    events:
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/asdf?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '2928'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              name: asdf
              namespace: '462803083913'
              selfLink: /apis/serving.knative.dev/v1/namespaces/462803083913/services/asdf
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 1
              labels:
                cloud.googleapis.com/location: us-central1
              annotations:
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                autoscaling.knative.dev/maxScale: '1000'
              creationTimestamp: '2019-07-23T18:13:29Z'
            spec:
              template:
                metadata:
                  name: asdf-a
                  annotations:
                    run.googleapis.com/client-name: gcloud
                    client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                spec:
                  containerConcurrency: 80
                  timeoutSeconds: 900
                  containers:
                  - image: gcr.io/knative-samples/helloworld-nodejs
                    resources:
                      limits:
                        memory: 256M
                        cpu: 1000m
                    ports:
                    - containerPort: 8080
              traffic:
              - percent: 100
                latestRevision: true
            status:
              observedGeneration: 1
              conditions:
              - type: Ready
                status: 'True'
                lastTransitionTime: '2019-11-13T21:55:23.804Z'
              - type: ConfigurationsReady
                status: 'True'
                lastTransitionTime: '2019-11-13T21:55:23.632Z'
              - type: RoutesReady
                status: 'True'
                lastTransitionTime: '2019-11-13T21:55:23.804Z'
              latestReadyRevisionName: asdf-asdf
              latestCreatedRevisionName: asdf-asdf
              traffic:
              - revisionName: asdf-asdf
                percent: 100
                latestRevision: true
              url: https://asdf-ixwc4imo7a-uc.a.run.app
              address:
                url: https://asdf-ixwc4imo7a-uc.a.run.app
    - api_call:
        repeatable: true
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/462803083913/revisions/asdf-a?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '3056'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Revision
            metadata:
              name: asdf-asdf
              namespace: '462803083913'
              selfLink: /apis/serving.knative.dev/v1/namespaces/462803083913/revisions/service-name-20191113-215503-bjma-00001-vaz
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 1
              labels:
                serving.knative.dev/route: asdf
                serving.knative.dev/configuration: asdf
                serving.knative.dev/configurationGeneration: '1'
                serving.knative.dev/service: asdf
                cloud.googleapis.com/location: us-central1
              annotations:
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
              ownerReferences:
              - apiVersion: serving.knative.dev/v1
                kind: Configuration
                name: asdf
                uid: 92610cc6-ad75-11e9-b545-42010a800168
                controller: true
                blockOwnerDeletion: true
              creationTimestamp: '2019-07-23T18:13:29Z'
            spec:
              containerConcurrency: 80
              timeoutSeconds: 900
              containers:
              - image: gcr.io/knative-samples/helloworld-nodejs
                resources:
                  limits:
                    memory: 256M
                    cpu: 1000m
                ports:
                - containerPort: 8080
            status:
              observedGeneration: 1
              conditions:
              - type: Ready
                status: 'True'
                lastTransitionTime: '2019-11-13T21:55:23.493Z'
              - type: Active
                status: 'True'
                severity: Info
                lastTransitionTime: '2019-11-13T21:55:13.506Z'
              - type: ContainerHealthy
                status: 'True'
                lastTransitionTime: '2019-11-13T21:55:23.493Z'
              - type: ResourcesAvailable
                status: 'True'
                lastTransitionTime: '2019-11-13T21:55:13.304Z'
              logUrl: https://console.cloud.google.com/logs/viewer?project=fake-project&resource=cloud_run_revision/service_name/asdf/revision_name/service-name-20191113-215503-bjma-00001-vaz&advancedFilter=resource.type%3D%22cloud_run_revision%22%0Aresource.labels.service_name%3D%22asdf%22%0Aresource.labels.revision_name%3D%22service-name-20191113-215503-bjma-00001-vaz%22
              imageDigest: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
    - api_call:
        repeatable: true
        optional: true
        expect_request:
          uri:
            matches: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/revisions/.*
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '3407'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Revision
            metadata:
              name: asdf-asdf
              namespace: fake-project
              selfLink: /apis/serving.knative.dev/v1/namespaces/fake-project/revisions/service-name-20191113-215415-xzvx-00001-yaw
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 1
              creationTimestamp: '2019-07-23T18:13:29Z'
              labels:
                serving.knative.dev/route: asdf
                serving.knative.dev/configuration: asdf
                client.knative.dev/nonce: dmwqrjmbba
                serving.knative.dev/configurationGeneration: '1'
                serving.knative.dev/service: asdf
                cloud.googleapis.com/location: us-central1
              annotations:
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
              ownerReferences:
              - kind: Configuration
                name: asdf
                uid: 92610cc6-ad75-11e9-b545-42010a800168
                apiVersion: serving.knative.dev/v1
                controller: true
                blockOwnerDeletion: true
            spec:
              container:
                image: gcr.io/knative-samples/helloworld-nodejs
              servingState: ACTIVE
            status:
              logUrl: https://console.cloud.google.com/logs/viewer?project=fake-project&resource=cloud_run_revision/service_name/asdf/revision_name/service-name-20191113-215415-xzvx-00001-yaw&advancedFilter=resource.type%3D%22cloud_run_revision%22%0Aresource.labels.service_name%3D%22asdf%22%0Aresource.labels.revision_name%3D%22service-name-20191113-215415-xzvx-00001-yaw%22
              conditions:
              - type: Ready
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:06Z'
              - type: ResourcesAvailable
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:06Z'
              - type: ContainerHealthy
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:06Z'
              - type: Active
                status: 'True'
                lastTransitionTime: '2019-07-23T20:10:06Z'
              observedGeneration: 1
              imageDigest: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/asdf?alt=json
          method: PUT
          headers: {}
          body:
            json:
              apiVersion: serving.knative.dev/v1
              kind: Service
              metadata:
                annotations:
                  client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                generation: 1
                labels:
                  cloud.googleapis.com/location: us-central1
                name: asdf
                namespace: '462803083913'
                selfLink: /apis/serving.knative.dev/v1/namespaces/462803083913/services/asdf
              spec: {}
              status:
                observedGeneration: 1
        return_response:
          headers:
            cache-control: private
            content-length: '3276'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              name: asdf
              namespace: '462803083913'
              selfLink: /apis/serving.knative.dev/v1/namespaces/462803083913/services/asdf
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 2
              labels:
                cloud.googleapis.com/location: us-central1
              annotations:
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                autoscaling.knative.dev/maxScale: '1000'
              creationTimestamp: '2019-07-23T18:13:29Z'
            spec:
              template:
                metadata:
                  name: asdf-a
                  annotations:
                    run.googleapis.com/client-name: gcloud
                    client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                    run.googleapis.com/cloudsql-instances: fake-project:us-central1:foo,fake-project:us-central1:bar
                spec:
                  containerConcurrency: 3
                  timeoutSeconds: 900
                  containers:
                  - image: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
                    env:
                    - name: FOO
                      value: bar
                    resources:
                      limits:
                        cpu: 1000m
                        memory: 512Mi
                    ports:
                    - containerPort: 8080
              traffic:
              - percent: 100
                latestRevision: true
              - revisionName: asdf-a
                tag: cool
            status:
              observedGeneration: 1
              conditions:
              - type: Ready
                status: 'True'
                lastTransitionTime: '2019-11-13T21:55:23.804Z'
              - type: ConfigurationsReady
                status: 'True'
                lastTransitionTime: '2019-11-13T21:55:23.632Z'
              - type: RoutesReady
                status: 'True'
                lastTransitionTime: '2019-11-13T21:55:23.804Z'
              latestReadyRevisionName: asdf-a
              latestCreatedRevisionName: asdf-a
              traffic:
              - revisionName: asdf-a
                percent: 100
                latestRevision: true
              url: https://asdf-ixwc4imo7a-uc.a.run.app
              address:
                url: https://asdf-ixwc4imo7a-uc.a.run.app
    - api_call:
        repeatable: true
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/asdf?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '3244'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              name: asdf
              namespace: '462803083913'
              selfLink: /apis/serving.knative.dev/v1/namespaces/462803083913/services/asdf
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 2
              labels:
                cloud.googleapis.com/location: us-central1
              annotations:
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                autoscaling.knative.dev/maxScale: '1000'
              creationTimestamp: '2019-07-23T18:13:29Z'
            spec:
              template:
                metadata:
                  name: asdf-a
                  annotations:
                    run.googleapis.com/client-name: gcloud
                    client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                    run.googleapis.com/cloudsql-instances: fake-project:us-central1:foo,fake-project:us-central1:bar
                spec:
                  containerConcurrency: 3
                  timeoutSeconds: 900
                  containers:
                  - image: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
                    env:
                    - name: FOO
                      value: bar
                    resources:
                      limits:
                        cpu: 1000m
                        memory: 512Mi
                    ports:
                    - containerPort: 8080
              traffic:
              - percent: 100
                latestRevision: true
            status:
              observedGeneration: 2
              conditions:
              - type: Ready
                status: 'True'
                lastTransitionTime: '2019-11-13T21:55:46.560Z'
              - type: ConfigurationsReady
                status: 'True'
                lastTransitionTime: '2019-11-13T21:55:36.478Z'
              - type: RoutesReady
                status: 'True'
                lastTransitionTime: '2019-11-13T21:55:47.460Z'
              latestReadyRevisionName: asdf-00002-zag
              latestCreatedRevisionName: asdf-00002-zag
              traffic:
              - revisionName: asdf-a
                percent: 100
              - revisionName: asdf-a
                tag: cool
                url: https://cool-asdf-ixwc4imo7a-uc.a.run.app
              url: https://asdf-ixwc4imo7a-uc.a.run.app
              address:
                url: https://asdf-ixwc4imo7a-uc.a.run.app
    - expect_staged_progress_tracker:
        message: Deploying...
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://us-central1-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/fake-project/services/asdf?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '3244'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              name: asdf
              namespace: '462803083913'
              selfLink: /apis/serving.knative.dev/v1/namespaces/462803083913/services/asdf
              uid: 92610cc6-ad75-11e9-b545-42010a800168
              resourceVersion: '51639050'
              generation: 2
              labels:
                cloud.googleapis.com/location: us-central1
              annotations:
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                autoscaling.knative.dev/maxScale: '1000'
              creationTimestamp: '2019-07-23T18:13:29Z'
            spec:
              template:
                metadata:
                  name: asdf-a
                  annotations:
                    run.googleapis.com/client-name: gcloud
                    client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                    run.googleapis.com/cloudsql-instances: fake-project:us-central1:foo,fake-project:us-central1:bar
                spec:
                  containerConcurrency: 3
                  timeoutSeconds: 900
                  containers:
                  - image: gcr.io/knative-samples/helloworld-nodejs@sha256:ae8c741379bbe004df62c1f29bbfd9bc92c84060a6d4af409d220e54f29959f6
                    env:
                    - name: FOO
                      value: bar
                    resources:
                      limits:
                        cpu: 1000m
                        memory: 512Mi
                    ports:
                    - containerPort: 8080
              traffic:
              - percent: 100
                latestRevision: true
            status:
              observedGeneration: 2
              conditions:
              - type: Ready
                status: 'True'
                lastTransitionTime: '2019-11-13T21:55:46.560Z'
              - type: ConfigurationsReady
                status: 'True'
                lastTransitionTime: '2019-11-13T21:55:36.478Z'
              - type: RoutesReady
                status: 'True'
                lastTransitionTime: '2019-11-13T21:55:47.460Z'
              latestReadyRevisionName: asdf-a
              latestCreatedRevisionName: asdf-a
              traffic:
              - latestRevision: true
                percent: 100
              - revisionName: asdf-a
                tag: cool
                url: https://cool-asdf-ixwc4imo7a-uc.a.run.app
              url: https://asdf-ixwc4imo7a-uc.a.run.app
              address:
                url: https://asdf-ixwc4imo7a-uc.a.run.app
        expect_response:
          extract_references:
          - field: status.latestCreatedRevisionName
            reference: service-revision-name-2
          body:
            json: {}
    - expect_stderr: |
        Service [asdf] revision [asdf-a] has been deployed and is serving 100 percent of traffic.
        Service URL: https://asdf-ixwc4imo7a-uc.a.run.app
        The revision can be reached directly at https://cool-asdf-ixwc4imo7a-uc.a.run.app
    - expect_exit:
        code: 0

- set_property:
    # container/use_client_certificate: true
    # auth/disable_ssl_validation: true
    run/cluster: do-not-delete-gke-knative-test-cluster
    run/cluster_location: us-central1-a
    run/platform: gke

- execute_command:
    command: run deploy aacrhello --image gcr.io/knative-samples/helloworld-nodejs
      --no-traffic --service-account test-service-account
    events:
    - api_call:
        expect_request:
          uri: https://container.googleapis.com/v1/projects/fake-project/locations/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            cache-control: private
            content-length: '8431'
            content-type: application/json; charset=UTF-8
            status: '200'
          body:
            name: do-not-delete-gke-knative-test-cluster
            nodeConfig:
              machineType: n1-standard-2
              diskSizeGb: 100
              oauthScopes:
              - https://www.googleapis.com/auth/cloud-platform
              - https://www.googleapis.com/auth/logging.write
              - https://www.googleapis.com/auth/monitoring.write
              - https://www.googleapis.com/auth/pubsub
              imageType: COS
              serviceAccount: default
              diskType: pd-standard
            masterAuth:
              username: admin
              password: password
              clusterCaCertificate: ==
              clientCertificate: ==
              clientKey: ==
            loggingService: logging.googleapis.com/kubernetes
            monitoringService: monitoring.googleapis.com/kubernetes
            network: default
            clusterIpv4Cidr: 10.64.0.0/14
            addonsConfig:
              httpLoadBalancing:
                disabled: true
              horizontalPodAutoscaling:
                disabled: true
              kubernetesDashboard:
                disabled: true
              networkPolicyConfig:
                disabled: true
            nodePools:
            - name: default-pool
              config:
                machineType: n1-standard-2
                diskSizeGb: 100
                oauthScopes:
                - https://www.googleapis.com/auth/cloud-platform
                - https://www.googleapis.com/auth/logging.write
                - https://www.googleapis.com/auth/monitoring.write
                - https://www.googleapis.com/auth/pubsub
                imageType: COS
                serviceAccount: default
                diskType: pd-standard
              initialNodeCount: 3
              autoscaling:
                enabled: true
                minNodeCount: 1
                maxNodeCount: 10
              management:
                autoRepair: true
              podIpv4CidrSize: 24
              selfLink: https://container.googleapis.com/v1/projects/fake-project/zones/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster/nodePools/default-pool
              version: 1.11.7-gke.12
              instanceGroupUrls:
              - https://www.googleapis.com/compute/v1/projects/fake-project/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-gke-kn-default-pool-2c29644d-grp
              status: RUNNING
            locations:
            - us-central1-a
            labelFingerprint: a9dc16a7
            legacyAbac: {}
            networkConfig:
              network: projects/fake-project/global/networks/default
            defaultMaxPodsConstraint:
              maxPodsPerNode: '110'
            selfLink: https://container.googleapis.com/v1/projects/fake-project/zones/us-central1-a/clusters/do-not-delete-gke-knative-test-cluster
            zone: us-central1-a
            endpoint: 35.239.121.203
            initialClusterVersion: 1.11.6-gke.6
            currentMasterVersion: 1.12.7-gke.25
            currentNodeVersion: 1.11.7-gke.12
            createTime: '2019-02-10T22:30:24+00:00'
            status: RUNNING
            nodeIpv4CidrSize: 24
            servicesIpv4Cidr: 10.67.240.0/20
            instanceGroupUrls:
            - https://www.googleapis.com/compute/v1/projects/fake-project/zones/us-central1-a/instanceGroupManagers/gke-do-not-delete-gke-kn-default-pool-2c29644d-grp
            currentNodeCount: 4
            location: us-central1-a
    - api_call:
        expect_request:
          uri:
            matches: https://.*/apis/serving.knative.dev/v1/namespaces/default/services/aacrhello\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-length: '1860'
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 2
              name: aacrhello
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/default/services/aacrhello
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                metadata:
                  annotations:
                    run.googleapis.com/client-name: gcloud
                  creationTimestamp: '2019-07-23T18:13:29Z'
                  labels:
                    client.knative.dev/nonce: dmwqrjmbba
                spec:
                  containers:
                  - image: gcr.io/knative-samples/helloworld-nodejs
                    name: ''
                    resources:
                      requests:
                        cpu: 400m
                    timeoutSeconds: 300
              traffic:
              - latestRevision: false
                percent: 10
                revisionName: aacrhello-rev02
              - latestRevision: false
                percent: 90
                revisionName: aacrhello-rev01
            status:
              address:
                hostname: aacrhello.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:04Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:04Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:04Z'
                status: 'True'
                type: RoutesReady
              url: aacrhello.default.example.com
              domainInternal: aacrhello.default.svc.cluster.local
              latestCreatedRevisionName: aacrhello-rev02
              latestReadyRevisionName: aacrhello-rev02
              observedGeneration: 2
              traffic:
              - latestRevision: true
                percent: 10
                revisionName: aacrhello-rev02
              - latestRevision: false
                percent: 90
                revisionName: aacrhello-rev01

    - expect_stderr: |
        Deploying container to Cloud Run for Anthos service [aacrhello] in namespace [default] of cluster [do-not-delete-gke-knative-test-cluster]
    - api_call:
        expect_request:
          uri:
            matches: https://.*/apis/serving.knative.dev/v1/namespaces/default/services/aacrhello\?alt=json
          method: PUT
          headers: {}
          body:
            json:
              apiVersion: serving.knative.dev/v1
              kind: Service
              metadata:
                annotations:
                  client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                generation: 2
                name: aacrhello
                namespace: default
              spec:
                template:
                  metadata:
                    creationTimestamp: '2019-07-23T18:13:29Z'
                  spec:
                    containers:
                    - image: gcr.io/knative-samples/helloworld-nodejs
                      name: ''
                      resources:
                        requests:
                          cpu: 400m
                      timeoutSeconds: 300
                    serviceAccountName: test-service-account
                traffic:
                - percent: 10
                  revisionName: aacrhello-rev02
                - percent: 90
                  revisionName: aacrhello-rev01
              status:
                address:
                  hostname: aacrhello.default.svc.cluster.local
                conditions:
                - status: 'True'
                  type: ConfigurationsReady
                - status: 'True'
                  type: Ready
                - status: 'True'
                  type: RoutesReady
                url: aacrhello.default.example.com
                domainInternal: aacrhello.default.svc.cluster.local
                observedGeneration: 2
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 3
              labels:
                serving.knative.dev/visibility: cluster-local
              name: aacrhello
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/default/services/aacrhello
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                metadata:
                  annotations:
                    run.googleapis.com/client-name: gcloud
                  creationTimestamp: '2019-07-23T18:13:29Z'
                  labels:
                    client.knative.dev/nonce: dmwqrjmbba
                spec:
                  containers:
                  - image: gcr.io/knative-samples/helloworld-nodejs
                    name: ''
                    resources:
                      requests:
                        cpu: 400m
                    timeoutSeconds: 300
              traffic:
              - latestRevision: true
                percent: 10
                revisionName: aacrhello-rev02
              - latestRevision: false
                percent: 90
                revisionName: aacrhello-rev01
            status:
              address:
                hostname: aacrhello.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:07Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:07Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:07Z'
                status: 'True'
                type: RoutesReady
              url: aacrhello.default.example.com
              domainInternal: aacrhello.default.svc.cluster.local
              latestCreatedRevisionName: aacrhello-rev02
              latestReadyRevisionName: aacrhello-rev02
              observedGeneration: 2
              traffic:
              - latestRevision: true
                percent: 10
                revisionName: aacrhello-rev02
              - latestRevision: false
                percent: 90
                revisionName: aacrhello-rev01
    - api_call:
        repeatable: true
        expect_request:
          uri:
            matches: https://.*/apis/serving.knative.dev/v1/namespaces/default/services/aacrhello\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 3
              labels:
                serving.knative.dev/visibility: cluster-local
              name: aacrhello
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/default/services/aacrhello
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                metadata:
                  annotations:
                    run.googleapis.com/client-name: gcloud
                  creationTimestamp: '2019-07-23T18:13:29Z'
                  labels:
                    client.knative.dev/nonce: dmwqrjmbba
                spec:
                  containers:
                  - image: gcr.io/knative-samples/helloworld-nodejs
                    name: ''
                    resources:
                      requests:
                        cpu: 400m
                    timeoutSeconds: 300
              traffic:
              - latestRevision: false
                percent: 90
                revisionName: aacrhello-rev01
              - percent: 10
                revisionName: aacrhello-rev02
            status:
              address:
                hostname: aacrhello.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:08Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:08Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:08Z'
                status: 'True'
                type: RoutesReady
              url: aacrhello.default.svc.cluster.local
              domainInternal: aacrhello.default.svc.cluster.local
              latestCreatedRevisionName: aacrhello-rev03
              latestReadyRevisionName: aacrhello-rev03
              observedGeneration: 3
              traffic:
              - latestRevision: false
                percent: 90
                revisionName: aacrhello-rev01
              - percent: 10
                revisionName: aacrhello-rev02
    - expect_staged_progress_tracker:
        message: Deploying...
        status: SUCCESS
    - api_call:
        repeatable: true
        expect_request:
          uri:
            matches: https://.*/apis/serving.knative.dev/v1/namespaces/default/services/aacrhello\?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            audit-id: b24852a0-bebf-412f-8432-e7b98289ffbf
            content-type: application/json
            status: '200'
          body:
            apiVersion: serving.knative.dev/v1
            kind: Service
            metadata:
              annotations:
                client.knative.dev/user-image: gcr.io/knative-samples/helloworld-nodejs
                run.googleapis.com/client-name: gcloud
                serving.knative.dev/creator: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
                serving.knative.dev/lastModifier: 462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              creationTimestamp: '2019-07-23T18:13:29Z'
              generation: 3
              labels:
                serving.knative.dev/visibility: cluster-local
              name: aacrhello
              namespace: default
              resourceVersion: '51639050'
              selfLink: /apis/serving.knative.dev/v1/namespaces/default/services/aacrhello
              uid: 92610cc6-ad75-11e9-b545-42010a800168
            spec:
              template:
                metadata:
                  annotations:
                    run.googleapis.com/client-name: gcloud
                  creationTimestamp: '2019-07-23T18:13:29Z'
                  labels:
                    client.knative.dev/nonce: dmwqrjmbba
                spec:
                  containers:
                  - image: gcr.io/knative-samples/helloworld-nodejs
                    name: ''
                    resources:
                      requests:
                        cpu: 400m
                    timeoutSeconds: 300
              traffic:
              - latestRevision: false
                percent: 90
                revisionName: aacrhello-rev01
              - percent: 10
                revisionName: aacrhello-rev02
            status:
              address:
                hostname: aacrhello.default.svc.cluster.local
              conditions:
              - lastTransitionTime: '2019-07-23T20:10:08Z'
                status: 'True'
                type: ConfigurationsReady
              - lastTransitionTime: '2019-07-23T20:10:08Z'
                status: 'True'
                type: Ready
              - lastTransitionTime: '2019-07-23T20:10:08Z'
                status: 'True'
                type: RoutesReady
              url: aacrhello.default.svc.cluster.local
              domainInternal: aacrhello.default.svc.cluster.local
              latestCreatedRevisionName: aacrhello-rev03
              latestReadyRevisionName: aacrhello-rev03
              observedGeneration: 3
              traffic:
              - latestRevision: false
                percent: 90
                revisionName: aacrhello-rev01
              - percent: 10
                revisionName: aacrhello-rev02
        expect_response:
          extract_references:
          - field: status.latestCreatedRevisionName
            reference: service-revision-name-3
          body:
            json: {}
    - expect_stderr: |
        Service [aacrhello] revision [$$service-revision-name-3$$] has been deployed and is serving 0 percent of traffic.


    - expect_exit:
        code: 0
