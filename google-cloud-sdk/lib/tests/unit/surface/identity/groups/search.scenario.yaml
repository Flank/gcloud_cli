title: cloud identity groups search groups test scenario
release_tracks: [ALPHA]
summary:
# This summary is generated automatically on update and should not be edited.
- execute:
  - command: |
      identity groups search --organization 433637338589
          --label "system/groups/discussion_forum"
          --page-size 2
  - stdout: |
      ---
      groups:
      - displayName: GCloud group 1
        groupKey:
          id: gcloud1@novitas.name
        name: groups/02grqrue0wqlxw
      - groupKey:
          id: gcloud2@novitas.name
        name: groups/02grqrueerx8r74z
      nextPageToken: CmUKOPfHJQbt_____2dnZ18wMDAwMDA1MZWZiAP8B__5KsuCHc5AAAAABLtEFYXtlF0QA2CzzeT9BQ==
- execute:
  - command: |
      identity groups search --organization 433637338589
          --label "system/groups/discussion_forum"
          --page-size 2
          --page-token "CmUKOPfHJQbt_____2dnZ18wMDAwMDA1MZWZiAP8B__5KsuCHc5AAAAABLtEFYXtlF0QA2CzzeT9BQ=="
  - stdout: |
      ---
      groups:
      - displayName: GCloud group 3
        groupKey:
          id: gcloud3@novitas.name
        name: groups/02grqruefghwqlxw
      - groupKey:
          id: gcloud4@novitas.name
        name: groups/02grsdfgerx8r74z
      nextPageToken: 2bUKOPfHJQbt_____2dnZDA1MZWZiAdfghP8B__5KsuCHc5AAAAABLtEFYXtlF0QA2CzzeT9BQ==
- execute:
  - command: |
      identity groups search --organization 433637338589
          --label "system/groups/discussion_forum"
          --page-size 2
          --view FULL
          --page-token "CmUKOPfHJQbt_____2dnZ18wMDAwMDA1MZWZiAP8B__5KsuCHc5AAAAABLtEFYXtlF0QA2CzzeT9BQ=="
  - stdout: |
      ---
      groups:
      - description: First GCloud group
        displayName: GCloud group 1
        groupKey:
          id: gcloud1@novitas.name
        labels:
          system/groups/discussion_forum: ''
        name: groups/02grqrue0wqlxw
      - description: Second GCloud group
        groupKey:
          id: gcloud2@novitas.name
        labels:
          system/groups/discussion_forum: ''
        name: groups/02grqrueerx8r74z
      nextPageToken: CmUKOPfHJQbt_____2dnZ18wMDAwMDA1MZWZiAP8B__5KsuCHc5AAAAABLtEFYXtlF0QA2CzzeT9BQ==
- execute:
  - command: |
      identity groups search --organization 433637338589
          --label "system/groups/invalid_label"
  - error: |-
      1: INVALID_ARGUMENT
      - '@type': type.googleapis.com/google.rpc.DebugInfo
        detail: '[ORIGINAL ERROR] generic::invalid_argument: com.google.apps.framework.request.BadRequestException'
- execute:
  - command: |
      identity groups search --organization 433637338589
          --label "system/groups/invalid_label"
          --page-token "CmUKOPfHJQbt_____2dnZ18wMDAwMDA1MZWZiAP8B__5KsuCHc5AAAAABLtEFYXtlF0QA2CzzeT9BQ=="
  - error: |-
      1: INVALID_ARGUMENT
      - '@type': type.googleapis.com/google.rpc.DebugInfo
        detail: '[ORIGINAL ERROR] generic::invalid_argument: com.google.apps.framework.request.BadRequestException:
          Invalid page token'
actions:
- execute_command:     # Test 1: Search all groups.
    command: |
      identity groups search --organization 433637338589
          --label "system/groups/discussion_forum"
          --page-size 2
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/433637338589?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "displayName": "google.com",
              "owner": {
                "directoryCustomerId": "C02h8e9nw"
              },
              "creationTime": "2015-09-09T19:34:18.591Z",
              "lifecycleState": "ACTIVE",
              "name": "organizations/433637338589"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups:search?alt=json&pageSize=2&query=parent%3D%3D%22customerId%2FC02h8e9nw%22+%26%26+%22system%2Fgroups%2Fdiscussion_forum%22+in+labels&view=BASIC
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "groups": [
                {
                  "displayName": "GCloud group 1",
                  "groupKey": {
                    "id": "gcloud1@novitas.name"
                  },
                  "name": "groups/02grqrue0wqlxw"
                },
                {
                  "groupKey": {
                    "id": "gcloud2@novitas.name"
                  },
                  "name": "groups/02grqrueerx8r74z"
                }
              ],
              "nextPageToken": "CmUKOPfHJQbt_____2dnZ18wMDAwMDA1MZWZiAP8B__5KsuCHc5AAAAABLtEFYXtlF0QA2CzzeT9BQ=="
            }
    - expect_stdout: |
        ---
        groups:
        - displayName: GCloud group 1
          groupKey:
            id: gcloud1@novitas.name
          name: groups/02grqrue0wqlxw
        - groupKey:
            id: gcloud2@novitas.name
          name: groups/02grqrueerx8r74z
        nextPageToken: CmUKOPfHJQbt_____2dnZ18wMDAwMDA1MZWZiAP8B__5KsuCHc5AAAAABLtEFYXtlF0QA2CzzeT9BQ==
    - expect_exit:
        code: 0

- execute_command:     # Test 2: Search next page of groups.
    command: |
      identity groups search --organization 433637338589
          --label "system/groups/discussion_forum"
          --page-size 2
          --page-token "CmUKOPfHJQbt_____2dnZ18wMDAwMDA1MZWZiAP8B__5KsuCHc5AAAAABLtEFYXtlF0QA2CzzeT9BQ=="
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/433637338589?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "displayName": "google.com",
              "owner": {
                "directoryCustomerId": "C02h8e9nw"
              },
              "creationTime": "2015-09-09T19:34:18.591Z",
              "lifecycleState": "ACTIVE",
              "name": "organizations/433637338589"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups:search?alt=json&pageSize=2&pageToken=CmUKOPfHJQbt_____2dnZ18wMDAwMDA1MZWZiAP8B__5KsuCHc5AAAAABLtEFYXtlF0QA2CzzeT9BQ%3D%3D&query=parent%3D%3D%22customerId%2FC02h8e9nw%22+%26%26+%22system%2Fgroups%2Fdiscussion_forum%22+in+labels&view=BASIC
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "groups": [
                {
                  "displayName": "GCloud group 3",
                  "groupKey": {
                    "id": "gcloud3@novitas.name"
                  },
                  "name": "groups/02grqruefghwqlxw"
                },
                {
                  "groupKey": {
                    "id": "gcloud4@novitas.name"
                  },
                  "name": "groups/02grsdfgerx8r74z"
                }
              ],
              "nextPageToken": "2bUKOPfHJQbt_____2dnZDA1MZWZiAdfghP8B__5KsuCHc5AAAAABLtEFYXtlF0QA2CzzeT9BQ=="
            }
    - expect_stdout: |
        ---
        groups:
        - displayName: GCloud group 3
          groupKey:
            id: gcloud3@novitas.name
          name: groups/02grqruefghwqlxw
        - groupKey:
            id: gcloud4@novitas.name
          name: groups/02grsdfgerx8r74z
        nextPageToken: 2bUKOPfHJQbt_____2dnZDA1MZWZiAdfghP8B__5KsuCHc5AAAAABLtEFYXtlF0QA2CzzeT9BQ==
    - expect_exit:
        code: 0

- execute_command:     # Test 3: Search all groups with FULL view.
    command: |
      identity groups search --organization 433637338589
          --label "system/groups/discussion_forum"
          --page-size 2
          --view FULL
          --page-token "CmUKOPfHJQbt_____2dnZ18wMDAwMDA1MZWZiAP8B__5KsuCHc5AAAAABLtEFYXtlF0QA2CzzeT9BQ=="
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/433637338589?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "displayName": "google.com",
              "owner": {
                "directoryCustomerId": "C02h8e9nw"
              },
              "creationTime": "2015-09-09T19:34:18.591Z",
              "lifecycleState": "ACTIVE",
              "name": "organizations/433637338589"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups:search?alt=json&pageSize=2&pageToken=CmUKOPfHJQbt_____2dnZ18wMDAwMDA1MZWZiAP8B__5KsuCHc5AAAAABLtEFYXtlF0QA2CzzeT9BQ%3D%3D&query=parent%3D%3D%22customerId%2FC02h8e9nw%22+%26%26+%22system%2Fgroups%2Fdiscussion_forum%22+in+labels&view=FULL
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "groups": [
                {
                  "description": "First GCloud group",
                  "displayName": "GCloud group 1",
                  "groupKey": {
                    "id": "gcloud1@novitas.name"
                  },
                  "labels": {
                    "system/groups/discussion_forum": ""
                  },
                  "name": "groups/02grqrue0wqlxw"
                },
                {
                  "description": "Second GCloud group",
                  "groupKey": {
                    "id": "gcloud2@novitas.name"
                  },
                  "labels": {
                    "system/groups/discussion_forum": ""
                  },
                  "name": "groups/02grqrueerx8r74z"
                }
              ],
              "nextPageToken": "CmUKOPfHJQbt_____2dnZ18wMDAwMDA1MZWZiAP8B__5KsuCHc5AAAAABLtEFYXtlF0QA2CzzeT9BQ=="
            }
    - expect_stdout: |
        ---
        groups:
        - description: First GCloud group
          displayName: GCloud group 1
          groupKey:
            id: gcloud1@novitas.name
          labels:
            system/groups/discussion_forum: ''
          name: groups/02grqrue0wqlxw
        - description: Second GCloud group
          groupKey:
            id: gcloud2@novitas.name
          labels:
            system/groups/discussion_forum: ''
          name: groups/02grqrueerx8r74z
        nextPageToken: CmUKOPfHJQbt_____2dnZ18wMDAwMDA1MZWZiAP8B__5KsuCHc5AAAAABLtEFYXtlF0QA2CzzeT9BQ==
    - expect_exit:
        code: 0

- execute_command:     # Test 4: Search groups with invalid label throws BadRequestException.
    command: |
      identity groups search --organization 433637338589
          --label "system/groups/invalid_label"
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/433637338589?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "displayName": "google.com",
              "owner": {
                "directoryCustomerId": "C02h8e9nw"
              },
              "creationTime": "2015-09-09T19:34:18.591Z",
              "lifecycleState": "ACTIVE",
              "name": "organizations/433637338589"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups:search?alt=json&query=parent%3D%3D%22customerId%2FC02h8e9nw%22+%26%26+%22system%2Fgroups%2Finvalid_label%22+in+labels&view=BASIC
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '404'
          body: {error: {code: 404, status: INVALID_ARGUMENT, details: [{'@type': type.googleapis.com/google.rpc.DebugInfo,
                  detail: '[ORIGINAL ERROR] generic::invalid_argument: com.google.apps.framework.request.BadRequestException'}]}}
    - expect_exit:
        code: 1
        message: |-
          INVALID_ARGUMENT
          - '@type': type.googleapis.com/google.rpc.DebugInfo
            detail: '[ORIGINAL ERROR] generic::invalid_argument: com.google.apps.framework.request.BadRequestException'

- execute_command:     # Test 5: Search groups with invalid page-token throws BadRequestException.
    command: |
      identity groups search --organization 433637338589
          --label "system/groups/invalid_label"
          --page-token "CmUKOPfHJQbt_____2dnZ18wMDAwMDA1MZWZiAP8B__5KsuCHc5AAAAABLtEFYXtlF0QA2CzzeT9BQ=="
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/433637338589?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "displayName": "google.com",
              "owner": {
                "directoryCustomerId": "C02h8e9nw"
              },
              "creationTime": "2015-09-09T19:34:18.591Z",
              "lifecycleState": "ACTIVE",
              "name": "organizations/433637338589"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups:search?alt=json&pageToken=CmUKOPfHJQbt_____2dnZ18wMDAwMDA1MZWZiAP8B__5KsuCHc5AAAAABLtEFYXtlF0QA2CzzeT9BQ%3D%3D&query=parent%3D%3D%22customerId%2FC02h8e9nw%22+%26%26+%22system%2Fgroups%2Finvalid_label%22+in+labels&view=BASIC
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '404'
          body: {error: {code: 404, status: INVALID_ARGUMENT, details: [{'@type': type.googleapis.com/google.rpc.DebugInfo,
                  detail: '[ORIGINAL ERROR] generic::invalid_argument: com.google.apps.framework.request.BadRequestException:
                    Invalid page token'}]}}
    - expect_exit:
        code: 1
        message: |-
          INVALID_ARGUMENT
          - '@type': type.googleapis.com/google.rpc.DebugInfo
            detail: '[ORIGINAL ERROR] generic::invalid_argument: com.google.apps.framework.request.BadRequestException:
              Invalid page token'
