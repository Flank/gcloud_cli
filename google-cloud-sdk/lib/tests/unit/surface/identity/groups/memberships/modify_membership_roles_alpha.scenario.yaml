# Copyright 2020 Google LLC. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
title: cloud identity groups memberships modify membership roles test scenario
release_tracks: [ALPHA]
summary:
# This summary is generated by http://go/gcloud-scenario-tests on update and should not be edited.
- execute:
  - label: (Add Membership Role) Modify membership roles in a group for a specified
      group email and member email.
  - command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email user@foo.com --add-roles OWNER
  - stdout: |
      membership:
        name: groups/11zu0gzc3tkdgn2/memberships/110293416452252446513
        roles:
        - name: OWNER
- execute:
  - label: (Add Multiple Membership Roles) Modify membership roles in a group for
      a specified group email and member email.
  - command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email user@foo.com --add-roles OWNER,MANAGER
  - stdout: |
      membership:
        name: groups/11zu0gzc3tkdgn2/memberships/110293416452252446513
        roles:
        - name: MANAGER
        - name: OWNER
- execute:
  - label: (Remove Membership Role) Modify membership roles in a group for a specified
      group email and member email.
  - command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email user@foo.com --remove-roles OWNER
  - stdout: |
      membership:
        name: groups/11zu0gzc3tkdgn2/memberships/110293416452252446513
        roles:
        - name: MANAGER
- execute:
  - label: (Remove Multiple Membership Roles) Modify membership roles in a group for
      a specified group email and member email.
  - command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email user@foo.com --remove-roles OWNER,MANAGER
  - stdout: |
      membership:
        name: groups/11zu0gzc3tkdgn2/memberships/110293416452252446513
        roles:
        - name: MANAGER
        - name: OWNER
- execute:
  - label: (Add and Remove Membership Roles) Modify membership roles in a group for
      a specified group email and member email.
  - command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email user@foo.com --add-roles MANAGER --remove-roles OWNER
  - stdout: |
      membership:
        name: groups/11zu0gzc3tkdgn2/memberships/110293416452252446513
        roles:
        - name: OWNER
        - name: MANAGER
- execute:
  - label: Modify membership roles with an invalid group email.
  - command: |
      identity groups memberships modify-membership-roles --group-email invalid-group@foo.com
      --member-email user@foo.com
  - error: '1: Invalid value for [--group-email]: There is no such a group associated
      with the specified argument:invalid-group@foo.com'
- execute:
  - label: Modify membership roles with an invalid member email.
  - command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email invalid-user@foo.com
  - error: '1: Invalid value for [--group-email, --member-email]: There is no such
      membership associated with the specified arguments: eng-discuss@foo.com, invalid-user@foo.com'
- execute:
  - label: Modify membership roles - Removing MEMBER role throws Invalid Argument
      error.
  - command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email invalid-user@foo.com
  - error: |-
      1: INVALID_ARGUMENT: Request contains an invalid argument.
      - '@type': type.googleapis.com/google.rpc.DebugInfo
        detail: '[ORIGINAL ERROR] generic::invalid_argument: Cannot remove member role without
          deleting the complete membership. Please use DeleteMembership to remove the membership
          for this user.'
- execute:
  - label: Set Membership Expiry on a given Membership.
  - command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email user@foo.com --update-roles-params MEMBER=expiration=3d
  - stdout: |
      membership:
        name: groups/041mghml1f3biwi/memberships/117906258713030503419
        roles:
        - expiryDetail:
            expireTime: ''
          name: MEMBER
- execute:
  - label: Set Membership Expiry on a non-MEMBER role of membership.
  - command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email user@foo.com --update-roles-params OWNER=expiration=3d
  - error: '1: Invalid value for [--update-roles-params]: Membership Expiry is not
      supported on a specified role: OWNER.'
- execute:
  - label: Set Membership Expiry with an invalid format of 'update-roles-params'.
  - command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email user@foo.com --update-roles-params MEMBER=expiration:3d
  - error: '1: Invalid value for [--update-roles-params]: Invalid format: MEMBER=expiration:3d'
actions:

- execute_command:
    label: (Add Membership Role) Modify membership roles in a group for a specified
      group email and member email.
    command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email user@foo.com --add-roles OWNER
    events:
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups:lookup?alt=json&groupKey.id=eng-discuss%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "groups/11zu0gzc3tkdgn2"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups/11zu0gzc3tkdgn2/memberships:lookup?alt=json&memberKey.id=user%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "groups/11zu0gzc3tkdgn2/memberships/110293416452252446513"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups/11zu0gzc3tkdgn2/memberships/110293416452252446513:modifyMembershipRoles?alt=json
          method: POST
          headers: {}
          body: |
            {
              "addRoles": [
                {
                  "name": "OWNER"
                }
              ]
            }
        return_response:
          headers:
            status: '200'
          body: |
            {
              "membership": {
                "name": "groups/11zu0gzc3tkdgn2/memberships/110293416452252446513",
                "roles": [
                  {
                    "name": "OWNER"
                  }
                ]
              }
            }
    - expect_stdout: |
        membership:
          name: groups/11zu0gzc3tkdgn2/memberships/110293416452252446513
          roles:
          - name: OWNER
    - expect_exit:
        code: 0

- execute_command:
    label: (Add Multiple Membership Roles) Modify membership roles in a group for
      a specified group email and member email.
    command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email user@foo.com --add-roles OWNER,MANAGER
    events:
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups:lookup?alt=json&groupKey.id=eng-discuss%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "groups/11zu0gzc3tkdgn2"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups/11zu0gzc3tkdgn2/memberships:lookup?alt=json&memberKey.id=user%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "groups/11zu0gzc3tkdgn2/memberships/110293416452252446513"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups/11zu0gzc3tkdgn2/memberships/110293416452252446513:modifyMembershipRoles?alt=json
          method: POST
          headers: {}
          body: |
            {
              "addRoles": [
                {
                  "name": "OWNER"
                },
                {
                  "name": "MANAGER"
                }
              ]
            }
        return_response:
          headers:
            status: '200'
          body: |
            {
              "membership": {
                "name": "groups/11zu0gzc3tkdgn2/memberships/110293416452252446513",
                "roles": [
                  {
                    "name": "MANAGER"
                  },
                  {
                    "name": "OWNER"
                  }
                ]
              }
            }
    - expect_stdout: |
        membership:
          name: groups/11zu0gzc3tkdgn2/memberships/110293416452252446513
          roles:
          - name: MANAGER
          - name: OWNER
    - expect_exit:
        code: 0

- execute_command:
    label: (Remove Membership Role) Modify membership roles in a group for a specified
      group email and member email.
    command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email user@foo.com --remove-roles OWNER
    events:
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups:lookup?alt=json&groupKey.id=eng-discuss%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "groups/11zu0gzc3tkdgn2"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups/11zu0gzc3tkdgn2/memberships:lookup?alt=json&memberKey.id=user%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "groups/11zu0gzc3tkdgn2/memberships/110293416452252446513"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups/11zu0gzc3tkdgn2/memberships/110293416452252446513:modifyMembershipRoles?alt=json
          method: POST
          headers: {}
          body: |
            {
              "removeRoles": [
                {
                  "name": "OWNER"
                }
              ]
            }
        return_response:
          headers:
            status: '200'
          body: |
            {
              "membership": {
                "name": "groups/11zu0gzc3tkdgn2/memberships/110293416452252446513",
                "roles": [
                  {
                    "name": "MANAGER"
                  }
                ]
              }
            }

    - expect_stdout: |
        membership:
          name: groups/11zu0gzc3tkdgn2/memberships/110293416452252446513
          roles:
          - name: MANAGER
    - expect_exit:
        code: 0

- execute_command:
    label: (Remove Multiple Membership Roles) Modify membership roles in a group for
      a specified group email and member email.
    command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email user@foo.com --remove-roles OWNER,MANAGER
    events:
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups:lookup?alt=json&groupKey.id=eng-discuss%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "groups/11zu0gzc3tkdgn2"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups/11zu0gzc3tkdgn2/memberships:lookup?alt=json&memberKey.id=user%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "groups/11zu0gzc3tkdgn2/memberships/110293416452252446513"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups/11zu0gzc3tkdgn2/memberships/110293416452252446513:modifyMembershipRoles?alt=json
          method: POST
          headers: {}
          body: |
            {
              "removeRoles": [
                {
                  "name": "OWNER"
                },
                {
                  "name": "MANAGER"
                }
              ]
            }
        return_response:
          headers:
            status: '200'
          body: |
            {
              "membership": {
                "name": "groups/11zu0gzc3tkdgn2/memberships/110293416452252446513",
                "roles": [
                  {
                    "name": "MANAGER"
                  },
                  {
                    "name": "OWNER"
                  }
                ]
              }
            }
    - expect_stdout: |
        membership:
          name: groups/11zu0gzc3tkdgn2/memberships/110293416452252446513
          roles:
          - name: MANAGER
          - name: OWNER
    - expect_exit:
        code: 0

- execute_command:
    label: (Add and Remove Membership Roles) Modify membership roles in a group for
      a specified group email and member email.
    command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email user@foo.com --add-roles MANAGER --remove-roles OWNER
    events:
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups:lookup?alt=json&groupKey.id=eng-discuss%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "groups/11zu0gzc3tkdgn2"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups/11zu0gzc3tkdgn2/memberships:lookup?alt=json&memberKey.id=user%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "groups/11zu0gzc3tkdgn2/memberships/110293416452252446513"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups/11zu0gzc3tkdgn2/memberships/110293416452252446513:modifyMembershipRoles?alt=json
          method: POST
          headers: {}
          body: |
            {
              "addRoles": [
                {
                  "name": "MANAGER"
                }
              ],
              "removeRoles": [
                {
                  "name": "OWNER"
                }
              ]
            }
        return_response:
          headers:
            status: '200'
          body: |
            {
              "membership": {
                "name": "groups/11zu0gzc3tkdgn2/memberships/110293416452252446513",
                "roles": [
                  {
                    "name": "OWNER"
                  },
                  {
                    "name": "MANAGER"
                  }
                ]
              }
            }

    - expect_stdout: |
        membership:
          name: groups/11zu0gzc3tkdgn2/memberships/110293416452252446513
          roles:
          - name: OWNER
          - name: MANAGER
    - expect_exit:
        code: 0

- execute_command:
    label: Modify membership roles with an invalid group email.
    command: |
      identity groups memberships modify-membership-roles --group-email invalid-group@foo.com
      --member-email user@foo.com
    events:
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups:lookup?alt=json&groupKey.id=invalid-group%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '404'
          body: |
            {
              "error": {
                "code": 404,
                "message": "Error(2019): Group 'invalid@foo.com' does not exist.",
                "status": "NOT_FOUND",
                "details": [
                  {
                    "@type": "type.googleapis.com/google.rpc.ResourceInfo",
                    "detail": "Error(2019): Group 'invalid@foo.com' does not exist."
                  },
                  {
                    "@type": "type.googleapis.com/google.rpc.DebugInfo",
                    "detail": "[ORIGINAL ERROR] generic::not_found: Error(2019): Group 'invalid@foo.com' does not exist.\n"
                  }
                ]
              }
            }
    - expect_exit:
        code: 1
        message: 'Invalid value for [--group-email]: There is no such a group associated
          with the specified argument:invalid-group@foo.com'
- execute_command:
    label: Modify membership roles with an invalid member email.
    command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email invalid-user@foo.com
    events:
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups:lookup?alt=json&groupKey.id=eng-discuss%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "groups/11zu0gzc3tkdgn2"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups/11zu0gzc3tkdgn2/memberships:lookup?alt=json&memberKey.id=invalid-user%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '404'
          body: |
            {
              "error": {
                "code": 404,
                "message": "Error(4006): Membership does not exist.",
                "status": "NOT_FOUND",
                "details": [
                  {
                    "@type": "type.googleapis.com/google.rpc.ResourceInfo",
                    "resourceType": "cloudidentity.googleapis.com/Membership",
                    "resourceName": "groups/11zu0gzc3tkdgn2",
                    "owner": "domain:cloudidentity.googleapis.com",
                    "description": "Error(4006): Membership does not exist."
                  },
                  {
                    "@type": "type.googleapis.com/google.rpc.DebugInfo",
                    "detail": "[ORIGINAL ERROR] generic::not_found: Error(4006): Membership does not exist.\n"
                  }
                ]
              }
            }
    - expect_exit:
        code: 1
        message: 'Invalid value for [--group-email, --member-email]: There is no such
          membership associated with the specified arguments: eng-discuss@foo.com,
          invalid-user@foo.com'
- execute_command:
    label: Modify membership roles - Removing MEMBER role throws Invalid Argument
      error.
    command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email invalid-user@foo.com
    events:
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups:lookup?alt=json&groupKey.id=eng-discuss%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "groups/11zu0gzc3tkdgn2"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups/11zu0gzc3tkdgn2/memberships:lookup?alt=json&memberKey.id=invalid-user%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "groups/11zu0gzc3tkdgn2/memberships/110293416452252446513"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups/11zu0gzc3tkdgn2/memberships/110293416452252446513:modifyMembershipRoles?alt=json
          method: POST
          headers: {}
          body: null
        return_response:
          headers:
            status: '400'
          body: |
            {
              "error": {
                "code": 400,
                "message": "Request contains an invalid argument.",
                "status": "INVALID_ARGUMENT",
                "details": [
                  {
                    "@type": "type.googleapis.com/google.rpc.DebugInfo",
                    "detail": "[ORIGINAL ERROR] generic::invalid_argument: Cannot remove member role without deleting the complete membership. Please use DeleteMembership to remove the membership for this user."
                  }
                ]
              }
            }
    - expect_exit:
        code: 1
        message: |-
          INVALID_ARGUMENT: Request contains an invalid argument.
          - '@type': type.googleapis.com/google.rpc.DebugInfo
            detail: '[ORIGINAL ERROR] generic::invalid_argument: Cannot remove member role without
              deleting the complete membership. Please use DeleteMembership to remove the membership
              for this user.'

- execute_command:
    label: Set Membership Expiry on a given Membership.
    command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email user@foo.com --update-roles-params MEMBER=expiration=3d
    events:
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups:lookup?alt=json&groupKey.id=eng-discuss%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "groups/11zu0gzc3tkdgn2"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups/11zu0gzc3tkdgn2/memberships:lookup?alt=json&memberKey.id=user%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "groups/11zu0gzc3tkdgn2/memberships/110293416452252446513"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups/11zu0gzc3tkdgn2/memberships/110293416452252446513:modifyMembershipRoles?alt=json
          method: POST
          headers: {}
          body: |
            {
              "updateRolesParams": [
                {
                  "fieldMask": "expiry_detail.expire_time",
                  "membershipRole":
                    {
                      "expiryDetail":
                        {
                          "expireTime": ""
                        },
                      "name": "MEMBER"
                    }
                }
              ]
            }
        return_response:
          headers:
            status: '200'
          body: |
            {
              "membership": {
                "name": "groups/041mghml1f3biwi/memberships/117906258713030503419",
                "roles": [
                  {
                    "name": "MEMBER",
                    "expiryDetail": {
                      "expireTime": ""
                    }
                  }
                ]
              }
            }

    - expect_stdout: |
        membership:
          name: groups/041mghml1f3biwi/memberships/117906258713030503419
          roles:
          - expiryDetail:
              expireTime: ''
            name: MEMBER
    - expect_exit:
        code: 0

- execute_command:
    label: Set Membership Expiry on a non-MEMBER role of membership.
    command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email user@foo.com --update-roles-params OWNER=expiration=3d
    events:
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups:lookup?alt=json&groupKey.id=eng-discuss%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "groups/11zu0gzc3tkdgn2"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups/11zu0gzc3tkdgn2/memberships:lookup?alt=json&memberKey.id=user%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "groups/11zu0gzc3tkdgn2/memberships/110293416452252446513"
            }
    - expect_exit:
        code: 1
        message: 'Invalid value for [--update-roles-params]: Membership Expiry is
          not supported on a specified role: OWNER.'
- execute_command:
    label: Set Membership Expiry with an invalid format of 'update-roles-params'.
    command: |
      identity groups memberships modify-membership-roles --group-email eng-discuss@foo.com
      --member-email user@foo.com --update-roles-params MEMBER=expiration:3d
    events:
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups:lookup?alt=json&groupKey.id=eng-discuss%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "groups/11zu0gzc3tkdgn2"
            }
    - api_call:
        expect_request:
          uri: https://cloudidentity.googleapis.com/v1alpha1/groups/11zu0gzc3tkdgn2/memberships:lookup?alt=json&memberKey.id=user%40foo.com
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "groups/11zu0gzc3tkdgn2/memberships/110293416452252446513"
            }
    - expect_exit:
        code: 1
        message: 'Invalid value for [--update-roles-params]: Invalid format: MEMBER=expiration:3d'
