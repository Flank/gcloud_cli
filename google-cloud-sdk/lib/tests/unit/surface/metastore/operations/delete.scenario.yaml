title: dataproc metastore delete operation test scenario
release_tracks: [ALPHA]
summary:
# This summary is generated by http://go/gcloud-scenario-tests on update and should not be edited.
- execute:
  - label: delete a single operation
  - command: |
      metastore operations delete foo --location us-east4
  - prompt:
    - message: |
        Deleting the following operations:
         - [foo] in [us-east4]
    - input: y
  - stderr: |
      Deleted operation [projects/fake-project/locations/us-east4/operations/foo].
- execute:
  - label: user abort
  - command: |
      metastore operations delete non-exist --location us-east4
  - prompt:
    - message: |
        Deleting the following operations:
         - [non-exist] in [us-east4]
    - input: n
  - error: '1: Deletion aborted by user.'
- execute:
  - label: delete multiple operations
  - command: |
      metastore operations delete foo bar --location us-east4
  - prompt:
    - message: |
        Deleting the following operations:
         - [foo] in [us-east4]
         - [bar] in [us-east4]
    - cancel_string: Deletion aborted by user.
    - input: y
  - stderr: |
      Deleted operation [projects/fake-project/locations/us-east4/operations/foo].
  - stderr: |
      Deleted operation [projects/fake-project/locations/us-east4/operations/bar].
- execute:
  - label: delete multiple operations and one fails
  - command: |
      metastore operations delete foo bar --location us-east4
  - prompt:
    - message: |
        Deleting the following operations:
         - [foo] in [us-east4]
         - [bar] in [us-east4]
    - cancel_string: Deletion aborted by user.
    - input: y
  - stderr: |
      Deleted operation [projects/fake-project/locations/us-east4/operations/foo].
  - stderr: |
      ERROR: Failed to delete operation [projects/fake-project/locations/us-east4/operations/bar]: Resource 'projects/metastore-dogfood-cp/locations/us-east4/operations/non-exist' was not found.
  - error: '1: Some deletions did not succeed.'
actions:
- execute_command:
    label: delete a single operation
    command: |
      metastore operations delete foo --location us-east4
    events:
    - expect_prompt_continue:
        message: |
          Deleting the following operations:
           - [foo] in [us-east4]
        user_input: y
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/operations/foo?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {}
    - expect_stderr: |
        Deleted operation [projects/fake-project/locations/us-east4/operations/foo].
    - expect_exit:
        code: 0
- execute_command:
    label: user abort
    command: |
      metastore operations delete non-exist --location us-east4
    events:
    - expect_prompt_continue:
        message: |
          Deleting the following operations:
           - [non-exist] in [us-east4]
        user_input: n
    - expect_exit:
        code: 1
        message: Deletion aborted by user.
- execute_command:
    label: delete multiple operations
    command: |
      metastore operations delete foo bar --location us-east4
    events:
    - expect_prompt_continue:
        message: |
          Deleting the following operations:
           - [foo] in [us-east4]
           - [bar] in [us-east4]
        cancel_string: Deletion aborted by user.
        user_input: y
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/operations/foo?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: {}
    - expect_stderr: |
        Deleted operation [projects/fake-project/locations/us-east4/operations/foo].
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/operations/bar?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: {}
    - expect_stderr: |
        Deleted operation [projects/fake-project/locations/us-east4/operations/bar].
    - expect_exit:
        code: 0
- execute_command:
    label: delete multiple operations and one fails
    command: |
      metastore operations delete foo bar --location us-east4
    events:
    - expect_prompt_continue:
        message: |
          Deleting the following operations:
           - [foo] in [us-east4]
           - [bar] in [us-east4]
        cancel_string: Deletion aborted by user.
        user_input: y
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/operations/foo?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: {}
    - expect_stderr: |
        Deleted operation [projects/fake-project/locations/us-east4/operations/foo].
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/operations/bar?alt=json
          method: DELETE
          headers: {}
          body: null
        return_response:
          status: 404
          headers: {}
          body: |
            {
              "error": {
                "code": 404,
                "message": "Resource 'projects/metastore-dogfood-cp/locations/us-east4/operations/non-exist' was not found",
                "status": "NOT_FOUND",
                "details": [
                  {
                    "@type": "type.googleapis.com/google.rpc.DebugInfo",
                    "stackEntries": [
                      "cloud/control2/shared/userfriendly/userfriendly.go:696 +0x28 google3/cloud/control2/shared/userfriendly/userfriendly.debugInfoWithMessage(0xc0357463a0, 0x1d, 0x1d, 0xc05ccba2a0, 0xc05a8f6ea0)",
                      "cloud/control2/shared/userfriendly/userfriendly.go:692 +0x54 google3/cloud/control2/shared/userfriendly/userfriendly.debugInfoWithError(0x55de9dad4300, 0xc000ef2cc0, 0xc0339803e8, 0x1, 0x1)",
                      "cloud/control2/shared/userfriendly/userfriendly.go:304 +0xe5 google3/cloud/control2/shared/userfriendly/userfriendly.NotFound(0x55de9daf9e60, 0xc01ced7fb0, 0x55de941a73e3, 0x10, 0xc018f1a500, 0x45, 0x55de9dad4300, 0xc000ef2cc0, 0x0)",
                      "cloud/control2/frontend/userfriendly/userfriendly_store.go:63 +0x586 google3/cloud/control2/frontend/userfriendly/userfriendlystore.ResourceErrorToUserFriendly(0x55de9daf9e60, 0xc01ced7fb0, 0xc018f1a500, 0x45, 0x55de9dad4300, 0xc000ef2cc0, 0x9)",
                      "cloud/control2/frontend/handler/handler.go:650 +0x85 google3/cloud/control2/frontend/handler/handler.storeErrorToUserFriendly(0x55de9daf9e60, 0xc01ced7fb0, 0xc02f7d1860, 0x55de9dad4300, 0xc000ef2cc0, 0xc012fffe3c)",
                      "cloud/control2/frontend/handler/mutate_lro.go:43 +0x37e google3/cloud/control2/frontend/handler/handler.(*customMethodHandler).handleDeleteOperation.func1(0x55de9daf9e60, 0xc01ced7fb0, 0x55de9db29300, 0xc0235cb560, 0xc035b0ce00)",
                      "cloud/control2/frontend/userfriendly/userfriendly_store.go:31 +0x53 google3/cloud/control2/frontend/userfriendly/userfriendlystore.Mutate.func1(0x55de9daf9e60, 0xc01ced7fb0, 0x55de9db29300, 0xc0235cb560, 0xc05d641a40, 0xc035b0ced0)",
                      "cloud/control2/frontend/logging/store_logging.go:498 +0x411 google3/cloud/control2/frontend/logging/storelogging.loggingStore.Mutate.func1(0x55de9daf9e60, 0xc01ced7fb0, 0x55de9db293a0, 0xc05d641a40, 0xc05d641a40, 0xc021cf6060)",
                      "cloud/control2/frontend/store/mutate_helper.go:26 +0x59 google3/cloud/control2/frontend/store/store.Mutate.func1(0x55de9daf9e60, 0xc01ced7fb0, 0x55de9db293a0, 0xc05d641a40, 0xc05d641a40, 0xc03e3ef901)",
                      "cloud/control2/frontend/store/mutate_helper.go:72 +0xed google3/cloud/control2/frontend/store/store.callHandler.func1(0xc03e3ef9e0, 0x0, 0x0)",
                      "spanner/go/transaction.go:278 +0x47 google3/spanner/go/spanner.RunInTransaction.func1(0x55de9daf9e60, 0xc01ced7fb0)",
                      "spanner/go/transaction.go:305 +0xb8 google3/spanner/go/spanner.RunInTransaction(0x55de9daf9e60, 0xc01ced7fb0, 0xc0339809c8, 0x0, 0x0, 0x0, 0x55de9c1fffc0, 0x55de9d9f43b0, 0x55de9c207880)",
                      "cloud/control2/frontend/store/mutate_helper.go:66 +0x12b google3/cloud/control2/frontend/store/store.callHandler(0x55de9daf9e60, 0xc01ced7fb0, 0x55de9db0cda0, 0xc00a48a8c0, 0x7f863cd72600, 0xc033980ab8, 0xa4800000008, 0xc05f07e070)",
                      "cloud/control2/frontend/store/mutate_helper.go:41 +0x236 google3/cloud/control2/frontend/store/store.Mutate(0x55de9daf9e60, 0xc02fb19a10, 0x55de9db0cda0, 0xc00a48a8c0, 0x55de941f13fc, 0x18, 0xc05d641900, 0xe0bec6201, 0xc05d641900)",
                      "cloud/control2/frontend/store/spanstore.go:1849 +0x72 google3/cloud/control2/frontend/store/store.(*Spanner).Mutate(0xc00a48a8c0, 0x55de9daf9e60, 0xc02fb19a10, 0x55de941f13fc, 0x18, 0xc05d641900, 0xc05aabd650, 0xc05aabd680)",
                      "cloud/control2/frontend/logging/store_logging.go:477 +0x2e5 google3/cloud/control2/frontend/logging/storelogging.loggingStore.Mutate(0xc01acab360, 0x18, 0x7ffeb32f7573, 0x8, 0x55de9db0cda0, 0xc00a48a8c0, 0x55de9daf9e60, 0xc02fb19a10, 0x55de941f13fc, 0x18, ...)",
                      "cloud/control2/frontend/userfriendly/userfriendly_store.go:30 +0x9c google3/cloud/control2/frontend/userfriendly/userfriendlystore.Mutate(0x55de9daf9e60, 0xc02fb19a10, 0x55de9db0d9a0, 0xc02e8270b0, 0x55de941f13fc, 0x18, 0xc03e9778a0, 0xc07289ccb0)",
                      "cloud/control2/frontend/handler/handler.go:736 google3/cloud/control2/frontend/handler/handler.(*handler).userFriendlyMutate(...)",
                      "cloud/control2/frontend/handler/mutate_lro.go:40 +0x685 google3/cloud/control2/frontend/handler/handler.(*customMethodHandler).handleDeleteOperation(0xc0339810e0, 0x55de9daf9e60, 0xc02fb19a10, 0xc04fbd6280, 0xc04fbd62c0, 0x14)",
                      "cloud/control2/frontend/handler/handler.go:412 +0x8af google3/cloud/control2/frontend/handler/handler.HandleRequest(0x55de9daf9e60, 0xc02fb19a10, 0xc050a9b6c0, 0xc04fbd6280, 0xc04fbd62c0, 0xc02fb19a10)",
                      "cloud/control2/frontend/server/frontend.go:751 +0x7bc google3/cloud/control2/frontend/server/server.(*Frontend).handleRequestWithFullMethodName(0xc004739200, 0x55de9daf9e60, 0xc02fb19860, 0xc05e01b780, 0xc035b3d9e0, 0xc0557f0a80, 0xc012fffa40, 0x4e, 0xc0282ab000)",
                      "cloud/control2/frontend/server/frontend.go:720 +0x777 google3/cloud/control2/frontend/server/server.(*Frontend).handleRequest(0xc004739200, 0x55de9daf9e60, 0xc02fb19860, 0xc035b3d9e0, 0xc0557f0a80, 0x7f864096aef8)",
                      "cloud/control2/frontend/server/frontend.go:318 +0x54 google3/cloud/control2/frontend/server/server.(*Frontend).SetTenantServices.func1(0x55de9daf9e60, 0xc02fb19860, 0xc035b3d9e0, 0xc0557f0a80, 0xc04d1173e8, 0x55de9695b2bb)",
                      "cloud/control2/frontend/server/tenantservice.go:344 +0x62 google3/cloud/control2/frontend/server/server.(*TenantService).registerFrontendAPIs.func1(0x55de9daf9e60, 0xc02fb19860, 0xc035b3d9e0, 0xc0557f0a80, 0xc0282ab001, 0x1)",
                      "cloud/control2/shared/genericrpc/service.go:123 +0x36d google3/cloud/control2/shared/genericrpc/genericrpc.(*Dispatcher).DefaultMethodHandler(0xc0015e7f40, 0x55de9daf9e60, 0xc02fb19860, 0xc035b3d9e0, 0x28, 0x28, 0xc02fb19890, 0x7f864106ea18)",
                      "net/rpc/go/stream.go:881 +0x6b google3/net/rpc/go/rpc.runStreamHandler(0x55de9daf9e60, 0xc02fb19860, 0xc02fb19890, 0x0, 0x0, 0x55de9db12ba0, 0xc02f7d1810)",
                      "net/goa/rpc/rpchandler.go:70 +0x22b google3/net/goa/rpc/rpchandler.ExecHandlerSubset(0x55de9daf9e60, 0xc02fb19860, 0xc033981998, 0x2, 0x2, 0xc035b3dec0, 0x55de9daf9e60)",
                      "net/goa/rpc/rpchandler.go:260 +0x45a google3/net/goa/rpc/rpchandler.(*closedRegistry).hook(0xc01da02560, 0x55de9daf9e60, 0xc0237a5e90, 0xc07289c850, 0x55de9707990c, 0xc035b1a730)"
                    ],
                    "detail": "generic::not_found: not found"
                  },
                  {
                    "@type": "type.googleapis.com/google.rpc.ResourceInfo",
                    "resourceName": "projects/metastore-dogfood-cp/locations/us-east4/operations/non-exist"
                  }
                ]
              }
            }
    - expect_stderr: |
        ERROR: Failed to delete operation [projects/fake-project/locations/us-east4/operations/bar]: Resource 'projects/metastore-dogfood-cp/locations/us-east4/operations/non-exist' was not found.
    - expect_exit:
        code: 1
        message: Some deletions did not succeed.
