title: dataproc metastore update test scenario
release_tracks: [ALPHA]
summary:
# This summary is generated by http://go/gcloud-scenario-tests on update and should not be edited.
- execute:
  - label: port number
  - command: |
      metastore services update test-gcloud --location=us-east4 --port=8080
  - stderr: |
      Request issued for: [test-gcloud]
  - progress_tracker:
    - message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597022368270-5ac7bbef58814-b51954ed-84b6eef7]
        to complete
    - status: SUCCESS
  - stderr: |
      Updated service [test-gcloud].
  - stdout: |
      artifactGcsUri: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c
      createTime: '2020-08-07T18:05:02.456596335Z'
      endpointUri: thrift://10.20.64.23:8080
      hiveMetastoreConfig:
        configOverrides:
          hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse
        version: 2.3.6
      name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
      network: projects/metastore-dogfood-cp/global/networks/default
      port: 8080
      state: ACTIVE
      stateMessage: The service is ready to use
      tier: ENTERPRISE
      updateTime: '2020-08-07T18:32:10.215528227Z'
- execute:
  - label: port number async
  - command: |
      metastore services update test-gcloud --location=us-east4 --port=9083 --async
  - stderr: |
      Request issued for: [test-gcloud]
      Check operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598227502430-5ad94568d7992-fc903549-e354e8a2] for status.
      Updated service [test-gcloud].
  - stdout: |
      done: false
      metadata:
        '@type': type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata
        apiVersion: v1alpha
        createTime: '2020-08-24T00:05:02.478150812Z'
        requestedCancellation: false
        target: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
        verb: update
      name: projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598227502430-5ad94568d7992-fc903549-e354e8a2
- execute:
  - label: insert one hive metastore config
  - command: |
      metastore services update test-gcloud --location=us-east4 --update-hive-metastore-configs=foo=bar
  - stderr: |
      Request issued for: [test-gcloud]
  - progress_tracker:
    - message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597034915881-5ac7eaadae323-2981fb17-8a47e9d7]
        to complete
    - status: SUCCESS
  - stderr: |
      Updated service [test-gcloud].
  - stdout: |
      artifactGcsUri: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c
      createTime: '2020-08-07T18:05:02.456596335Z'
      endpointUri: thrift://10.20.64.23:8080
      hiveMetastoreConfig:
        configOverrides:
          foo: bar
          hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse
        version: 2.3.6
      name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
      network: projects/metastore-dogfood-cp/global/networks/default
      port: 8080
      state: ACTIVE
      stateMessage: The service is ready to use
      tier: ENTERPRISE
      updateTime: '2020-08-07T18:32:10.215528227Z'
- execute:
  - label: update one existing hive metastore config
  - command: |
      metastore services update test-gcloud --location=us-east4 --update-hive-metastore-configs=foo=bar1
  - stderr: |
      Request issued for: [test-gcloud]
  - progress_tracker:
    - message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597034915881-5ac7eaadae323-2981fb17-8a47e9d7]
        to complete
    - status: SUCCESS
  - stderr: |
      Updated service [test-gcloud].
  - stdout: |
      artifactGcsUri: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c
      createTime: '2020-08-07T18:05:02.456596335Z'
      endpointUri: thrift://10.20.64.23:8080
      hiveMetastoreConfig:
        configOverrides:
          foo: bar1
          hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse
        version: 2.3.6
      name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
      network: projects/metastore-dogfood-cp/global/networks/default
      port: 8080
      state: ACTIVE
      stateMessage: The service is ready to use
      tier: ENTERPRISE
      updateTime: '2020-08-07T18:32:10.215528227Z'
- execute:
  - label: |
      remove an existing hive metastore config and an non-existing one
  - command: |
      metastore services update test-gcloud --location=us-east4 --remove-hive-metastore-configs=foo,foo1
  - stderr: |
      Request issued for: [test-gcloud]
  - progress_tracker:
    - message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597116636385-5ac91b1c6d062-7794c949-85d3cb32]
        to complete
    - status: SUCCESS
  - stderr: |
      Updated service [test-gcloud].
  - stdout: |
      artifactGcsUri: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c
      createTime: '2020-08-07T18:05:02.456596335Z'
      endpointUri: thrift://10.20.64.23:8080
      hiveMetastoreConfig:
        configOverrides:
          hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse
        version: 2.3.6
      name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
      network: projects/metastore-dogfood-cp/global/networks/default
      port: 8080
      state: ACTIVE
      stateMessage: The service is ready to use
      tier: ENTERPRISE
      updateTime: '2020-08-07T18:32:10.215528227Z'
- execute:
  - label: clear hive metastore configs and insert new configs
  - command: |
      metastore services update test-gcloud --location=us-east4 --clear-hive-metastore-configs --update-hive-metastore-configs=hive.metastore.warehouse.dir=gs://bar,baz=qux
  - stderr: |
      Request issued for: [test-gcloud]
  - progress_tracker:
    - message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598070234448-5ad6fb8a682e5-a1e300df-754b98b5]
        to complete
    - status: SUCCESS
  - stderr: |
      Updated service [test-gcloud].
  - stdout: |
      artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
      createTime: '2020-08-21T23:22:00.651575530Z'
      endpointUri: thrift://10.62.192.23:8080
      hiveMetastoreConfig:
        configOverrides:
          baz: qux
          hive.metastore.warehouse.dir: gs://bar
        version: 2.3.6
      labels:
        corge: grault
      name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
      network: projects/metastore-dogfood-cp/global/networks/default
      port: 8080
      state: ACTIVE
      stateMessage: The service is ready to use
      tier: ENTERPRISE
      updateTime: '2020-08-22T04:23:54.516510207Z'
- execute:
  - label: clear and remove hive metastore configs at the same time
  - command: |
      metastore services update test-gcloud --location=us-east4 --clear-hive-metastore-configs --remove-hive-metastore-configs=baz
  - stderr: |
      ERROR: (gcloud.alpha.metastore.services.update) argument --clear-hive-metastore-configs: At most one of --clear-hive-metastore-configs | --remove-hive-metastore-configs may be specified.
      Usage: gcloud alpha metastore services update (SERVICE : --location=LOCATION) [optional flags]
        optional flags may be  --async | --clear-hive-metastore-configs |
                               --clear-labels | --help | --kerberos_principal |
                               --keytab | --krb5-config | --location | --port |
                               --remove-hive-metastore-configs | --remove-labels |
                               --update-hive-metastore-configs |
                               --update-hive-metastore-configs-from-file |
                               --update-labels

      For detailed information on this command and its flags, run:
        gcloud alpha metastore services update --help
  - error: '1: argument --clear-hive-metastore-configs: At most one of --clear-hive-metastore-configs
      | --remove-hive-metastore-configs may be specified.'
- execute:
  - label: |
      update hive metastore configs via flags and parse-from-file at the same time
  - command: |
      metastore services update test-gcloud --location=us-east4 --update-hive-metastore-configs=foo=bar --update-hive-metastore-configs-from-file=metastore.xml
  - stderr: |
      ERROR: (gcloud.alpha.metastore.services.update) argument --update-hive-metastore-configs-from-file: At most one of --update-hive-metastore-configs-from-file | --update-hive-metastore-configs --clear-hive-metastore-configs | --remove-hive-metastore-configs may be specified.
      Usage: gcloud alpha metastore services update (SERVICE : --location=LOCATION) [optional flags]
        optional flags may be  --async | --clear-hive-metastore-configs |
                               --clear-labels | --help | --kerberos_principal |
                               --keytab | --krb5-config | --location | --port |
                               --remove-hive-metastore-configs | --remove-labels |
                               --update-hive-metastore-configs |
                               --update-hive-metastore-configs-from-file |
                               --update-labels

      For detailed information on this command and its flags, run:
        gcloud alpha metastore services update --help
  - error: '1: argument --update-hive-metastore-configs-from-file: At most one of
      --update-hive-metastore-configs-from-file | --update-hive-metastore-configs
      --clear-hive-metastore-configs | --remove-hive-metastore-configs may be specified.'
- execute:
  - label: |
      file doesn't exist
  - command: |
      metastore services update test-gcloud2 --location=us-east4 --update-hive-metastore-configs-from-file=non-exist.xml
  - stderr: |
      ERROR: (gcloud.alpha.metastore.services.update) argument --update-hive-metastore-configs-from-file: Unable to read file [non-exist.xml]: [Errno 2] No such file or directory: 'non-exist.xml'
      Usage: gcloud alpha metastore services update (SERVICE : --location=LOCATION) [optional flags]
        optional flags may be  --async | --clear-hive-metastore-configs |
                               --clear-labels | --help | --kerberos_principal |
                               --keytab | --krb5-config | --location | --port |
                               --remove-hive-metastore-configs | --remove-labels |
                               --update-hive-metastore-configs |
                               --update-hive-metastore-configs-from-file |
                               --update-labels

      For detailed information on this command and its flags, run:
        gcloud alpha metastore services update --help
  - error: "1: argument --update-hive-metastore-configs-from-file: Unable to read\
      \ file [non-exist.xml]: [Errno 2] No such file or directory: 'non-exist.xml'"
- execute:
  - label: |
      update hive metastore configs from file
  - command: |
      metastore services update test-gcloud2 --location=us-east4 --update-hive-metastore-configs-from-file=metastore.xml
  - stderr: |
      Request issued for: [test-gcloud2]
  - progress_tracker:
    - message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597247533689-5acb02bdd2c1a-ccb46a3a-d1146c0f]
        to complete
    - status: SUCCESS
  - stderr: |
      Updated service [test-gcloud2].
  - stdout: |
      artifactGcsUri: gs://gcs-bucket-test-gcloud2-57c31be6-37bc-4160-ab04-8ee9296ca6ed
      createTime: '2020-08-12T06:48:50.653862168Z'
      endpointUri: thrift://10.107.64.23:9083
      hiveMetastoreConfig:
        configOverrides:
          bar: foo
          hive.metastore.warehouse.dir: gs://gcs-bucket-test-update
        version: 2.3.6
      name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud2
      network: projects/metastore-dogfood-cp/global/networks/default
      port: 9083
      state: ACTIVE
      stateMessage: The service is ready to use
      tier: ENTERPRISE
      updateTime: '2020-08-12T07:12:49.522599855Z'
- execute:
  - label: insert labels
  - command: |
      metastore services update test-gcloud --location=us-east4 --update-labels=foo=bar,baz=qux
  - stderr: |
      Request issued for: [test-gcloud]
  - progress_tracker:
    - message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598063661397-5ad6e30ddb491-e4a5036c-89d516d3]
        to complete
    - status: SUCCESS
  - stderr: |
      Updated service [test-gcloud].
  - stdout: |
      artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
      createTime: '2020-08-21T23:22:00.651575530Z'
      endpointUri: thrift://10.62.192.23:9083
      hiveMetastoreConfig:
        configOverrides:
          hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse
        version: 2.3.6
      labels:
        baz: qux
        foo: bar
      name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
      network: projects/metastore-dogfood-cp/global/networks/default
      port: 9083
      state: ACTIVE
      stateMessage: The service is ready to use
      tier: ENTERPRISE
      updateTime: '2020-08-22T02:34:21.450014414Z'
- execute:
  - label: update one label and add one label
  - command: |
      metastore services update test-gcloud --location=us-east4 --update-labels=foo=quux,quuz=corge
  - stderr: |
      Request issued for: [test-gcloud]
  - progress_tracker:
    - message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598064083379-5ad6e4a04a505-c524f6f3-d9906c76]
        to complete
    - status: SUCCESS
  - stderr: |
      Updated service [test-gcloud].
  - stdout: |
      artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
      createTime: '2020-08-21T23:22:00.651575530Z'
      endpointUri: thrift://10.62.192.23:9083
      hiveMetastoreConfig:
        configOverrides:
          hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse
        version: 2.3.6
      labels:
        baz: qux
        foo: quux
        quuz: corge
      name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
      network: projects/metastore-dogfood-cp/global/networks/default
      port: 9083
      state: ACTIVE
      stateMessage: The service is ready to use
      tier: ENTERPRISE
      updateTime: '2020-08-22T02:41:23.440819465Z'
- execute:
  - label: remove labels
  - command: |
      metastore services update test-gcloud --location=us-east4 --remove-labels=foo,quuz
  - stderr: |
      Request issued for: [test-gcloud]
  - progress_tracker:
    - message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598064300617-5ad6e56f76fca-71b2741a-1fbec116]
        to complete
    - status: SUCCESS
  - stderr: |
      Updated service [test-gcloud].
  - stdout: |
      artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
      createTime: '2020-08-21T23:22:00.651575530Z'
      endpointUri: thrift://10.62.192.23:9083
      hiveMetastoreConfig:
        configOverrides:
          hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse
        version: 2.3.6
      labels:
        baz: qux
      name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
      network: projects/metastore-dogfood-cp/global/networks/default
      port: 9083
      state: ACTIVE
      stateMessage: The service is ready to use
      tier: ENTERPRISE
      updateTime: '2020-08-22T02:45:00.675525884Z'
- execute:
  - label: remove labels and insert a new label
  - command: |
      metastore services update test-gcloud --location=us-east4 --remove-labels=foo,quuz --update-labels=garply=waldo
  - stderr: |
      Request issued for: [test-gcloud]
  - progress_tracker:
    - message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598065631330-5ad6ea64880a8-f83fba97-1facadcd]
        to complete
    - status: SUCCESS
  - stderr: |
      Updated service [test-gcloud].
  - stdout: |
      done: true
      metadata:
        '@type': type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata
        apiVersion: v1alpha
        createTime: '2020-08-22T03:07:11.390340318Z'
        endTime: '2020-08-22T03:07:50.636359220Z'
        requestedCancellation: false
        target: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
        verb: update
      name: projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598065631330-5ad6ea64880a8-f83fba97-1facadcd
      response:
        '@type': type.googleapis.com/google.cloud.metastore.v1alpha.Service
        artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
        createTime: '2020-08-21T23:22:00.651575530Z'
        endpointUri: thrift://10.62.192.23:9083
        hiveMetastoreConfig:
          configOverrides:
            hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse
          version: 2.3.6
        labels:
          corge: grault
          foo: bar
          quuz: quux
        name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
        network: projects/metastore-dogfood-cp/global/networks/default
        port: 9083
        state: ACTIVE
        stateMessage: The service is ready to use
        tier: ENTERPRISE
        updateTime: '2020-08-22T03:07:11.391839329Z'
- execute:
  - label: update port and labels
  - command: |
      metastore services update test-gcloud --location=us-east4 --port=8080 --remove-labels=foo,quuz
  - stderr: |
      Request issued for: [test-gcloud]
  - progress_tracker:
    - message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598067866659-5ad6f2b84ea53-15c0b6b2-21a9f90f]
        to complete
    - status: SUCCESS
  - stderr: |
      Updated service [test-gcloud].
  - stdout: |
      artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
      createTime: '2020-08-21T23:22:00.651575530Z'
      endpointUri: thrift://10.62.192.23:8080
      hiveMetastoreConfig:
        configOverrides:
          hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse
        version: 2.3.6
      labels:
        corge: grault
      name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
      network: projects/metastore-dogfood-cp/global/networks/default
      port: 8080
      state: ACTIVE
      stateMessage: The service is ready to use
      tier: ENTERPRISE
      updateTime: '2020-08-22T03:44:26.713183032Z'
- execute:
  - label: clear labels
  - command: |
      metastore services update test-gcloud --location=us-east4 --clear-labels
  - stderr: |
      Request issued for: [test-gcloud]
  - progress_tracker:
    - message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598065219825-5ad6e8dc1714e-d9176a01-d99e8c1d]
        to complete
    - status: SUCCESS
  - stderr: |
      Updated service [test-gcloud].
  - stdout: |
      artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
      createTime: '2020-08-21T23:22:00.651575530Z'
      endpointUri: thrift://10.62.192.23:9083
      hiveMetastoreConfig:
        configOverrides:
          hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse
        version: 2.3.6
      name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
      network: projects/metastore-dogfood-cp/global/networks/default
      port: 9083
      state: ACTIVE
      stateMessage: The service is ready to use
      tier: ENTERPRISE
      updateTime: '2020-08-22T03:00:19.887565618Z'
- execute:
  - label: clear labels and insert new labels
  - command: |
      metastore services update test-gcloud --location=us-east4 --clear-labels --update-labels=foo=bar,quuz=quux,corge=grault
  - stderr: |
      Request issued for: [test-gcloud]
  - progress_tracker:
    - message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598065631330-5ad6ea64880a8-f83fba97-1facadcd]
        to complete
    - status: SUCCESS
  - stderr: |
      Updated service [test-gcloud].
  - stdout: |
      artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
      createTime: '2020-08-21T23:22:00.651575530Z'
      endpointUri: thrift://10.62.192.23:9083
      hiveMetastoreConfig:
        configOverrides:
          hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse
        version: 2.3.6
      labels:
        corge: grault
        foo: bar
        quuz: quux
      name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
      network: projects/metastore-dogfood-cp/global/networks/default
      port: 9083
      state: ACTIVE
      stateMessage: The service is ready to use
      tier: ENTERPRISE
      updateTime: '2020-08-22T03:07:11.391839329Z'
- execute:
  - label: clear and remove labels at the same time
  - command: |
      metastore services update test-gcloud --location=us-east4 --clear-labels --remove-labels=foo
  - stderr: |
      ERROR: (gcloud.alpha.metastore.services.update) argument --clear-labels: At most one of --clear-labels | --remove-labels may be specified.
      Usage: gcloud alpha metastore services update (SERVICE : --location=LOCATION) [optional flags]
        optional flags may be  --async | --clear-hive-metastore-configs |
                               --clear-labels | --help | --kerberos_principal |
                               --keytab | --krb5-config | --location | --port |
                               --remove-hive-metastore-configs | --remove-labels |
                               --update-hive-metastore-configs |
                               --update-hive-metastore-configs-from-file |
                               --update-labels

      For detailed information on this command and its flags, run:
        gcloud alpha metastore services update --help
  - error: '1: argument --clear-labels: At most one of --clear-labels | --remove-labels
      may be specified.'
- execute:
  - label: kerberos configs keytab
  - command: |
      metastore services update test-gcloud2 --location=us-east4 --keytab=projects/fake-project/secrets/kerberos-test/versions/2
  - stderr: |
      Request issued for: [test-gcloud2]
  - progress_tracker:
    - message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597290458189-5acba2a5d0d8a-4e39394d-1cfbf4bc]
        to complete
    - status: SUCCESS
  - stderr: |
      Updated service [test-gcloud2].
  - stdout: |
      artifactGcsUri: gs://gcs-bucket-test-gcloud2-64eaa6dd-1c31-4e82-93c9-28545aebb3c5
      createTime: '2020-08-11T03:31:52.912810057Z'
      endpointUri: thrift://10.20.64.31:8080
      hiveMetastoreConfig:
        configOverrides:
          bar: foo
          hive.metastore.warehouse.dir: gs://gcs-bucket-test-update/hive-warehouse
        kerberosConfig:
          keytab:
            cloudSecret: projects/fake-project/secrets/kerberos-test/versions/2
          krb5ConfigGcsUri: gs://kerberos-fake-project/krb5.conf
          principal: metastore/fake-project@C.FAKE-PROJECT.INTERNAL
        version: 2.3.6
      name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud2
      network: projects/metastore-dogfood-cp/global/networks/yanbinlyu1
      port: 8080
      state: ACTIVE
      stateMessage: The service is ready to use
      tier: ENTERPRISE
      updateTime: '2020-08-11T03:31:52.912810057Z'
actions:
- execute_command:
    label: port number
    command: |
      metastore services update test-gcloud --location=us-east4 --port=8080
    events:
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-07T18:05:02.456596335Z",
              "updateTime": "2020-08-07T18:32:10.215528227Z",
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.20.64.23:9083",
              "port": 9083,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c",
              "tier": "ENTERPRISE"
            }
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json&updateMask=port
          method: PATCH
          headers: {}
          body:
            json:
              artifactGcsUri: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c
              createTime: '2020-08-07T18:05:02.456596335Z'
              endpointUri: thrift://10.20.64.23:9083
              hiveMetastoreConfig:
                version: 2.3.6
              name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
              network: projects/metastore-dogfood-cp/global/networks/default
              port: 8080
              state: ACTIVE
              stateMessage: The service is ready to use
              tier: ENTERPRISE
              updateTime: '2020-08-07T18:32:10.215528227Z'
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597022368270-5ac7bbef58814-b51954ed-84b6eef7",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-10T01:19:28.294541075Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": false
            }
    - expect_stderr: |
        Request issued for: [test-gcloud]
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597022368270-5ac7bbef58814-b51954ed-84b6eef7?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          headers:
            status: '200'
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597022368270-5ac7bbef58814-b51954ed-84b6eef7",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-10T01:19:28.294541075Z",
                "endTime": "2020-08-10T01:24:08.140146907Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": true,
              "response": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.Service",
                "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "createTime": "2020-08-07T18:05:02.456596335Z",
                "updateTime": "2020-08-07T18:32:10.215528227Z",
                "hiveMetastoreConfig": {
                  "version": "2.3.6",
                  "configOverrides": {
                    "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse"
                  }
                },
                "network": "projects/metastore-dogfood-cp/global/networks/default",
                "endpointUri": "thrift://10.20.64.23:8080",
                "port": 8080,
                "state": "ACTIVE",
                "stateMessage": "The service is ready to use",
                "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c",
                "tier": "ENTERPRISE"
              }
            }
    - expect_progress_tracker:
        message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597022368270-5ac7bbef58814-b51954ed-84b6eef7]
          to complete
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-07T18:05:02.456596335Z",
              "updateTime": "2020-08-07T18:32:10.215528227Z",
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.20.64.23:8080",
              "port": 8080,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c",
              "tier": "ENTERPRISE"
            }
    - expect_stderr: |
        Updated service [test-gcloud].
    - expect_stdout: |
        artifactGcsUri: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c
        createTime: '2020-08-07T18:05:02.456596335Z'
        endpointUri: thrift://10.20.64.23:8080
        hiveMetastoreConfig:
          configOverrides:
            hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse
          version: 2.3.6
        name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
        network: projects/metastore-dogfood-cp/global/networks/default
        port: 8080
        state: ACTIVE
        stateMessage: The service is ready to use
        tier: ENTERPRISE
        updateTime: '2020-08-07T18:32:10.215528227Z'
    - expect_exit:
        code: 0
- execute_command:
    label: port number async
    command: |
      metastore services update test-gcloud --location=us-east4 --port=9083 --async
    events:
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-21T23:22:00.651575530Z",
              "updateTime": "2020-08-22T04:23:54.516510207Z",
              "labels": {
                "corge": "grault"
              },
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "baz": "qux",
                  "hive.metastore.warehouse.dir": "gs://bar"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.62.192.23:8080",
              "port": 8080,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
              "tier": "ENTERPRISE"
            }
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json&updateMask=port
          method: PATCH
          headers: {}
          body:
            json:
              artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
              createTime: '2020-08-21T23:22:00.651575530Z'
              endpointUri: thrift://10.62.192.23:8080
              hiveMetastoreConfig:
                version: 2.3.6
              labels:
                corge: grault
              name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
              network: projects/metastore-dogfood-cp/global/networks/default
              port: 9083
              state: ACTIVE
              stateMessage: The service is ready to use
              tier: ENTERPRISE
              updateTime: '2020-08-22T04:23:54.516510207Z'
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598227502430-5ad94568d7992-fc903549-e354e8a2",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-24T00:05:02.478150812Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": false
            }
    - expect_stderr: |
        Request issued for: [test-gcloud]
        Check operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598227502430-5ad94568d7992-fc903549-e354e8a2] for status.
        Updated service [test-gcloud].
    - expect_stdout: |
        done: false
        metadata:
          '@type': type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata
          apiVersion: v1alpha
          createTime: '2020-08-24T00:05:02.478150812Z'
          requestedCancellation: false
          target: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
          verb: update
        name: projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598227502430-5ad94568d7992-fc903549-e354e8a2
    - expect_exit:
        code: 0
- execute_command:
    label: insert one hive metastore config
    command: |
      metastore services update test-gcloud --location=us-east4 --update-hive-metastore-configs=foo=bar
    events:
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-07T18:05:02.456596335Z",
              "updateTime": "2020-08-07T18:32:10.215528227Z",
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.20.64.23:8080",
              "port": 8080,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c",
              "tier": "ENTERPRISE"
            }
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json&updateMask=hive_metastore_config.config_overrides.foo
          method: PATCH
          headers: {}
          body:
            json:
              artifactGcsUri: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c
              createTime: '2020-08-07T18:05:02.456596335Z'
              endpointUri: thrift://10.20.64.23:8080
              hiveMetastoreConfig:
                configOverrides:
                  foo: bar
                version: 2.3.6
              name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
              network: projects/metastore-dogfood-cp/global/networks/default
              port: 8080
              state: ACTIVE
              stateMessage: The service is ready to use
              tier: ENTERPRISE
              updateTime: '2020-08-07T18:32:10.215528227Z'
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597034915881-5ac7eaadae323-2981fb17-8a47e9d7",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-10T04:48:35.908556341Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": false
            }
    - expect_stderr: |
        Request issued for: [test-gcloud]
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597034915881-5ac7eaadae323-2981fb17-8a47e9d7?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597034915881-5ac7eaadae323-2981fb17-8a47e9d7",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-10T04:48:35.908556341Z",
                "endTime": "2020-08-10T04:53:15.918354974Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": true,
              "response": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.Service",
                "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "createTime": "2020-08-07T18:05:02.456596335Z",
                "updateTime": "2020-08-07T18:32:10.215528227Z",
                "hiveMetastoreConfig": {
                  "version": "2.3.6",
                  "configOverrides": {
                    "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse",
                    "foo": "bar"
                  }
                },
                "network": "projects/metastore-dogfood-cp/global/networks/default",
                "endpointUri": "thrift://10.20.64.23:8080",
                "port": 8080,
                "state": "ACTIVE",
                "stateMessage": "The service is ready to use",
                "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c",
                "tier": "ENTERPRISE"
              }
            }
    - expect_progress_tracker:
        message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597034915881-5ac7eaadae323-2981fb17-8a47e9d7]
          to complete
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-07T18:05:02.456596335Z",
              "updateTime": "2020-08-07T18:32:10.215528227Z",
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse",
                  "foo": "bar"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.20.64.23:8080",
              "port": 8080,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c",
              "tier": "ENTERPRISE"
            }
    - expect_stderr: |
        Updated service [test-gcloud].
    - expect_stdout: |
        artifactGcsUri: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c
        createTime: '2020-08-07T18:05:02.456596335Z'
        endpointUri: thrift://10.20.64.23:8080
        hiveMetastoreConfig:
          configOverrides:
            foo: bar
            hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse
          version: 2.3.6
        name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
        network: projects/metastore-dogfood-cp/global/networks/default
        port: 8080
        state: ACTIVE
        stateMessage: The service is ready to use
        tier: ENTERPRISE
        updateTime: '2020-08-07T18:32:10.215528227Z'
    - expect_exit:
        code: 0
- execute_command:
    label: update one existing hive metastore config
    command: |
      metastore services update test-gcloud --location=us-east4 --update-hive-metastore-configs=foo=bar1
    events:
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-07T18:05:02.456596335Z",
              "updateTime": "2020-08-07T18:32:10.215528227Z",
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse",
                  "foo": "bar"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.20.64.23:8080",
              "port": 8080,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c",
              "tier": "ENTERPRISE"
            }
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json&updateMask=hive_metastore_config.config_overrides.foo
          method: PATCH
          headers: {}
          body:
            json:
              artifactGcsUri: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c
              createTime: '2020-08-07T18:05:02.456596335Z'
              endpointUri: thrift://10.20.64.23:8080
              hiveMetastoreConfig:
                configOverrides:
                  foo: bar1
                version: 2.3.6
              name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
              network: projects/metastore-dogfood-cp/global/networks/default
              port: 8080
              state: ACTIVE
              stateMessage: The service is ready to use
              tier: ENTERPRISE
              updateTime: '2020-08-07T18:32:10.215528227Z'
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597034915881-5ac7eaadae323-2981fb17-8a47e9d7",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-10T04:48:35.908556341Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": false
            }
    - expect_stderr: |
        Request issued for: [test-gcloud]
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597034915881-5ac7eaadae323-2981fb17-8a47e9d7?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597035764900-5ac7edd75e0b7-df6cb383-1e564d7e",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-10T05:02:44.925210765Z",
                "endTime": "2020-08-10T05:05:37.038946030Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": true,
              "response": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.Service",
                "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "createTime": "2020-08-07T18:05:02.456596335Z",
                "updateTime": "2020-08-07T18:32:10.215528227Z",
                "hiveMetastoreConfig": {
                  "version": "2.3.6",
                  "configOverrides": {
                    "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse",
                    "foo": "bar1"
                  }
                },
                "network": "projects/metastore-dogfood-cp/global/networks/default",
                "endpointUri": "thrift://10.20.64.23:8080",
                "port": 8080,
                "state": "ACTIVE",
                "stateMessage": "The service is ready to use",
                "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c",
                "tier": "ENTERPRISE"
              }
            }
    - expect_progress_tracker:
        message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597034915881-5ac7eaadae323-2981fb17-8a47e9d7]
          to complete
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-07T18:05:02.456596335Z",
              "updateTime": "2020-08-07T18:32:10.215528227Z",
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse",
                  "foo": "bar1"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.20.64.23:8080",
              "port": 8080,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c",
              "tier": "ENTERPRISE"
            }
    - expect_stderr: |
        Updated service [test-gcloud].
    - expect_stdout: |
        artifactGcsUri: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c
        createTime: '2020-08-07T18:05:02.456596335Z'
        endpointUri: thrift://10.20.64.23:8080
        hiveMetastoreConfig:
          configOverrides:
            foo: bar1
            hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse
          version: 2.3.6
        name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
        network: projects/metastore-dogfood-cp/global/networks/default
        port: 8080
        state: ACTIVE
        stateMessage: The service is ready to use
        tier: ENTERPRISE
        updateTime: '2020-08-07T18:32:10.215528227Z'
    - expect_exit:
        code: 0
- execute_command:
    label: |
      remove an existing hive metastore config and an non-existing one
    command: |
      metastore services update test-gcloud --location=us-east4 --remove-hive-metastore-configs=foo,foo1
    events:
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-07T18:05:02.456596335Z",
              "updateTime": "2020-08-07T18:32:10.215528227Z",
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse",
                  "foo": "bar1"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.20.64.23:8080",
              "port": 8080,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c",
              "tier": "ENTERPRISE"
            }
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json&updateMask=hive_metastore_config.config_overrides.foo%2Chive_metastore_config.config_overrides.foo1
          method: PATCH
          headers: {}
          body:
            json:
              artifactGcsUri: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c
              createTime: '2020-08-07T18:05:02.456596335Z'
              endpointUri: thrift://10.20.64.23:8080
              hiveMetastoreConfig:
                version: 2.3.6
              name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
              network: projects/metastore-dogfood-cp/global/networks/default
              port: 8080
              state: ACTIVE
              stateMessage: The service is ready to use
              tier: ENTERPRISE
              updateTime: '2020-08-07T18:32:10.215528227Z'
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597116636385-5ac91b1c6d062-7794c949-85d3cb32",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-11T03:30:36.409299689Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": false
            }
    - expect_stderr: |
        Request issued for: [test-gcloud]
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597116636385-5ac91b1c6d062-7794c949-85d3cb32?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597116636385-5ac91b1c6d062-7794c949-85d3cb32",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-11T03:30:36.409299689Z",
                "endTime": "2020-08-11T03:35:48.667290153Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": true,
              "response": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.Service",
                "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "createTime": "2020-08-07T18:05:02.456596335Z",
                "updateTime": "2020-08-07T18:32:10.215528227Z",
                "hiveMetastoreConfig": {
                  "version": "2.3.6",
                  "configOverrides": {
                    "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse"
                  }
                },
                "network": "projects/metastore-dogfood-cp/global/networks/default",
                "endpointUri": "thrift://10.20.64.23:8080",
                "port": 8080,
                "state": "ACTIVE",
                "stateMessage": "The service is ready to use",
                "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c",
                "tier": "ENTERPRISE"
              }
            }
    - expect_progress_tracker:
        message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597116636385-5ac91b1c6d062-7794c949-85d3cb32]
          to complete
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-07T18:05:02.456596335Z",
              "updateTime": "2020-08-07T18:32:10.215528227Z",
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.20.64.23:8080",
              "port": 8080,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c",
              "tier": "ENTERPRISE"
            }
    - expect_stderr: |
        Updated service [test-gcloud].
    - expect_stdout: |
        artifactGcsUri: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c
        createTime: '2020-08-07T18:05:02.456596335Z'
        endpointUri: thrift://10.20.64.23:8080
        hiveMetastoreConfig:
          configOverrides:
            hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c52fa939-3d46-46a2-8242-29825c08318c/hive-warehouse
          version: 2.3.6
        name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
        network: projects/metastore-dogfood-cp/global/networks/default
        port: 8080
        state: ACTIVE
        stateMessage: The service is ready to use
        tier: ENTERPRISE
        updateTime: '2020-08-07T18:32:10.215528227Z'
    - expect_exit:
        code: 0
- execute_command:
    label: clear hive metastore configs and insert new configs
    command: |
      metastore services update test-gcloud --location=us-east4 --clear-hive-metastore-configs --update-hive-metastore-configs=hive.metastore.warehouse.dir=gs://bar,baz=qux
    events:
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-21T23:22:00.651575530Z",
              "updateTime": "2020-08-22T04:15:34.684650667Z",
              "labels": {
                "corge": "grault"
              },
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse",
                  "foo": "bar"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.62.192.23:8080",
              "port": 8080,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
              "tier": "ENTERPRISE"
            }
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json&updateMask=hive_metastore_config.config_overrides
          method: PATCH
          headers: {}
          body:
            json:
              artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
              createTime: '2020-08-21T23:22:00.651575530Z'
              endpointUri: thrift://10.62.192.23:8080
              hiveMetastoreConfig:
                configOverrides:
                  baz: qux
                  hive.metastore.warehouse.dir: gs://bar
                version: 2.3.6
              labels:
                corge: grault
              name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
              network: projects/metastore-dogfood-cp/global/networks/default
              port: 8080
              state: ACTIVE
              stateMessage: The service is ready to use
              tier: ENTERPRISE
              updateTime: '2020-08-22T04:15:34.684650667Z'
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598070234448-5ad6fb8a682e5-a1e300df-754b98b5",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-22T04:23:54.514919472Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": false
            }
    - expect_stderr: |
        Request issued for: [test-gcloud]
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598070234448-5ad6fb8a682e5-a1e300df-754b98b5?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598070234448-5ad6fb8a682e5-a1e300df-754b98b5",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-22T04:23:54.514919472Z",
                "endTime": "2020-08-22T04:26:10.921024422Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": true,
              "response": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.Service",
                "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "createTime": "2020-08-21T23:22:00.651575530Z",
                "updateTime": "2020-08-22T04:23:54.516510207Z",
                "labels": {
                  "corge": "grault"
                },
                "hiveMetastoreConfig": {
                  "version": "2.3.6",
                  "configOverrides": {
                    "baz": "qux",
                    "hive.metastore.warehouse.dir": "gs://bar"
                  }
                },
                "network": "projects/metastore-dogfood-cp/global/networks/default",
                "endpointUri": "thrift://10.62.192.23:8080",
                "port": 8080,
                "state": "ACTIVE",
                "stateMessage": "The service is ready to use",
                "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
                "tier": "ENTERPRISE"
              }
            }
    - expect_progress_tracker:
        message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598070234448-5ad6fb8a682e5-a1e300df-754b98b5]
          to complete
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-21T23:22:00.651575530Z",
              "updateTime": "2020-08-22T04:23:54.516510207Z",
              "labels": {
                "corge": "grault"
              },
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "baz": "qux",
                  "hive.metastore.warehouse.dir": "gs://bar"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.62.192.23:8080",
              "port": 8080,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
              "tier": "ENTERPRISE"
            }
    - expect_stderr: |
        Updated service [test-gcloud].
    - expect_stdout: |
        artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
        createTime: '2020-08-21T23:22:00.651575530Z'
        endpointUri: thrift://10.62.192.23:8080
        hiveMetastoreConfig:
          configOverrides:
            baz: qux
            hive.metastore.warehouse.dir: gs://bar
          version: 2.3.6
        labels:
          corge: grault
        name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
        network: projects/metastore-dogfood-cp/global/networks/default
        port: 8080
        state: ACTIVE
        stateMessage: The service is ready to use
        tier: ENTERPRISE
        updateTime: '2020-08-22T04:23:54.516510207Z'
    - expect_exit:
        code: 0
- execute_command:
    label: clear and remove hive metastore configs at the same time
    command: |
      metastore services update test-gcloud --location=us-east4 --clear-hive-metastore-configs --remove-hive-metastore-configs=baz
    events:
    - expect_stderr: |
        ERROR: (gcloud.alpha.metastore.services.update) argument --clear-hive-metastore-configs: At most one of --clear-hive-metastore-configs | --remove-hive-metastore-configs may be specified.
        Usage: gcloud alpha metastore services update (SERVICE : --location=LOCATION) [optional flags]
          optional flags may be  --async | --clear-hive-metastore-configs |
                                 --clear-labels | --help | --kerberos_principal |
                                 --keytab | --krb5-config | --location | --port |
                                 --remove-hive-metastore-configs | --remove-labels |
                                 --update-hive-metastore-configs |
                                 --update-hive-metastore-configs-from-file |
                                 --update-labels

        For detailed information on this command and its flags, run:
          gcloud alpha metastore services update --help
    - expect_exit:
        code: 1
        message: 'argument --clear-hive-metastore-configs: At most one of --clear-hive-metastore-configs
          | --remove-hive-metastore-configs may be specified.'
- write_file:
    path: metastore.xml
    contents: |
      <configuration>
        <property>
          <name>bar</name>
          <value>foo</value>
        </property>
        <property>
          <name>hive.metastore.warehouse.dir</name>
          <value>gs://gcs-bucket-test-update</value>
        </property>
      </configuration>
- execute_command:
    label: |
      update hive metastore configs via flags and parse-from-file at the same time
    command: |
      metastore services update test-gcloud --location=us-east4 --update-hive-metastore-configs=foo=bar --update-hive-metastore-configs-from-file=metastore.xml
    events:
    - expect_stderr: |
        ERROR: (gcloud.alpha.metastore.services.update) argument --update-hive-metastore-configs-from-file: At most one of --update-hive-metastore-configs-from-file | --update-hive-metastore-configs --clear-hive-metastore-configs | --remove-hive-metastore-configs may be specified.
        Usage: gcloud alpha metastore services update (SERVICE : --location=LOCATION) [optional flags]
          optional flags may be  --async | --clear-hive-metastore-configs |
                                 --clear-labels | --help | --kerberos_principal |
                                 --keytab | --krb5-config | --location | --port |
                                 --remove-hive-metastore-configs | --remove-labels |
                                 --update-hive-metastore-configs |
                                 --update-hive-metastore-configs-from-file |
                                 --update-labels

        For detailed information on this command and its flags, run:
          gcloud alpha metastore services update --help
    - expect_exit:
        code: 1
        message: 'argument --update-hive-metastore-configs-from-file: At most one
          of --update-hive-metastore-configs-from-file | --update-hive-metastore-configs
          --clear-hive-metastore-configs | --remove-hive-metastore-configs may be
          specified.'
- execute_command:
    label: |
      file doesn't exist
    command: |
      metastore services update test-gcloud2 --location=us-east4 --update-hive-metastore-configs-from-file=non-exist.xml
    events:
    - expect_stderr: |
        ERROR: (gcloud.alpha.metastore.services.update) argument --update-hive-metastore-configs-from-file: Unable to read file [non-exist.xml]: [Errno 2] No such file or directory: 'non-exist.xml'
        Usage: gcloud alpha metastore services update (SERVICE : --location=LOCATION) [optional flags]
          optional flags may be  --async | --clear-hive-metastore-configs |
                                 --clear-labels | --help | --kerberos_principal |
                                 --keytab | --krb5-config | --location | --port |
                                 --remove-hive-metastore-configs | --remove-labels |
                                 --update-hive-metastore-configs |
                                 --update-hive-metastore-configs-from-file |
                                 --update-labels

        For detailed information on this command and its flags, run:
          gcloud alpha metastore services update --help
    - expect_exit:
        code: 1
        message: "argument --update-hive-metastore-configs-from-file: Unable to read\
          \ file [non-exist.xml]: [Errno 2] No such file or directory: 'non-exist.xml'"
- execute_command:
    label: |
      update hive metastore configs from file
    command: |
      metastore services update test-gcloud2 --location=us-east4 --update-hive-metastore-configs-from-file=metastore.xml
    events:
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud2?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud2",
              "createTime": "2020-08-12T06:48:50.653862168Z",
              "updateTime": "2020-08-12T07:12:49.522599855Z",
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud2-57c31be6-37bc-4160-ab04-8ee9296ca6ed/hive-warehouse"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.107.64.23:9083",
              "port": 9083,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud2-57c31be6-37bc-4160-ab04-8ee9296ca6ed",
              "tier": "ENTERPRISE"
            }
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud2?alt=json&updateMask=hive_metastore_config.config_overrides
          method: PATCH
          headers: {}
          body:
            json:
              artifactGcsUri: gs://gcs-bucket-test-gcloud2-57c31be6-37bc-4160-ab04-8ee9296ca6ed
              createTime: '2020-08-12T06:48:50.653862168Z'
              endpointUri: thrift://10.107.64.23:9083
              hiveMetastoreConfig:
                configOverrides:
                  bar: foo
                  hive.metastore.warehouse.dir: gs://gcs-bucket-test-update
                version: 2.3.6
              name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud2
              network: projects/metastore-dogfood-cp/global/networks/default
              port: 9083
              state: ACTIVE
              stateMessage: The service is ready to use
              tier: ENTERPRISE
              updateTime: '2020-08-12T07:12:49.522599855Z'
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597247533689-5acb02bdd2c1a-ccb46a3a-d1146c0f",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-12T15:52:13.711797533Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud2",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": false
            }
    - expect_stderr: |
        Request issued for: [test-gcloud2]
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597247533689-5acb02bdd2c1a-ccb46a3a-d1146c0f?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597247533689-5acb02bdd2c1a-ccb46a3a-d1146c0f",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-12T15:52:13.711797533Z",
                "endTime": "2020-08-12T15:57:07.885767731Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud2",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": true,
              "response": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.Service",
                "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud2",
                "createTime": "2020-08-12T06:48:50.653862168Z",
                "updateTime": "2020-08-12T07:12:49.522599855Z",
                "hiveMetastoreConfig": {
                  "version": "2.3.6",
                  "configOverrides": {
                    "bar": "foo",
                    "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-update"
                  }
                },
                "network": "projects/metastore-dogfood-cp/global/networks/default",
                "endpointUri": "thrift://10.107.64.23:9083",
                "port": 9083,
                "state": "ACTIVE",
                "stateMessage": "The service is ready to use",
                "artifactGcsUri": "gs://gcs-bucket-test-gcloud2-57c31be6-37bc-4160-ab04-8ee9296ca6ed",
                "tier": "ENTERPRISE"
              }
            }
    - expect_progress_tracker:
        message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597247533689-5acb02bdd2c1a-ccb46a3a-d1146c0f]
          to complete
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud2?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud2",
              "createTime": "2020-08-12T06:48:50.653862168Z",
              "updateTime": "2020-08-12T07:12:49.522599855Z",
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "bar": "foo",
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-update"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.107.64.23:9083",
              "port": 9083,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud2-57c31be6-37bc-4160-ab04-8ee9296ca6ed",
              "tier": "ENTERPRISE"
            }
    - expect_stderr: |
        Updated service [test-gcloud2].
    - expect_stdout: |
        artifactGcsUri: gs://gcs-bucket-test-gcloud2-57c31be6-37bc-4160-ab04-8ee9296ca6ed
        createTime: '2020-08-12T06:48:50.653862168Z'
        endpointUri: thrift://10.107.64.23:9083
        hiveMetastoreConfig:
          configOverrides:
            bar: foo
            hive.metastore.warehouse.dir: gs://gcs-bucket-test-update
          version: 2.3.6
        name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud2
        network: projects/metastore-dogfood-cp/global/networks/default
        port: 9083
        state: ACTIVE
        stateMessage: The service is ready to use
        tier: ENTERPRISE
        updateTime: '2020-08-12T07:12:49.522599855Z'
    - expect_exit:
        code: 0
- execute_command:
    label: insert labels
    command: |
      metastore services update test-gcloud --location=us-east4 --update-labels=foo=bar,baz=qux
    events:
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-21T23:22:00.651575530Z",
              "updateTime": "2020-08-21T23:47:57.354615062Z",
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.62.192.23:9083",
              "port": 9083,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
              "tier": "ENTERPRISE"
            }
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json&updateMask=labels.baz%2Clabels.foo
          method: PATCH
          headers: {}
          body:
            json:
              artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
              createTime: '2020-08-21T23:22:00.651575530Z'
              endpointUri: thrift://10.62.192.23:9083
              hiveMetastoreConfig:
                version: 2.3.6
              labels:
                baz: qux
                foo: bar
              name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
              network: projects/metastore-dogfood-cp/global/networks/default
              port: 9083
              state: ACTIVE
              stateMessage: The service is ready to use
              tier: ENTERPRISE
              updateTime: '2020-08-21T23:47:57.354615062Z'
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598063661397-5ad6e30ddb491-e4a5036c-89d516d3",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-22T02:34:21.448341869Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": false
            }
    - expect_stderr: |
        Request issued for: [test-gcloud]
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598063661397-5ad6e30ddb491-e4a5036c-89d516d3?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598063661397-5ad6e30ddb491-e4a5036c-89d516d3",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-22T02:34:21.448341869Z",
                "endTime": "2020-08-22T02:34:54.755226535Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": true,
              "response": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.Service",
                "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "createTime": "2020-08-21T23:22:00.651575530Z",
                "updateTime": "2020-08-22T02:34:21.450014414Z",
                "labels": {
                  "baz": "qux",
                  "foo": "bar"
                },
                "hiveMetastoreConfig": {
                  "version": "2.3.6",
                  "configOverrides": {
                    "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                  }
                },
                "network": "projects/metastore-dogfood-cp/global/networks/default",
                "endpointUri": "thrift://10.62.192.23:9083",
                "port": 9083,
                "state": "ACTIVE",
                "stateMessage": "The service is ready to use",
                "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
                "tier": "ENTERPRISE"
              }
            }
    - expect_progress_tracker:
        message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598063661397-5ad6e30ddb491-e4a5036c-89d516d3]
          to complete
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-21T23:22:00.651575530Z",
              "updateTime": "2020-08-22T02:34:21.450014414Z",
              "labels": {
                "baz": "qux",
                "foo": "bar"
              },
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.62.192.23:9083",
              "port": 9083,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
              "tier": "ENTERPRISE"
            }
    - expect_stderr: |
        Updated service [test-gcloud].
    - expect_stdout: |
        artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
        createTime: '2020-08-21T23:22:00.651575530Z'
        endpointUri: thrift://10.62.192.23:9083
        hiveMetastoreConfig:
          configOverrides:
            hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse
          version: 2.3.6
        labels:
          baz: qux
          foo: bar
        name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
        network: projects/metastore-dogfood-cp/global/networks/default
        port: 9083
        state: ACTIVE
        stateMessage: The service is ready to use
        tier: ENTERPRISE
        updateTime: '2020-08-22T02:34:21.450014414Z'
    - expect_exit:
        code: 0
- execute_command:
    label: update one label and add one label
    command: |
      metastore services update test-gcloud --location=us-east4 --update-labels=foo=quux,quuz=corge
    events:
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-21T23:22:00.651575530Z",
              "updateTime": "2020-08-22T02:34:21.450014414Z",
              "labels": {
                "baz": "qux",
                "foo": "bar"
              },
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.62.192.23:9083",
              "port": 9083,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
              "tier": "ENTERPRISE"
            }
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json&updateMask=labels.foo%2Clabels.quuz
          method: PATCH
          headers: {}
          body:
            json:
              artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
              createTime: '2020-08-21T23:22:00.651575530Z'
              endpointUri: thrift://10.62.192.23:9083
              hiveMetastoreConfig:
                version: 2.3.6
              labels:
                baz: qux
                foo: quux
                quuz: corge
              name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
              network: projects/metastore-dogfood-cp/global/networks/default
              port: 9083
              state: ACTIVE
              stateMessage: The service is ready to use
              tier: ENTERPRISE
              updateTime: '2020-08-22T02:34:21.450014414Z'
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598064083379-5ad6e4a04a505-c524f6f3-d9906c76",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-22T02:41:23.439286715Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": false
            }
    - expect_stderr: |
        Request issued for: [test-gcloud]
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598064083379-5ad6e4a04a505-c524f6f3-d9906c76?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598064083379-5ad6e4a04a505-c524f6f3-d9906c76",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-22T02:41:23.439286715Z",
                "endTime": "2020-08-22T02:41:56.651193209Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": true,
              "response": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.Service",
                "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "createTime": "2020-08-21T23:22:00.651575530Z",
                "updateTime": "2020-08-22T02:41:23.440819465Z",
                "labels": {
                  "baz": "qux",
                  "foo": "quux",
                  "quuz": "corge"
                },
                "hiveMetastoreConfig": {
                  "version": "2.3.6",
                  "configOverrides": {
                    "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                  }
                },
                "network": "projects/metastore-dogfood-cp/global/networks/default",
                "endpointUri": "thrift://10.62.192.23:9083",
                "port": 9083,
                "state": "ACTIVE",
                "stateMessage": "The service is ready to use",
                "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
                "tier": "ENTERPRISE"
              }
            }
    - expect_progress_tracker:
        message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598064083379-5ad6e4a04a505-c524f6f3-d9906c76]
          to complete
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-21T23:22:00.651575530Z",
              "updateTime": "2020-08-22T02:41:23.440819465Z",
              "labels": {
                "foo": "quux",
                "quuz": "corge",
                "baz": "qux"
              },
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.62.192.23:9083",
              "port": 9083,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
              "tier": "ENTERPRISE"
            }
    - expect_stderr: |
        Updated service [test-gcloud].
    - expect_stdout: |
        artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
        createTime: '2020-08-21T23:22:00.651575530Z'
        endpointUri: thrift://10.62.192.23:9083
        hiveMetastoreConfig:
          configOverrides:
            hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse
          version: 2.3.6
        labels:
          baz: qux
          foo: quux
          quuz: corge
        name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
        network: projects/metastore-dogfood-cp/global/networks/default
        port: 9083
        state: ACTIVE
        stateMessage: The service is ready to use
        tier: ENTERPRISE
        updateTime: '2020-08-22T02:41:23.440819465Z'
    - expect_exit:
        code: 0
- execute_command:
    label: remove labels
    command: |
      metastore services update test-gcloud --location=us-east4 --remove-labels=foo,quuz
    events:
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-21T23:22:00.651575530Z",
              "updateTime": "2020-08-22T02:41:23.440819465Z",
              "labels": {
                "baz": "qux",
                "foo": "quux",
                "quuz": "corge"
              },
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.62.192.23:9083",
              "port": 9083,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
              "tier": "ENTERPRISE"
            }
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json&updateMask=labels.foo%2Clabels.quuz
          method: PATCH
          headers: {}
          body:
            json:
              artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
              createTime: '2020-08-21T23:22:00.651575530Z'
              endpointUri: thrift://10.62.192.23:9083
              hiveMetastoreConfig:
                version: 2.3.6
              labels:
                baz: qux
              name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
              network: projects/metastore-dogfood-cp/global/networks/default
              port: 9083
              state: ACTIVE
              stateMessage: The service is ready to use
              tier: ENTERPRISE
              updateTime: '2020-08-22T02:41:23.440819465Z'
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598064300617-5ad6e56f76fca-71b2741a-1fbec116",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-22T02:45:00.674017948Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": false
            }
    - expect_stderr: |
        Request issued for: [test-gcloud]
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598064300617-5ad6e56f76fca-71b2741a-1fbec116?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598064300617-5ad6e56f76fca-71b2741a-1fbec116",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-22T02:45:00.674017948Z",
                "endTime": "2020-08-22T02:45:40.468174619Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": true,
              "response": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.Service",
                "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "createTime": "2020-08-21T23:22:00.651575530Z",
                "updateTime": "2020-08-22T02:45:00.675525884Z",
                "labels": {
                  "baz": "qux"
                },
                "hiveMetastoreConfig": {
                  "version": "2.3.6",
                  "configOverrides": {
                    "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                  }
                },
                "network": "projects/metastore-dogfood-cp/global/networks/default",
                "endpointUri": "thrift://10.62.192.23:9083",
                "port": 9083,
                "state": "ACTIVE",
                "stateMessage": "The service is ready to use",
                "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
                "tier": "ENTERPRISE"
              }
            }
    - expect_progress_tracker:
        message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598064300617-5ad6e56f76fca-71b2741a-1fbec116]
          to complete
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-21T23:22:00.651575530Z",
              "updateTime": "2020-08-22T02:45:00.675525884Z",
              "labels": {
                "baz": "qux"
              },
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.62.192.23:9083",
              "port": 9083,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
              "tier": "ENTERPRISE"
            }
    - expect_stderr: |
        Updated service [test-gcloud].
    - expect_stdout: |
        artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
        createTime: '2020-08-21T23:22:00.651575530Z'
        endpointUri: thrift://10.62.192.23:9083
        hiveMetastoreConfig:
          configOverrides:
            hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse
          version: 2.3.6
        labels:
          baz: qux
        name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
        network: projects/metastore-dogfood-cp/global/networks/default
        port: 9083
        state: ACTIVE
        stateMessage: The service is ready to use
        tier: ENTERPRISE
        updateTime: '2020-08-22T02:45:00.675525884Z'
    - expect_exit:
        code: 0
- execute_command:
    label: remove labels and insert a new label
    command: |
      metastore services update test-gcloud --location=us-east4 --remove-labels=foo,quuz --update-labels=garply=waldo
    events:
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-21T23:22:00.651575530Z",
              "updateTime": "2020-08-22T03:04:36.145913841Z",
              "labels": {
                "foo": "quux",
                "quuz": "corge"
              },
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.62.192.23:9083",
              "port": 9083,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
              "tier": "ENTERPRISE"
            }
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json&updateMask=labels.foo%2Clabels.garply%2Clabels.quuz
          method: PATCH
          headers: {}
          body:
            json:
              artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
              createTime: '2020-08-21T23:22:00.651575530Z'
              endpointUri: thrift://10.62.192.23:9083
              hiveMetastoreConfig:
                version: 2.3.6
              labels:
                garply: waldo
              name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
              network: projects/metastore-dogfood-cp/global/networks/default
              port: 9083
              state: ACTIVE
              stateMessage: The service is ready to use
              tier: ENTERPRISE
              updateTime: '2020-08-22T03:04:36.145913841Z'
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598065631330-5ad6ea64880a8-f83fba97-1facadcd",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-22T03:07:11.390340318Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": false
            }
    - expect_stderr: |
        Request issued for: [test-gcloud]
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598065631330-5ad6ea64880a8-f83fba97-1facadcd?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598065631330-5ad6ea64880a8-f83fba97-1facadcd",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-22T03:07:11.390340318Z",
                "endTime": "2020-08-22T03:07:50.636359220Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": true,
              "response": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.Service",
                "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "createTime": "2020-08-21T23:22:00.651575530Z",
                "updateTime": "2020-08-22T03:07:11.391839329Z",
                "labels": {
                  "corge": "grault",
                  "foo": "bar",
                  "quuz": "quux"
                },
                "hiveMetastoreConfig": {
                  "version": "2.3.6",
                  "configOverrides": {
                    "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                  }
                },
                "network": "projects/metastore-dogfood-cp/global/networks/default",
                "endpointUri": "thrift://10.62.192.23:9083",
                "port": 9083,
                "state": "ACTIVE",
                "stateMessage": "The service is ready to use",
                "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
                "tier": "ENTERPRISE"
              }
            }
    - expect_progress_tracker:
        message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598065631330-5ad6ea64880a8-f83fba97-1facadcd]
          to complete
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598065631330-5ad6ea64880a8-f83fba97-1facadcd",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-22T03:07:11.390340318Z",
                "endTime": "2020-08-22T03:07:50.636359220Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": true,
              "response": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.Service",
                "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "createTime": "2020-08-21T23:22:00.651575530Z",
                "updateTime": "2020-08-22T03:07:11.391839329Z",
                "labels": {
                  "corge": "grault",
                  "foo": "bar",
                  "quuz": "quux"
                },
                "hiveMetastoreConfig": {
                  "version": "2.3.6",
                  "configOverrides": {
                    "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                  }
                },
                "network": "projects/metastore-dogfood-cp/global/networks/default",
                "endpointUri": "thrift://10.62.192.23:9083",
                "port": 9083,
                "state": "ACTIVE",
                "stateMessage": "The service is ready to use",
                "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
                "tier": "ENTERPRISE"
              }
            }
    - expect_stderr: |
        Updated service [test-gcloud].
    - expect_stdout: |
        done: true
        metadata:
          '@type': type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata
          apiVersion: v1alpha
          createTime: '2020-08-22T03:07:11.390340318Z'
          endTime: '2020-08-22T03:07:50.636359220Z'
          requestedCancellation: false
          target: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
          verb: update
        name: projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598065631330-5ad6ea64880a8-f83fba97-1facadcd
        response:
          '@type': type.googleapis.com/google.cloud.metastore.v1alpha.Service
          artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
          createTime: '2020-08-21T23:22:00.651575530Z'
          endpointUri: thrift://10.62.192.23:9083
          hiveMetastoreConfig:
            configOverrides:
              hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse
            version: 2.3.6
          labels:
            corge: grault
            foo: bar
            quuz: quux
          name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
          network: projects/metastore-dogfood-cp/global/networks/default
          port: 9083
          state: ACTIVE
          stateMessage: The service is ready to use
          tier: ENTERPRISE
          updateTime: '2020-08-22T03:07:11.391839329Z'
    - expect_exit:
        code: 0
- execute_command:
    label: update port and labels
    command: |
      metastore services update test-gcloud --location=us-east4 --port=8080 --remove-labels=foo,quuz
    events:
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-21T23:22:00.651575530Z",
              "updateTime": "2020-08-22T03:07:11.391839329Z",
              "labels": {
                "foo": "bar",
                "quuz": "quux",
                "corge": "grault"
              },
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.62.192.23:9083",
              "port": 9083,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
              "tier": "ENTERPRISE"
            }
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json&updateMask=labels.foo%2Clabels.quuz%2Cport
          method: PATCH
          headers: {}
          body:
            json:
              artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
              createTime: '2020-08-21T23:22:00.651575530Z'
              endpointUri: thrift://10.62.192.23:9083
              hiveMetastoreConfig:
                version: 2.3.6
              labels:
                corge: grault
              name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
              network: projects/metastore-dogfood-cp/global/networks/default
              port: 8080
              state: ACTIVE
              stateMessage: The service is ready to use
              tier: ENTERPRISE
              updateTime: '2020-08-22T03:07:11.391839329Z'
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598067866659-5ad6f2b84ea53-15c0b6b2-21a9f90f",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-22T03:44:26.711544151Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": false
            }
    - expect_stderr: |
        Request issued for: [test-gcloud]
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598067866659-5ad6f2b84ea53-15c0b6b2-21a9f90f?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598067866659-5ad6f2b84ea53-15c0b6b2-21a9f90f",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-22T03:44:26.711544151Z",
                "endTime": "2020-08-22T03:49:10.575402450Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": true,
              "response": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.Service",
                "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "createTime": "2020-08-21T23:22:00.651575530Z",
                "updateTime": "2020-08-22T03:44:26.713183032Z",
                "labels": {
                  "corge": "grault"
                },
                "hiveMetastoreConfig": {
                  "version": "2.3.6",
                  "configOverrides": {
                    "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                  }
                },
                "network": "projects/metastore-dogfood-cp/global/networks/default",
                "endpointUri": "thrift://10.62.192.23:8080",
                "port": 8080,
                "state": "ACTIVE",
                "stateMessage": "The service is ready to use",
                "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
                "tier": "ENTERPRISE"
              }
            }
    - expect_progress_tracker:
        message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598067866659-5ad6f2b84ea53-15c0b6b2-21a9f90f]
          to complete
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-21T23:22:00.651575530Z",
              "updateTime": "2020-08-22T03:44:26.713183032Z",
              "labels": {
                "corge": "grault"
              },
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.62.192.23:8080",
              "port": 8080,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
              "tier": "ENTERPRISE"
            }
    - expect_stderr: |
        Updated service [test-gcloud].
    - expect_stdout: |
        artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
        createTime: '2020-08-21T23:22:00.651575530Z'
        endpointUri: thrift://10.62.192.23:8080
        hiveMetastoreConfig:
          configOverrides:
            hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse
          version: 2.3.6
        labels:
          corge: grault
        name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
        network: projects/metastore-dogfood-cp/global/networks/default
        port: 8080
        state: ACTIVE
        stateMessage: The service is ready to use
        tier: ENTERPRISE
        updateTime: '2020-08-22T03:44:26.713183032Z'
    - expect_exit:
        code: 0
- execute_command:
    label: clear labels
    command: |
      metastore services update test-gcloud --location=us-east4 --clear-labels
    events:
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-21T23:22:00.651575530Z",
              "updateTime": "2020-08-22T02:58:46.581080588Z",
              "labels": {
                "foo": "quux",
                "quuz": "corge"
              },
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.62.192.23:9083",
              "port": 9083,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
              "tier": "ENTERPRISE"
            }
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json&updateMask=labels
          method: PATCH
          headers: {}
          body:
            json:
              artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
              createTime: '2020-08-21T23:22:00.651575530Z'
              endpointUri: thrift://10.62.192.23:9083
              hiveMetastoreConfig:
                version: 2.3.6
              labels: {}
              name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
              network: projects/metastore-dogfood-cp/global/networks/default
              port: 9083
              state: ACTIVE
              stateMessage: The service is ready to use
              tier: ENTERPRISE
              updateTime: '2020-08-22T02:58:46.581080588Z'
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598065219825-5ad6e8dc1714e-d9176a01-d99e8c1d",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-22T03:00:19.885851523Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": false
            }
    - expect_stderr: |
        Request issued for: [test-gcloud]
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598065219825-5ad6e8dc1714e-d9176a01-d99e8c1d?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598065219825-5ad6e8dc1714e-d9176a01-d99e8c1d",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-22T03:00:19.885851523Z",
                "endTime": "2020-08-22T03:00:54.649693368Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": true,
              "response": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.Service",
                "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "createTime": "2020-08-21T23:22:00.651575530Z",
                "updateTime": "2020-08-22T03:00:19.887565618Z",
                "hiveMetastoreConfig": {
                  "version": "2.3.6",
                  "configOverrides": {
                    "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                  }
                },
                "network": "projects/metastore-dogfood-cp/global/networks/default",
                "endpointUri": "thrift://10.62.192.23:9083",
                "port": 9083,
                "state": "ACTIVE",
                "stateMessage": "The service is ready to use",
                "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
                "tier": "ENTERPRISE"
              }
            }
    - expect_progress_tracker:
        message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598065219825-5ad6e8dc1714e-d9176a01-d99e8c1d]
          to complete
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-21T23:22:00.651575530Z",
              "updateTime": "2020-08-22T03:00:19.887565618Z",
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.62.192.23:9083",
              "port": 9083,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
              "tier": "ENTERPRISE"
            }
    - expect_stderr: |
        Updated service [test-gcloud].
    - expect_stdout: |
        artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
        createTime: '2020-08-21T23:22:00.651575530Z'
        endpointUri: thrift://10.62.192.23:9083
        hiveMetastoreConfig:
          configOverrides:
            hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse
          version: 2.3.6
        name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
        network: projects/metastore-dogfood-cp/global/networks/default
        port: 9083
        state: ACTIVE
        stateMessage: The service is ready to use
        tier: ENTERPRISE
        updateTime: '2020-08-22T03:00:19.887565618Z'
    - expect_exit:
        code: 0
- execute_command:
    label: clear labels and insert new labels
    command: |
      metastore services update test-gcloud --location=us-east4 --clear-labels --update-labels=foo=bar,quuz=quux,corge=grault
    events:
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-21T23:22:00.651575530Z",
              "updateTime": "2020-08-22T03:04:36.145913841Z",
              "labels": {
                "foo": "quux",
                "quuz": "corge"
              },
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.62.192.23:9083",
              "port": 9083,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
              "tier": "ENTERPRISE"
            }
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json&updateMask=labels
          method: PATCH
          headers: {}
          body:
            json:
              artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
              createTime: '2020-08-21T23:22:00.651575530Z'
              endpointUri: thrift://10.62.192.23:9083
              hiveMetastoreConfig:
                version: 2.3.6
              labels:
                corge: grault
                foo: bar
                quuz: quux
              name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
              network: projects/metastore-dogfood-cp/global/networks/default
              port: 9083
              state: ACTIVE
              stateMessage: The service is ready to use
              tier: ENTERPRISE
              updateTime: '2020-08-22T03:04:36.145913841Z'
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598065631330-5ad6ea64880a8-f83fba97-1facadcd",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-22T03:07:11.390340318Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": false
            }
    - expect_stderr: |
        Request issued for: [test-gcloud]
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598065631330-5ad6ea64880a8-f83fba97-1facadcd?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598065631330-5ad6ea64880a8-f83fba97-1facadcd",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-22T03:07:11.390340318Z",
                "endTime": "2020-08-22T03:07:50.636359220Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": true,
              "response": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.Service",
                "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
                "createTime": "2020-08-21T23:22:00.651575530Z",
                "updateTime": "2020-08-22T03:07:11.391839329Z",
                "labels": {
                  "corge": "grault",
                  "foo": "bar",
                  "quuz": "quux"
                },
                "hiveMetastoreConfig": {
                  "version": "2.3.6",
                  "configOverrides": {
                    "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                  }
                },
                "network": "projects/metastore-dogfood-cp/global/networks/default",
                "endpointUri": "thrift://10.62.192.23:9083",
                "port": 9083,
                "state": "ACTIVE",
                "stateMessage": "The service is ready to use",
                "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
                "tier": "ENTERPRISE"
              }
            }
    - expect_progress_tracker:
        message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1598065631330-5ad6ea64880a8-f83fba97-1facadcd]
          to complete
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud",
              "createTime": "2020-08-21T23:22:00.651575530Z",
              "updateTime": "2020-08-22T03:07:11.391839329Z",
              "labels": {
                "corge": "grault",
                "foo": "bar",
                "quuz": "quux"
              },
              "hiveMetastoreConfig": {
                "version": "2.3.6",
                "configOverrides": {
                  "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse"
                }
              },
              "network": "projects/metastore-dogfood-cp/global/networks/default",
              "endpointUri": "thrift://10.62.192.23:9083",
              "port": 9083,
              "state": "ACTIVE",
              "stateMessage": "The service is ready to use",
              "artifactGcsUri": "gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f",
              "tier": "ENTERPRISE"
            }
    - expect_stderr: |
        Updated service [test-gcloud].
    - expect_stdout: |
        artifactGcsUri: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f
        createTime: '2020-08-21T23:22:00.651575530Z'
        endpointUri: thrift://10.62.192.23:9083
        hiveMetastoreConfig:
          configOverrides:
            hive.metastore.warehouse.dir: gs://gcs-bucket-test-gcloud-c90708d1-32c6-4c25-8015-c56851e9de2f/hive-warehouse
          version: 2.3.6
        labels:
          corge: grault
          foo: bar
          quuz: quux
        name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud
        network: projects/metastore-dogfood-cp/global/networks/default
        port: 9083
        state: ACTIVE
        stateMessage: The service is ready to use
        tier: ENTERPRISE
        updateTime: '2020-08-22T03:07:11.391839329Z'
    - expect_exit:
        code: 0
- execute_command:
    label: clear and remove labels at the same time
    command: |
      metastore services update test-gcloud --location=us-east4 --clear-labels --remove-labels=foo
    events:
    - expect_stderr: |
        ERROR: (gcloud.alpha.metastore.services.update) argument --clear-labels: At most one of --clear-labels | --remove-labels may be specified.
        Usage: gcloud alpha metastore services update (SERVICE : --location=LOCATION) [optional flags]
          optional flags may be  --async | --clear-hive-metastore-configs |
                                 --clear-labels | --help | --kerberos_principal |
                                 --keytab | --krb5-config | --location | --port |
                                 --remove-hive-metastore-configs | --remove-labels |
                                 --update-hive-metastore-configs |
                                 --update-hive-metastore-configs-from-file |
                                 --update-labels

        For detailed information on this command and its flags, run:
          gcloud alpha metastore services update --help
    - expect_exit:
        code: 1
        message: 'argument --clear-labels: At most one of --clear-labels | --remove-labels
          may be specified.'
- execute_command:
    label: kerberos configs keytab
    command: |
      metastore services update test-gcloud2 --location=us-east4 --keytab=projects/fake-project/secrets/kerberos-test/versions/2
    events:
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud2?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
               "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud2",
               "createTime": "2020-08-11T03:31:52.912810057Z",
               "updateTime": "2020-08-11T03:31:52.912810057Z",
               "hiveMetastoreConfig": {
                 "version": "2.3.6",
                 "configOverrides": {
                   "bar": "foo",
                   "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-update/hive-warehouse"
                 },
                 "kerberosConfig": {
                   "keytab": {
                     "cloudSecret": "projects/fake-project/secrets/kerberos-test/versions/1"
                   },
                   "krb5ConfigGcsUri": "gs://kerberos-fake-project/krb5.conf",
                   "principal": "metastore/fake-project@C.FAKE-PROJECT.INTERNAL"
                 }
               },
               "network": "projects/metastore-dogfood-cp/global/networks/yanbinlyu1",
               "endpointUri": "thrift://10.20.64.31:8080",
               "port": 8080,
               "state": "ACTIVE",
               "stateMessage": "The service is ready to use",
               "artifactGcsUri": "gs://gcs-bucket-test-gcloud2-64eaa6dd-1c31-4e82-93c9-28545aebb3c5",
               "tier": "ENTERPRISE"
             }
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud2?alt=json&updateMask=hive_metastore_config.kerberos_config.keytab
          method: PATCH
          headers: {}
          body:
            json:
              artifactGcsUri: gs://gcs-bucket-test-gcloud2-64eaa6dd-1c31-4e82-93c9-28545aebb3c5
              createTime: '2020-08-11T03:31:52.912810057Z'
              endpointUri: thrift://10.20.64.31:8080
              hiveMetastoreConfig:
                kerberosConfig:
                  keytab:
                    cloudSecret: projects/fake-project/secrets/kerberos-test/versions/2
                  krb5ConfigGcsUri: gs://kerberos-fake-project/krb5.conf
                  principal: metastore/fake-project@C.FAKE-PROJECT.INTERNAL
                version: 2.3.6
              name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud2
              network: projects/metastore-dogfood-cp/global/networks/yanbinlyu1
              port: 8080
              state: ACTIVE
              stateMessage: The service is ready to use
              tier: ENTERPRISE
              updateTime: '2020-08-11T03:31:52.912810057Z'
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597290458189-5acba2a5d0d8a-4e39394d-1cfbf4bc",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-13T03:47:38.212350862Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud2",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": false
            }
    - expect_stderr: |
        Request issued for: [test-gcloud2]
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597290458189-5acba2a5d0d8a-4e39394d-1cfbf4bc?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597290458189-5acba2a5d0d8a-4e39394d-1cfbf4bc",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.OperationMetadata",
                "createTime": "2020-08-13T03:47:38.212350862Z",
                "endTime": "2020-08-13T03:48:11.992689943Z",
                "target": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud2",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha"
              },
              "done": true,
              "response": {
                "@type": "type.googleapis.com/google.cloud.metastore.v1alpha.Service",
                "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud2",
                "createTime": "2020-08-11T03:31:52.912810057Z",
                "updateTime": "2020-08-11T03:31:52.912810057Z",
                "hiveMetastoreConfig": {
                  "version": "2.3.6",
                  "configOverrides": {
                    "bar": "foo",
                    "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-update/hive-warehouse"
                  },
                  "kerberosConfig": {
                    "keytab": {
                      "cloudSecret": "projects/fake-project/secrets/kerberos-test/versions/1"
                    },
                    "krb5ConfigGcsUri": "gs://kerberos-fake-project/krb5.conf",
                    "principal": "metastore/fake-project@C.FAKE-PROJECT.INTERNAL"
                  }
                },
                "network": "projects/metastore-dogfood-cp/global/networks/yanbinlyu1",
                "endpointUri": "thrift://10.20.64.31:8080",
                "port": 8080,
                "state": "ACTIVE",
                "stateMessage": "The service is ready to use",
                "artifactGcsUri": "gs://gcs-bucket-test-gcloud2-64eaa6dd-1c31-4e82-93c9-28545aebb3c5",
                "tier": "ENTERPRISE"
              }
            }
    - expect_progress_tracker:
        message: Waiting for operation [projects/metastore-dogfood-cp/locations/us-east4/operations/operation-1597290458189-5acba2a5d0d8a-4e39394d-1cfbf4bc]
          to complete
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://metastore.googleapis.com/v1alpha/projects/fake-project/locations/us-east4/services/test-gcloud2?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
               "name": "projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud2",
               "createTime": "2020-08-11T03:31:52.912810057Z",
               "updateTime": "2020-08-11T03:31:52.912810057Z",
               "hiveMetastoreConfig": {
                 "version": "2.3.6",
                 "configOverrides": {
                   "bar": "foo",
                   "hive.metastore.warehouse.dir": "gs://gcs-bucket-test-update/hive-warehouse"
                 },
                 "kerberosConfig": {
                   "keytab": {
                     "cloudSecret": "projects/fake-project/secrets/kerberos-test/versions/2"
                   },
                   "krb5ConfigGcsUri": "gs://kerberos-fake-project/krb5.conf",
                   "principal": "metastore/fake-project@C.FAKE-PROJECT.INTERNAL"
                 }
               },
               "network": "projects/metastore-dogfood-cp/global/networks/yanbinlyu1",
               "endpointUri": "thrift://10.20.64.31:8080",
               "port": 8080,
               "state": "ACTIVE",
               "stateMessage": "The service is ready to use",
               "artifactGcsUri": "gs://gcs-bucket-test-gcloud2-64eaa6dd-1c31-4e82-93c9-28545aebb3c5",
               "tier": "ENTERPRISE"
             }
    - expect_stderr: |
        Updated service [test-gcloud2].
    - expect_stdout: |
        artifactGcsUri: gs://gcs-bucket-test-gcloud2-64eaa6dd-1c31-4e82-93c9-28545aebb3c5
        createTime: '2020-08-11T03:31:52.912810057Z'
        endpointUri: thrift://10.20.64.31:8080
        hiveMetastoreConfig:
          configOverrides:
            bar: foo
            hive.metastore.warehouse.dir: gs://gcs-bucket-test-update/hive-warehouse
          kerberosConfig:
            keytab:
              cloudSecret: projects/fake-project/secrets/kerberos-test/versions/2
            krb5ConfigGcsUri: gs://kerberos-fake-project/krb5.conf
            principal: metastore/fake-project@C.FAKE-PROJECT.INTERNAL
          version: 2.3.6
        name: projects/metastore-dogfood-cp/locations/us-east4/services/test-gcloud2
        network: projects/metastore-dogfood-cp/global/networks/yanbinlyu1
        port: 8080
        state: ACTIVE
        stateMessage: The service is ready to use
        tier: ENTERPRISE
        updateTime: '2020-08-11T03:31:52.912810057Z'
    - expect_exit:
        code: 0
