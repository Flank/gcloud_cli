title: admin-service-cluster create test with custom endpoint and key scenario
release_tracks: [ALPHA]
summary:
# This summary is generated by http://go/gcloud-scenario-tests on update and should not be edited.
- execute:
  - command: |
      admin-service-cluster instances create foo --bundles=Anthos --git-sync-repo="git@git-server.git-server:/git-volume/repos/configs-custom.git" --git-secret-type=token --location=us-central1
  - stderr: |
      Create request issued for: [foo]
  - progress_tracker:
    - message: Waiting for operation [projects/fake-project/locations/us-central1/operations/operation-1596498466798-5ac01c3ff7b54-d4ae3594-44958af7]
        to complete
    - status: SUCCESS
  - stderr: |
      Created instance [foo].
actions:
- execute_command:
    command: |
      admin-service-cluster instances create foo --bundles=Anthos --git-sync-repo="git@git-server.git-server:/git-volume/repos/configs-custom.git" --git-secret-type=token --location=us-central1
    events:
    - api_call:
        expect_request:
          uri: https://krmapihosting.googleapis.com/v1alpha1/projects/fake-project/locations/us-central1/krmApiHosts?alt=json&krmApiHostId=foo
          method: POST
          headers: {}
          body:
            json:
              bundlesConfig: {anthosSseConfig: {enabled: true}}
              gitEndpoint: git@git-server.git-server:/git-volume/repos/configs-custom.git
              gitSecretType: token
              masterIpv4CidrBlock: 172.16.0.128/28
        return_response:
          status: 200
          headers:
            status: '200'
          body: |
            {
              "name": "projects/fake-project/locations/us-central1/operations/operation-1596498466798-5ac01c3ff7b54-d4ae3594-44958af7",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.krmapihosting.v1alpha1.OperationMetadata",
                "createTime": "2020-08-03T23:47:46.813581368Z",
                "target": "projects/fake-project/locations/us-central1/krmApiHosts/foo",
                "apiVersion": "v1alpha1"
              },
              "done": false
            }
    - expect_stderr: |
        Create request issued for: [foo]
    - api_call:
        expect_request:
          uri: https://krmapihosting.googleapis.com/v1alpha1/projects/fake-project/locations/us-central1/operations/operation-1596498466798-5ac01c3ff7b54-d4ae3594-44958af7?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            status: '200'
          body: |
            {
              "name": "projects/fake-project/locations/us-central1/operations/operation-1596498466798-5ac01c3ff7b54-d4ae3594-44958af7",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.krmapihosting.v1alpha1.OperationMetadata",
                "createTime": "2020-08-04T19:01:40.999018162Z",
                "target": "projects/fake-project/locations/us-central1/krmApiHosts/foo",
                "apiVersion": "v1alpha1"
              },
              "done": true
            }
        repeatable: true
    - expect_progress_tracker:
        message: Waiting for operation [projects/fake-project/locations/us-central1/operations/operation-1596498466798-5ac01c3ff7b54-d4ae3594-44958af7]
          to complete
        status: SUCCESS
    - api_call:
        expect_request:
          uri: https://krmapihosting.googleapis.com/v1alpha1/projects/fake-project/locations/us-central1/krmApiHosts/foo?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            status: '200'
          body: |
            {
              "name": "projects/fake-project/locations/us-central1/krmApiHosts/foo",
              "bundlesConfig": {
                "anthosSseConfig": {
                  "enabled": true
                }
              },
              "manBlock": "0.0.0.0/0",
              "masterIpv4CidrBlock": "172.16.0.128/28",
              "network": "default",
              "gitEndpoint": "git@git-server.git-server:/git-volume/repos/configs-custom.git",
              "gitBranch": "master",
              "gitSecretType": "token",
              "gitPolicyDir": "/",
              "gitSecretKey": "-----BEGIN OPENSSH PRIVATE KEY-----\nxxxxxxxxxxxxxxxxxxxxxx\n-----END OPENSSH PRIVATE KEY-----\n",
              "clusterCidrBlock": "/20",
              "servicesCidrBlock": "/27"
            }

    - expect_stderr: |
        Created instance [foo].
    - expect_exit:
        code: 0
