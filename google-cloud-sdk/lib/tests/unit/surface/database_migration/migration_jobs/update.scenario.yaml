title: database-migration migration-jobs update scenario test.
release_tracks: [ALPHA]
summary:
# This summary is generated by http://go/gcloud-scenario-tests on update and should not be edited.
- execute:
  - command: database-migration migration-jobs update test-job --region=us-central1
      --display-name=new-name --source=new-source --destination=new-dest --type=ONE_TIME
      --vm-ip=35.188.150.50 --vm-port=3306 --vpc=new-vpc --dump-path=gs://fake-bucket/dumpfile.sql
  - stdout: |
      done: true
      metadata:
        '@type': type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata
        apiVersion: v1alpha2
        createTime: '2020-09-02T17:35:23.308479663Z'
        endTime: '2020-09-02T17:35:23.350767828Z'
        requestedCancellation: false
        target: projects/fake-project/locations/us-central1/migrationJobs/test-job
        verb: update
      name: projects/fake-project/locations/us-central1/operations/operation-1599068123210-5ae580f74a40d-d9994858-988abe06
      response:
        '@type': type.googleapis.com/google.cloud.clouddms.v1alpha2.MigrationJob
        createTime: '2020-09-02T17:29:21.165014773Z'
        destination: projects/fake-project/locations/us-central1/connectionProfiles/new-dest
        displayName: new-name
        dumpPath: gs://fake-bucket/dumpfile.sql
        name: projects/fake-project/locations/us-central1/migrationJobs/test-draft
        reverseSshConnectivity:
          vmIp: 35.188.150.50
          vmPort: '3306'
          vpc: new-vpc
        source: projects/fake-project/locations/us-central1/connectionProfiles/new-src
        sourceDatabase:
          engine: MYSQL
          provider: CLOUDSQL
        state: DRAFT
        type: ONE_TIME
        updateTime: '2020-09-02T17:35:23.310500876Z'
- execute:
  - command: database-migration migration-jobs update test-job --region=us-central1
      --type=CONTINUOUS --display-name=new-name --peer-vpc=new-vpc --update-labels=k1=v1
  - stdout: |
      done: false
      metadata:
        '@type': type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata
        apiVersion: v1alpha2
        createTime: '2020-09-02T17:35:23.308479663Z'
        endTime: '2020-09-02T17:35:23.350767828Z'
        requestedCancellation: false
        target: projects/fake-project/locations/us-central1/migrationJobs/test-job
        verb: update
      name: projects/fake-project/locations/us-central1/operations/operation-1599068123210-5ae580f74a40d-d9994858-988abe06
actions:
- execute_command:
    command: database-migration migration-jobs update test-job --region=us-central1
      --display-name=new-name --source=new-source --destination=new-dest --type=ONE_TIME
      --vm-ip=35.188.150.50 --vm-port=3306 --vpc=new-vpc --dump-path=gs://fake-bucket/dumpfile.sql
    events:
    - api_call:
        expect_request:
          uri: https://datamigration.googleapis.com/v1alpha2/projects/fake-project/locations/us-central1/migrationJobs/test-job?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/fake-project/locations/us-central1/migrationJobs/test-job",
              "createTime": "2020-09-02T17:35:23.308479663Z",
              "updateTime": "2020-09-02T17:34:08.504218894Z",
              "displayName": "test-job",
              "state": "DRAFT",
              "type": "CONTINUOUS",
              "source": "projects/fake-project/locations/us-central1/connectionProfiles/fake-src",
              "destination": "projects/fake-project/locations/us-central1/connectionProfiles/fake-dest",
              "sourceDatabase": {
                "provider": "CLOUDSQL",
                "engine": "MYSQL"
              },
              "reverseSshConnectivity": {
                "vmPort": 1234
              }
            }
    - api_call:
        expect_request:
          uri:
            matches: https://datamigration.googleapis.com/v1alpha2/projects/fake-project/locations/us-central1/migrationJobs/test-job\?alt=json&requestId=.*&updateMask=destination%2CdisplayName%2CdumpPath%2Csource%2Ctype%2CreverseSshConnectivity.vmIp%2CreverseSshConnectivity.vmPort%2CreverseSshConnectivity.vpc
          method: PATCH
          headers: {}
          body:
            json:
              createTime: '2020-09-02T17:35:23.308479663Z'
              destination: projects/fake-project/locations/us-central1/connectionProfiles/new-dest
              displayName: new-name
              dumpPath: gs://fake-bucket/dumpfile.sql
              name: projects/fake-project/locations/us-central1/migrationJobs/test-job
              reverseSshConnectivity:
                vmIp: 35.188.150.50
                vmPort: 3306
                vpc: new-vpc
              source: projects/fake-project/locations/us-central1/connectionProfiles/new-source
              sourceDatabase:
                engine: MYSQL
                provider: CLOUDSQL
              state: DRAFT
              type: ONE_TIME
              updateTime: '2020-09-02T17:34:08.504218894Z'
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/fake-project/locations/us-central1/operations/operation-1599068123210-5ae580f74a40d-d9994858-988abe06",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata",
                "createTime": "2020-09-02T17:35:23.308479663Z",
                "endTime": "2020-09-02T17:35:23.350767828Z",
                "target": "projects/fake-project/locations/us-central1/migrationJobs/test-job",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha2"
              },
              "done": true,
              "response": {
                "@type": "type.googleapis.com/google.cloud.clouddms.v1alpha2.MigrationJob",
                "name": "projects/fake-project/locations/us-central1/migrationJobs/test-draft",
                "createTime": "2020-09-02T17:29:21.165014773Z",
                "updateTime": "2020-09-02T17:35:23.310500876Z",
                "displayName": "new-name",
                "dumpPath": "gs://fake-bucket/dumpfile.sql",
                "state": "DRAFT",
                "type": "ONE_TIME",
                "source": "projects/fake-project/locations/us-central1/connectionProfiles/new-src",
                "destination": "projects/fake-project/locations/us-central1/connectionProfiles/new-dest",
                "sourceDatabase": {
                  "provider": "CLOUDSQL",
                  "engine": "MYSQL"
                },
                "reverseSshConnectivity": {
                  "vmIp": "35.188.150.50",
                  "vmPort": "3306",
                  "vpc": "new-vpc"
                }
              }
            }
    - api_call:
        expect_request:
          uri: https://datamigration.googleapis.com/v1alpha2/projects/fake-project/locations/us-central1/operations/operation-1599068123210-5ae580f74a40d-d9994858-988abe06?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/fake-project/locations/us-central1/operations/operation-1599068123210-5ae580f74a40d-d9994858-988abe06",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata",
                "createTime": "2020-09-02T17:35:23.308479663Z",
                "endTime": "2020-09-02T17:35:23.350767828Z",
                "target": "projects/fake-project/locations/us-central1/migrationJobs/test-job",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha2"
              },
              "done": true,
              "response": {
                "@type": "type.googleapis.com/google.cloud.clouddms.v1alpha2.MigrationJob",
                "name": "projects/fake-project/locations/us-central1/migrationJobs/test-draft",
                "createTime": "2020-09-02T17:29:21.165014773Z",
                "updateTime": "2020-09-02T17:35:23.310500876Z",
                "displayName": "new-name",
                "dumpPath": "gs://fake-bucket/dumpfile.sql",
                "state": "DRAFT",
                "type": "ONE_TIME",
                "source": "projects/fake-project/locations/us-central1/connectionProfiles/new-src",
                "destination": "projects/fake-project/locations/us-central1/connectionProfiles/new-dest",
                "sourceDatabase": {
                  "provider": "CLOUDSQL",
                  "engine": "MYSQL"
                },
                "reverseSshConnectivity": {
                  "vmIp": "35.188.150.50",
                  "vmPort": "3306",
                  "vpc": "new-vpc"
                }
              }
            }
    - expect_stdout: |
        done: true
        metadata:
          '@type': type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata
          apiVersion: v1alpha2
          createTime: '2020-09-02T17:35:23.308479663Z'
          endTime: '2020-09-02T17:35:23.350767828Z'
          requestedCancellation: false
          target: projects/fake-project/locations/us-central1/migrationJobs/test-job
          verb: update
        name: projects/fake-project/locations/us-central1/operations/operation-1599068123210-5ae580f74a40d-d9994858-988abe06
        response:
          '@type': type.googleapis.com/google.cloud.clouddms.v1alpha2.MigrationJob
          createTime: '2020-09-02T17:29:21.165014773Z'
          destination: projects/fake-project/locations/us-central1/connectionProfiles/new-dest
          displayName: new-name
          dumpPath: gs://fake-bucket/dumpfile.sql
          name: projects/fake-project/locations/us-central1/migrationJobs/test-draft
          reverseSshConnectivity:
            vmIp: 35.188.150.50
            vmPort: '3306'
            vpc: new-vpc
          source: projects/fake-project/locations/us-central1/connectionProfiles/new-src
          sourceDatabase:
            engine: MYSQL
            provider: CLOUDSQL
          state: DRAFT
          type: ONE_TIME
          updateTime: '2020-09-02T17:35:23.310500876Z'
    - expect_exit:
        code: 0

- execute_command:
    command: database-migration migration-jobs update test-job --region=us-central1
      --type=CONTINUOUS --display-name=new-name --peer-vpc=new-vpc --update-labels=k1=v1
    events:
    - api_call:
        expect_request:
          uri: https://datamigration.googleapis.com/v1alpha2/projects/fake-project/locations/us-central1/migrationJobs/test-job?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/fake-project/locations/us-central1/migrationJobs/test-job",
              "createTime": "2020-09-02T17:35:23.308479663Z",
              "updateTime": "2020-09-02T17:34:08.504218894Z",
              "displayName": "test-job",
              "state": "DRAFT",
              "type": "CONTINUOUS",
              "source": "projects/fake-project/locations/us-central1/connectionProfiles/fake-src",
              "destination": "projects/fake-project/locations/us-central1/connectionProfiles/fake-dest",
              "sourceDatabase": {
                "provider": "CLOUDSQL",
                "engine": "MYSQL"
              },
              "reverseSshConnectivity": {
                "vmPort": 1234
              }
            }
    - api_call:
        expect_request:
          uri:
            matches: https://datamigration.googleapis.com/v1alpha2/projects/fake-project/locations/us-central1/migrationJobs/test-job\?alt=json&requestId=.*&updateMask=displayName%2Ctype%2CvpcPeeringConnectivity.vpc%2Clabels
          method: PATCH
          headers: {}
          body:
            json:
              createTime: '2020-09-02T17:35:23.308479663Z'
              destination: projects/fake-project/locations/us-central1/connectionProfiles/fake-dest
              displayName: new-name
              labels:
                k1: v1
              name: projects/fake-project/locations/us-central1/migrationJobs/test-job
              source: projects/fake-project/locations/us-central1/connectionProfiles/fake-src
              sourceDatabase:
                engine: MYSQL
                provider: CLOUDSQL
              state: DRAFT
              type: CONTINUOUS
              updateTime: '2020-09-02T17:34:08.504218894Z'
              vpcPeeringConnectivity:
                vpc: new-vpc
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/fake-project/locations/us-central1/operations/operation-1599068123210-5ae580f74a40d-d9994858-988abe06",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata",
                "createTime": "2020-09-02T17:35:23.308479663Z",
                "endTime": "2020-09-02T17:35:23.350767828Z",
                "target": "projects/fake-project/locations/us-central1/migrationJobs/test-job",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha2"
              },
              "done": false
            }
    - api_call:
        expect_request:
          uri: https://datamigration.googleapis.com/v1alpha2/projects/fake-project/locations/us-central1/operations/operation-1599068123210-5ae580f74a40d-d9994858-988abe06?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/fake-project/locations/us-central1/operations/operation-1599068123210-5ae580f74a40d-d9994858-988abe06",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata",
                "createTime": "2020-09-02T17:35:23.308479663Z",
                "endTime": "2020-09-02T17:35:23.350767828Z",
                "target": "projects/fake-project/locations/us-central1/migrationJobs/test-job",
                "verb": "update",
                "requestedCancellation": false,
                "apiVersion": "v1alpha2"
              },
              "done": false
            }
    - expect_stdout: |
        done: false
        metadata:
          '@type': type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata
          apiVersion: v1alpha2
          createTime: '2020-09-02T17:35:23.308479663Z'
          endTime: '2020-09-02T17:35:23.350767828Z'
          requestedCancellation: false
          target: projects/fake-project/locations/us-central1/migrationJobs/test-job
          verb: update
        name: projects/fake-project/locations/us-central1/operations/operation-1599068123210-5ae580f74a40d-d9994858-988abe06
    - expect_exit:
        code: 0
