title: database-migration migration-jobs create scenario test.
release_tracks: [ALPHA]
summary:
# This summary is generated by http://go/gcloud-scenario-tests on update and should not be edited.
- execute:
  - command: database-migration migration-jobs create test-job --region=us-central1
      --display-name=test-job --source=fake-source --destination=fake-dest --peer-vpc=fake-vpc
      --type=ONE_TIME
  - stdout: |
      done: true
      metadata:
        '@type': type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata
        apiVersion: v1alpha2
        createTime: '2020-08-20T15:50:10.958247249Z'
        endTime: '2020-08-20T15:54:53.744027484Z'
        requestedCancellation: false
        target: projects/fake-project/locations/us-central1/migrationJobs/myjob
        verb: create
      name: projects/fake-project/locations/us-central1/operations/operation-1597938610785-5ad511344cd5d-2c67243c-ff1cc5e9
      response:
        '@type': type.googleapis.com/google.cloud.clouddms.v1alpha2.MigrationJob
        createTime: '2020-08-20T15:50:10.935190864Z'
        destination: projects/fake-project/locations/us-central1/connectionProfiles/fake-dest
        destinationDatabase:
          provider: CLOUDSQL
        displayName: test-job
        name: projects/fake-project/locations/us-central1/migrationJobs/myjob
        source: projects/fake-project/locations/us-central1/connectionProfiles/fake-source
        state: NOT_STARTED
        type: ONE_TIME
        updateTime: '2020-08-20T15:50:10.935190864Z'
        vpcPeeringConnectivity:
          vpc: fake-vpc
- execute:
  - command: database-migration migration-jobs create test-job --region=us-central1
      --display-name=test-job --source=fake-source --destination=fake-dest --type=CONTINUOUS
      --dump-path=gs://fakebucket/dumpfile.sql
  - stdout: |
      done: false
      metadata:
        '@type': type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata
        apiVersion: v1alpha2
        createTime: '2020-08-20T16:10:39.010765781Z'
        requestedCancellation: false
        target: projects/fake-project/locations/us-central1/migrationJobs/test-job
        verb: create
      name: projects/fake-project/locations/us-central1/operations/operation-1597939838873-5ad515c77f151-0f3e5e46-86fa5cc8
- execute:
  - command: database-migration migration-jobs create test-job --region=us-central1
      --display-name=test-job --source=fake-source --destination=fake-dest --type=ONE_TIME
      --vm-ip=35.188.150.50 --vm-port=3306 --vpc=fake-vpc
  - stdout: |
      done: false
      metadata:
        '@type': type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata
        apiVersion: v1alpha2
        createTime: '2020-08-20T16:10:39.010765781Z'
        requestedCancellation: false
        target: projects/fake-project/locations/us-central1/migrationJobs/test-job
        verb: create
      name: projects/fake-project/locations/us-central1/operations/operation-1597939838873-5ad515c77f151-0f3e5e46-86fa5cc8
- execute:
  - command: database-migration migration-jobs create test-job --region=us-central1
      --display-name=test-job --source=fake-source --destination=fake-dest --peer-vpc=fake-vpc
      --type=ONE_TIME --dump-path=incorrect-path
  - error: '1: Invalid value for [dump-path]: Must be of form gs://bucket/object'
actions:
- execute_command:
    command: database-migration migration-jobs create test-job --region=us-central1
      --display-name=test-job --source=fake-source --destination=fake-dest --peer-vpc=fake-vpc
      --type=ONE_TIME
    events:
    - api_call:
        expect_request:
          uri:
            matches: https://datamigration.googleapis.com/v1alpha2/projects/fake-project/locations/us-central1/migrationJobs\?alt=json&migrationJobId=test-job&requestId=.*
          method: POST
          headers: {}
          body:
            json:
              destination: projects/fake-project/locations/us-central1/connectionProfiles/fake-dest
              displayName: test-job
              name: test-job
              source: projects/fake-project/locations/us-central1/connectionProfiles/fake-source
              state: CREATING
              type: ONE_TIME
              vpcPeeringConnectivity:
                vpc: fake-vpc
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/fake-project/locations/us-central1/operations/operation-1597939838873-5ad515c77f151-0f3e5e46-86fa5cc8",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata",
                "createTime": "2020-08-20T16:10:39.010765781Z",
                "target": "projects/fake-project/locations/us-central1/migrationJobs/test-job",
                "verb": "create",
                "requestedCancellation": false,
                "apiVersion": "v1alpha2"
              },
              "done": false
            }
    - api_call:
        expect_request:
          uri: https://datamigration.googleapis.com/v1alpha2/projects/fake-project/locations/us-central1/operations/operation-1597939838873-5ad515c77f151-0f3e5e46-86fa5cc8?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/fake-project/locations/us-central1/operations/operation-1597938610785-5ad511344cd5d-2c67243c-ff1cc5e9",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata",
                "createTime": "2020-08-20T15:50:10.958247249Z",
                "endTime": "2020-08-20T15:54:53.744027484Z",
                "target": "projects/fake-project/locations/us-central1/migrationJobs/myjob",
                "verb": "create",
                "requestedCancellation": false,
                "apiVersion": "v1alpha2"
              },
              "done": true,
              "response": {
                "@type": "type.googleapis.com/google.cloud.clouddms.v1alpha2.MigrationJob",
                "name": "projects/fake-project/locations/us-central1/migrationJobs/myjob",
                "createTime": "2020-08-20T15:50:10.935190864Z",
                "updateTime": "2020-08-20T15:50:10.935190864Z",
                "displayName": "test-job",
                "state": "NOT_STARTED",
                "type": "ONE_TIME",
                "source": "projects/fake-project/locations/us-central1/connectionProfiles/fake-source",
                "destination": "projects/fake-project/locations/us-central1/connectionProfiles/fake-dest",
                "destinationDatabase": {
                  "provider": "CLOUDSQL"
                },
                "vpcPeeringConnectivity": {
                  "vpc": "fake-vpc"
                }
              }
            }
    - expect_stdout: |
        done: true
        metadata:
          '@type': type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata
          apiVersion: v1alpha2
          createTime: '2020-08-20T15:50:10.958247249Z'
          endTime: '2020-08-20T15:54:53.744027484Z'
          requestedCancellation: false
          target: projects/fake-project/locations/us-central1/migrationJobs/myjob
          verb: create
        name: projects/fake-project/locations/us-central1/operations/operation-1597938610785-5ad511344cd5d-2c67243c-ff1cc5e9
        response:
          '@type': type.googleapis.com/google.cloud.clouddms.v1alpha2.MigrationJob
          createTime: '2020-08-20T15:50:10.935190864Z'
          destination: projects/fake-project/locations/us-central1/connectionProfiles/fake-dest
          destinationDatabase:
            provider: CLOUDSQL
          displayName: test-job
          name: projects/fake-project/locations/us-central1/migrationJobs/myjob
          source: projects/fake-project/locations/us-central1/connectionProfiles/fake-source
          state: NOT_STARTED
          type: ONE_TIME
          updateTime: '2020-08-20T15:50:10.935190864Z'
          vpcPeeringConnectivity:
            vpc: fake-vpc
    - expect_exit:
        code: 0

- execute_command:
    command: database-migration migration-jobs create test-job --region=us-central1
      --display-name=test-job --source=fake-source --destination=fake-dest --type=CONTINUOUS
      --dump-path=gs://fakebucket/dumpfile.sql
    events:
    - api_call:
        expect_request:
          uri:
            matches: https://datamigration.googleapis.com/v1alpha2/projects/fake-project/locations/us-central1/migrationJobs\?alt=json&migrationJobId=test-job&requestId=.*
          method: POST
          headers: {}
          body:
            json:
              destination: projects/fake-project/locations/us-central1/connectionProfiles/fake-dest
              displayName: test-job
              dumpPath: gs://fakebucket/dumpfile.sql
              name: test-job
              source: projects/fake-project/locations/us-central1/connectionProfiles/fake-source
              state: CREATING
              staticIpConnectivity: {}
              type: CONTINUOUS
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/fake-project/locations/us-central1/operations/operation-1597939838873-5ad515c77f151-0f3e5e46-86fa5cc8",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata",
                "createTime": "2020-08-20T16:10:39.010765781Z",
                "target": "projects/fake-project/locations/us-central1/migrationJobs/test-job",
                "verb": "create",
                "requestedCancellation": false,
                "apiVersion": "v1alpha2"
              },
              "done": false
            }
    - api_call:
        expect_request:
          uri: https://datamigration.googleapis.com/v1alpha2/projects/fake-project/locations/us-central1/operations/operation-1597939838873-5ad515c77f151-0f3e5e46-86fa5cc8?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/fake-project/locations/us-central1/operations/operation-1597939838873-5ad515c77f151-0f3e5e46-86fa5cc8",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata",
                "createTime": "2020-08-20T16:10:39.010765781Z",
                "target": "projects/fake-project/locations/us-central1/migrationJobs/test-job",
                "verb": "create",
                "requestedCancellation": false,
                "apiVersion": "v1alpha2"
              },
              "done": false
            }
    - expect_stdout: |
        done: false
        metadata:
          '@type': type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata
          apiVersion: v1alpha2
          createTime: '2020-08-20T16:10:39.010765781Z'
          requestedCancellation: false
          target: projects/fake-project/locations/us-central1/migrationJobs/test-job
          verb: create
        name: projects/fake-project/locations/us-central1/operations/operation-1597939838873-5ad515c77f151-0f3e5e46-86fa5cc8
    - expect_exit:
        code: 0

- execute_command:
    command: database-migration migration-jobs create test-job --region=us-central1
      --display-name=test-job --source=fake-source --destination=fake-dest --type=ONE_TIME
      --vm-ip=35.188.150.50 --vm-port=3306 --vpc=fake-vpc
    events:
    - api_call:
        expect_request:
          uri:
            matches: https://datamigration.googleapis.com/v1alpha2/projects/fake-project/locations/us-central1/migrationJobs\?alt=json&migrationJobId=test-job&requestId=.*
          method: POST
          headers: {}
          body:
            json:
              destination: projects/fake-project/locations/us-central1/connectionProfiles/fake-dest
              displayName: test-job
              name: test-job
              reverseSshConnectivity:
                vmIp: 35.188.150.50
                vmPort: 3306
                vpc: fake-vpc
              source: projects/fake-project/locations/us-central1/connectionProfiles/fake-source
              state: CREATING
              type: ONE_TIME
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/fake-project/locations/us-central1/operations/operation-1597939838873-5ad515c77f151-0f3e5e46-86fa5cc8",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata",
                "createTime": "2020-08-20T16:10:39.010765781Z",
                "target": "projects/fake-project/locations/us-central1/migrationJobs/test-job",
                "verb": "create",
                "requestedCancellation": false,
                "apiVersion": "v1alpha2"
              },
              "done": false
            }
    - api_call:
        expect_request:
          uri: https://datamigration.googleapis.com/v1alpha2/projects/fake-project/locations/us-central1/operations/operation-1597939838873-5ad515c77f151-0f3e5e46-86fa5cc8?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers: {}
          body: |
            {
              "name": "projects/fake-project/locations/us-central1/operations/operation-1597939838873-5ad515c77f151-0f3e5e46-86fa5cc8",
              "metadata": {
                "@type": "type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata",
                "createTime": "2020-08-20T16:10:39.010765781Z",
                "target": "projects/fake-project/locations/us-central1/migrationJobs/test-job",
                "verb": "create",
                "requestedCancellation": false,
                "apiVersion": "v1alpha2"
              },
              "done": false
            }
    - expect_stdout: |
        done: false
        metadata:
          '@type': type.googleapis.com/google.cloud.clouddms.v1alpha2.OperationMetadata
          apiVersion: v1alpha2
          createTime: '2020-08-20T16:10:39.010765781Z'
          requestedCancellation: false
          target: projects/fake-project/locations/us-central1/migrationJobs/test-job
          verb: create
        name: projects/fake-project/locations/us-central1/operations/operation-1597939838873-5ad515c77f151-0f3e5e46-86fa5cc8
    - expect_exit:
        code: 0

- execute_command:
    command: database-migration migration-jobs create test-job --region=us-central1
      --display-name=test-job --source=fake-source --destination=fake-dest --peer-vpc=fake-vpc
      --type=ONE_TIME --dump-path=incorrect-path
    events:
    - expect_exit:
        code: 1
        message: 'Invalid value for [dump-path]: Must be of form gs://bucket/object'
