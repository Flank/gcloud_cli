title: resource-manager folders get-ancestors-iam-policy test scenario
release_tracks: [GA]
summary:
# This summary is generated by http://go/gcloud-scenario-tests on update and should not be edited.
- execute:
  - command: |
      resource-manager folders get-ancestors-iam-policy 433899940107
  - stdout: |
      ---
      id: '433899940107'
      policy:
        bindings:
        - members:
          - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
          role: roles/resourcemanager.folderAdmin
        - members:
          - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
          role: roles/resourcemanager.folderEditor
        etag: BwWvTMWAXRI=
        version: 1
      type: folder
      ---
      id: '386701523587'
      policy:
        bindings:
        - members:
          - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
          role: roles/resourcemanager.folderAdmin
        - members:
          - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
          role: roles/resourcemanager.folderEditor
        etag: BwWvTL7nKE4=
        version: 1
      type: folder
      ---
      id: '386701523587'
      policy:
        bindings:
        - members:
          - user:belitskiy@google.com
          - user:dhruvsinghal@google.com
          - user:wfaris@google.com
          - user:zjn@google.com
          role: roles/accesscontextmanager.policyAdmin
        - members:
          - user:wfaris@google.com
          role: roles/accesscontextmanager.policyEditor
        - members:
          - user:wfaris@google.com
          role: roles/billing.admin
        - members:
          - domain:cloudsdktest.joonix.net
          - user:wfaris@google.com
          role: roles/billing.creator
        - members:
          - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
          role: roles/compute.xpnAdmin
        - members:
          - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
          role: roles/logging.admin
        - members:
          - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
          - user:wfaris@google.com
          role: roles/orgpolicy.policyAdmin
        - members:
          - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
          - user:chaorenliu@google.com
          - user:cloudsdktester@gmail.com
          - user:cloudsdktesterota@gmail.com
          - user:hgregg@google.com
          - user:jmzhou@google.com
          - user:viveganandhan@google.com
          - user:wfaris@google.com
          role: roles/owner
        - members:
          - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
          - user:chaorenliu@google.com
          - user:hgregg@google.com
          - user:wfaris@google.com
          role: roles/resourcemanager.folderCreator
        - members:
          - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
          role: roles/resourcemanager.folderEditor
        - members:
          - group:cloud-sdk-team@google.com
          - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
          - user:cloudsdk@cloudsdktest.joonix.net
          - user:jmzhou@google.com
          - user:viveganandhan@google.com
          role: roles/resourcemanager.organizationAdmin
        - members:
          - domain:cloudsdktest.joonix.net
          role: roles/resourcemanager.projectCreator
        etag: BwWjb7VQ1rI=
        version: 1
      type: organization
- execute:
  - command: |
      resource-manager folders get-ancestors-iam-policy 332989160089
  - error: '1: User is not permitted to access IAM policy for one or more of the ancestors'
actions:
- execute_command:
    command: |
      resource-manager folders get-ancestors-iam-policy 433899940107
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v2/folders/433899940107?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '189'
            content-type: application/json; charset=UTF-8
          body:
            name: folders/433899940107
            parent: folders/386701523587
            displayName: ancestor-iam-folder-2
            lifecycleState: ACTIVE
            createTime: '2020-09-14T21:32:29.557Z'
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v2/folders/433899940107:getIamPolicy?alt=json
          method: POST
          headers: {}
          body:
            json:
              options:
                requestedPolicyVersion: 3
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '450'
            content-type: application/json; charset=UTF-8
          body:
            version: 1
            etag: BwWvTMWAXRI=
            bindings:
            - role: roles/resourcemanager.folderAdmin
              members:
              - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            - role: roles/resourcemanager.folderEditor
              members:
              - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v2/folders/386701523587?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '196'
            content-type: application/json; charset=UTF-8
          body:
            name: folders/386701523587
            parent: organizations/1054311078602
            displayName: ancestor-iam-folder-1
            lifecycleState: ACTIVE
            createTime: '2020-09-14T21:30:38.843Z'
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v2/folders/386701523587:getIamPolicy?alt=json
          method: POST
          headers: {}
          body:
            json:
              options:
                requestedPolicyVersion: 3
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '450'
            content-type: application/json; charset=UTF-8
          body:
            version: 1
            etag: BwWvTL7nKE4=
            bindings:
            - role: roles/resourcemanager.folderAdmin
              members:
              - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            - role: roles/resourcemanager.folderEditor
              members:
              - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/1054311078602:getIamPolicy?alt=json
          method: POST
          headers: {}
          body:
            json:
              options:
                requestedPolicyVersion: 3
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '2704'
            content-type: application/json; charset=UTF-8
          body:
            version: 1
            etag: BwWjb7VQ1rI=
            bindings:
            - role: roles/accesscontextmanager.policyAdmin
              members:
              - user:belitskiy@google.com
              - user:dhruvsinghal@google.com
              - user:wfaris@google.com
              - user:zjn@google.com
            - role: roles/accesscontextmanager.policyEditor
              members:
              - user:wfaris@google.com
            - role: roles/billing.admin
              members:
              - user:wfaris@google.com
            - role: roles/billing.creator
              members:
              - domain:cloudsdktest.joonix.net
              - user:wfaris@google.com
            - role: roles/compute.xpnAdmin
              members:
              - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            - role: roles/logging.admin
              members:
              - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            - role: roles/orgpolicy.policyAdmin
              members:
              - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              - user:wfaris@google.com
            - role: roles/owner
              members:
              - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              - user:chaorenliu@google.com
              - user:cloudsdktester@gmail.com
              - user:cloudsdktesterota@gmail.com
              - user:hgregg@google.com
              - user:jmzhou@google.com
              - user:viveganandhan@google.com
              - user:wfaris@google.com
            - role: roles/resourcemanager.folderCreator
              members:
              - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              - user:chaorenliu@google.com
              - user:hgregg@google.com
              - user:wfaris@google.com
            - role: roles/resourcemanager.folderEditor
              members:
              - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            - role: roles/resourcemanager.organizationAdmin
              members:
              - group:cloud-sdk-team@google.com
              - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
              - user:cloudsdk@cloudsdktest.joonix.net
              - user:jmzhou@google.com
              - user:viveganandhan@google.com
            - role: roles/resourcemanager.projectCreator
              members:
              - domain:cloudsdktest.joonix.net
    - expect_stdout: |
        ---
        id: '433899940107'
        policy:
          bindings:
          - members:
            - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            role: roles/resourcemanager.folderAdmin
          - members:
            - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            role: roles/resourcemanager.folderEditor
          etag: BwWvTMWAXRI=
          version: 1
        type: folder
        ---
        id: '386701523587'
        policy:
          bindings:
          - members:
            - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            role: roles/resourcemanager.folderAdmin
          - members:
            - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            role: roles/resourcemanager.folderEditor
          etag: BwWvTL7nKE4=
          version: 1
        type: folder
        ---
        id: '386701523587'
        policy:
          bindings:
          - members:
            - user:belitskiy@google.com
            - user:dhruvsinghal@google.com
            - user:wfaris@google.com
            - user:zjn@google.com
            role: roles/accesscontextmanager.policyAdmin
          - members:
            - user:wfaris@google.com
            role: roles/accesscontextmanager.policyEditor
          - members:
            - user:wfaris@google.com
            role: roles/billing.admin
          - members:
            - domain:cloudsdktest.joonix.net
            - user:wfaris@google.com
            role: roles/billing.creator
          - members:
            - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            role: roles/compute.xpnAdmin
          - members:
            - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            role: roles/logging.admin
          - members:
            - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            - user:wfaris@google.com
            role: roles/orgpolicy.policyAdmin
          - members:
            - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            - user:chaorenliu@google.com
            - user:cloudsdktester@gmail.com
            - user:cloudsdktesterota@gmail.com
            - user:hgregg@google.com
            - user:jmzhou@google.com
            - user:viveganandhan@google.com
            - user:wfaris@google.com
            role: roles/owner
          - members:
            - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            - user:chaorenliu@google.com
            - user:hgregg@google.com
            - user:wfaris@google.com
            role: roles/resourcemanager.folderCreator
          - members:
            - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            role: roles/resourcemanager.folderEditor
          - members:
            - group:cloud-sdk-team@google.com
            - serviceAccount:462803083913-lak0k1ette3muh3o3kb3pp2im3urj3e9@developer.gserviceaccount.com
            - user:cloudsdk@cloudsdktest.joonix.net
            - user:jmzhou@google.com
            - user:viveganandhan@google.com
            role: roles/resourcemanager.organizationAdmin
          - members:
            - domain:cloudsdktest.joonix.net
            role: roles/resourcemanager.projectCreator
          etag: BwWjb7VQ1rI=
          version: 1
        type: organization
    - expect_exit:
        code: 0
- execute_command:
    command: |
      resource-manager folders get-ancestors-iam-policy 332989160089
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v2/folders/332989160089?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '176'
            content-type: application/json; charset=UTF-8
          body:
            name: folders/332989160089
            parent: folders/617875571173
            displayName: folder 2
            lifecycleState: ACTIVE
            createTime: '2020-09-10T23:48:26.544Z'
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v2/folders/332989160089:getIamPolicy?alt=json
          method: POST
          headers: {}
          body:
            json:
              options:
                requestedPolicyVersion: 3
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '322'
            content-type: application/json; charset=UTF-8
          body:
            version: 1
            etag: BwWu/jRUo2g=
            bindings:
            - role: roles/resourcemanager.folderAdmin
              members:
              - user:yifengwang@google.com
            - role: roles/resourcemanager.folderEditor
              members:
              - user:yifengwang@google.com
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v2/folders/617875571173?alt=json
          method: GET
          headers: {}
          body: null
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '187'
            content-type: application/json; charset=UTF-8
          body:
            name: folders/617875571173
            parent: organizations/961309089256
            displayName: Yifeng folder
            lifecycleState: ACTIVE
            createTime: '2020-09-10T23:47:21.655Z'
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v2/folders/617875571173:getIamPolicy?alt=json
          method: POST
          headers: {}
          body:
            json:
              options:
                requestedPolicyVersion: 3
        return_response:
          status: 200
          headers:
            cache-control: private
            content-length: '322'
            content-type: application/json; charset=UTF-8
          body:
            version: 1
            etag: BwWu/jB2bbc=
            bindings:
            - role: roles/resourcemanager.folderAdmin
              members:
              - user:yifengwang@google.com
            - role: roles/resourcemanager.folderEditor
              members:
              - user:yifengwang@google.com
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/961309089256:getIamPolicy?alt=json
          method: POST
          headers: {}
          body:
            json:
              options:
                requestedPolicyVersion: 3
        return_response:
          status: 403
          headers:
            cache-control: private
            content-length: '394'
            content-type: application/json; charset=UTF-8
          body:
            error:
              code: 403
              message: The caller does not have permission
              status: PERMISSION_DENIED
              details:
              - '@type': type.googleapis.com/google.rpc.DebugInfo
                detail: '[ORIGINAL ERROR] generic::permission_denied: com.google.apps.framework.request.ForbiddenException:
                  Unauthorized to perform the requested operation'
    - expect_exit:
        code: 1
        message: User is not permitted to access IAM policy for one or more of the
          ancestors
