title: projects add-iam-policy-binding scenario test
release_tracks: [ALPHA, BETA, GA]
summary:
# This summary is generated automatically on update and should not be edited.
- execute:
  - command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive
  - stderr: |
      Updated IAM policy for project [test-project].
  - stdout: |
      bindings:
      - members:
        - user:owner@gmail.com
        role: roles/another-non-primitive
      - members:
        - user:test@gmail.com
        role: roles/non-primitive
      etag: etag
      version: 1
- execute:
  - command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition=None
  - stderr: |
      Updated IAM policy for project [test-project].
  - stdout: |
      bindings:
      - members:
        - user:owner@gmail.com
        role: roles/another-non-primitive
      - members:
        - user:test@gmail.com
        role: roles/non-primitive
      etag: etag
      version: 1
- execute:
  - command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition='expression=request.time < timestamp("2019-01-01T00:00:00Z"),title=expires_end_of_2018'
  - stderr: |
      WARNING: Adding binding with condition to a policy without condition will change the behavior of add-iam-policy-binding and remove-iam-policy-binding commands.
  - stderr: |
      Updated IAM policy for project [test-project].
  - stdout: |
      bindings:
      - members:
        - user:owner@gmail.com
        role: roles/another-non-primitive
      - condition:
          expression: request.time < timestamp("2019-01-01T00:00:00Z")
          title: expires_end_of_2018
        members:
        - user:test@gmail.com
        role: roles/non-primitive
      etag: etag
      version: 3
- execute:
  - command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition='expression=expr,title=title,description=descr'
  - stderr: |
      Updated IAM policy for project [test-project].
  - stdout: |
      bindings:
      - condition:
          description: descr
          expression: expr
          title: title
        members:
        - user:oldtest@gmail.com
        - user:test@gmail.com
        role: roles/non-primitive
      etag: etag
      version: 3
- execute:
  - command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition='expression=new_expr,title=new_title,description=new_descr'
  - stderr: |
      Updated IAM policy for project [test-project].
  - stdout: |
      bindings:
      - condition:
          description: descr
          expression: expr
          title: title
        members:
        - user:oldtest@gmail.com
        role: roles/non-primitive
      - condition:
          description: new_descr
          expression: new_expr
          title: new_title
        members:
        - user:test@gmail.com
        role: roles/non-primitive
      etag: etag
      version: 3
- execute:
  - command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition=None
  - stderr: |
      Updated IAM policy for project [test-project].
  - stdout: |
      bindings:
      - condition:
          description: descr
          expression: expr
          title: title
        members:
        - user:oldtest@gmail.com
        role: roles/non-primitive
      - members:
        - user:test@gmail.com
        role: roles/non-primitive
      etag: etag
      version: 3
- execute:
  - command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition-from-file=condition.json
  - stderr: |
      Updated IAM policy for project [test-project].
  - stdout: |
      bindings:
      - condition:
          description: descr
          expression: expr
          title: title
        members:
        - user:oldtest@gmail.com
        - user:test@gmail.com
        role: roles/non-primitive
      etag: etag
      version: 3
- execute:
  - command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition-from-file=condition.yaml
  - stderr: |
      Updated IAM policy for project [test-project].
  - stdout: |
      bindings:
      - condition:
          description: descr
          expression: expr
          title: title
        members:
        - user:oldtest@gmail.com
        - user:test@gmail.com
        role: roles/non-primitive
      etag: etag
      version: 3
- execute:
  - command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition-from-file=condition_wrong_format.yaml
  - error: '1: Invalid value for [condition-from-file]: condition-from-file must be
      a path to a YAML or JSON file containing the condition. `expression` and `title`
      are required keys. `description` is optional. To specify a `None` condition,
      use --condition=None.'
- execute:
  - command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition=expression=expr,description=descr
  - error: |-
      1: Invalid value for [condition]: condition must be either `None` or a list of key=value pairs. If not `None`, `expression` and `title` are required keys.
      Example: --condition=expression=[expression],title=[title],description=[description]
- execute:
  - command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/editor --condition=expression=expr,title=title,description=descr
  - error: '1: Binding with a condition and a primitive role is not allowed. Primitive
      roles are `roles/editor`, `roles/owner`, and `roles/viewer`.'
- execute:
  - command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/editor --condition=None
  - stderr: |
      Updated IAM policy for project [test-project].
  - stdout: |
      bindings:
      - members:
        - user:owner@gmail.com
        role: roles/owner
      - members:
        - user:test@gmail.com
        role: roles/editor
      etag: etag
      version: 1
- execute:
  - command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition='expression=abcd,title=invalid_expression,description=descr'
  - stderr: |
      ERROR: Policy modification failed. For a binding with condition, run "gcloud alpha iam policies lint-condition" to identify issues in condition.
  - error: '1: HTTPError 400: INVALID_ARGUMENT: Condition expression compilation failed.'
- execute:
  - command: projects add-iam-policy-binding test-project --member=user:owner@google.com
      --role=roles/another-non-primitive
  - prompt:
    - prompt_string: The policy contains bindings with conditions, so specifying a
        condition is required when adding a binding. Please specify a condition.
    - choices: &id001
      - expression=expr,title=title,description=descr
      - None
      - Specify a new condition
    - input: '1'
  - stderr: |
      Updated IAM policy for project [test-project].
  - stdout: |
      bindings:
      - condition:
          description: descr
          expression: expr
          title: title
        members:
        - user:tester@gmail.com
        role: roles/non-primitive
      - condition:
          description: descr
          expression: expr
          title: title
        members:
        - user:owner@google.com
        role: roles/another-non-primitive
      etag: etag
      version: 3
- execute:
  - command: projects add-iam-policy-binding test-project --member=user:owner@google.com
      --role=roles/another-non-primitive
  - prompt:
    - prompt_string: The policy contains bindings with conditions, so specifying a
        condition is required when adding a binding. Please specify a condition.
    - choices: &id002
      - expression=expr,title=title,description=descr
      - None
      - Specify a new condition
    - input: '3'
  - prompt:
    - message: "Condition is either `None` or a list of key=value pairs. If not `None`, `expression` and `title` are required keys.\nExample: --condition=expression=[expression],title=[title],description=[description].\nSpecify the condition:  "
    - input: expression=expr,title=title,description=descr
  - stderr: |
      Updated IAM policy for project [test-project].
  - stdout: |
      bindings:
      - condition:
          description: descr
          expression: expr
          title: title
        members:
        - user:tester@gmail.com
        role: roles/non-primitive
      - condition:
          description: descr
          expression: expr
          title: title
        members:
        - user:owner@google.com
        role: roles/another-non-primitive
      etag: etag
      version: 3
- execute:
  - command: projects add-iam-policy-binding test-project --member=user:owner@google.com
      --role=roles/editor
  - prompt:
    - prompt_string: The policy contains bindings with conditions, so specifying a
        condition is required when adding a binding. Please specify a condition.
    - choices: &id003
      - expression=expr,title=title,description=descr
      - None
      - Specify a new condition
    - input: '3'
  - prompt:
    - message: "Condition is either `None` or a list of key=value pairs. If not `None`, `expression` and `title` are required keys.\nExample: --condition=expression=[expression],title=[title],description=[description].\nSpecify the condition:  "
    - input: expression=expr,title=title,description=descr
  - error: '1: Binding with a condition and a primitive role is not allowed. Primitive
      roles are `roles/editor`, `roles/owner`, and `roles/viewer`.'
actions:
- write_file:
    path: condition.json
    contents: |
      {
        "expression": "expr",
        "title": "title",
        "description": "descr"
      }
- write_file:
    path: condition.yaml
    contents: |
      expression: expr
      title: title
      description: descr

- write_file:
    path: condition_wrong_format.yaml
    contents: |
      expression: expr
      description: descr

# add binding without condition to a policy without condition
- execute_command:
    command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:getIamPolicy?alt=json
          method: POST
          body:
            json:
              options:
                requestedPolicyVersion: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/another-non-primitive",
                  "members": [
                    "user:owner@gmail.com"
                  ]
                }
              ]
            }
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:setIamPolicy?alt=json
          method: POST
          body:
            json:
              policy:
                bindings:
                - role: roles/another-non-primitive
                  members:
                  - user:owner@gmail.com
                - role: roles/non-primitive
                  members:
                  - user:test@gmail.com
                etag: etag
                version: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/another-non-primitive",
                  "members": [
                    "user:owner@gmail.com"
                  ]
                },
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:test@gmail.com"
                  ]
                }
              ]
            }
    - expect_stderr: |
        Updated IAM policy for project [test-project].
    - expect_stdout: |
        bindings:
        - members:
          - user:owner@gmail.com
          role: roles/another-non-primitive
        - members:
          - user:test@gmail.com
          role: roles/non-primitive
        etag: etag
        version: 1
    - expect_exit:
        code: 0

- execute_command:
    command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition=None
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:getIamPolicy?alt=json
          method: POST
          body:
            json:
              options:
                requestedPolicyVersion: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/another-non-primitive",
                  "members": [
                    "user:owner@gmail.com"
                  ]
                }
              ]
            }
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:setIamPolicy?alt=json
          method: POST
          body:
            json:
              policy:
                bindings:
                - role: roles/another-non-primitive
                  members:
                  - user:owner@gmail.com
                - role: roles/non-primitive
                  members:
                  - user:test@gmail.com
                etag: etag
                version: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/another-non-primitive",
                  "members": [
                    "user:owner@gmail.com"
                  ]
                },
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:test@gmail.com"
                  ]
                }
              ]
            }
    - expect_stderr: |
        Updated IAM policy for project [test-project].
    - expect_stdout: |
        bindings:
        - members:
          - user:owner@gmail.com
          role: roles/another-non-primitive
        - members:
          - user:test@gmail.com
          role: roles/non-primitive
        etag: etag
        version: 1
    - expect_exit:
        code: 0

- execute_command:
    command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition='expression=request.time < timestamp("2019-01-01T00:00:00Z"),title=expires_end_of_2018'
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:getIamPolicy?alt=json
          method: POST
          body:
            json:
              options:
                requestedPolicyVersion: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/another-non-primitive",
                  "members": [
                    "user:owner@gmail.com"
                  ]
                }
              ]
            }
    - expect_stderr: >
        WARNING: Adding binding with condition to a policy without condition will
        change the behavior
        of add-iam-policy-binding and remove-iam-policy-binding commands.
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:setIamPolicy?alt=json
          method: POST
          body:
            json:
              policy:
                bindings:
                - role: roles/another-non-primitive
                  members:
                  - user:owner@gmail.com
                - role: roles/non-primitive
                  members:
                  - user:test@gmail.com
                  condition:
                    expression: request.time < timestamp("2019-01-01T00:00:00Z")
                    title: expires_end_of_2018
                etag: etag
                version: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 3,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/another-non-primitive",
                  "members": [
                    "user:owner@gmail.com"
                  ]
                },
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:test@gmail.com"
                  ],
                  "condition": {
                    "expression": "request.time < timestamp(\"2019-01-01T00:00:00Z\")",
                    "title": "expires_end_of_2018"
                  }
                }
              ]
            }
    - expect_stderr: |
        Updated IAM policy for project [test-project].
    - expect_stdout: |
        bindings:
        - members:
          - user:owner@gmail.com
          role: roles/another-non-primitive
        - condition:
            expression: request.time < timestamp("2019-01-01T00:00:00Z")
            title: expires_end_of_2018
          members:
          - user:test@gmail.com
          role: roles/non-primitive
        etag: etag
        version: 3
    - expect_exit:
        code: 0

- execute_command:
    command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition='expression=expr,title=title,description=descr'
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:getIamPolicy?alt=json
          method: POST
          body:
            json:
              options:
                requestedPolicyVersion: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 3,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": ["user:oldtest@gmail.com"],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:setIamPolicy?alt=json
          method: POST
          body:
            json:
              policy:
                bindings:
                - role: roles/non-primitive
                  members:
                  - user:oldtest@gmail.com
                  - user:test@gmail.com
                  condition:
                    expression: expr
                    title: title
                    description: descr
                etag: etag
                version: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 3,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:oldtest@gmail.com",
                    "user:test@gmail.com"
                  ],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - expect_stderr: |
        Updated IAM policy for project [test-project].
    - expect_stdout: |
        bindings:
        - condition:
            description: descr
            expression: expr
            title: title
          members:
          - user:oldtest@gmail.com
          - user:test@gmail.com
          role: roles/non-primitive
        etag: etag
        version: 3
    - expect_exit:
        code: 0

- execute_command:
    command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition='expression=new_expr,title=new_title,description=new_descr'
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:getIamPolicy?alt=json
          method: POST
          body:
            json:
              options:
                requestedPolicyVersion: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 3,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": ["user:oldtest@gmail.com"],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:setIamPolicy?alt=json
          method: POST
          body:
            json:
              policy:
                bindings:
                - role: roles/non-primitive
                  members:
                  - user:oldtest@gmail.com
                  condition:
                    expression: expr
                    title: title
                    description: descr
                - role: roles/non-primitive
                  members:
                  - user:test@gmail.com
                  condition:
                    expression: new_expr
                    title: new_title
                    description: new_descr
                etag: etag
                version: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 3,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:oldtest@gmail.com"
                  ],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                },
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:test@gmail.com"
                  ],
                  "condition": {
                    "expression": "new_expr",
                    "title": "new_title",
                    "description": "new_descr"
                  }
                }
              ]
            }
    - expect_stderr: |
        Updated IAM policy for project [test-project].
    - expect_stdout: |
        bindings:
        - condition:
            description: descr
            expression: expr
            title: title
          members:
          - user:oldtest@gmail.com
          role: roles/non-primitive
        - condition:
            description: new_descr
            expression: new_expr
            title: new_title
          members:
          - user:test@gmail.com
          role: roles/non-primitive
        etag: etag
        version: 3
    - expect_exit:
        code: 0

- execute_command:
    command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition=None
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:getIamPolicy?alt=json
          method: POST
          body:
            json:
              options:
                requestedPolicyVersion: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 3,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": ["user:oldtest@gmail.com"],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:setIamPolicy?alt=json
          method: POST
          body:
            json:
              policy:
                bindings:
                - role: roles/non-primitive
                  members:
                  - user:oldtest@gmail.com
                  condition:
                    expression: expr
                    title: title
                    description: descr
                - role: roles/non-primitive
                  members:
                  - user:test@gmail.com
                etag: etag
                version: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 3,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:oldtest@gmail.com"
                  ],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                },
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:test@gmail.com"
                  ]
                }
              ]
            }
    - expect_stderr: |
        Updated IAM policy for project [test-project].
    - expect_stdout: |
        bindings:
        - condition:
            description: descr
            expression: expr
            title: title
          members:
          - user:oldtest@gmail.com
          role: roles/non-primitive
        - members:
          - user:test@gmail.com
          role: roles/non-primitive
        etag: etag
        version: 3
    - expect_exit:
        code: 0

- execute_command:
    command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition-from-file=condition.json
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:getIamPolicy?alt=json
          method: POST
          body:
            json:
              options:
                requestedPolicyVersion: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 3,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": ["user:oldtest@gmail.com"],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:setIamPolicy?alt=json
          method: POST
          body:
            json:
              policy:
                bindings:
                - role: roles/non-primitive
                  members:
                  - user:oldtest@gmail.com
                  - user:test@gmail.com
                  condition:
                    expression: expr
                    title: title
                    description: descr
                etag: etag
                version: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 3,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:oldtest@gmail.com",
                    "user:test@gmail.com"
                  ],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - expect_stderr: |
        Updated IAM policy for project [test-project].
    - expect_stdout: |
        bindings:
        - condition:
            description: descr
            expression: expr
            title: title
          members:
          - user:oldtest@gmail.com
          - user:test@gmail.com
          role: roles/non-primitive
        etag: etag
        version: 3
    - expect_exit:
        code: 0

- execute_command:
    command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition-from-file=condition.yaml
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:getIamPolicy?alt=json
          method: POST
          body:
            json:
              options:
                requestedPolicyVersion: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 3,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": ["user:oldtest@gmail.com"],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:setIamPolicy?alt=json
          method: POST
          body:
            json:
              policy:
                bindings:
                - role: roles/non-primitive
                  members:
                  - user:oldtest@gmail.com
                  - user:test@gmail.com
                  condition:
                    expression: expr
                    title: title
                    description: descr
                etag: etag
                version: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 3,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:oldtest@gmail.com",
                    "user:test@gmail.com"
                  ],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - expect_stderr: |
        Updated IAM policy for project [test-project].
    - expect_stdout: |
        bindings:
        - condition:
            description: descr
            expression: expr
            title: title
          members:
          - user:oldtest@gmail.com
          - user:test@gmail.com
          role: roles/non-primitive
        etag: etag
        version: 3
    - expect_exit:
        code: 0

- execute_command:
    command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition-from-file=condition_wrong_format.yaml
    events:
    - expect_exit:
        code: 1
        message: 'Invalid value for [condition-from-file]: condition-from-file must
          be a path to a YAML or JSON file containing the condition. `expression`
          and `title` are required keys. `description` is optional. To specify a `None`
          condition, use --condition=None.'
- execute_command:
    command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition=expression=expr,description=descr
    events:
    - expect_exit:
        code: 1
        message: |-
          Invalid value for [condition]: condition must be either `None` or a list of key=value pairs. If not `None`, `expression` and `title` are required keys.
          Example: --condition=expression=[expression],title=[title],description=[description]

# error when binding has condition and a primitive role
- execute_command:
    command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/editor --condition=expression=expr,title=title,description=descr
    events:
    - expect_exit:
        code: 1
        message: |-
          Binding with a condition and a primitive role is not allowed. Primitive roles are `roles/editor`, `roles/owner`, and `roles/viewer`.

# binding has None condition and a primitive role
- execute_command:
    command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/editor --condition=None
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:getIamPolicy?alt=json
          method: POST
          body:
            json:
              options:
                requestedPolicyVersion: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/owner",
                  "members": [
                    "user:owner@gmail.com"
                  ]
                }
              ]
            }
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:setIamPolicy?alt=json
          method: POST
          body:
            json:
              policy:
                bindings:
                - role: roles/owner
                  members:
                  - user:owner@gmail.com
                - role: roles/editor
                  members:
                  - user:test@gmail.com
                etag: etag
                version: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/owner",
                  "members": [
                    "user:owner@gmail.com"
                  ]
                },
                {
                  "role": "roles/editor",
                  "members": [
                    "user:test@gmail.com"
                  ]
                }
              ]
            }
    - expect_stderr: |
        Updated IAM policy for project [test-project].
    - expect_stdout: |
        bindings:
        - members:
          - user:owner@gmail.com
          role: roles/owner
        - members:
          - user:test@gmail.com
          role: roles/editor
        etag: etag
        version: 1
    - expect_exit:
        code: 0

- execute_command:
    command: projects add-iam-policy-binding test-project --member=user:test@gmail.com
      --role=roles/non-primitive --condition='expression=abcd,title=invalid_expression,description=descr'
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:getIamPolicy?alt=json
          method: POST
          body:
            json:
              options:
                requestedPolicyVersion: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": ["user:oldtest@gmail.com"],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:setIamPolicy?alt=json
          method: POST
          body:
            json:
              policy:
                bindings:
                - role: roles/non-primitive
                  members:
                  - user:oldtest@gmail.com
                  condition:
                    expression: expr
                    title: title
                    description: descr
                - role: roles/non-primitive
                  members:
                  - user:test@gmail.com
                  condition:
                    expression: abcd
                    title: invalid_expression
                    description: descr
                etag: etag
                version: 3
        return_response:
          headers:
            status: '400'
          body: |-
            INVALID_ARGUMENT: Condition expression compilation failed.
    - expect_stderr: |
        ERROR: Policy modification failed. For a binding with condition, run "gcloud alpha iam policies lint-condition" to identify issues in condition.
    - expect_exit:
        message: 'HTTPError 400: INVALID_ARGUMENT: Condition expression compilation
          failed.'
        code: 1
- execute_command:
    command: projects add-iam-policy-binding test-project --member=user:owner@google.com
      --role=roles/another-non-primitive
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:getIamPolicy?alt=json
          method: POST
          body:
            json:
              options:
                requestedPolicyVersion: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": ["user:tester@gmail.com"],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - expect_prompt_choice:
        prompt_string: The policy contains bindings with conditions, so specifying
          a condition is required when adding a binding. Please specify a condition.
        choices: *id001
        user_input: '1'
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:setIamPolicy?alt=json
          method: POST
          headers: {}
          body:
            json:
              policy:
                bindings:
                - role: roles/non-primitive
                  members:
                  - user:tester@gmail.com
                  condition:
                    expression: expr
                    title: title
                    description: descr
                - role: roles/another-non-primitive
                  members:
                  - user:owner@google.com
                  condition:
                    expression: expr
                    title: title
                    description: descr
                etag: etag
                version: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 3,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:tester@gmail.com"
                  ],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                },
                {
                  "role": "roles/another-non-primitive",
                  "members": [
                    "user:owner@google.com"
                  ],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }

    - expect_stderr: |
        Updated IAM policy for project [test-project].
    - expect_stdout: |
        bindings:
        - condition:
            description: descr
            expression: expr
            title: title
          members:
          - user:tester@gmail.com
          role: roles/non-primitive
        - condition:
            description: descr
            expression: expr
            title: title
          members:
          - user:owner@google.com
          role: roles/another-non-primitive
        etag: etag
        version: 3
    - expect_exit:
        code: 0
- execute_command:
    command: projects add-iam-policy-binding test-project --member=user:owner@google.com
      --role=roles/another-non-primitive
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:getIamPolicy?alt=json
          method: POST
          body:
            json:
              options:
                requestedPolicyVersion: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": ["user:tester@gmail.com"],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - expect_prompt_choice:
        prompt_string: The policy contains bindings with conditions, so specifying
          a condition is required when adding a binding. Please specify a condition.
        choices: *id002
        user_input: '3'
    - expect_prompt_response:
        message: "Condition is either `None` or a list of key=value pairs. If not `None`, `expression` and `title` are required keys.\nExample: --condition=expression=[expression],title=[title],description=[description].\nSpecify the condition:  "
        user_input: expression=expr,title=title,description=descr
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:setIamPolicy?alt=json
          method: POST
          headers: {}
          body:
            json:
              policy:
                bindings:
                - role: roles/non-primitive
                  members:
                  - user:tester@gmail.com
                  condition:
                    expression: expr
                    title: title
                    description: descr
                - role: roles/another-non-primitive
                  members:
                  - user:owner@google.com
                  condition:
                    expression: expr
                    title: title
                    description: descr
                etag: etag
                version: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 3,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:tester@gmail.com"
                  ],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                },
                {
                  "role": "roles/another-non-primitive",
                  "members": [
                    "user:owner@google.com"
                  ],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - expect_stderr: |
        Updated IAM policy for project [test-project].
    - expect_stdout: |
        bindings:
        - condition:
            description: descr
            expression: expr
            title: title
          members:
          - user:tester@gmail.com
          role: roles/non-primitive
        - condition:
            description: descr
            expression: expr
            title: title
          members:
          - user:owner@google.com
          role: roles/another-non-primitive
        etag: etag
        version: 3
    - expect_exit:
        code: 0
- execute_command:
    command: projects add-iam-policy-binding test-project --member=user:owner@google.com
      --role=roles/editor
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/projects/test-project:getIamPolicy?alt=json
          method: POST
          body:
            json:
              options:
                requestedPolicyVersion: 3
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": ["user:tester@gmail.com"],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - expect_prompt_choice:
        prompt_string: The policy contains bindings with conditions, so specifying
          a condition is required when adding a binding. Please specify a condition.
        choices: *id003
        user_input: '3'
    - expect_prompt_response:
        message: "Condition is either `None` or a list of key=value pairs. If not `None`, `expression` and `title` are required keys.\nExample: --condition=expression=[expression],title=[title],description=[description].\nSpecify the condition:  "
        user_input: expression=expr,title=title,description=descr
    - expect_exit:
        code: 1
        message: Binding with a condition and a primitive role is not allowed. Primitive
          roles are `roles/editor`, `roles/owner`, and `roles/viewer`.
