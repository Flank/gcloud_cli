title: organizations remove-iam-policy-binding scenario test
release_tracks: [ALPHA]

actions:
- write_file:
    path: condition.json
    contents: |
      {
        "expression": "expr",
        "title": "title",
        "description": "descr"
      }
- write_file:
    path: condition.yaml
    contents: |
      expression: expr
      title: title
      description: descr

- write_file:
    path: condition_wrong_format.yaml
    contents: |
      expression: expr
      description: descr

# remove binding without condition from a policy without condition
- execute_command:
    command: organizations remove-iam-policy-binding test-organization --member=user:owner@gmail.com --role=roles/owner
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/test-organization:getIamPolicy?alt=json
          method: POST
          body: null
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/owner",
                  "members": [
                    "user:owner@gmail.com",
                    "user:newowner@gmail.com"
                  ]
                }
              ]
            }
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/test-organization:setIamPolicy?alt=json
          method: POST
          body:
            json:
              policy:
                bindings:
                - role: 'roles/owner'
                  members: ['user:newowner@gmail.com']
                etag: 'etag'
                version: 1
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/owner",
                  "members": [
                    "user:newowner@gmail.com"
                  ]
                }
              ]
            }
    - expect_stdout: |
        bindings:
        - members:
          - user:newowner@gmail.com
          role: roles/owner
        etag: etag
        version: 1
    - expect_exit:
        code: 0

# remove binding without condition from a policy without condition, empty member list
- execute_command:
    command: organizations remove-iam-policy-binding test-organization --member=user:owner@gmail.com --role=roles/owner
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/test-organization:getIamPolicy?alt=json
          method: POST
          body: null
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/owner",
                  "members": [
                    "user:owner@gmail.com"
                  ]
                },
                {
                  "role": "roles/editor",
                  "members": [
                    "user:editor@gmail.com"
                  ]
                }
              ]
            }
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/test-organization:setIamPolicy?alt=json
          method: POST
          body:
            json:
              policy:
                bindings:
                - role: 'roles/editor'
                  members: ['user:editor@gmail.com']
                etag: 'etag'
                version: 1
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/editor",
                  "members": [
                    "user:editor@gmail.com"
                  ]
                }
              ]
            }
    - expect_stdout: |
        bindings:
        - members:
          - user:editor@gmail.com
          role: roles/editor
        etag: etag
        version: 1
    - expect_exit:
        code: 0

# remove binding without condition from a policy without condition, binding not found
- execute_command:
    command: organizations remove-iam-policy-binding test-organization --member=user:owner@gmail.com --role=roles/owner
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/test-organization:getIamPolicy?alt=json
          method: POST
          body: null
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/editor",
                  "members": [
                    "user:editor@gmail.com"
                  ]
                }
              ]
            }
    - expect_exit:
        code: 1
        message: Policy binding with the specified member, role, and condition not found!


# remove binding with condition from a policy with condition
- execute_command:
    command: organizations remove-iam-policy-binding test-organization --member=user:owner@gmail.com --role=roles/non-primitive --condition=expression=expr,title=title,description=descr
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/test-organization:getIamPolicy?alt=json
          method: POST
          body: null
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:owner@gmail.com",
                    "user:newowner@gmail.com"
                  ],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/test-organization:setIamPolicy?alt=json
          method: POST
          body:
            json:
              policy:
                bindings:
                - role: 'roles/non-primitive'
                  members: ['user:newowner@gmail.com']
                  condition:
                    expression: expr
                    title: title
                    description: descr
                etag: 'etag'
                version: 1
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:newowner@gmail.com"
                  ],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - expect_stdout: |
        bindings:
        - condition:
            description: descr
            expression: expr
            title: title
          members:
          - user:newowner@gmail.com
          role: roles/non-primitive
        etag: etag
        version: 1
    - expect_exit:
        code: 0

# remove binding with condition from a policy with condition, None condition
- execute_command:
    command: organizations remove-iam-policy-binding test-organization --member=user:editor@gmail.com --role=roles/editor --condition=None
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/test-organization:getIamPolicy?alt=json
          method: POST
          body: null
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:owner@gmail.com"
                  ],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                },
                {
                  "role": "roles/editor",
                  "members": [
                    "user:editor@gmail.com"
                  ]
                }
              ]
            }
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/test-organization:setIamPolicy?alt=json
          method: POST
          body:
            json:
              policy:
                bindings:
                - role: 'roles/non-primitive'
                  members: ['user:owner@gmail.com']
                  condition:
                    expression: expr
                    title: title
                    description: descr
                etag: 'etag'
                version: 1
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:owner@gmail.com"
                  ],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - expect_stdout: |
        bindings:
        - condition:
            description: descr
            expression: expr
            title: title
          members:
          - user:owner@gmail.com
          role: roles/non-primitive
        etag: etag
        version: 1
    - expect_exit:
        code: 0

# remove binding of all conditions from a policy with condition
- execute_command:
    command: organizations remove-iam-policy-binding test-organization --member=user:owner@gmail.com --role=roles/non-primitive --all
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/test-organization:getIamPolicy?alt=json
          method: POST
          body: null
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:owner@gmail.com",
                    "user:newowner@gmail.com"
                  ],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                },
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:owner@gmail.com"
                  ]
                }
              ]
            }
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/test-organization:setIamPolicy?alt=json
          method: POST
          body:
            json:
              policy:
                bindings:
                - role: 'roles/non-primitive'
                  members: ['user:newowner@gmail.com']
                  condition:
                    expression: expr
                    title: title
                    description: descr
                etag: 'etag'
                version: 1
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:newowner@gmail.com"
                  ],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - expect_stdout: |
        bindings:
        - condition:
            description: descr
            expression: expr
            title: title
          members:
          - user:newowner@gmail.com
          role: roles/non-primitive
        etag: etag
        version: 1
    - expect_exit:
        code: 0

# remove binding with condition from a policy with condition, condition from JSON file
- execute_command:
    command: organizations remove-iam-policy-binding test-organization --member=user:owner@gmail.com --role=roles/non-primitive --condition-from-file=condition.json
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/test-organization:getIamPolicy?alt=json
          method: POST
          body: null
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:owner@gmail.com",
                    "user:newowner@gmail.com"
                  ],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/test-organization:setIamPolicy?alt=json
          method: POST
          body:
            json:
              policy:
                bindings:
                - role: 'roles/non-primitive'
                  members: ['user:newowner@gmail.com']
                  condition:
                    expression: expr
                    title: title
                    description: descr
                etag: 'etag'
                version: 1
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:newowner@gmail.com"
                  ],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - expect_stdout: |
        bindings:
        - condition:
            description: descr
            expression: expr
            title: title
          members:
          - user:newowner@gmail.com
          role: roles/non-primitive
        etag: etag
        version: 1
    - expect_exit:
        code: 0

# remove binding with condition from a policy with condition, condition from YAML file
- execute_command:
    command: organizations remove-iam-policy-binding test-organization --member=user:owner@gmail.com --role=roles/non-primitive --condition-from-file=condition.yaml
    events:
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/test-organization:getIamPolicy?alt=json
          method: POST
          body: null
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:owner@gmail.com",
                    "user:newowner@gmail.com"
                  ],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - api_call:
        expect_request:
          uri: https://cloudresourcemanager.googleapis.com/v1/organizations/test-organization:setIamPolicy?alt=json
          method: POST
          body:
            json:
              policy:
                bindings:
                - role: 'roles/non-primitive'
                  members: ['user:newowner@gmail.com']
                  condition:
                    expression: expr
                    title: title
                    description: descr
                etag: 'etag'
                version: 1
        return_response:
          headers:
            status: '200'
          body: |-
            {
              "version": 1,
              "etag": "etag",
              "bindings": [
                {
                  "role": "roles/non-primitive",
                  "members": [
                    "user:newowner@gmail.com"
                  ],
                  "condition": {
                    "expression": "expr",
                    "title": "title",
                    "description": "descr"
                  }
                }
              ]
            }
    - expect_stdout: |
        bindings:
        - condition:
            description: descr
            expression: expr
            title: title
          members:
          - user:newowner@gmail.com
          role: roles/non-primitive
        etag: etag
        version: 1
    - expect_exit:
        code: 0

# condition is from file, format is wrong
- execute_command:
    command: organizations remove-iam-policy-binding test-organization --member=user:test@gmail.com --role=roles/non-primitive --condition-from-file=condition_wrong_format.yaml
    events:
    - expect_exit:
        code: 1
        message: 'Invalid value for [condition-from-file]: condition-from-file must be a path to a YAML or JSON file containing the condition. `expression` and `title` are required keys. `description` is optional. To specify a `None` condition, use --condition=None.'

# condition, format is wrong
- execute_command:
    command: organizations remove-iam-policy-binding test-organization --member=user:test@gmail.com --role=roles/non-primitive --condition=expression=expr,description=descr
    events:
    - expect_exit:
        code: 1
        message: |-
          Invalid value for [condition]: condition must be either `None` or a list of key=value pairs. If not `None`, `expression` and `title` are required keys.
          Example: --condition=expression=[expression],title=[title],description=[description]
